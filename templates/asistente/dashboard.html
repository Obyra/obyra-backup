{% extends "base.html" %}

{% block title %}Asistente Inteligente - OBYRA IA{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Hero Section del Asistente IA -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-primary text-white border-0">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="h2 mb-3">
                                <i class="fas fa-robot me-3"></i>
                                Asistente Inteligente OBYRA IA
                            </h1>
                            <p class="lead mb-0">
                                Tu asistente personal para optimizar proyectos, automatizar cálculos y proporcionar 
                                recomendaciones inteligentes basadas en datos reales de construcción.
                            </p>
                        </div>
                        <div class="col-md-4 text-center">
                            <button class="btn btn-light btn-lg" onclick="iniciarConfiguracionInteligente()">
                                <i class="fas fa-magic me-2"></i>
                                Configurar Proyecto
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas Rápidas -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-center mb-3">
                        <div class="bg-primary text-white rounded-circle p-3">
                            <i class="fas fa-building fa-2x"></i>
                        </div>
                    </div>
                    <h3 class="h4 text-primary">{{ obras_activas }}</h3>
                    <p class="text-muted mb-0">Obras Activas</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-center mb-3">
                        <div class="bg-warning text-white rounded-circle p-3">
                            <i class="fas fa-file-invoice-dollar fa-2x"></i>
                        </div>
                    </div>
                    <h3 class="h4 text-warning">{{ presupuestos_pendientes }}</h3>
                    <p class="text-muted mb-0">Presupuestos Pendientes</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-center mb-3">
                        <div class="bg-danger text-white rounded-circle p-3">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                    </div>
                    <h3 class="h4 text-danger">{{ items_stock_bajo }}</h3>
                    <p class="text-muted mb-0">Items Stock Bajo</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-center mb-3">
                        <div class="bg-success text-white rounded-circle p-3">
                            <i class="fas fa-lightbulb fa-2x"></i>
                        </div>
                    </div>
                    <h3 class="h4 text-success">{{ recomendaciones|length }}</h3>
                    <p class="text-muted mb-0">Recomendaciones IA</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Módulos Principales del Asistente -->
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="mb-4">Módulos Inteligentes Disponibles</h3>
        </div>
        
        {% if not current_user.is_authenticated %}
        <!-- 1. Ingreso del Usuario -->
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card h-100 border-0 shadow-sm hover-card">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-primary text-white rounded-circle p-3 me-3">
                            <i class="fas fa-sign-in-alt fa-lg"></i>
                        </div>
                        <div>
                            <h5 class="card-title mb-1">1. Ingreso del Usuario</h5>
                            <small class="text-muted">Página principal de OBYRA IA</small>
                        </div>
                    </div>
                    <p class="card-text mb-3">
                        Opción rápida: "Cotiza tu obra" / Login / Crear cuenta / Invitado
                    </p>
                    <a href="{{ url_for('reportes.dashboard') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-arrow-right me-1"></i>Acceder
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- 2. Formulario Inicial - Asistente Inteligente -->
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card h-100 border-0 shadow-sm hover-card">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-success text-white rounded-circle p-3 me-3">
                            <i class="fas fa-robot fa-lg"></i>
                        </div>
                        <div>
                            <h5 class="card-title mb-1">2. Formulario Inicial - Asistente Inteligente</h5>
                            <small class="text-muted">Configuración automática</small>
                        </div>
                    </div>
                    <p class="card-text mb-3">
                        Tipo de obra / m² / ubicación / Presupuesto tentativo / Selección inicial de etapa
                    </p>
                    <a href="{{ url_for('asistente.configuracion_inicial') }}" class="btn btn-success btn-sm">
                        <i class="fas fa-magic me-1"></i>Configurar Proyecto
                    </a>
                </div>
            </div>
        </div>

        <!-- 3. Módulo de Cotización Inteligente -->
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card h-100 border-0 shadow-sm hover-card">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-info text-white rounded-circle p-3 me-3">
                            <i class="fas fa-calculator fa-lg"></i>
                        </div>
                        <div>
                            <h5 class="card-title mb-1">3. Módulo de Cotización Inteligente</h5>
                            <small class="text-muted">Cálculo automático</small>
                        </div>
                    </div>
                    <p class="card-text mb-3">
                        Cálculo de materiales / m² / Sugerencia de máquinas / Costo estimado por etapa
                    </p>
                    <a href="{{ url_for('cotizacion.calculadora_inteligente') }}" class="btn btn-info btn-sm">
                        <i class="fas fa-chart-line me-1"></i>Calcular Materiales
                    </a>
                </div>
            </div>
        </div>

        <!-- 4. Document & Data Control -->
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card h-100 border-0 shadow-sm hover-card">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-dark text-white rounded-circle p-3 me-3">
                            <i class="fas fa-file-alt fa-lg"></i>
                        </div>
                        <div>
                            <h5 class="card-title mb-1">5. Document & Data Control</h5>
                            <small class="text-muted">Control documental</small>
                        </div>
                    </div>
                    <p class="card-text mb-3">
                        Panel privado del usuario / Subida y gestión de permisos, informes / Formularios digitales editables
                    </p>
                    <a href="{{ url_for('documentos.dashboard') }}" class="btn btn-dark btn-sm">
                        <i class="fas fa-folder me-1"></i>Gestionar Documentos
                    </a>
                </div>
            </div>
        </div>

        <!-- 6. Financial Command Center -->
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card h-100 border-0 shadow-sm hover-card">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-warning text-white rounded-circle p-3 me-3">
                            <i class="fas fa-chart-pie fa-lg"></i>
                        </div>
                        <div>
                            <h5 class="card-title mb-1">6. Financial Command Center</h5>
                            <small class="text-muted">Centro financiero</small>
                        </div>
                    </div>
                    <p class="card-text mb-3">
                        Cotizaciones en tiempo real / Generación de órdenes de compra / Control de facturación y pagos
                    </p>
                    <a href="{{ url_for('presupuestos.lista') }}" class="btn btn-warning btn-sm">
                        <i class="fas fa-money-bill-wave me-1"></i>Centro Financiero
                    </a>
                </div>
            </div>
        </div>

        <!-- 7. Safety & Compliance Assured -->
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card h-100 border-0 shadow-sm hover-card">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-danger text-white rounded-circle p-3 me-3">
                            <i class="fas fa-shield-alt fa-lg"></i>
                        </div>
                        <div>
                            <h5 class="card-title mb-1">9. Safety & Compliance Assured</h5>
                            <small class="text-muted">Seguridad y cumplimiento</small>
                        </div>
                    </div>
                    <p class="card-text mb-3">
                        Registro de incidentes / Gestión de EPP / Check de seguridad por etapa / Carga de certificados
                    </p>
                    <a href="{{ url_for('seguridad.dashboard') }}" class="btn btn-danger btn-sm">
                        <i class="fas fa-hard-hat me-1"></i>Seguridad
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Recomendaciones Inteligentes -->
    {% if recomendaciones %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-gradient-warning text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        Recomendaciones Inteligentes
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for recomendacion in recomendaciones %}
                        <div class="col-md-6 mb-3">
                            <div class="alert alert-{{ 'danger' if recomendacion.tipo == 'urgente' else 'warning' if recomendacion.tipo == 'advertencia' else 'info' }} border-start border-4 mb-2">
                                <div class="d-flex align-items-center">
                                    <i class="fas {{ recomendacion.icono }} me-3"></i>
                                    <div class="flex-grow-1">
                                        <h6 class="alert-heading mb-1">{{ recomendacion.titulo }}</h6>
                                        <p class="mb-2">{{ recomendacion.descripcion }}</p>
                                        <a href="{{ recomendacion.accion }}" class="btn btn-sm btn-outline-{{ 'danger' if recomendacion.tipo == 'urgente' else 'warning' if recomendacion.tipo == 'advertencia' else 'info' }}">
                                            Ver Detalles
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Chat con Asistente IA -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>
                        Chat con Asistente IA
                    </h5>
                </div>
                <div class="card-body">
                    <div id="chat-container" style="height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem; background-color: #f8f9fa;">
                        <div class="chat-message bot-message mb-3">
                            <div class="d-flex align-items-start">
                                <div class="bg-primary text-white rounded-circle p-2 me-3">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="bg-white p-3 rounded shadow-sm">
                                        <p class="mb-0">¡Hola! Soy tu asistente inteligente de OBYRA IA. ¿En qué puedo ayudarte hoy? Puedo asistirte con el estado de obras, inventario, presupuestos o cualquier análisis que necesites.</p>
                                    </div>
                                    <small class="text-muted">Ahora</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <div class="input-group">
                            <input type="text" id="chat-input" class="form-control" placeholder="Escribe tu consulta aquí..." onkeypress="if(event.key==='Enter') enviarMensajeIA()">
                            <button class="btn btn-primary" onclick="enviarMensajeIA()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Sugerencias rápidas -->
                    <div class="mt-3">
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="enviarConsultaRapida('¿Cuál es el estado de mis obras?')">
                                Estado de obras
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="enviarConsultaRapida('¿Qué items tienen stock bajo?')">
                                Stock bajo
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="enviarConsultaRapida('¿Cuántos presupuestos tengo pendientes?')">
                                Presupuestos pendientes
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="enviarConsultaRapida('Ayúdame a optimizar mi proyecto')">
                                Optimizar proyecto
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="enviarConsultaRapida('¿Cómo crear un nuevo proyecto?')">
                                Crear proyecto
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="enviarConsultaRapida('¿Qué materiales necesito para una casa de 100m²?')">
                                Calcular materiales
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Configuración Inteligente -->
<div class="modal fade" id="modalConfiguracionInteligente" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-magic me-2"></i>
                    Configuración Inteligente de Proyecto
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formConfiguracionInteligente">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre del Proyecto</label>
                            <input type="text" class="form-control" name="nombre_proyecto" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tipo de Obra</label>
                            <select class="form-select" name="tipo_obra" required>
                                <option value="">Seleccionar...</option>
                                <option value="casa_familia">Casa Unifamiliar</option>
                                <option value="edificio_departamentos">Edificio de Departamentos</option>
                                <option value="local_comercial">Local Comercial</option>
                                <option value="galpon_industrial">Galpón Industrial</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Metros Cuadrados</label>
                            <input type="number" class="form-control" name="metros_cuadrados" min="1" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ubicación</label>
                            <input type="text" class="form-control" name="ubicacion" placeholder="Ciudad, Provincia" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Presupuesto Estimado (ARS)</label>
                            <input type="number" class="form-control" name="presupuesto_estimado" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fecha de Inicio</label>
                            <input type="date" class="form-control" name="fecha_inicio" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Cliente</label>
                            <input type="text" class="form-control" name="cliente" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Teléfono Cliente</label>
                            <input type="tel" class="form-control" name="telefono_cliente">
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Email Cliente</label>
                            <input type="email" class="form-control" name="email_cliente">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="procesarConfiguracionInteligente()">
                    <i class="fas fa-magic me-1"></i>Configurar Automáticamente
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function iniciarConfiguracionInteligente() {
    new bootstrap.Modal(document.getElementById('modalConfiguracionInteligente')).show();
}

function procesarConfiguracionInteligente() {
    const form = document.getElementById('formConfiguracionInteligente');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    fetch('/asistente/configurar_proyecto', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('modalConfiguracionInteligente')).hide();
            showNotification('Proyecto configurado automáticamente con éxito', 'success');
            setTimeout(() => {
                window.location.href = `/obras/detalle/${data.obra_id}`;
            }, 2000);
        } else {
            showNotification('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showNotification('Error al procesar configuración', 'danger');
    });
}

function enviarMensajeIA() {
    const input = document.getElementById('chat-input');
    const mensaje = input.value.trim();
    
    if (!mensaje) return;
    
    // Agregar mensaje del usuario
    agregarMensajeChat(mensaje, 'user');
    input.value = '';
    
    // Enviar a la IA
    fetch('/asistente/chat_ia', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({mensaje: mensaje})
    })
    .then(response => response.json())
    .then(data => {
        agregarMensajeChat(data.respuesta, 'bot');
    })
    .catch(error => {
        agregarMensajeChat('Lo siento, no pude procesar tu consulta en este momento.', 'bot');
    });
}

function enviarConsultaRapida(consulta) {
    document.getElementById('chat-input').value = consulta;
    enviarMensajeIA();
}

function agregarMensajeChat(mensaje, tipo) {
    const container = document.getElementById('chat-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${tipo}-message mb-3`;
    
    const isBot = tipo === 'bot';
    
    // Formatear mensaje para mejor presentación
    let mensajeFormateado = mensaje;
    if (isBot) {
        // Convertir markdown básico a HTML
        mensajeFormateado = mensajeFormateado
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **texto** -> <strong>
            .replace(/\*(.*?)\*/g, '<em>$1</em>')              // *texto* -> <em>
            .replace(/\n/g, '<br>')                             // Saltos de línea
            .replace(/• /g, '&bull; ');                         // Bullets
    }
    
    messageDiv.innerHTML = `
        <div class="d-flex align-items-start ${isBot ? '' : 'flex-row-reverse'}">
            <div class="bg-${isBot ? 'primary' : 'secondary'} text-white rounded-circle p-2 ${isBot ? 'me-3' : 'ms-3'}">
                <i class="fas fa-${isBot ? 'robot' : 'user'}"></i>
            </div>
            <div class="flex-grow-1">
                <div class="bg-white p-3 rounded shadow-sm border-start border-${isBot ? 'primary' : 'secondary'} border-3">
                    <div class="mensaje-contenido">${mensajeFormateado}</div>
                </div>
                <small class="text-muted">Ahora</small>
            </div>
        </div>
    `;
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
    
    // Añadir animación de aparición
    messageDiv.style.opacity = '0';
    messageDiv.style.transform = 'translateY(20px)';
    setTimeout(() => {
        messageDiv.style.transition = 'all 0.3s ease';
        messageDiv.style.opacity = '1';
        messageDiv.style.transform = 'translateY(0)';
    }, 100);
}

function showNotification(message, type) {
    // Crear notificación
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-eliminar después de 5 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

// Estilos hover para cards
document.addEventListener('DOMContentLoaded', function() {
    const hoverCards = document.querySelectorAll('.hover-card');
    hoverCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.transition = 'all 0.3s ease';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
});
</script>
{% endblock %}