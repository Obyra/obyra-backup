{% extends "base.html" %}

{% block title %}Configuración Inicial Inteligente - OBYRA IA{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow">
                <div class="card-header bg-gradient-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-magic me-2"></i>
                        Asistente de Configuración Inicial Inteligente
                    </h3>
                    <p class="mb-0">Configura tu proyecto automáticamente con IA</p>
                </div>
                
                <div class="card-body p-4">
                    <!-- Pasos del asistente -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="progress mb-3" style="height: 8px;">
                                <div class="progress-bar bg-primary" role="progressbar" style="width: 25%" id="progress-bar"></div>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <div class="text-center">
                                    <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                        <span class="fw-bold">1</span>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-primary fw-bold">Datos Básicos</small>
                                    </div>
                                </div>
                                
                                <div class="text-center">
                                    <div class="bg-secondary text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                        <span class="fw-bold">2</span>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Cálculos IA</small>
                                    </div>
                                </div>
                                
                                <div class="text-center">
                                    <div class="bg-secondary text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                        <span class="fw-bold">3</span>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Revisión</small>
                                    </div>
                                </div>
                                
                                <div class="text-center">
                                    <div class="bg-secondary text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                        <span class="fw-bold">4</span>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Completado</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Paso 1: Datos Básicos -->
                    <div id="paso-1" class="wizard-step">
                        <h4 class="mb-4">
                            <i class="fas fa-info-circle text-primary me-2"></i>
                            Información Básica del Proyecto
                        </h4>
                        
                        <form id="form-paso-1">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-tag me-1"></i>
                                        Nombre del Proyecto
                                    </label>
                                    <input type="text" class="form-control" name="nombre_proyecto" placeholder="Ej: Casa Familia González" required>
                                    <div class="form-text">Este será el nombre principal de tu proyecto</div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-building me-1"></i>
                                        Tipo de Obra
                                    </label>
                                    <select class="form-select" name="tipo_obra" required onchange="actualizarInfoTipoObra()">
                                        <option value="">Selecciona el tipo de obra...</option>
                                        <option value="casa_unifamiliar">Casa Unifamiliar</option>
                                        <option value="duplex">Dúplex</option>
                                        <option value="edificio_3_5_pisos">Edificio 3-5 Pisos</option>
                                        <option value="edificio_6_10_pisos">Edificio 6-10 Pisos</option>
                                        <option value="edificio_11_15_pisos">Edificio 11-15 Pisos</option>
                                        <option value="local_comercial">Local Comercial</option>
                                        <option value="galpon_industrial">Galpón Industrial</option>
                                        <option value="nave_industrial">Nave Industrial</option>
                                        <option value="centro_comercial">Centro Comercial</option>
                                        <option value="renovacion_completa">Renovación Completa</option>
                                    </select>
                                    <div id="info-tipo-obra" class="form-text"></div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-ruler-combined me-1"></i>
                                        Metros Cuadrados
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" name="metros_cuadrados" min="10" max="10000" placeholder="120" required>
                                        <span class="input-group-text">m²</span>
                                    </div>
                                    <div class="form-text">Superficie total a construir</div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-map-marker-alt me-1"></i>
                                        Ubicación
                                    </label>
                                    <input type="text" class="form-control" name="ubicacion" id="ubicacion-input" 
                                           placeholder="Ej: Caseros, Buenos Aires" required autocomplete="off">
                                    <div class="form-text">
                                        <small class="text-muted">Escribe la dirección y selecciona de las sugerencias</small>
                                        <div id="ubicacion-provincia" class="fw-bold text-primary mt-1"></div>
                                    </div>
                                    <input type="hidden" name="provincia_detectada" id="provincia-detectada">
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-calendar-alt me-1"></i>
                                        Fecha de Inicio
                                    </label>
                                    <input type="date" class="form-control" name="fecha_inicio" required>
                                    <div class="form-text">Fecha estimada de inicio de obra</div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-dollar-sign me-1"></i>
                                        Presupuesto Estimado (Opcional)
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">ARS $</span>
                                        <input type="number" class="form-control" name="presupuesto_estimado" min="0" placeholder="5000000">
                                    </div>
                                    <div class="form-text">Si no tienes un presupuesto, la IA lo calculará automáticamente</div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-layer-group me-1"></i>
                                        Calidad de Terminación
                                    </label>
                                    <select class="form-select" name="calidad" required>
                                        <option value="economica">Económica</option>
                                        <option value="estandar" selected>Estándar</option>
                                        <option value="premium">Premium</option>
                                    </select>
                                    <div class="form-text">Influye en la selección de materiales y acabados</div>
                                </div>
                            </div>
                            
                            <hr class="my-4">
                            
                            <h5 class="mb-3">
                                <i class="fas fa-user me-2"></i>
                                Información del Cliente
                            </h5>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">Nombre del Cliente</label>
                                    <input type="text" class="form-control" name="cliente" placeholder="Juan Pérez" required>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">Teléfono</label>
                                    <input type="tel" class="form-control" name="telefono_cliente" placeholder="11-5555-5555">
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">Email</label>
                                    <input type="email" class="form-control" name="email_cliente" placeholder="cliente@email.com">
                                </div>
                            </div>
                        </form>
                        
                        <div class="d-flex justify-content-end mt-4">
                            <button type="button" class="btn btn-primary btn-lg" onclick="siguientePaso()">
                                Continuar con IA
                                <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Paso 2: Procesamiento IA -->
                    <div id="paso-2" class="wizard-step d-none">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary mb-4" style="width: 3rem; height: 3rem;"></div>
                            <h4 class="mb-3">
                                <i class="fas fa-robot text-primary me-2"></i>
                                Procesando con Inteligencia Artificial
                            </h4>
                            <p class="text-muted mb-4">La IA está analizando tu proyecto y generando configuraciones automáticas...</p>
                            
                            <div class="row justify-content-center">
                                <div class="col-md-8">
                                    <div class="list-group text-start">
                                        <div class="list-group-item d-flex align-items-center">
                                            <div class="spinner-grow spinner-grow-sm text-primary me-3"></div>
                                            Calculando materiales necesarios
                                        </div>
                                        <div class="list-group-item d-flex align-items-center">
                                            <div class="spinner-grow spinner-grow-sm text-success me-3"></div>
                                            Generando cronograma por etapas
                                        </div>
                                        <div class="list-group-item d-flex align-items-center">
                                            <div class="spinner-grow spinner-grow-sm text-info me-3"></div>
                                            Optimizando costos según ubicación
                                        </div>
                                        <div class="list-group-item d-flex align-items-center">
                                            <div class="spinner-grow spinner-grow-sm text-warning me-3"></div>
                                            Creando presupuesto detallado
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Paso 3: Revisión -->
                    <div id="paso-3" class="wizard-step d-none">
                        <h4 class="mb-4">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Revisión de Configuración Automática
                        </h4>
                        
                        <div id="resultados-ia" class="row">
                            <!-- Los resultados se cargarán aquí dinámicamente -->
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-outline-secondary" onclick="pasoAnterior()">
                                <i class="fas fa-arrow-left me-2"></i>
                                Anterior
                            </button>
                            <button type="button" class="btn btn-success btn-lg" onclick="confirmarConfiguracion()">
                                <i class="fas fa-save me-2"></i>
                                Confirmar y Crear Proyecto
                            </button>
                        </div>
                    </div>

                    <!-- Paso 4: Completado -->
                    <div id="paso-4" class="wizard-step d-none">
                        <div class="text-center py-5">
                            <div class="text-success mb-4">
                                <i class="fas fa-check-circle" style="font-size: 5rem;"></i>
                            </div>
                            <h3 class="text-success mb-3">¡Proyecto Configurado Exitosamente!</h3>
                            <p class="text-muted mb-4">Tu proyecto ha sido creado automáticamente con todas las configuraciones optimizadas por IA.</p>
                            
                            <div class="d-flex justify-content-center gap-3">
                                <a href="#" id="btn-ver-proyecto" class="btn btn-primary btn-lg">
                                    <i class="fas fa-eye me-2"></i>
                                    Ver Proyecto
                                </a>
                                <a href="{{ url_for('asistente.dashboard') }}" class="btn btn-outline-primary btn-lg">
                                    <i class="fas fa-home me-2"></i>
                                    Volver al Asistente
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let pasoActual = 1;
let datosProyecto = {};
let proyectoCreado = null;

function actualizarInfoTipoObra() {
    const tipoObra = document.querySelector('select[name="tipo_obra"]').value;
    const infoDiv = document.getElementById('info-tipo-obra');
    
    const infos = {
        'casa_familia': 'Construcción residencial unifamiliar tradicional',
        'duplex': 'Vivienda de dos unidades en dos plantas',
        'edificio_departamentos': 'Construcción multifamiliar en altura',
        'local_comercial': 'Espacio comercial para negocio',
        'galpon_industrial': 'Nave industrial para depósito o producción',
        'reforma_ampliacion': 'Modificación de estructura existente'
    };
    
    infoDiv.textContent = infos[tipoObra] || '';
}

function siguientePaso() {
    if (pasoActual === 1) {
        if (validarPaso1()) {
            // Recopilar datos del formulario
            const form = document.getElementById('form-paso-1');
            const formData = new FormData(form);
            datosProyecto = Object.fromEntries(formData.entries());
            
            // Mostrar paso 2 (procesamiento)
            mostrarPaso(2);
            
            // Simular procesamiento IA y luego procesar realmente
            setTimeout(() => {
                procesarConIA();
            }, 3000);
        }
    }
}

function pasoAnterior() {
    if (pasoActual > 1) {
        mostrarPaso(pasoActual - 1);
    }
}

function mostrarPaso(numero) {
    // Ocultar paso actual
    document.getElementById(`paso-${pasoActual}`).classList.add('d-none');
    
    // Mostrar nuevo paso
    pasoActual = numero;
    document.getElementById(`paso-${pasoActual}`).classList.remove('d-none');
    
    // Actualizar barra de progreso
    const progreso = (pasoActual / 4) * 100;
    document.getElementById('progress-bar').style.width = `${progreso}%`;
    
    // Actualizar indicadores de pasos
    actualizarIndicadoresPasos();
}

function actualizarIndicadoresPasos() {
    for (let i = 1; i <= 4; i++) {
        const stepCircle = document.querySelector(`.text-center:nth-child(${i}) .rounded-circle`);
        const stepText = document.querySelector(`.text-center:nth-child(${i}) small`);
        
        if (i <= pasoActual) {
            stepCircle.className = stepCircle.className.replace('bg-secondary', 'bg-primary');
            stepText.className = stepText.className.replace('text-muted', 'text-primary fw-bold');
        } else {
            stepCircle.className = stepCircle.className.replace('bg-primary', 'bg-secondary');
            stepText.className = stepText.className.replace('text-primary fw-bold', 'text-muted');
        }
    }
}

function validarPaso1() {
    const form = document.getElementById('form-paso-1');
    return form.checkValidity();
}

function procesarConIA() {
    fetch('/asistente/configurar_proyecto', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(datosProyecto)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            proyectoCreado = data;
            mostrarResultados(data);
            mostrarPaso(3);
        } else {
            alert('Error: ' + data.error);
            mostrarPaso(1);
        }
    })
    .catch(error => {
        alert('Error al procesar con IA');
        mostrarPaso(1);
    });
}

function mostrarResultados(data) {
    const container = document.getElementById('resultados-ia');
    container.innerHTML = `
        <div class="col-md-6 mb-4">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Cronograma</h6>
                </div>
                <div class="card-body">
                    <p class="mb-2"><strong>Duración estimada:</strong> ${data.configuracion.duracion_estimada} días</p>
                    <p class="mb-0"><strong>Etapas generadas:</strong> ${data.configuracion.etapas.length}</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Presupuesto</h6>
                </div>
                <div class="card-body">
                    <p class="mb-2"><strong>Total estimado:</strong> $${data.configuracion.presupuesto_ajustado.toLocaleString('es-AR')}</p>
                    <p class="mb-0"><strong>Items generados:</strong> ${data.configuracion.items_presupuesto.length}</p>
                </div>
            </div>
        </div>
        
        <div class="col-12 mb-4">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Recomendaciones IA</h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        ${data.configuracion.recomendaciones.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
            </div>
        </div>
    `;
}

function confirmarConfiguracion() {
    mostrarPaso(4);
    
    // Actualizar enlace del botón
    document.getElementById('btn-ver-proyecto').href = `/obras/detalle/${proyectoCreado.obra_id}`;
}

// Autocomplete para ubicaciones argentinas
function initLocationAutocomplete() {
    const input = document.getElementById('ubicacion-input');
    const provinciaDiv = document.getElementById('ubicacion-provincia');
    const provinciaHidden = document.getElementById('provincia-detectada');
    
    // Localidades principales de Argentina
    const ubicacionesArgentina = [
        // Buenos Aires
        { nombre: 'Ciudad Autónoma de Buenos Aires (CABA)', provincia: 'caba', factor: 1.3 },
        { nombre: 'La Plata, Buenos Aires', provincia: 'buenos_aires', factor: 1.1 },
        { nombre: 'Mar del Plata, Buenos Aires', provincia: 'buenos_aires', factor: 1.1 },
        { nombre: 'Bahía Blanca, Buenos Aires', provincia: 'buenos_aires', factor: 1.1 },
        { nombre: 'Tandil, Buenos Aires', provincia: 'buenos_aires', factor: 1.1 },
        { nombre: 'San Nicolás, Buenos Aires', provincia: 'buenos_aires', factor: 1.1 },
        { nombre: 'Pergamino, Buenos Aires', provincia: 'buenos_aires', factor: 1.1 },
        { nombre: 'Caseros, Buenos Aires', provincia: 'buenos_aires', factor: 1.1 },
        { nombre: 'Morón, Buenos Aires', provincia: 'buenos_aires', factor: 1.1 },
        { nombre: 'San Isidro, Buenos Aires', provincia: 'buenos_aires', factor: 1.1 },
        
        // Córdoba
        { nombre: 'Córdoba Capital, Córdoba', provincia: 'cordoba', factor: 1.0 },
        { nombre: 'Río Cuarto, Córdoba', provincia: 'cordoba', factor: 1.0 },
        { nombre: 'Villa María, Córdoba', provincia: 'cordoba', factor: 1.0 },
        { nombre: 'San Francisco, Córdoba', provincia: 'cordoba', factor: 1.0 },
        
        // Santa Fe
        { nombre: 'Rosario, Santa Fe', provincia: 'santa_fe', factor: 1.0 },
        { nombre: 'Santa Fe Capital, Santa Fe', provincia: 'santa_fe', factor: 1.0 },
        { nombre: 'Venado Tuerto, Santa Fe', provincia: 'santa_fe', factor: 1.0 },
        { nombre: 'Rafaela, Santa Fe', provincia: 'santa_fe', factor: 1.0 },
        
        // Mendoza
        { nombre: 'Mendoza Capital, Mendoza', provincia: 'mendoza', factor: 0.95 },
        { nombre: 'San Rafael, Mendoza', provincia: 'mendoza', factor: 0.95 },
        { nombre: 'Godoy Cruz, Mendoza', provincia: 'mendoza', factor: 0.95 },
        
        // Otras provincias importantes
        { nombre: 'Tucumán, Tucumán', provincia: 'otros', factor: 0.9 },
        { nombre: 'Salta Capital, Salta', provincia: 'otros', factor: 0.9 },
        { nombre: 'Resistencia, Chaco', provincia: 'otros', factor: 0.9 },
        { nombre: 'Corrientes Capital, Corrientes', provincia: 'otros', factor: 0.9 },
        { nombre: 'Posadas, Misiones', provincia: 'otros', factor: 0.9 },
        { nombre: 'Paraná, Entre Ríos', provincia: 'otros', factor: 0.9 },
        { nombre: 'San Juan Capital, San Juan', provincia: 'otros', factor: 0.9 },
        { nombre: 'Neuquén Capital, Neuquén', provincia: 'otros', factor: 0.9 },
        { nombre: 'San Luis Capital, San Luis', provincia: 'otros', factor: 0.9 }
    ];
    
    let currentFocus = -1;
    
    input.addEventListener('input', function() {
        const value = this.value.toLowerCase();
        closeAllLists();
        
        if (!value) {
            provinciaDiv.textContent = '';
            provinciaHidden.value = '';
            return;
        }
        
        const matches = ubicacionesArgentina.filter(loc => 
            loc.nombre.toLowerCase().includes(value)
        ).slice(0, 8);
        
        if (matches.length > 0) {
            const listDiv = document.createElement('div');
            listDiv.className = 'autocomplete-list position-absolute bg-white border rounded shadow-sm w-100';
            listDiv.style.zIndex = '1000';
            listDiv.style.maxHeight = '200px';
            listDiv.style.overflowY = 'auto';
            
            matches.forEach((match, index) => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item p-2 border-bottom';
                item.style.cursor = 'pointer';
                item.innerHTML = `<strong>${match.nombre}</strong>`;
                
                item.addEventListener('click', function() {
                    selectLocation(match);
                    closeAllLists();
                });
                
                listDiv.appendChild(item);
            });
            
            this.parentNode.appendChild(listDiv);
        }
    });
    
    function selectLocation(location) {
        input.value = location.nombre;
        provinciaDiv.textContent = `Provincia: ${getProvinciaName(location.provincia)} (Factor costo: ${location.factor})`;
        provinciaHidden.value = location.provincia;
    }
    
    function getProvinciaName(codigo) {
        const nombres = {
            'caba': 'Ciudad Autónoma de Buenos Aires',
            'buenos_aires': 'Buenos Aires',
            'cordoba': 'Córdoba',
            'santa_fe': 'Santa Fe',
            'mendoza': 'Mendoza',
            'otros': 'Otras Provincias'
        };
        return nombres[codigo] || 'Argentina';
    }
    
    function closeAllLists() {
        const lists = document.querySelectorAll('.autocomplete-list');
        lists.forEach(list => list.remove());
    }
    
    // Cerrar lista al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!input.contains(e.target)) {
            closeAllLists();
        }
    });
    
    // Navegación con teclado
    input.addEventListener('keydown', function(e) {
        const items = document.querySelectorAll('.autocomplete-item');
        if (e.keyCode === 40) { // DOWN
            currentFocus++;
            addActive(items);
        } else if (e.keyCode === 38) { // UP
            currentFocus--;
            addActive(items);
        } else if (e.keyCode === 13) { // ENTER
            e.preventDefault();
            if (currentFocus > -1 && items[currentFocus]) {
                items[currentFocus].click();
            }
        }
    });
    
    function addActive(items) {
        items.forEach(item => item.classList.remove('active'));
        if (currentFocus >= items.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = items.length - 1;
        if (items[currentFocus]) {
            items[currentFocus].classList.add('active');
            items[currentFocus].style.backgroundColor = '#e9ecef';
        }
    }
}

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    actualizarIndicadoresPasos();
    initLocationAutocomplete();
    
    // Establecer fecha mínima como hoy
    const fechaInput = document.querySelector('input[name="fecha_inicio"]');
    const hoy = new Date().toISOString().split('T')[0];
    fechaInput.value = hoy;
    fechaInput.min = hoy;
});
</script>
{% endblock %}