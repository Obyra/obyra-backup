{% extends "base.html" %}

{% block title %}Revisi√≥n de Presupuesto - OBYRA IA{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Progreso del flujo -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="fas fa-clipboard-check text-primary me-2"></i>Paso 3: Revisi√≥n</h4>
                        <div class="progress" style="width: 200px; height: 8px;">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: 75%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Resumen del proyecto -->
    <div class="row mb-4">
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informaci√≥n del Proyecto</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tipo de Obra:</label>
                        <p class="mb-1">{{ datos.tipo_obra|title|replace('_', ' ') }}</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Superficie:</label>
                        <p class="mb-1">{{ datos.metros_cuadrados }} m¬≤</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Calidad:</label>
                        <p class="mb-1">{{ datos.calidad|title }}</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Ubicaci√≥n:</label>
                        <p class="mb-1">{{ datos.ubicacion|title|replace('_', ' ') }}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Resultados del c√°lculo IA -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-brain me-2"></i>Presupuesto Calculado por IA</h5>
                </div>
                <div class="card-body">
                    <!-- Resumen financiero -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-light rounded">
                                <h3 class="text-primary mb-1">${{ "{:,.0f}".format(datos.calculo.total_materiales) }}</h3>
                                <small class="text-muted">Total Materiales</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-light rounded">
                                <h3 class="text-warning mb-1">${{ "{:,.0f}".format(datos.calculo.total_mano_obra) }}</h3>
                                <small class="text-muted">Mano de Obra</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-success text-white rounded">
                                <h3 class="mb-1">${{ "{:,.0f}".format(datos.calculo.total_general) }}</h3>
                                <small>Total General</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FLAG: calculadora cartel v1 -->
                    <div id="aviso-estimado" class="alert alert-warning alert-dismissible fade show mt-3" role="alert">
                        ‚ö†Ô∏è <strong>ESTE PRESUPUESTO ES ESTIMADO*</strong> Tomar como referencia.
                        El c√°lculo final se realizar√° una vez que el cliente d√© su <strong>OK</strong>.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    
                    <!-- Desglose de materiales -->
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>Material</th>
                                    <th>Cantidad</th>
                                    <th>Unidad</th>
                                    <th>Precio Unit.</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for material in datos.calculo.materiales %}
                                <tr>
                                    <td>{{ material.material }}</td>
                                    <td>{{ material.cantidad }}</td>
                                    <td>{{ material.unidad }}</td>
                                    <td>${{ "{:,.0f}".format(material.precio_unitario) }}</td>
                                    <td>${{ "{:,.0f}".format(material.total) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Recomendaciones IA -->
                    <div class="mt-4">
                        <h6 class="fw-bold"><i class="fas fa-lightbulb text-warning me-2"></i>Recomendaciones IA</h6>
                        <ul class="list-unstyled">
                            {% for rec in datos.calculo.recomendaciones %}
                            <li class="mb-2">
                                <i class="fas fa-check-circle text-success me-2"></i>{{ rec }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Formulario de Obra Destino -->
    <form id="formGuardarPresupuesto" action="{{ url_for('presupuestos.guardar_presupuesto') }}" method="POST">
        <div class="card mt-3">
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h5 class="card-title">üèóÔ∏è Obra Destino</h5>

                <div class="mb-2">
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="modo_obra" id="obra_existente" value="existente" checked>
                    <label class="form-check-label" for="obra_existente">Usar obra existente</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="modo_obra" id="obra_nueva" value="nueva">
                    <label class="form-check-label" for="obra_nueva">Crear nueva obra</label>
                  </div>
                </div>

                <!-- selector obra existente -->
                <div id="block_obra_existente" class="mb-3">
                  <select class="form-select" name="obra_id">
                    <option value="">Crear nueva obra autom√°ticamente</option>
                    {% for o in obras %}
                      <option value="{{ o.id }}">{{ o.nombre }}</option>
                    {% endfor %}
                  </select>
                  <div class="form-text">Si no seleccion√°s una obra, se crear√° autom√°ticamente.</div>
                </div>

                <!-- formulario obra nueva -->
                <div id="block_obra_nueva" class="mb-3" style="display:none;">
                  <div class="row g-2">
                    <div class="col-md-12">
                      <label class="form-label">Nombre de la obra</label>
                      <input class="form-control" name="obra_nombre" placeholder="Ej: Edificio Lavalle 123">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Cliente</label>
                      <input class="form-control" name="cliente_nombre" placeholder="Nombre y apellido / Empresa">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Email</label>
                      <input class="form-control" name="cliente_email" type="email">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Tel√©fono</label>
                      <input class="form-control" name="cliente_telefono">
                    </div>

                    <div class="col-md-8">
                      <label class="form-label">Direcci√≥n</label>
                      <input class="form-control" name="direccion" placeholder="Calle y n√∫mero">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Ciudad</label>
                      <input class="form-control" name="ciudad">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Provincia</label>
                      <input class="form-control" name="provincia">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Pa√≠s</label>
                      <input class="form-control" name="pais" value="Argentina">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">C√≥digo postal</label>
                      <input class="form-control" name="codigo_postal">
                    </div>

                    <div class="col-md-12">
                      <label class="form-label">Referencia / Notas</label>
                      <input class="form-control" name="referencia" placeholder="Piso, entrecalles, acceso, etc.">
                    </div>
                    <div class="col-md-12">
                      <label class="form-label">Notas internas</label>
                      <textarea class="form-control" name="obra_notas" rows="2"></textarea>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <h5 class="card-title">üìù Observaciones</h5>
                <textarea class="form-control" name="observaciones" placeholder="Observaciones adicionales..."></textarea>
                
                <!-- Campos ocultos con datos del c√°lculo -->
                <input type="hidden" name="superficie" value="{{ datos.metros_cuadrados }}">
                <input type="hidden" name="tipo_construccion" value="{{ datos.tipo_obra }}">
                <input type="hidden" name="calculo_json" value="{{ datos.calculo | tojson }}">
                <input type="hidden" name="total_estimado" value="{{ datos.calculo.total_general }}">
              </div>
            </div>

            <div class="mt-3 d-flex gap-2">
              <button type="submit" class="btn btn-success">
                <i class="bi bi-save"></i> Guardar Presupuesto
              </button>
              <button type="button" class="btn btn-outline-secondary" id="btn-export-excel">Exportar Excel</button>
              <a href="{{ url_for('cotizacion.calculadora_inteligente') }}" class="btn btn-outline-primary">Nuevo C√°lculo</a>
            </div>
          </div>
        </div>
    </form>
</div>

<script>
// Funcionalidad del conmutador de obra destino
const rExist = document.getElementById('obra_existente');
const rNueva = document.getElementById('obra_nueva');
const bExist = document.getElementById('block_obra_existente');
const bNueva = document.getElementById('block_obra_nueva');

function toggleObra() {
  if (rNueva.checked) {
    bNueva.style.display = '';
    bExist.style.display = 'none';
  } else {
    bNueva.style.display = 'none';
    bExist.style.display = '';
  }
}
rExist.addEventListener('change', toggleObra);
rNueva.addEventListener('change', toggleObra);
toggleObra();

// Al enviar, marcar flag crear_nueva_obra y manejar respuesta JSON
document.querySelector('#formGuardarPresupuesto').addEventListener('submit', async (e) => {
  e.preventDefault(); // Prevenir env√≠o normal del formulario
  
  const form = e.target;
  const submitBtn = form.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  
  // Agregar flag crear_nueva_obra
  let flag = form.querySelector('input[name="crear_nueva_obra"]');
  if (!flag) {
    flag = document.createElement('input');
    flag.type = 'hidden';
    flag.name = 'crear_nueva_obra';
    form.appendChild(flag);
  }
  flag.value = rNueva.checked ? '1' : '0';
  
  // Deshabilitar bot√≥n y mostrar loading
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
  
  try {
    // Enviar formulario con fetch
    const formData = new FormData(form);
    const response = await fetch(form.action, {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (result.ok) {
      alert('Presupuesto guardado exitosamente');
      // Redirigir al detalle del presupuesto
      window.location.href = '/presupuestos/' + result.presupuesto_id;
    } else {
      alert('Error: ' + (result.error || 'Error desconocido'));
    }
  } catch (error) {
    alert('Error de conexi√≥n: ' + error.message);
  } finally {
    // Restaurar bot√≥n
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalText;
  }
});

function editarPresupuesto() {
    if(confirm('¬øDesea modificar los datos del presupuesto? Esto lo llevar√° de vuelta al formulario inicial.')) {
        window.location.href = "{{ url_for('cotizacion.calculadora_inteligente') }}";
    }
}

function generarPDF() {
    const btn = document.getElementById('btnGenerarPDF');
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generando PDF...';
    
    fetch("{{ url_for('cotizacion.generar_pdf') }}")
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Descargar PDF
                window.open(data.pdf_url, '_blank');
                
                // Mostrar mensaje de √©xito
                alert('PDF generado correctamente. El archivo se ha descargado.');
                
                // Opci√≥n de ir al dashboard o comenzar nuevo presupuesto
                if(confirm('¬øDesea crear un nuevo presupuesto?')) {
                    window.location.href = "{{ url_for('cotizacion.calculadora_inteligente') }}";
                }
            } else {
                alert('Error generando PDF: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            alert('Error de conexi√≥n: ' + error.message);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
}
</script>
{% endblock %}