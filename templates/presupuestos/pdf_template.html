<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Presupuesto {{ presupuesto.numero }}</title>
    <style>
        @page {
            size: A4;
            margin: 2cm;
        }
        body {
            font-family: 'Arial', sans-serif;
            font-size: 11pt;
            color: #333;
            line-height: 1.4;
        }
        .header {
            border-bottom: 3px solid #0066cc;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #0066cc;
            margin: 0 0 10px 0;
            font-size: 24pt;
        }
        .header .numero {
            font-size: 16pt;
            color: #666;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
        }
        .info-box h3 {
            margin: 0 0 10px 0;
            color: #0066cc;
            font-size: 12pt;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        .info-box p {
            margin: 5px 0;
            font-size: 10pt;
        }
        .info-box strong {
            color: #555;
        }
        .items-section {
            margin: 30px 0;
        }
        .items-section h2 {
            color: #0066cc;
            font-size: 16pt;
            margin-bottom: 15px;
            border-bottom: 2px solid #0066cc;
            padding-bottom: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        table th {
            background: #0066cc;
            color: white;
            padding: 10px;
            text-align: left;
            font-size: 10pt;
        }
        table td {
            padding: 8px 10px;
            border-bottom: 1px solid #ddd;
            font-size: 10pt;
        }
        table tr:hover {
            background: #f8f9fa;
        }
        .tipo-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 9pt;
            font-weight: bold;
        }
        .tipo-material { background: #e3f2fd; color: #1976d2; }
        .tipo-mano_obra { background: #fff3e0; color: #f57c00; }
        .tipo-equipo { background: #f3e5f5; color: #7b1fa2; }
        .totals {
            float: right;
            width: 300px;
            margin-top: 20px;
        }
        .totals table {
            margin-bottom: 0;
        }
        .totals td {
            padding: 8px;
            font-weight: bold;
        }
        .totals .label {
            text-align: right;
            color: #666;
        }
        .totals .value {
            text-align: right;
            color: #333;
        }
        .totals .total-row {
            background: #0066cc;
            color: white;
        }
        .totals .total-row .value {
            color: white;
            font-size: 14pt;
        }
        .observaciones {
            clear: both;
            margin-top: 40px;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #0066cc;
        }
        .observaciones h3 {
            margin: 0 0 10px 0;
            color: #0066cc;
            font-size: 12pt;
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
            font-size: 9pt;
            color: #666;
            text-align: center;
        }
        .vigencia {
            display: inline-block;
            padding: 5px 10px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 3px;
            color: #856404;
            font-weight: bold;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>{{ organizacion.nombre }}</h1>
        <div class="numero">Presupuesto Nº {{ presupuesto.numero }}</div>
    </div>

    <div class="info-grid">
        <div class="info-box">
            <h3>Información del Presupuesto</h3>
            <p><strong>Fecha:</strong> {{ presupuesto.fecha.strftime('%d/%m/%Y') }}</p>
            <p><strong>Estado:</strong> {{ presupuesto.estado|title }}</p>
            {% if presupuesto.fecha_vigencia %}
            <p><strong>Vigencia:</strong> Hasta {{ presupuesto.fecha_vigencia.strftime('%d/%m/%Y') }}</p>
            {% endif %}
            <p><strong>Moneda:</strong> {{ presupuesto.currency }}</p>
            {% if presupuesto.ubicacion_texto %}
            <p><strong>Ubicación:</strong> {{ presupuesto.ubicacion_texto }}</p>
            {% endif %}
        </div>

        <div class="info-box">
            <h3>Cliente</h3>
            {% if presupuesto.cliente %}
            <p><strong>Nombre:</strong> {{ presupuesto.cliente.nombre_completo }}</p>
            <p><strong>Email:</strong> {{ presupuesto.cliente.email }}</p>
            {% if presupuesto.cliente.telefono %}
            <p><strong>Teléfono:</strong> {{ presupuesto.cliente.telefono }}</p>
            {% endif %}
            {% if presupuesto.cliente.documento_formateado %}
            <p><strong>Documento:</strong> {{ presupuesto.cliente.documento_formateado }}</p>
            {% endif %}
            {% else %}
            <p><em>Sin cliente asignado</em></p>
            {% endif %}
        </div>
    </div>

    {% if presupuesto.fecha_vigencia and not presupuesto.esta_vencido %}
    <div class="vigencia">
        Este presupuesto es válido hasta el {{ presupuesto.fecha_vigencia.strftime('%d/%m/%Y') }}
        ({{ presupuesto.dias_restantes_vigencia }} días restantes)
    </div>
    {% endif %}

    <div class="items-section">
        <h2>Detalle del Presupuesto</h2>

        {% set items = presupuesto.items.order_by('tipo', 'orden').all() %}
        {% if items %}
        <table>
            <thead>
                <tr>
                    <th style="width: 15%;">Tipo</th>
                    <th style="width: 35%;">Descripción</th>
                    <th style="width: 10%;">Cantidad</th>
                    <th style="width: 10%;">Unidad</th>
                    <th style="width: 15%;">Precio Unit.</th>
                    <th style="width: 15%;">Subtotal</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <td>
                        <span class="tipo-badge tipo-{{ item.tipo }}">
                            {% if item.tipo == 'material' %}Material
                            {% elif item.tipo == 'mano_obra' %}Mano de Obra
                            {% elif item.tipo == 'equipo' %}Equipo
                            {% else %}{{ item.tipo|title }}
                            {% endif %}
                        </span>
                    </td>
                    <td>{{ item.descripcion }}</td>
                    <td style="text-align: right;">{{ "%.2f"|format(item.cantidad) }}</td>
                    <td>{{ item.unidad }}</td>
                    <td style="text-align: right;">$ {{ "{:,.2f}".format(item.precio_unitario|float) }}</td>
                    <td style="text-align: right;">$ {{ "{:,.2f}".format(item.total|float) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p><em>No hay items en este presupuesto</em></p>
        {% endif %}
    </div>

    <div class="totals">
        <table>
            <tr>
                <td class="label">Materiales:</td>
                <td class="value">$ {{ "{:,.2f}".format(presupuesto.subtotal_materiales|float) }}</td>
            </tr>
            <tr>
                <td class="label">Mano de Obra:</td>
                <td class="value">$ {{ "{:,.2f}".format(presupuesto.subtotal_mano_obra|float) }}</td>
            </tr>
            <tr>
                <td class="label">Equipos:</td>
                <td class="value">$ {{ "{:,.2f}".format(presupuesto.subtotal_equipos|float) }}</td>
            </tr>
            <tr>
                <td class="label">Subtotal:</td>
                <td class="value">$ {{ "{:,.2f}".format(presupuesto.total_sin_iva|float) }}</td>
            </tr>
            <tr>
                <td class="label">IVA ({{ presupuesto.iva_porcentaje }}%):</td>
                <td class="value">$ {{ "{:,.2f}".format((presupuesto.total_con_iva - presupuesto.total_sin_iva)|float) }}</td>
            </tr>
            <tr class="total-row">
                <td class="label">TOTAL:</td>
                <td class="value">$ {{ "{:,.2f}".format(presupuesto.total_con_iva|float) }}</td>
            </tr>
        </table>
    </div>

    {% if presupuesto.observaciones %}
    <div class="observaciones">
        <h3>Observaciones</h3>
        <p>{{ presupuesto.observaciones }}</p>
    </div>
    {% endif %}

    <div class="footer">
        <p>Este presupuesto fue generado el {{ now.strftime('%d/%m/%Y a las %H:%M') }}</p>
        {% if organizacion.direccion or organizacion.telefono or organizacion.email %}
        <p>
            {% if organizacion.direccion %}{{ organizacion.direccion }} | {% endif %}
            {% if organizacion.telefono %}Tel: {{ organizacion.telefono }} | {% endif %}
            {% if organizacion.email %}Email: {{ organizacion.email }}{% endif %}
        </p>
        {% endif %}
    </div>
</body>
</html>
