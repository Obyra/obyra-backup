<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Presupuesto {{ presupuesto.numero }}</title>
    <style>
        @page {
            size: A4;
            margin: 10mm 15mm 15mm 15mm;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            font-size: 9pt;
            color: #2c2c2c;
            line-height: 1.4;
        }

        /* Header con diseño diagonal */
        .header-wrapper {
            position: relative;
            height: 130px;
            background: linear-gradient(135deg, #ff8c00 0%, #ff8c00 65%, #1a1a1a 65%, #1a1a1a 100%);
            padding: 15px 25px;
            margin: -10mm -15mm 15px -15mm;
            width: calc(100% + 30mm);
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .company-logo {
            font-size: 14pt;
            font-weight: bold;
            color: white;
            margin-bottom: 2px;
        }

        .company-info {
            font-size: 8pt;
            color: rgba(255,255,255,0.9);
            margin-bottom: 8px;
        }

        .company-info span {
            margin-right: 15px;
        }

        .header-title {
            font-size: 22pt;
            font-weight: bold;
            color: white;
            margin-top: 5px;
        }

        /* Estado badge */
        .estado-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #f0f0f0;
            color: #666;
            border-radius: 15px;
            font-size: 8pt;
            font-weight: bold;
            text-transform: uppercase;
            position: absolute;
            top: 15px;
            right: 25px;
        }

        .estado-enviado { background: #e3f2fd; color: #1976d2; }
        .estado-aprobado { background: #e8f5e9; color: #388e3c; }
        .estado-rechazado { background: #ffebee; color: #d32f2f; }

        /* Información del cliente y fecha */
        .info-bar {
            background: #f5f5f5;
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .info-bar table {
            width: 100%;
            border-collapse: collapse;
        }

        .info-bar td {
            padding: 2px 5px;
            font-size: 8pt;
        }

        .info-bar .label {
            font-weight: bold;
            color: #666;
            width: 100px;
        }

        .info-bar .value {
            color: #2c2c2c;
        }

        /* Secciones de servicios */
        .service-section {
            margin-bottom: 12px;
            page-break-inside: avoid;
        }

        .service-header {
            background: #ff8c00;
            color: white;
            padding: 5px 12px;
            font-weight: bold;
            font-size: 9pt;
            margin-bottom: 0;
        }

        /* Tabla de items - compacta */
        table.items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 8px;
        }

        table.items-table thead {
            background: #f8f8f8;
        }

        table.items-table th {
            padding: 5px 8px;
            text-align: left;
            font-size: 7pt;
            font-weight: bold;
            color: #666;
            text-transform: uppercase;
            border-bottom: 2px solid #ff8c00;
        }

        table.items-table th.right {
            text-align: right;
        }

        table.items-table td {
            padding: 5px 8px;
            border-bottom: 1px solid #eee;
            font-size: 8pt;
        }

        table.items-table td.right {
            text-align: right;
        }

        table.items-table tr {
            page-break-inside: avoid;
        }

        /* Observaciones */
        .observaciones {
            margin-top: 12px;
            padding: 8px;
            background: #f8f8f8;
            border-left: 3px solid #ff8c00;
            page-break-inside: avoid;
            font-size: 8pt;
        }

        .observaciones-title {
            font-weight: bold;
            margin-bottom: 4px;
            color: #666;
            font-size: 8pt;
        }

        /* Proyecto info */
        .proyecto-info {
            background: #fff8e1;
            border: 1px solid #ffcc80;
            padding: 6px 10px;
            margin-bottom: 12px;
            border-radius: 4px;
            font-size: 8pt;
        }

        .proyecto-info strong {
            color: #e65100;
        }

        /* ========================================
           FOOTER CON TOTALES - Siempre al final
           ======================================== */
        .footer-section {
            margin-top: 60px;
            page-break-inside: avoid;
        }

        /* Barra de totales */
        .totals-bar {
            background: #f5f5f5;
            padding: 10px 15px;
            border-top: 2px solid #ff8c00;
            margin-bottom: 0;
        }

        .totals-bar table {
            width: 100%;
            border-collapse: collapse;
        }

        .totals-bar td {
            padding: 3px 10px;
            font-size: 9pt;
        }

        .totals-bar .label-col {
            text-align: right;
            color: #666;
            width: 70%;
        }

        .totals-bar .value-col {
            text-align: right;
            font-weight: bold;
            width: 30%;
        }

        /* Total final destacado */
        .total-final-bar {
            background: #1a1a1a;
            padding: 12px 15px;
        }

        .total-final-bar table {
            width: 100%;
            border-collapse: collapse;
        }

        .total-final-bar td {
            padding: 0;
        }

        .total-final-bar .label-col {
            text-align: right;
            color: white;
            font-size: 14pt;
            font-weight: bold;
            width: 70%;
            padding-right: 15px;
        }

        .total-final-bar .value-col {
            text-align: right;
            color: #ff8c00;
            font-size: 18pt;
            font-weight: bold;
            width: 30%;
        }

        /* Datos de la empresa en el footer */
        .empresa-footer {
            background: #2c2c2c;
            color: white;
            padding: 12px 20px;
            font-size: 7pt;
        }

        .empresa-footer table {
            width: 100%;
            border-collapse: collapse;
        }

        .empresa-footer td {
            vertical-align: top;
            padding: 0 10px;
        }

        .empresa-footer .footer-title {
            font-weight: bold;
            margin-bottom: 3px;
            font-size: 8pt;
            color: #ff8c00;
        }

        .empresa-footer .footer-center {
            text-align: center;
        }

        .empresa-footer .footer-right {
            text-align: right;
        }
    </style>
</head>
<body>
    <!-- Header con datos de la empresa -->
    <div class="header-wrapper">
        <div class="header-content">
            <div class="company-logo">
                <svg width="22" height="22" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 5px;">
                    <circle cx="12" cy="12" r="12" fill="white"/>
                    <text x="12" y="16" font-size="12" font-weight="bold" text-anchor="middle" fill="#ff8c00">{{ organizacion.nombre[0] if organizacion.nombre else 'O' }}</text>
                </svg>
                {{ organizacion.nombre }}
            </div>
            <div class="company-info">
                {% if organizacion.cuit %}<span>CUIT: {{ organizacion.cuit }}</span>{% endif %}
                {% if organizacion.direccion %}<span>{{ organizacion.direccion }}</span>{% endif %}
                {% if organizacion.telefono %}<span>Tel: {{ organizacion.telefono }}</span>{% endif %}
                {% if organizacion.email %}<span>{{ organizacion.email }}</span>{% endif %}
            </div>
            <div class="header-title">Presupuesto</div>
        </div>
        <span class="estado-badge estado-{{ presupuesto.estado }}">{{ presupuesto.estado|title }}</span>
    </div>

    <!-- Barra de información del cliente -->
    <div class="info-bar">
        <table>
            <tr>
                <td class="label">Cliente:</td>
                <td class="value">{{ presupuesto.cliente.nombre_completo if presupuesto.cliente else 'Sin cliente asignado' }}</td>
                <td class="label">Nº Presupuesto:</td>
                <td class="value"><strong>{{ presupuesto.numero }}</strong></td>
            </tr>
            <tr>
                <td class="label">Fecha:</td>
                <td class="value">{{ presupuesto.fecha.strftime('%d/%m/%Y') }}</td>
                <td class="label">Vigencia:</td>
                <td class="value">{{ presupuesto.fecha_vigencia.strftime('%d/%m/%Y') if presupuesto.fecha_vigencia else 'Sin límite' }}</td>
            </tr>
            {% if presupuesto.nombre %}
            <tr>
                <td class="label">Proyecto:</td>
                <td class="value" colspan="3"><strong>{{ presupuesto.nombre }}</strong></td>
            </tr>
            {% endif %}
        </table>
    </div>

    {% if presupuesto.tipo_construccion or presupuesto.superficie_m2 %}
    <div class="proyecto-info">
        {% if presupuesto.tipo_construccion %}<strong>Tipo:</strong> {{ presupuesto.tipo_construccion }} | {% endif %}
        {% if presupuesto.superficie_m2 %}<strong>Superficie:</strong> {{ presupuesto.superficie_m2 }} m² | {% endif %}
        <strong>Moneda:</strong> {{ presupuesto.currency or 'ARS' }}
    </div>
    {% endif %}

    <!-- Contenido principal -->
    {% if items %}
    <!-- Agrupar items por tipo -->
    {% set materiales = items|selectattr('tipo', 'equalto', 'material')|list %}
    {% set mano_obra = items|selectattr('tipo', 'equalto', 'mano_obra')|list %}
    {% set equipos = items|selectattr('tipo', 'equalto', 'equipo')|list %}
    {% set otros = items|rejectattr('tipo', 'in', ['material', 'mano_obra', 'equipo'])|list %}

    {% if materiales %}
    <div class="service-section">
        <div class="service-header">Materiales ({{ materiales|length }} items)</div>
        <table class="items-table">
            <thead>
                <tr>
                    <th style="width: 50%;">Descripción</th>
                    <th class="right" style="width: 12%;">Cantidad</th>
                    <th style="width: 10%;">Unidad</th>
                    <th class="right" style="width: 14%;">P. Unit.</th>
                    <th class="right" style="width: 14%;">Subtotal</th>
                </tr>
            </thead>
            <tbody>
                {% for item in materiales %}
                <tr>
                    <td>{{ item.descripcion }}</td>
                    <td class="right">{{ "%.2f"|format(item.cantidad) }}</td>
                    <td>{{ item.unidad }}</td>
                    <td class="right">{{ "{:,.2f}".format(item.precio_unitario|float) if item.precio_unitario else '-' }}</td>
                    <td class="right"><strong>{{ "{:,.2f}".format(item.total|float) }}</strong></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if mano_obra %}
    <div class="service-section">
        <div class="service-header">Mano de Obra ({{ mano_obra|length }} items)</div>
        <table class="items-table">
            <thead>
                <tr>
                    <th style="width: 50%;">Descripción</th>
                    <th class="right" style="width: 12%;">Jornales</th>
                    <th style="width: 10%;">Unidad</th>
                    <th class="right" style="width: 14%;">P. Unit.</th>
                    <th class="right" style="width: 14%;">Subtotal</th>
                </tr>
            </thead>
            <tbody>
                {% for item in mano_obra %}
                <tr>
                    <td>{{ item.descripcion }}</td>
                    <td class="right">{{ "%.1f"|format(item.cantidad) }}</td>
                    <td>{{ item.unidad }}</td>
                    <td class="right">{{ "{:,.2f}".format(item.precio_unitario|float) if item.precio_unitario else '-' }}</td>
                    <td class="right"><strong>{{ "{:,.2f}".format(item.total|float) }}</strong></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if equipos %}
    <div class="service-section">
        <div class="service-header">Equipos y Maquinaria ({{ equipos|length }} items)</div>
        <table class="items-table">
            <thead>
                <tr>
                    <th style="width: 50%;">Descripción</th>
                    <th class="right" style="width: 12%;">Cantidad</th>
                    <th style="width: 10%;">Unidad</th>
                    <th class="right" style="width: 14%;">P. Unit.</th>
                    <th class="right" style="width: 14%;">Subtotal</th>
                </tr>
            </thead>
            <tbody>
                {% for item in equipos %}
                <tr>
                    <td>{{ item.descripcion }}</td>
                    <td class="right">{{ "%.2f"|format(item.cantidad) }}</td>
                    <td>{{ item.unidad }}</td>
                    <td class="right">{{ "{:,.2f}".format(item.precio_unitario|float) if item.precio_unitario else '-' }}</td>
                    <td class="right"><strong>{{ "{:,.2f}".format(item.total|float) }}</strong></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if otros %}
    <div class="service-section">
        <div class="service-header">Otros ({{ otros|length }} items)</div>
        <table class="items-table">
            <thead>
                <tr>
                    <th style="width: 50%;">Descripción</th>
                    <th class="right" style="width: 12%;">Cantidad</th>
                    <th style="width: 10%;">Unidad</th>
                    <th class="right" style="width: 14%;">P. Unit.</th>
                    <th class="right" style="width: 14%;">Subtotal</th>
                </tr>
            </thead>
            <tbody>
                {% for item in otros %}
                <tr>
                    <td>{{ item.descripcion }}</td>
                    <td class="right">{{ "%.2f"|format(item.cantidad) }}</td>
                    <td>{{ item.unidad or '-' }}</td>
                    <td class="right">{{ "{:,.2f}".format(item.precio_unitario|float) if item.precio_unitario else '-' }}</td>
                    <td class="right"><strong>{{ "{:,.2f}".format(item.total|float) }}</strong></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if presupuesto.observaciones %}
    <div class="observaciones">
        <div class="observaciones-title">Observaciones:</div>
        <div>{{ presupuesto.observaciones }}</div>
    </div>
    {% endif %}

    {% else %}
    <p style="text-align: center; color: #999; padding: 40px 0;">No hay items en este presupuesto</p>
    {% endif %}

    <!-- FOOTER: Datos empresa + Totales (siempre al final) -->
    <div class="footer-section">
        <!-- Subtotales -->
        <div class="totals-bar">
            <table>
                <tr>
                    <td class="label-col">Subtotal:</td>
                    <td class="value-col">{{ presupuesto.currency }} {{ "{:,.2f}".format(presupuesto.total_sin_iva|float) }}</td>
                </tr>
                {% if presupuesto.iva_porcentaje and presupuesto.iva_porcentaje > 0 %}
                <tr>
                    <td class="label-col">IVA ({{ "%.2f"|format(presupuesto.iva_porcentaje) }}%):</td>
                    <td class="value-col">{{ presupuesto.currency }} {{ "{:,.2f}".format((presupuesto.total_con_iva - presupuesto.total_sin_iva)|float) }}</td>
                </tr>
                {% endif %}
            </table>
        </div>

        <!-- Datos de la empresa -->
        <div class="empresa-footer">
            <table>
                <tr>
                    <td style="width: 33%;">
                        <div class="footer-title">{{ organizacion.nombre }}</div>
                        {% if organizacion.cuit %}
                        <div>CUIT: {{ organizacion.cuit }}</div>
                        {% endif %}
                        <div>{{ organizacion.direccion or 'Dirección no especificada' }}</div>
                    </td>
                    <td class="footer-center" style="width: 34%;">
                        <div class="footer-title">Contacto</div>
                        <div>Tel: {{ organizacion.telefono or '-' }}</div>
                        <div>Email: {{ organizacion.email or '-' }}</div>
                    </td>
                    <td class="footer-right" style="width: 33%;">
                        <div class="footer-title">Medios de pago</div>
                        <div>Transferencia bancaria</div>
                        <div>Efectivo</div>
                    </td>
                </tr>
            </table>
        </div>

        <!-- Total final destacado (AL FINAL DE TODO) -->
        <div class="total-final-bar">
            <table>
                <tr>
                    <td class="label-col">TOTAL</td>
                    <td class="value-col">{{ presupuesto.currency }} {{ "{:,.2f}".format(presupuesto.total_con_iva|float) }}</td>
                </tr>
            </table>
        </div>
    </div>
</body>
</html>
