<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Presupuesto {{ presupuesto.numero }}</title>
    <style>
        @page {
            size: A4;
            margin: 8mm 12mm 10mm 12mm;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            font-size: 8pt;
            color: #2c2c2c;
            line-height: 1.3;
        }

        /* Header compacto */
        .header-wrapper {
            background: #1A374D;
            padding: 10px 18px;
            margin: -8mm -12mm 8px -12mm;
            width: calc(100% + 24mm);
            display: table;
            table-layout: fixed;
        }

        .header-left {
            display: table-cell;
            vertical-align: middle;
            width: 65%;
        }

        .header-right {
            display: table-cell;
            vertical-align: middle;
            text-align: right;
            width: 35%;
        }

        .company-name {
            font-size: 13pt;
            font-weight: bold;
            color: white;
            margin-bottom: 2px;
        }

        .company-logo-img {
            max-height: 50px;
            max-width: 140px;
            margin-right: 10px;
            vertical-align: middle;
        }

        .company-info {
            font-size: 7pt;
            color: rgba(255,255,255,0.85);
        }

        .company-info span {
            margin-right: 10px;
        }

        .header-presupuesto {
            font-size: 11pt;
            font-weight: bold;
            color: white;
        }

        .header-numero {
            font-size: 16pt;
            font-weight: bold;
            color: #4CAF50;
        }

        /* Barra info cliente */
        .info-bar {
            background: #f5f5f5;
            padding: 6px 10px;
            margin-bottom: 8px;
            border-radius: 3px;
        }

        .info-bar table {
            width: 100%;
            border-collapse: collapse;
        }

        .info-bar td {
            padding: 1px 4px;
            font-size: 7.5pt;
        }

        .info-bar .label {
            font-weight: bold;
            color: #666;
            width: 90px;
        }

        .info-bar .value {
            color: #2c2c2c;
        }

        /* Info proyecto */
        .proyecto-info {
            background: #fff8e1;
            border: 1px solid #ffcc80;
            padding: 4px 8px;
            margin-bottom: 8px;
            border-radius: 3px;
            font-size: 7.5pt;
        }

        .proyecto-info strong {
            color: #e65100;
        }

        /* Tabla de etapas */
        .service-header {
            background: #1A374D;
            color: white;
            padding: 4px 10px;
            font-weight: bold;
            font-size: 8pt;
            margin-bottom: 0;
        }

        table.items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 6px;
        }

        table.items-table thead {
            background: #f0f0f0;
        }

        table.items-table th {
            padding: 4px 8px;
            text-align: left;
            font-size: 7pt;
            font-weight: bold;
            color: #555;
            text-transform: uppercase;
            border-bottom: 2px solid #4CAF50;
        }

        table.items-table th.right {
            text-align: right;
        }

        table.items-table td {
            padding: 4px 8px;
            border-bottom: 1px solid #eee;
            font-size: 8pt;
        }

        table.items-table td.right {
            text-align: right;
        }

        table.items-table tr {
            page-break-inside: avoid;
        }

        table.items-table tr.etapa-row:nth-child(even) {
            background: #fafafa;
        }

        .etapa-numero {
            color: #999;
            font-size: 7pt;
        }

        /* Observaciones */
        .observaciones {
            margin-top: 6px;
            padding: 5px 8px;
            background: #f8f8f8;
            border-left: 3px solid #1A374D;
            page-break-inside: avoid;
            font-size: 7.5pt;
        }

        .observaciones-title {
            font-weight: bold;
            margin-bottom: 2px;
            color: #666;
            font-size: 7.5pt;
        }

        /* Footer con totales */
        .footer-section {
            margin-top: 12px;
            page-break-inside: avoid;
        }

        .totals-bar {
            background: #f5f5f5;
            padding: 6px 10px;
            border-top: 2px solid #4CAF50;
        }

        .totals-bar table {
            width: 100%;
            border-collapse: collapse;
        }

        .totals-bar td {
            padding: 2px 8px;
            font-size: 8pt;
        }

        .totals-bar .label-col {
            text-align: right;
            color: #666;
            width: 40%;
        }

        .totals-bar .value-col {
            text-align: right;
            font-weight: bold;
            width: 30%;
        }

        /* Total final */
        .total-final-bar {
            background: #1A374D;
            padding: 8px 10px;
        }

        .total-final-bar table {
            width: 100%;
            border-collapse: collapse;
        }

        .total-final-bar td {
            padding: 2px 8px;
        }

        .total-final-bar .label-col {
            text-align: right;
            color: white;
            font-size: 10pt;
            font-weight: bold;
            width: 40%;
        }

        .total-final-bar .value-col {
            text-align: right;
            font-weight: bold;
            width: 30%;
            font-size: 12pt;
        }

        .total-final-bar .value-ars {
            color: #90CAF9;
        }

        .total-final-bar .value-usd {
            color: #4CAF50;
        }

        /* Footer empresa */
        .empresa-footer {
            background: #1A374D;
            color: white;
            padding: 8px 15px;
            font-size: 7pt;
            border-top: 1px solid #2d5a7b;
        }

        .empresa-footer table {
            width: 100%;
            border-collapse: collapse;
        }

        .empresa-footer td {
            vertical-align: top;
            padding: 0 8px;
        }

        .empresa-footer .footer-title {
            font-weight: bold;
            margin-bottom: 2px;
            font-size: 7.5pt;
            color: #4CAF50;
        }

        .empresa-footer .footer-center {
            text-align: center;
        }

        .empresa-footer .footer-right {
            text-align: right;
        }

        .paridad-footer {
            background: #0f2940;
            color: #aaa;
            padding: 4px 10px;
            font-size: 6.5pt;
            text-align: center;
            border-top: 1px solid #333;
        }

        .paridad-footer strong {
            color: #4caf50;
        }
    </style>
</head>
<body>
    {% set nombre_org = organizacion.nombre|replace('Organizacion de ', '')|replace('Organizacion de ', '') if organizacion.nombre else 'Empresa' %}

    <!-- Header compacto -->
    <div class="header-wrapper">
        <div class="header-left">
            <div class="company-name">
                {% if logo_base64 %}
                <img src="data:image/png;base64,{{ logo_base64 }}" class="company-logo-img" alt="Logo">
                {% else %}
                <svg width="20" height="20" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 4px;">
                    <circle cx="12" cy="12" r="12" fill="white"/>
                    <text x="12" y="16" font-size="12" font-weight="bold" text-anchor="middle" fill="#1A374D">{{ nombre_org[0] }}</text>
                </svg>
                {% endif %}
                {{ nombre_org }}
            </div>
            <div class="company-info">
                {% if organizacion.cuit %}<span>CUIT: {{ organizacion.cuit }}</span>{% endif %}
                {% if organizacion.direccion %}<span>{{ organizacion.direccion }}</span>{% endif %}
                {% if organizacion.telefono %}<span>Tel: {{ organizacion.telefono }}</span>{% endif %}
                {% if organizacion.email %}<span>{{ organizacion.email }}</span>{% endif %}
            </div>
        </div>
        <div class="header-right">
            <div class="header-presupuesto">PRESUPUESTO</div>
            <div class="header-numero">N. {{ presupuesto.numero }}</div>
        </div>
    </div>

    <!-- Info del cliente -->
    <div class="info-bar">
        <table>
            <tr>
                <td class="label">Cliente:</td>
                <td class="value">{{ presupuesto.cliente.nombre_completo if presupuesto.cliente else 'Sin cliente asignado' }}</td>
                <td class="label">Fecha:</td>
                <td class="value">{{ presupuesto.fecha.strftime('%d/%m/%Y') }}</td>
                <td class="label">Vigencia:</td>
                <td class="value">{{ presupuesto.fecha_vigencia.strftime('%d/%m/%Y') if presupuesto.fecha_vigencia else 'Sin limite' }}</td>
            </tr>
            {% if nombre_proyecto %}
            <tr>
                <td class="label">Proyecto:</td>
                <td class="value" colspan="5"><strong>{{ nombre_proyecto }}</strong></td>
            </tr>
            {% endif %}
        </table>
    </div>

    {% if tipo_construccion or superficie_m2 %}
    <div class="proyecto-info">
        {% if tipo_construccion %}<strong>Tipo:</strong> {{ tipo_construccion }} | {% endif %}
        {% if superficie_m2 %}<strong>Superficie:</strong> {{ superficie_m2 }} m2{% endif %}
    </div>
    {% endif %}

    <!-- Tabla principal con ambas monedas -->
    {% if etapas_totales %}
    <div class="service-section">
        <div class="service-header">Detalle por Etapas</div>
        <table class="items-table">
            <thead>
                <tr>
                    <th style="width: 6%;">N.</th>
                    <th style="width: 48%;">Etapa</th>
                    <th class="right" style="width: 23%;">Total ARS</th>
                    <th class="right" style="width: 23%;">Total USD</th>
                </tr>
            </thead>
            <tbody>
                {% for etapa_nombre, total_etapa in etapas_totales.items() %}
                <tr class="etapa-row">
                    <td><span class="etapa-numero">{{ loop.index }}</span></td>
                    <td><strong>{{ etapa_nombre }}</strong></td>
                    {% if moneda_principal == 'ARS' %}
                    <td class="right"><strong>$ {{ "{:,.2f}".format(total_etapa|float) }}</strong></td>
                    <td class="right" style="color: #2e7d32;">U$D {{ "{:,.2f}".format((total_etapa|float) * factor_conversion) }}</td>
                    {% else %}
                    <td class="right">$ {{ "{:,.2f}".format((total_etapa|float) * factor_conversion) }}</td>
                    <td class="right" style="color: #2e7d32;"><strong>U$D {{ "{:,.2f}".format(total_etapa|float) }}</strong></td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% elif items %}
    {# Fallback: items agrupados por tipo #}
    {% set materiales = items|selectattr('tipo', 'equalto', 'material')|list %}
    {% set mano_obra = items|selectattr('tipo', 'equalto', 'mano_obra')|list %}
    {% set equipos = items|selectattr('tipo', 'equalto', 'equipo')|list %}

    {% for grupo_nombre, grupo_items in [('Materiales', materiales), ('Mano de Obra', mano_obra), ('Equipos y Maquinaria', equipos)] %}
    {% if grupo_items %}
    <div class="service-section">
        <div class="service-header">{{ grupo_nombre }}</div>
        <table class="items-table">
            <thead>
                <tr>
                    <th style="width: 54%;">Descripcion</th>
                    <th class="right" style="width: 23%;">Total ARS</th>
                    <th class="right" style="width: 23%;">Total USD</th>
                </tr>
            </thead>
            <tbody>
                {% for item in grupo_items %}
                <tr>
                    <td>{{ item.descripcion }}</td>
                    {% if moneda_principal == 'ARS' %}
                    <td class="right"><strong>$ {{ "{:,.2f}".format(item.total|float) }}</strong></td>
                    <td class="right" style="color: #2e7d32;">U$D {{ "{:,.2f}".format((item.total|float) * factor_conversion) }}</td>
                    {% else %}
                    <td class="right">$ {{ "{:,.2f}".format((item.total|float) * factor_conversion) }}</td>
                    <td class="right" style="color: #2e7d32;"><strong>U$D {{ "{:,.2f}".format(item.total|float) }}</strong></td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    {% endfor %}
    {% else %}
    <p style="text-align: center; color: #999; padding: 20px 0;">No hay items en este presupuesto</p>
    {% endif %}

    {% if presupuesto.observaciones %}
    <div class="observaciones">
        <div class="observaciones-title">Observaciones:</div>
        <div>{{ presupuesto.observaciones }}</div>
    </div>
    {% endif %}

    <!-- FOOTER: Totales en ambas monedas -->
    <div class="footer-section">
        <div class="totals-bar">
            <table>
                <tr>
                    <td class="label-col">Subtotal:</td>
                    {% if moneda_principal == 'ARS' %}
                    <td class="value-col">$ {{ "{:,.2f}".format(presupuesto.total_sin_iva|float) }}</td>
                    <td class="value-col" style="color: #2e7d32;">U$D {{ "{:,.2f}".format((presupuesto.total_sin_iva|float) * factor_conversion) }}</td>
                    {% else %}
                    <td class="value-col">$ {{ "{:,.2f}".format((presupuesto.total_sin_iva|float) * factor_conversion) }}</td>
                    <td class="value-col" style="color: #2e7d32;">U$D {{ "{:,.2f}".format(presupuesto.total_sin_iva|float) }}</td>
                    {% endif %}
                </tr>
                {% if presupuesto.iva_porcentaje and presupuesto.iva_porcentaje > 0 %}
                <tr>
                    <td class="label-col">IVA ({{ "%.2f"|format(presupuesto.iva_porcentaje) }}%):</td>
                    {% set iva_monto = (presupuesto.total_con_iva - presupuesto.total_sin_iva)|float %}
                    {% if moneda_principal == 'ARS' %}
                    <td class="value-col">$ {{ "{:,.2f}".format(iva_monto) }}</td>
                    <td class="value-col" style="color: #2e7d32;">U$D {{ "{:,.2f}".format(iva_monto * factor_conversion) }}</td>
                    {% else %}
                    <td class="value-col">$ {{ "{:,.2f}".format(iva_monto * factor_conversion) }}</td>
                    <td class="value-col" style="color: #2e7d32;">U$D {{ "{:,.2f}".format(iva_monto) }}</td>
                    {% endif %}
                </tr>
                {% endif %}
            </table>
        </div>

        <div class="total-final-bar">
            <table>
                <tr>
                    <td class="label-col">TOTAL</td>
                    {% if moneda_principal == 'ARS' %}
                    <td class="value-col value-ars">$ {{ "{:,.2f}".format(presupuesto.total_con_iva|float) }}</td>
                    <td class="value-col value-usd">U$D {{ "{:,.2f}".format((presupuesto.total_con_iva|float) * factor_conversion) }}</td>
                    {% else %}
                    <td class="value-col value-ars">$ {{ "{:,.2f}".format((presupuesto.total_con_iva|float) * factor_conversion) }}</td>
                    <td class="value-col value-usd">U$D {{ "{:,.2f}".format(presupuesto.total_con_iva|float) }}</td>
                    {% endif %}
                </tr>
            </table>
        </div>

        <div class="empresa-footer">
            <table>
                <tr>
                    <td style="width: 33%;">
                        <div class="footer-title">{{ nombre_org }}</div>
                        {% if organizacion.cuit %}
                        <div>CUIT: {{ organizacion.cuit }}</div>
                        {% endif %}
                        <div>{{ organizacion.direccion or '' }}</div>
                    </td>
                    <td class="footer-center" style="width: 34%;">
                        <div class="footer-title">Contacto</div>
                        <div>Tel: {{ organizacion.telefono or '-' }}</div>
                        <div>Email: {{ organizacion.email or '-' }}</div>
                    </td>
                    <td class="footer-right" style="width: 33%;">
                        <div class="footer-title">Medios de pago</div>
                        <div>Transferencia bancaria</div>
                        <div>Efectivo</div>
                    </td>
                </tr>
            </table>
        </div>

        <div class="paridad-footer">
            <strong>Paridad Banco Nacion (vendedor):</strong> 1 USD = {{ "{:,.2f}".format(cotizacion_dolar) }} ARS | Fecha: {{ fecha_cotizacion }}
        </div>
    </div>
</body>
</html>
