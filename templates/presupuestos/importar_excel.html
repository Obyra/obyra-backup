{% extends "base.html" %}

{% block title %}Importar Presupuesto desde Excel - OBYRA{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-file-excel text-success me-2"></i>Importar Presupuesto desde Excel</h2>
                    <p class="text-muted mb-0">Importa items desde un archivo Excel de constructora (.xlsx)</p>
                </div>
                <div class="btn-group" role="group">
                    <a href="{{ url_for('presupuestos.lista') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Volver
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Columna izquierda: Formulario -->
        <div class="col-lg-4">
            <!-- Datos del presupuesto -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Datos del Presupuesto</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="numero" class="form-label fw-bold">Numero *</label>
                        <input type="text" class="form-control" id="numero" value="{{ numero_sugerido }}" required>
                    </div>

                    <div class="mb-3">
                        <label for="nombre_obra" class="form-label fw-bold">Nombre del Proyecto</label>
                        <input type="text" class="form-control" id="nombre_obra"
                               placeholder="Ej: Cabildo Boulevard">
                    </div>

                    <div class="mb-3">
                        <label for="cliente_id" class="form-label fw-bold">Cliente</label>
                        <select class="form-select" id="cliente_id">
                            <option value="">Sin cliente asignado</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id }}">
                                {{ cliente.nombre_completo }}{% if cliente.email %} - {{ cliente.email }}{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="vigencia_dias" class="form-label fw-bold">Vigencia (dias)</label>
                        <input type="number" class="form-control" id="vigencia_dias" value="30" min="1" max="180">
                    </div>
                </div>
            </div>

            <!-- Upload Excel -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-upload me-2"></i>Archivo Excel</h6>
                </div>
                <div class="card-body">
                    <div id="dropZone" class="border border-2 border-dashed rounded p-4 text-center"
                         style="cursor: pointer; border-color: #dee2e6 !important;">
                        <i class="fas fa-file-excel fa-3x text-success mb-3 d-block"></i>
                        <p class="mb-1 fw-bold">Arrastra un archivo .xlsx aqui</p>
                        <p class="text-muted small mb-2">o hace clic para seleccionar</p>
                        <input type="file" id="fileInput" accept=".xlsx" class="d-none">
                        <div id="fileName" class="text-success fw-bold d-none mt-2">
                            <i class="fas fa-check-circle me-1"></i><span></span>
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary w-100 mt-3" id="btnPreview" disabled>
                        <i class="fas fa-search me-1"></i>Analizar Archivo
                    </button>
                </div>
            </div>

            <!-- Vendor selector (multi-vendor only) -->
            <div class="card shadow-sm mb-4 d-none" id="cardVendorSelector">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-building me-2"></i>Seleccionar Constructora</h6>
                </div>
                <div class="card-body">
                    <p class="text-muted small">Se detectaron multiples constructoras en el archivo:</p>
                    <div id="vendorList"></div>
                </div>
            </div>

            <!-- Resumen -->
            <div class="card shadow-sm d-none" id="cardResumen">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>Resumen</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Materiales:</span>
                        <strong id="totalMateriales">$0.00</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Mano de Obra:</span>
                        <strong id="totalManoObra">$0.00</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Equipos:</span>
                        <strong id="totalEquipos">$0.00</strong>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="fw-bold">Subtotal:</span>
                        <strong id="subtotalGeneral">$0.00</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>IVA (21%):</span>
                        <strong id="ivaTotal">$0.00</strong>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold fs-5">TOTAL:</span>
                        <strong class="text-success fs-5" id="totalGeneral">$0.00</strong>
                    </div>

                    <div class="mt-2 text-muted small">
                        <span id="itemCount">0</span> items en <span id="etapaCount">0</span> etapas
                    </div>
                </div>
                <div class="card-footer">
                    <button type="button" class="btn btn-success w-100" id="btnConfirmar" disabled>
                        <i class="fas fa-save me-1"></i>Importar Presupuesto
                    </button>
                </div>
            </div>
        </div>

        <!-- Columna derecha: Preview -->
        <div class="col-lg-8">
            <!-- Estado inicial -->
            <div class="card shadow-sm" id="cardEmptyState">
                <div class="card-body text-center py-5">
                    <i class="fas fa-file-excel fa-4x text-muted mb-3"></i>
                    <h5 class="text-muted">Subi un archivo Excel para ver la preview</h5>
                    <p class="text-muted">Se aceptan archivos .xlsx de presupuestos de constructoras</p>
                </div>
            </div>

            <!-- Loading -->
            <div class="card shadow-sm d-none" id="cardLoading">
                <div class="card-body text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Analizando...</span>
                    </div>
                    <h5 class="text-muted">Analizando archivo Excel...</h5>
                    <p class="text-muted">Detectando rubros, items y precios</p>
                </div>
            </div>

            <!-- Preview table -->
            <div class="card shadow-sm d-none" id="cardPreview">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-table me-2"></i>Preview - <span id="vendorName"></span></h6>
                    <div>
                        <span class="badge bg-success" id="badgeItems">0 items</span>
                        <span class="badge bg-secondary" id="badgeSkipped">0 omitidos</span>
                    </div>
                </div>
                <div class="card-body p-0" style="max-height: 75vh; overflow-y: auto;">
                    <div id="previewContent"></div>
                </div>
            </div>

            <!-- Warnings -->
            <div class="d-none mt-3" id="cardWarnings">
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Advertencias</h6>
                    <ul id="warningsList" class="mb-0 small"></ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ========== STATE ==========
let previewData = null;
let selectedVendor = null;
let selectedFile = null;

// ========== DOM ELEMENTS ==========
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const fileNameEl = document.getElementById('fileName');
const btnPreview = document.getElementById('btnPreview');
const btnConfirmar = document.getElementById('btnConfirmar');

const cardEmptyState = document.getElementById('cardEmptyState');
const cardLoading = document.getElementById('cardLoading');
const cardPreview = document.getElementById('cardPreview');
const cardWarnings = document.getElementById('cardWarnings');
const cardVendorSelector = document.getElementById('cardVendorSelector');
const cardResumen = document.getElementById('cardResumen');

// ========== FILE UPLOAD ==========
dropZone.addEventListener('click', () => fileInput.click());

dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = '#198754';
    dropZone.style.backgroundColor = '#f0fff4';
});

dropZone.addEventListener('dragleave', () => {
    dropZone.style.borderColor = '#dee2e6';
    dropZone.style.backgroundColor = '';
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = '#dee2e6';
    dropZone.style.backgroundColor = '';
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
});

fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
        handleFile(fileInput.files[0]);
    }
});

function handleFile(file) {
    if (!file.name.toLowerCase().endsWith('.xlsx')) {
        showAlert('Solo se aceptan archivos .xlsx', 'danger');
        return;
    }
    selectedFile = file;
    fileNameEl.querySelector('span').textContent = file.name;
    fileNameEl.classList.remove('d-none');
    btnPreview.disabled = false;

    // Reset preview
    previewData = null;
    selectedVendor = null;
    cardPreview.classList.add('d-none');
    cardResumen.classList.add('d-none');
    cardVendorSelector.classList.add('d-none');
    cardWarnings.classList.add('d-none');
    cardEmptyState.classList.remove('d-none');
    btnConfirmar.disabled = true;
}

// ========== PREVIEW ==========
btnPreview.addEventListener('click', async () => {
    if (!selectedFile) return;

    // Show loading
    cardEmptyState.classList.add('d-none');
    cardLoading.classList.remove('d-none');
    cardPreview.classList.add('d-none');
    cardWarnings.classList.add('d-none');
    btnPreview.disabled = true;
    btnPreview.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Analizando...';

    try {
        const formData = new FormData();
        formData.append('file', selectedFile);

        const response = await fetch('{{ url_for("presupuestos.importar_excel_preview") }}', {
            method: 'POST',
            body: formData,
        });

        const data = await response.json();

        if (!response.ok || !data.ok) {
            throw new Error(data.error || 'Error al analizar el archivo');
        }

        previewData = data;
        cardLoading.classList.add('d-none');

        // Handle multi-vendor
        if (data.file_type === 'multi_vendor' && data.vendors.length > 1) {
            showVendorSelector(data.vendors);
        } else {
            // Single vendor - show directly
            const vendorName = data.vendors[0]?.nombre || 'Constructora';
            selectedVendor = vendorName;
            renderPreview(vendorName);
        }

        // Show warnings
        if (data.warnings && data.warnings.length > 0) {
            const warningsList = document.getElementById('warningsList');
            warningsList.innerHTML = '';
            data.warnings.forEach(w => {
                const li = document.createElement('li');
                li.textContent = w;
                warningsList.appendChild(li);
            });
            cardWarnings.classList.remove('d-none');
        }

    } catch (error) {
        cardLoading.classList.add('d-none');
        cardEmptyState.classList.remove('d-none');
        showAlert(error.message || 'Error al procesar el archivo', 'danger');
    } finally {
        btnPreview.disabled = false;
        btnPreview.innerHTML = '<i class="fas fa-search me-1"></i>Analizar Archivo';
    }
});

// ========== VENDOR SELECTOR ==========
function showVendorSelector(vendors) {
    const vendorList = document.getElementById('vendorList');
    vendorList.innerHTML = '';

    vendors.forEach((v, idx) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-outline-primary w-100 mb-2 text-start';
        btn.innerHTML = `<i class="fas fa-building me-2"></i>${v.nombre}`;
        btn.addEventListener('click', () => {
            // Highlight selected
            vendorList.querySelectorAll('button').forEach(b => {
                b.classList.remove('btn-primary');
                b.classList.add('btn-outline-primary');
            });
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-primary');

            selectedVendor = v.nombre;
            renderPreview(v.nombre);
        });
        vendorList.appendChild(btn);
    });

    cardVendorSelector.classList.remove('d-none');
}

// ========== RENDER PREVIEW ==========
function renderPreview(vendorName) {
    if (!previewData || !previewData.items_by_vendor[vendorName]) return;

    const vendorData = previewData.items_by_vendor[vendorName];
    const etapas = vendorData.etapas || [];

    document.getElementById('vendorName').textContent = vendorName;
    document.getElementById('badgeItems').textContent = `${vendorData.total_items} items`;
    document.getElementById('badgeSkipped').textContent = `${vendorData.skipped} omitidos`;

    const container = document.getElementById('previewContent');
    container.innerHTML = '';

    let totalMat = 0, totalMO = 0, totalEq = 0;
    let itemCount = 0;

    etapas.forEach((etapa, eIdx) => {
        // Etapa header
        const headerDiv = document.createElement('div');
        headerDiv.className = 'bg-light border-bottom px-3 py-2 d-flex justify-content-between align-items-center';
        headerDiv.innerHTML = `
            <strong><i class="fas fa-layer-group text-primary me-2"></i>${etapa.nombre}</strong>
            <span class="badge bg-primary">${etapa.items.length} items - $${formatNumber(etapa.subtotal)}</span>
        `;
        container.appendChild(headerDiv);

        // Items table
        const table = document.createElement('table');
        table.className = 'table table-sm table-hover mb-0';
        table.innerHTML = `
            <thead class="table-light">
                <tr>
                    <th style="width: 35%;">Descripcion</th>
                    <th class="text-center" style="width: 60px;">Unid.</th>
                    <th class="text-center" style="width: 70px;">Cant.</th>
                    <th class="text-end" style="width: 100px;">P. Unit.</th>
                    <th class="text-end" style="width: 100px;">Total</th>
                    <th class="text-center" style="width: 80px;">Tipo</th>
                    <th class="text-center" style="width: 40px;">Inv.</th>
                </tr>
            </thead>
        `;
        const tbody = document.createElement('tbody');

        etapa.items.forEach(item => {
            if (item.valor_especial) return; // Skip special items

            const tipo = item.tipo || 'material';
            const tipoBadge = tipo === 'mano_obra' ? 'bg-warning text-dark' :
                              tipo === 'equipo' ? 'bg-info' : 'bg-secondary';
            const tipoLabel = tipo === 'mano_obra' ? 'M.O.' :
                              tipo === 'equipo' ? 'Equipo' : 'Mat.';

            const invMatch = item.inventario_match;
            const invIcon = invMatch && invMatch.id
                ? `<i class="fas fa-check-circle text-success" title="Match: ${invMatch.nombre}"></i>`
                : `<i class="fas fa-minus-circle text-muted" title="Sin match"></i>`;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="small">${item.descripcion}</td>
                <td class="text-center small">${item.unidad}</td>
                <td class="text-center small">${formatNumber(item.cantidad)}</td>
                <td class="text-end small">$${formatNumber(item.precio_unitario)}</td>
                <td class="text-end small fw-bold">$${formatNumber(item.total)}</td>
                <td class="text-center"><span class="badge ${tipoBadge} badge-sm">${tipoLabel}</span></td>
                <td class="text-center">${invIcon}</td>
            `;
            tbody.appendChild(tr);

            // Accumulate totals by tipo
            if (tipo === 'mano_obra') totalMO += item.total;
            else if (tipo === 'equipo') totalEq += item.total;
            else totalMat += item.total;
            itemCount++;
        });

        table.appendChild(tbody);
        container.appendChild(table);
    });

    // Update summary
    const subtotal = totalMat + totalMO + totalEq;
    const iva = subtotal * 0.21;
    const total = subtotal + iva;

    document.getElementById('totalMateriales').textContent = '$' + formatNumber(totalMat);
    document.getElementById('totalManoObra').textContent = '$' + formatNumber(totalMO);
    document.getElementById('totalEquipos').textContent = '$' + formatNumber(totalEq);
    document.getElementById('subtotalGeneral').textContent = '$' + formatNumber(subtotal);
    document.getElementById('ivaTotal').textContent = '$' + formatNumber(iva);
    document.getElementById('totalGeneral').textContent = '$' + formatNumber(total);
    document.getElementById('itemCount').textContent = itemCount;
    document.getElementById('etapaCount').textContent = etapas.length;

    // Show cards
    cardPreview.classList.remove('d-none');
    cardResumen.classList.remove('d-none');
    cardEmptyState.classList.add('d-none');
    btnConfirmar.disabled = false;
}

// ========== CONFIRM IMPORT ==========
btnConfirmar.addEventListener('click', async () => {
    if (!previewData || !selectedVendor) return;

    const numero = document.getElementById('numero').value.trim();
    if (!numero) {
        showAlert('El numero de presupuesto es requerido', 'warning');
        return;
    }

    const vendorData = previewData.items_by_vendor[selectedVendor];
    if (!vendorData || !vendorData.etapas || vendorData.etapas.length === 0) {
        showAlert('No hay items para importar', 'warning');
        return;
    }

    // Build etapas payload (filtering out special-value items)
    const etapas = vendorData.etapas.map(etapa => ({
        nombre: etapa.nombre,
        items: etapa.items
            .filter(item => !item.valor_especial)
            .map(item => ({
                descripcion: item.descripcion,
                unidad: item.unidad,
                cantidad: item.cantidad,
                precio_unitario: item.precio_unitario,
                total: item.total,
                tipo: item.tipo || 'material',
                item_inventario_id: item.inventario_match?.id || null,
            })),
    })).filter(e => e.items.length > 0);

    btnConfirmar.disabled = true;
    btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Importando...';

    try {
        const csrf = document.querySelector('meta[name="csrf-token"]');
        const headers = {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
        };
        if (csrf) {
            headers['X-CSRFToken'] = csrf.getAttribute('content');
        }

        const response = await fetch('{{ url_for("presupuestos.importar_excel_confirmar") }}', {
            method: 'POST',
            headers,
            body: JSON.stringify({
                numero,
                nombre_obra: document.getElementById('nombre_obra').value.trim(),
                cliente_id: document.getElementById('cliente_id').value || null,
                vigencia_dias: parseInt(document.getElementById('vigencia_dias').value) || 30,
                vendor: selectedVendor,
                filename: selectedFile ? selectedFile.name : '',
                etapas,
            }),
        });

        const result = await response.json();

        if (!response.ok || !result.ok) {
            throw new Error(result.error || 'Error al importar');
        }

        showAlert('Presupuesto importado exitosamente', 'success');

        // Redirect to detail
        if (result.redirect_url) {
            setTimeout(() => {
                window.location.href = result.redirect_url;
            }, 800);
        }

    } catch (error) {
        showAlert(error.message || 'Error al importar el presupuesto', 'danger');
        btnConfirmar.disabled = false;
        btnConfirmar.innerHTML = '<i class="fas fa-save me-1"></i>Importar Presupuesto';
    }
});

// ========== HELPERS ==========
function formatNumber(val) {
    if (val === null || val === undefined) return '0.00';
    return parseFloat(val).toLocaleString('es-AR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    setTimeout(() => {
        if (alertDiv.parentNode) alertDiv.remove();
    }, 4000);
}
</script>
{% endblock %}
