{% extends "base.html" %}

{% block title %}Presupuestos - OBYRA IA{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-calculator me-2"></i>Gestión de Presupuestos</h2>
                {% if current_user.rol in ['administrador', 'tecnico'] %}
                <div class="btn-group" role="group">
                    <a href="{{ url_for('presupuestos.crear') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Nuevo Presupuesto
                    </a>
                    <a href="{{ url_for('presupuestos.calculadora_ia') }}" class="btn btn-success">
                        <i class="fas fa-brain me-1"></i>Calculadora IA
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label for="estado" class="form-label">Estado</label>
                    <select class="form-select" id="estado" name="estado">
                        <option value="">Todos los estados</option>
                        <option value="borrador" {{ 'selected' if estado == 'borrador' }}>Borrador</option>
                        <option value="enviado" {{ 'selected' if estado == 'enviado' }}>Enviado</option>
                        <option value="aprobado" {{ 'selected' if estado == 'aprobado' }}>Aprobado</option>
                        <option value="rechazado" {{ 'selected' if estado == 'rechazado' }}>Rechazado</option>
                        <option value="perdido" {{ 'selected' if estado == 'perdido' }}>Perdido</option>
                        <option value="vencido" {{ 'selected' if estado == 'vencido' }}>Vencido</option>
                        {% if current_user.rol == 'administrador' %}
                        <option value="eliminado" {{ 'selected' if estado == 'eliminado' }}>Eliminado</option>
                        {% endif %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="vigencia" class="form-label">Vigencia</label>
                    <select class="form-select" id="vigencia" name="vigencia">
                        <option value="">Todas</option>
                        <option value="por_vencer" {{ 'selected' if vigencia == 'por_vencer' }}>Por vencer (7 días)</option>
                        <option value="vencidos" {{ 'selected' if vigencia == 'vencidos' }}>Vencidos</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="buscar" class="form-label">Buscar</label>
                    <input type="text" class="form-control" id="buscar" name="buscar"
                           value="{{ buscar }}" placeholder="Número, obra o cliente...">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-outline-primary me-2">
                        <i class="fas fa-search me-1"></i>Filtrar
                    </button>
                    <a href="{{ url_for('presupuestos.lista') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i>Limpiar
                    </a>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Lista de presupuestos -->
    <div class="row">
        {% if presupuestos %}
            {% for presupuesto in presupuestos %}
            <div class="col-lg-6 col-xl-4 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 fw-bold">{{ presupuesto.numero }}</h6>
                        <span class="badge {{ presupuesto.estado|estado_badge }}">
                            {{ presupuesto.estado.title() }}
                        </span>
                    </div>
                    <div class="card-body">
                        {% if presupuesto.obra %}
                            <h6 class="card-title">{{ presupuesto.obra.nombre }}</h6>
                            <p class="text-muted mb-2">
                                <i class="fas fa-user me-1"></i>{{ presupuesto.obra.cliente }}
                            </p>
                        {% else %}
                            <h6 class="card-title">
                                {% set datos = presupuesto.datos_proyecto|safe %}
                                {% if datos %}
                                    {% set proyecto_json = datos|from_json %}
                                    {{ proyecto_json.nombre if proyecto_json.nombre else 'Presupuesto sin obra' }}
                                {% else %}
                                    Presupuesto sin obra
                                {% endif %}
                            </h6>
                            <p class="text-muted mb-2">
                                <i class="fas fa-user me-1"></i>
                                {% if datos and proyecto_json.cliente %}
                                    {{ proyecto_json.cliente }}
                                {% else %}
                                    Cliente por confirmar
                                {% endif %}
                            </p>
                        {% endif %}
                        <p class="text-muted mb-3">
                            <i class="fas fa-calendar me-1"></i>{{ presupuesto.fecha|fecha }}
                            {% if presupuesto.fecha_vigencia %}
                                {% set dias_restantes = presupuesto.dias_restantes_vigencia %}
                                <span class="badge {{ presupuesto.clase_vigencia_badge }} ms-2">
                                    {% if presupuesto.esta_vencido %}
                                        <i class="fas fa-exclamation-triangle me-1"></i>Vencido el {{ presupuesto.fecha_vigencia.strftime('%d/%m/%Y') }}
                                    {% else %}
                                        <i class="fas fa-hourglass-half me-1"></i>{{ presupuesto.fecha_vigencia.strftime('%d/%m/%Y') }}
                                        {% if dias_restantes is not none %}
                                            <span class="ms-1">(faltan {{ dias_restantes }} días)</span>
                                        {% endif %}
                                    {% endif %}
                                </span>
                            {% endif %}
                        </p>
                        
                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <small class="text-muted d-block">Sin IVA</small>
                                <strong class="text-primary">{{ presupuesto.total_sin_iva|moneda }}</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Total</small>
                                <strong class="text-success">{{ presupuesto.total_con_iva|moneda }}</strong>
                            </div>
                        </div>

                        {% if presupuesto.estado == 'perdido' %}
                        <div class="alert alert-warning py-2">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-archive me-2 mt-1"></i>
                                <div>
                                    <strong>Presupuesto perdido</strong>
                                    {% if presupuesto.perdido_motivo %}
                                    <div class="small mt-1">{{ presupuesto.perdido_motivo }}</div>
                                    {% endif %}
                                    {% if presupuesto.perdido_fecha %}
                                    <div class="small text-muted mt-1">{{ presupuesto.perdido_fecha.strftime('%d/%m/%Y %H:%M') }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                    {% if presupuesto.items.count() > 0 %}
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="fas fa-list me-1"></i>{{ presupuesto.items.count() }} items
                        </small>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="d-grid gap-2">
                            {% if presupuesto.estado == 'eliminado' %}
                            <button class="btn btn-outline-secondary" disabled>
                                <i class="fas fa-box-archive me-1"></i>Presupuesto eliminado
                            </button>
                            {% else %}
                            <a href="{{ url_for('presupuestos.detalle', id=presupuesto.id) }}"
                               class="btn btn-outline-primary">
                                <i class="fas fa-eye me-1"></i>Ver Detalles
                            </a>
                            {% if presupuesto.items.count() > 0 %}
                            <a href="{{ url_for('presupuestos.generar_pdf', id=presupuesto.id) }}"
                               class="btn btn-outline-success btn-sm" target="_blank">
                                <i class="fas fa-file-pdf me-1"></i>Descargar PDF
                            </a>
                            {% endif %}
                            {% endif %}
                            
                            <!-- Botón Confirmar Obra para presupuestos sin obra -->
                            {% if not presupuesto.confirmado_como_obra and not presupuesto.obra_id and current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' %}
                            <button class="btn btn-success btn-sm" onclick="confirmarComoObra({{ presupuesto.id }}, '{{ presupuesto.numero }}')">
                                <i class="fas fa-check-circle me-1"></i>Confirmar como Obra
                            </button>
                            {% endif %}

                            {% if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' %}
                            <button class="btn btn-outline-warning btn-sm" onclick="abrirPerderModal({{ presupuesto.id }}, '{{ presupuesto.numero }}')">
                                <i class="fas fa-archive me-1"></i>Marcar como perdido
                            </button>
                            {% endif %}

                            {% if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'perdido' %}
                            <button class="btn btn-outline-secondary btn-sm" onclick="restaurarPresupuesto({{ presupuesto.id }})">
                                <i class="fas fa-undo me-1"></i>Restaurar a borrador
                            </button>
                            {% endif %}

                            {% if current_user.rol == 'administrador' and presupuesto.estado in ['borrador', 'perdido'] %}
                            <button class="btn btn-outline-danger btn-sm" onclick="eliminarPresupuesto({{ presupuesto.id }}, '{{ presupuesto.numero }}')">
                                <i class="fas fa-trash me-1"></i>Eliminar
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="fas fa-calculator fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No hay presupuestos registrados</h4>
                    <p class="text-muted">
                        {% if current_user.rol in ['administrador', 'tecnico'] %}
                            Comienza creando tu primer presupuesto.
                        {% else %}
                            No hay presupuestos disponibles para visualizar.
                        {% endif %}
                    </p>
                    {% if current_user.rol in ['administrador', 'tecnico'] %}
                    <a href="{{ url_for('presupuestos.crear') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Crear Primer Presupuesto
                    </a>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% include 'presupuestos/_perder_modal.html' %}
{% endblock %}

{% block scripts %}
<script>
function confirmarComoObra(presupuestoId, numeroPresupuesto) {
    if (confirm(`¿Estás seguro de que deseas convertir el presupuesto ${numeroPresupuesto} en una obra activa?`)) {
        // Crear un formulario para enviar la solicitud POST
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/presupuestos/${presupuestoId}/confirmar-obra`;
        
        // Agregar token CSRF si existe
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
            const tokenInput = document.createElement('input');
            tokenInput.type = 'hidden';
            tokenInput.name = 'csrf_token';
            tokenInput.value = csrfToken.content;
            form.appendChild(tokenInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}

let presupuestoSeleccionado = null;
const modalPerdidoEl = document.getElementById('modalMarcarPerdido');
const modalPerdido = modalPerdidoEl ? new bootstrap.Modal(modalPerdidoEl) : null;
const botonConfirmarPerdido = document.getElementById('btnConfirmarPerdido');
if (botonConfirmarPerdido) {
    botonConfirmarPerdido.addEventListener('click', confirmarMarcarPerdido);
}

function abrirPerderModal(id, numero) {
    if (!modalPerdido) return;
    presupuestoSeleccionado = { id, numero };
    document.getElementById('perderPresupuestoNumero').textContent = numero;
    document.getElementById('motivoPerdido').value = '';
    document.getElementById('detallePerdido').value = '';
    modalPerdido.show();
}

async function confirmarMarcarPerdido() {
    if (!presupuestoSeleccionado) return;
    const motivo = document.getElementById('motivoPerdido').value.trim();
    const detalle = document.getElementById('detallePerdido').value.trim();

    if (!motivo && !detalle) {
        showAlert('Selecciona un motivo o agrega un detalle para registrar el motivo.', 'warning');
        return;
    }

    try {
        const response = await fetch(`/presupuestos/${presupuestoSeleccionado.id}/perder`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ motivo, detalle })
        });

        const result = await response.json().catch(() => ({}));
        if (!response.ok) {
            showAlert(result.error || 'Error al marcar el presupuesto como perdido.', 'danger');
            return;
        }

        if (modalPerdido) {
            modalPerdido.hide();
        }
        showAlert(result.mensaje || 'Presupuesto marcado como perdido.', 'success');
        setTimeout(() => window.location.reload(), 800);
    } catch (error) {
        console.error(error);
        showAlert('No se pudo completar la operación. Intenta nuevamente.', 'danger');
    }
}

async function restaurarPresupuesto(id) {
    if (!confirm('¿Restaurar este presupuesto a borrador?')) {
        return;
    }

    try {
        const response = await fetch(`/presupuestos/${id}/restaurar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const result = await response.json().catch(() => ({}));
        if (!response.ok) {
            showAlert(result.error || 'Error al restaurar el presupuesto.', 'danger');
            return;
        }

        showAlert(result.mensaje || 'Presupuesto restaurado a borrador.', 'success');
        setTimeout(() => window.location.reload(), 800);
    } catch (error) {
        console.error(error);
        showAlert('No se pudo completar la operación. Intenta nuevamente.', 'danger');
    }
}

async function eliminarPresupuesto(id, numero) {
    if (!confirm(`¿Eliminar el presupuesto ${numero}? Esta acción lo archivará y podrás verlo solo desde el filtro de eliminados.`)) {
        return;
    }

    try {
        const response = await fetch(`/presupuestos/${id}/eliminar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const result = await response.json().catch(() => ({}));
        if (!response.ok) {
            showAlert(result.error || 'Error al eliminar el presupuesto.', 'danger');
            return;
        }

        showAlert(result.mensaje || 'Presupuesto eliminado correctamente.', 'success');
        setTimeout(() => window.location.reload(), 800);
    } catch (error) {
        console.error(error);
        showAlert('No se pudo completar la operación. Intenta nuevamente.', 'danger');
    }
}

function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alertDiv);

    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}
</script>
{% endblock %}
