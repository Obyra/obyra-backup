{% extends "base.html" %}

{% block title %}Presupuestos - OBYRA IA{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-calculator me-2"></i>Gestión de Presupuestos</h2>
                {% if current_user.rol in ['administrador', 'tecnico'] %}
                <div class="btn-group" role="group">
                    <div class="dropdown">
                        <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownNuevoPresupuesto"
                                data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-plus me-1"></i>Nuevo Presupuesto
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownNuevoPresupuesto">
                            <li>
                                <a class="dropdown-item" href="{{ url_for('presupuestos.crear') }}">
                                    <i class="fas fa-brain text-success me-2"></i>Con Calculadora IA
                                    <br><small class="text-muted ms-4">Calcula materiales automaticamente</small>
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('presupuestos.crear_manual') }}">
                                    <i class="fas fa-edit text-primary me-2"></i>Carga Manual
                                    <br><small class="text-muted ms-4">Agrega items manualmente</small>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label for="estado" class="form-label">Estado</label>
                    <select class="form-select" id="estado" name="estado">
                        <option value="">Todos los estados</option>
                        <option value="borrador" {{ 'selected' if estado == 'borrador' }}>Borrador</option>
                        <option value="enviado" {{ 'selected' if estado == 'enviado' }}>Enviado</option>
                        <option value="aprobado" {{ 'selected' if estado == 'aprobado' }}>Aprobado</option>
                        <option value="confirmado" {{ 'selected' if estado == 'confirmado' }}>Confirmado</option>
                        <option value="rechazado" {{ 'selected' if estado == 'rechazado' }}>Rechazado</option>
                        <option value="perdido" {{ 'selected' if estado == 'perdido' }}>Perdido</option>
                        <option value="vencido" {{ 'selected' if estado == 'vencido' }}>Vencido</option>
                        {% if current_user.rol == 'administrador' %}
                        <option value="eliminado" {{ 'selected' if estado == 'eliminado' }}>Eliminado</option>
                        {% endif %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="vigencia" class="form-label">Vigencia</label>
                    <select class="form-select" id="vigencia" name="vigencia">
                        <option value="">Todas</option>
                        <option value="por_vencer" {{ 'selected' if vigencia == 'por_vencer' }}>Por vencer (7 días)</option>
                        <option value="vencidos" {{ 'selected' if vigencia == 'vencidos' }}>Vencidos</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="buscar" class="form-label">Buscar</label>
                    <input type="text" class="form-control" id="buscar" name="buscar"
                           value="{{ buscar }}" placeholder="Número, obra o cliente...">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-outline-primary me-2">
                        <i class="fas fa-search me-1"></i>Filtrar
                    </button>
                    <a href="{{ url_for('presupuestos.lista') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i>Limpiar
                    </a>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Lista de presupuestos -->
    <div class="row">
        {% if presupuestos %}
            {% for presupuesto in presupuestos %}
            <div class="col-lg-6 col-xl-4 mb-4" data-presupuesto-wrapper="{{ presupuesto.id }}">
                <div class="card h-100 shadow-sm" id="presupuesto-card-{{ presupuesto.id }}"
                     data-presupuesto-card="{{ presupuesto.id }}"
                     data-presupuesto-estado="{{ presupuesto.estado }}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 fw-bold">{{ presupuesto.numero }}</h6>
                        <span class="badge {{ presupuesto.estado|estado_badge }}"
                              data-presupuesto-estado-badge="{{ presupuesto.id }}">
                            {{ presupuesto.estado.title() }}
                        </span>
                    </div>
                    {% set datos_raw = presupuesto.datos_proyecto %}
                    {% set proyecto_json = datos_raw|from_json if datos_raw else {} %}
                    {# Prioridad: obra > datos_proyecto.nombre_obra > datos_proyecto.nombre > ubicacion_texto #}
                    {% set nombre_proyecto = presupuesto.obra.nombre if presupuesto.obra else (proyecto_json.nombre_obra if proyecto_json and proyecto_json.nombre_obra else (proyecto_json.nombre if proyecto_json and proyecto_json.nombre else (presupuesto.ubicacion_normalizada or presupuesto.ubicacion_texto or 'Sin ubicación definida'))) %}
                    {# Prioridad: obra > cliente relacion > datos_proyecto.cliente_nombre > datos_proyecto.cliente #}
                    {% set cliente_proyecto = presupuesto.obra.cliente if presupuesto.obra else (presupuesto.cliente.nombre_completo if presupuesto.cliente else (proyecto_json.cliente_nombre if proyecto_json and proyecto_json.cliente_nombre else (proyecto_json.cliente if proyecto_json and proyecto_json.cliente else 'Cliente por confirmar'))) %}
                    {% set ubicacion_proyecto = presupuesto.ubicacion_normalizada or presupuesto.ubicacion_texto or (proyecto_json.ubicacion if proyecto_json and proyecto_json.ubicacion else None) %}
                    <div class="card-body">
                        <h6 class="card-title">{{ nombre_proyecto }}</h6>
                        <p class="text-muted mb-2">
                            <i class="fas fa-user me-1"></i>{{ cliente_proyecto }}
                        </p>
                        <p class="text-muted mb-3">
                            <i class="fas fa-calendar me-1"></i>{{ presupuesto.fecha|fecha }}
                            {% if presupuesto.fecha_vigencia %}
                                {% set dias_restantes = presupuesto.dias_restantes_vigencia %}
                                <span class="badge {{ presupuesto.clase_vigencia_badge }} ms-2">
                                    {% if presupuesto.esta_vencido %}
                                        <i class="fas fa-exclamation-triangle me-1"></i>Vencido el {{ presupuesto.fecha_vigencia.strftime('%d/%m/%Y') }}
                                    {% else %}
                                        <i class="fas fa-hourglass-half me-1"></i>{{ presupuesto.fecha_vigencia.strftime('%d/%m/%Y') }}
                                        {% if dias_restantes is not none %}
                                            <span class="ms-1">(faltan {{ dias_restantes }} días)</span>
                                        {% endif %}
                                    {% endif %}
                                </span>
                            {% endif %}
                        </p>

                        <div class="d-flex align-items-center gap-2 mb-3">
                            <span class="badge bg-light text-dark border">{{ presupuesto.currency }}</span>
                            {% if presupuesto.currency != 'ARS' and presupuesto.tasa_usd_venta %}
                                <span class="text-muted small">
                                    TC {{ presupuesto.exchange_rate_provider|upper if presupuesto.exchange_rate_provider else 'BNA' }}
                                    {{ presupuesto.tasa_usd_venta|moneda('ARS') }}
                                </span>
                            {% endif %}
                            {% if presupuesto.indice_cac_valor %}
                                <span class="text-muted small">
                                    CAC {{ '{:,.0f}'.format(presupuesto.indice_cac_valor) }}
                                </span>
                            {% endif %}
                        </div>

                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <small class="text-muted d-block">Sin IVA</small>
                                <strong class="text-primary">{{ presupuesto.total_sin_iva|moneda(presupuesto.currency) }}</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Total</small>
                                <strong class="text-success">{{ presupuesto.total_con_iva|moneda(presupuesto.currency) }}</strong>
                            </div>
                        </div>

                        {% if presupuesto.estado == 'perdido' %}
                        <div class="alert alert-warning py-2">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-archive me-2 mt-1"></i>
                                <div>
                                    <strong>Presupuesto perdido</strong>
                                    {% if presupuesto.perdido_motivo %}
                                    <div class="small mt-1">{{ presupuesto.perdido_motivo }}</div>
                                    {% endif %}
                                    {% if presupuesto.perdido_fecha %}
                                    <div class="small text-muted mt-1">{{ presupuesto.perdido_fecha.strftime('%d/%m/%Y %H:%M') }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                    {% if presupuesto.items.count() > 0 %}
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="fas fa-list me-1"></i>{{ presupuesto.items.count() }} items
                        </small>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-footer bg-transparent" data-presupuesto-footer="{{ presupuesto.id }}">
                        <div class="d-grid gap-2" data-confirm-container="{{ presupuesto.id }}">
                            {% set es_admin = tiene_rol('admin') or (current_user.is_authenticated and current_user.es_admin()) %}
                            {% if not presupuesto.confirmado_como_obra and not presupuesto.obra_id and es_admin and presupuesto.estado in ['borrador', 'enviado', 'aprobado'] %}
                            {% set cliente_obj = presupuesto.cliente %}
                            {% set cliente_completo = cliente_obj and cliente_obj.nombre and (cliente_obj.email or cliente_obj.telefono) and cliente_obj.numero_documento %}
                            <button type="button" class="btn btn-success btn-sm btn-confirmar-presupuesto"
                                    data-action="abrir-confirmar"
                                    data-presupuesto-id="{{ presupuesto.id }}"
                                    data-numero="{{ presupuesto.numero }}"
                                    data-cliente="{{ cliente_proyecto|e }}"
                                    data-cliente-id="{{ presupuesto.cliente_id or '' }}"
                                    data-cliente-completo="{{ 'true' if cliente_completo else 'false' }}"
                                    data-cliente-tiene-email="{{ 'true' if cliente_obj and cliente_obj.email else 'false' }}"
                                    data-cliente-tiene-telefono="{{ 'true' if cliente_obj and cliente_obj.telefono else 'false' }}"
                                    data-cliente-tiene-documento="{{ 'true' if cliente_obj and cliente_obj.numero_documento else 'false' }}"
                                    data-obra="{{ nombre_proyecto|e }}"
                                    data-ubicacion="{{ (ubicacion_proyecto or 'Ubicación no especificada')|e }}"
                                    data-ubicacion-valid="{{ 'true' if presupuesto.geocode_status == 'ok' or (presupuesto.geo_latitud and presupuesto.geo_longitud) else 'false' }}"
                                    data-moneda="{{ presupuesto.currency }}"
                                    data-currency-symbol="{{ '$' if presupuesto.currency == 'ARS' else 'US$' }}"
                                    data-tasa="{{ presupuesto.tasa_usd_venta if presupuesto.tasa_usd_venta else '' }}"
                                    data-tasa-provider="{{ presupuesto.exchange_rate_provider or 'BNA' }}"
                                    data-tasa-fecha="{{ presupuesto.exchange_rate_as_of.strftime('%d/%m/%Y') if presupuesto.exchange_rate_as_of else '' }}"
                                    data-cac="{{ presupuesto.indice_cac_valor if presupuesto.indice_cac_valor else '' }}"
                                    data-cac-fecha="{{ presupuesto.indice_cac_fecha.strftime('%m/%Y') if presupuesto.indice_cac_fecha else '' }}"
                                    data-subtotal-materiales="{{ presupuesto.subtotal_materiales|moneda(presupuesto.currency) }}"
                                    data-subtotal-mano-obra="{{ presupuesto.subtotal_mano_obra|moneda(presupuesto.currency) }}"
                                    data-subtotal-equipos="{{ presupuesto.subtotal_equipos|moneda(presupuesto.currency) }}"
                                    data-total="{{ presupuesto.total_con_iva|float }}"
                                    data-total-sin-iva="{{ presupuesto.total_sin_iva|float }}"
                                    data-geo-lat="{{ presupuesto.geo_latitud if presupuesto.geo_latitud is not none else '' }}"
                                    data-geo-lng="{{ presupuesto.geo_longitud if presupuesto.geo_longitud is not none else '' }}"
                                    data-geocode-status="{{ presupuesto.geocode_status or '' }}"
                                    data-geocode-provider="{{ presupuesto.geocode_provider or '' }}"
                                    aria-label="Confirmar presupuesto {{ presupuesto.numero }} y crear obra">
                                <i class="fas fa-check-circle me-1"></i>Confirmar
                            </button>
                            {% endif %}
                            {% if presupuesto.estado == 'eliminado' %}
                            <button class="btn btn-outline-secondary" disabled>
                                <i class="fas fa-box-archive me-1"></i>Presupuesto eliminado
                            </button>
                            {% else %}
                            <a href="{{ url_for('presupuestos.detalle', id=presupuesto.id) }}"
                               class="btn btn-outline-primary">
                                <i class="fas fa-eye me-1"></i>Ver Detalles
                            </a>
                            {% if presupuesto.items.count() > 0 %}
                            <a href="{{ url_for('presupuestos.generar_pdf', id=presupuesto.id) }}"
                               class="btn btn-outline-success btn-sm w-100" target="_blank">
                                <i class="fas fa-file-pdf me-1"></i>Descargar PDF
                            </a>
                            {# El botón de enviar por correo aparece si el presupuesto NO está confirmado como obra #}
                            {% if not presupuesto.confirmado_como_obra %}
                            <a href="{{ url_for('presupuestos.enviar_email', id=presupuesto.id) }}" class="btn btn-outline-info btn-sm w-100">
                                <i class="fas fa-envelope me-1"></i>Enviar por correo
                            </a>
                            {% endif %}
                            {% endif %}
                            {% endif %}

                            {% if (es_admin or tiene_rol('tecnico')) and presupuesto.estado == 'borrador' %}
                            <button class="btn btn-outline-warning btn-sm" onclick="abrirPerderModal({{ presupuesto.id }}, '{{ presupuesto.numero }}')">
                                <i class="fas fa-archive me-1"></i>Marcar como perdido
                            </button>
                            {% endif %}

                            {% if (es_admin or tiene_rol('tecnico')) and presupuesto.estado == 'perdido' %}
                            <button class="btn btn-outline-secondary btn-sm" onclick="restaurarPresupuesto({{ presupuesto.id }})">
                                <i class="fas fa-undo me-1"></i>Restaurar a borrador
                            </button>
                            {% endif %}

                            {% if es_admin and presupuesto.estado in ['enviado', 'aprobado', 'rechazado'] %}
                            <button class="btn btn-outline-warning btn-sm" onclick="revertirABorrador({{ presupuesto.id }}, '{{ presupuesto.numero }}')">
                                <i class="fas fa-undo-alt me-1"></i>Revertir a Borrador
                            </button>
                            {% endif %}

                            {% if es_admin and not presupuesto.confirmado_como_obra %}
                            <button class="btn btn-outline-danger btn-sm" onclick="eliminarPresupuesto({{ presupuesto.id }}, '{{ presupuesto.numero }}')">
                                <i class="fas fa-trash me-1"></i>Eliminar
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% endif %}
        <div class="col-12 {% if presupuestos %}d-none{% endif %}" data-presupuestos-empty>
            <div class="text-center py-5">
                <i class="fas fa-calculator fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No hay presupuestos registrados</h4>
                <p class="text-muted">
                    {% if current_user.rol in ['administrador', 'tecnico'] %}
                        Comienza creando tu primer presupuesto.
                    {% else %}
                        No hay presupuestos disponibles para visualizar.
                    {% endif %}
                </p>
                {% if current_user.rol in ['administrador', 'tecnico'] %}
                <a href="{{ url_for('presupuestos.crear') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i>Crear Primer Presupuesto
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    </div>
</div>

<div class="modal fade" id="modalConfirmarPresupuesto" tabindex="-1"
     aria-labelledby="modalConfirmarPresupuestoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalConfirmarPresupuestoLabel">
                    Confirmar presupuesto y crear obra
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <form id="confirmarPresupuestoForm">
                <div class="modal-body">
                    <p class="text-muted small mb-3">
                        Revisa los datos clave antes de confirmar. Podrás ajustar las tareas luego desde la obra.
                    </p>
                    <div id="confirmModalMessage" class="alert alert-danger d-none" role="alert"></div>
                    <div id="confirmClienteIncompleto" class="alert alert-warning d-none" role="alert">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                            <div class="flex-grow-1">
                                <strong>Datos del cliente incompletos</strong>
                                <p class="mb-2 small">Complete los datos faltantes para confirmar la obra:</p>

                                <!-- Formulario inline para completar datos del cliente -->
                                <div id="formClienteInline" class="bg-white p-3 rounded border mt-2">
                                    <input type="hidden" id="clienteIdEditar" value="">

                                    <div class="row g-2">
                                        <div class="col-md-6" id="campoEmailContainer">
                                            <label class="form-label small mb-1">
                                                <i class="fas fa-envelope me-1"></i>Email
                                            </label>
                                            <input type="email" class="form-control form-control-sm" id="clienteEmailInline" placeholder="email@ejemplo.com">
                                        </div>
                                        <div class="col-md-6" id="campoTelefonoContainer">
                                            <label class="form-label small mb-1">
                                                <i class="fas fa-phone me-1"></i>Teléfono
                                            </label>
                                            <input type="tel" class="form-control form-control-sm" id="clienteTelefonoInline" placeholder="11-1234-5678">
                                        </div>
                                        <div class="col-md-6" id="campoDocumentoContainer">
                                            <label class="form-label small mb-1">
                                                <i class="fas fa-id-card me-1"></i>DNI
                                            </label>
                                            <input type="text" class="form-control form-control-sm" id="clienteDocumentoInline" placeholder="12345678">
                                        </div>
                                        <div class="col-md-6" id="campoCuitContainer">
                                            <label class="form-label small mb-1">
                                                <i class="fas fa-building me-1"></i>CUIT
                                            </label>
                                            <input type="text" class="form-control form-control-sm" id="clienteCuitInline" placeholder="20-12345678-9">
                                        </div>
                                    </div>

                                    <div class="mt-3 d-flex gap-2">
                                        <button type="button" class="btn btn-warning btn-sm" id="btnGuardarClienteInline">
                                            <i class="fas fa-save me-1"></i>Guardar y continuar
                                        </button>
                                        <span class="text-muted small align-self-center" id="mensajeGuardadoCliente"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="confirmSinCliente" class="alert alert-warning d-none" role="alert">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-user-plus me-2 mt-1"></i>
                            <div class="flex-grow-1">
                                <strong>Sin cliente asignado</strong>
                                <p class="mb-2 small">Seleccione un cliente existente o cree uno nuevo:</p>

                                <!-- Selector de cliente existente -->
                                <div id="selectorClienteExistente" class="bg-white p-3 rounded border">
                                    <div class="mb-3">
                                        <label class="form-label small mb-1">
                                            <i class="fas fa-search me-1"></i>Buscar cliente existente
                                        </label>
                                        <select class="form-select form-select-sm" id="selectClienteExistente">
                                            <option value="">-- Seleccionar cliente --</option>
                                        </select>
                                    </div>

                                    <div class="text-center my-2">
                                        <span class="text-muted small">— o —</span>
                                    </div>

                                    <!-- Formulario para crear cliente nuevo -->
                                    <div id="formNuevoCliente">
                                        <p class="small text-muted mb-2"><i class="fas fa-user-plus me-1"></i>Crear cliente nuevo:</p>
                                        <div class="row g-2">
                                            <div class="col-md-6">
                                                <input type="text" class="form-control form-control-sm" id="nuevoClienteNombre" placeholder="Nombre / Razón Social *">
                                            </div>
                                            <div class="col-md-6">
                                                <input type="text" class="form-control form-control-sm" id="nuevoClienteApellido" placeholder="Apellido (opcional)">
                                            </div>
                                            <div class="col-md-6">
                                                <input type="email" class="form-control form-control-sm" id="nuevoClienteEmail" placeholder="Email *">
                                            </div>
                                            <div class="col-md-6">
                                                <input type="tel" class="form-control form-control-sm" id="nuevoClienteTelefono" placeholder="Teléfono">
                                            </div>
                                            <div class="col-md-4">
                                                <select class="form-select form-select-sm" id="nuevoClienteTipoDoc">
                                                    <option value="CUIT">CUIT</option>
                                                    <option value="DNI">DNI</option>
                                                    <option value="CUIL">CUIL</option>
                                                </select>
                                            </div>
                                            <div class="col-md-8">
                                                <input type="text" class="form-control form-control-sm" id="nuevoClienteNumDoc" placeholder="Número de documento *">
                                            </div>
                                        </div>

                                        <div class="mt-3 d-flex gap-2">
                                            <button type="button" class="btn btn-success btn-sm" id="btnCrearClienteRapido">
                                                <i class="fas fa-plus me-1"></i>Crear y asignar cliente
                                            </button>
                                            <span class="text-muted small align-self-center" id="mensajeClienteCreado"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <dl class="row mb-3">
                        <dt class="col-sm-4">Presupuesto</dt>
                        <dd class="col-sm-8 fw-semibold" id="confirmPresupuestoNumero"></dd>
                        <dt class="col-sm-4">Obra</dt>
                        <dd class="col-sm-8" id="confirmPresupuestoObra"></dd>
                        <dt class="col-sm-4">Cliente</dt>
                        <dd class="col-sm-8" id="confirmPresupuestoCliente"></dd>
                        <dt class="col-sm-4">Ubicación</dt>
                        <dd class="col-sm-8" id="confirmPresupuestoUbicacion"></dd>
                        <dt class="col-sm-4">Moneda</dt>
                        <dd class="col-sm-8" id="confirmPresupuestoMoneda"></dd>
                        <dt class="col-sm-4">Tipo de cambio</dt>
                        <dd class="col-sm-8" id="confirmPresupuestoTipoCambio"></dd>
                        <dt class="col-sm-4">Índice CAC</dt>
                        <dd class="col-sm-8" id="confirmPresupuestoCAC"></dd>
                    </dl>
                    <div id="confirmUbicacionEstado" class="mb-3"></div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <div class="border rounded p-3 h-100">
                                <div class="text-muted small">Materiales</div>
                                <div class="fw-semibold" id="confirmSubtotalMateriales"></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border rounded p-3 h-100">
                                <div class="text-muted small">Mano de obra</div>
                                <div class="fw-semibold" id="confirmSubtotalManoObra"></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border rounded p-3 h-100">
                                <div class="text-muted small">Equipos</div>
                                <div class="fw-semibold" id="confirmSubtotalEquipos"></div>
                            </div>
                        </div>
                    </div>
                    <div class="border rounded p-3 mb-3 bg-light">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Total estimado (con IVA)</span>
                            <span class="fs-5 fw-bold" id="confirmTotalGeneral"></span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center text-muted small" id="confirmTotalAlternativoRow">
                            <span>Equivalente en <span id="confirmMonedaAlternativa"></span></span>
                            <span class="fw-semibold" id="confirmTotalAlternativo"></span>
                        </div>
                    </div>
                    <div class="border rounded p-3">
                        <input type="hidden" id="confirmPresupuestoId" value="">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="confirmCrearTareas" checked>
                            <label class="form-check-label" for="confirmCrearTareas">
                                Crear tareas sugeridas para cada etapa
                            </label>
                        </div>
                        {# Slug y etapa normalizada se asignan automáticamente - no mostrar como opción #}
                        <input type="hidden" id="confirmNormalizarSlugs" value="true">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-link" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnConfirmarPresupuesto">
                        <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"
                              id="spinnerConfirmarPresupuesto"></span>
                        Confirmar y crear obra
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% include 'presupuestos/_perder_modal.html' %}
{% endblock %}

{% block scripts %}
<script>
const confirmModalEl = document.getElementById('modalConfirmarPresupuesto');
const confirmModal = confirmModalEl ? new bootstrap.Modal(confirmModalEl) : null;
const confirmForm = document.getElementById('confirmarPresupuestoForm');
const confirmMessage = document.getElementById('confirmModalMessage');
const confirmSpinner = document.getElementById('spinnerConfirmarPresupuesto');
const confirmSubmitBtn = document.getElementById('btnConfirmarPresupuesto');
const confirmPresupuestoIdInput = document.getElementById('confirmPresupuestoId');
const campoNumero = document.getElementById('confirmPresupuestoNumero');
const campoObra = document.getElementById('confirmPresupuestoObra');
const campoCliente = document.getElementById('confirmPresupuestoCliente');
const campoUbicacion = document.getElementById('confirmPresupuestoUbicacion');
const campoMoneda = document.getElementById('confirmPresupuestoMoneda');
const campoTipoCambio = document.getElementById('confirmPresupuestoTipoCambio');
const campoIndiceCAC = document.getElementById('confirmPresupuestoCAC');
const campoSubtotalMateriales = document.getElementById('confirmSubtotalMateriales');
const campoSubtotalManoObra = document.getElementById('confirmSubtotalManoObra');
const campoSubtotalEquipos = document.getElementById('confirmSubtotalEquipos');
const campoTotalGeneral = document.getElementById('confirmTotalGeneral');
const campoTotalAlternativoRow = document.getElementById('confirmTotalAlternativoRow');
const campoTotalAlternativo = document.getElementById('confirmTotalAlternativo');
const campoMonedaAlternativa = document.getElementById('confirmMonedaAlternativa');
const campoUbicacionEstado = document.getElementById('confirmUbicacionEstado');
const alertaClienteIncompleto = document.getElementById('confirmClienteIncompleto');
const alertaSinCliente = document.getElementById('confirmSinCliente');
const linkEditarCliente = document.getElementById('linkEditarCliente');
const checkboxCrearTareas = document.getElementById('confirmCrearTareas');
const checkboxNormalizarSlugs = document.getElementById('confirmNormalizarSlugs');
let presupuestoSeleccionadoConfirmacion = null;

const confirmButtons = document.querySelectorAll('.btn-confirmar-presupuesto');
confirmButtons.forEach((btn) => {
    btn.addEventListener('click', () => abrirModalConfirmacion(btn));
});

function abrirModalConfirmacion(button) {
    if (!confirmModal) {
        return;
    }
    presupuestoSeleccionadoConfirmacion = button;
    confirmForm.dataset.presupuestoId = button.dataset.presupuestoId;
    if (confirmPresupuestoIdInput) {
        confirmPresupuestoIdInput.value = button.dataset.presupuestoId || '';
    }
    campoNumero.textContent = button.dataset.numero || '';
    campoObra.textContent = button.dataset.obra || '';
    campoCliente.textContent = button.dataset.cliente || '—';
    campoUbicacion.textContent = button.dataset.ubicacion || 'Ubicación no especificada';
    campoMoneda.textContent = button.dataset.moneda || 'ARS';

    // Tipo de cambio con formato completo
    const tasa = parseFloat(button.dataset.tasa) || 0;
    const tasaProvider = (button.dataset.tasaProvider || 'BNA').toUpperCase();
    const tasaFecha = button.dataset.tasaFecha || '';
    if (tasa > 0) {
        let tipoCambioText = `1 USD = ${tasa.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ARS`;
        if (tasaFecha) {
            tipoCambioText += ` (${tasaProvider} - ${tasaFecha})`;
        } else {
            tipoCambioText += ` (${tasaProvider})`;
        }
        campoTipoCambio.textContent = tipoCambioText;
    } else {
        campoTipoCambio.textContent = '—';
    }

    // Índice CAC con formato completo
    const cac = parseFloat(button.dataset.cac) || 0;
    const cacFecha = button.dataset.cacFecha || '';
    if (cac > 0) {
        let cacText = cac.toLocaleString('es-AR', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        if (cacFecha) {
            cacText += ` (vigencia ${cacFecha})`;
        }
        campoIndiceCAC.textContent = cacText;
    } else {
        campoIndiceCAC.textContent = '—';
    }

    campoSubtotalMateriales.textContent = button.dataset.subtotalMateriales || '—';
    campoSubtotalManoObra.textContent = button.dataset.subtotalManoObra || '—';
    campoSubtotalEquipos.textContent = button.dataset.subtotalEquipos || '—';

    // Total principal
    const moneda = button.dataset.moneda || 'ARS';
    const total = parseFloat(button.dataset.total) || 0;
    const currencySymbol = moneda === 'ARS' ? '$' : 'US$';
    campoTotalGeneral.textContent = `${currencySymbol}${total.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

    // Total alternativo (conversión)
    if (tasa > 0 && campoTotalAlternativoRow) {
        campoTotalAlternativoRow.style.display = 'flex';
        const monedaAlternativa = moneda === 'ARS' ? 'USD' : 'ARS';
        const symbolAlternativo = monedaAlternativa === 'ARS' ? '$' : 'US$';
        let totalAlternativo;
        if (moneda === 'ARS') {
            totalAlternativo = total / tasa;
        } else {
            totalAlternativo = total * tasa;
        }
        campoMonedaAlternativa.textContent = monedaAlternativa;
        campoTotalAlternativo.textContent = `${symbolAlternativo}${totalAlternativo.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    } else if (campoTotalAlternativoRow) {
        campoTotalAlternativoRow.style.display = 'none';
    }

    if (button.dataset.ubicacionValid === 'true') {
        campoUbicacionEstado.innerHTML = '<span class="badge bg-success"><i class="fas fa-map-marker-alt me-1"></i>Ubicación validada correctamente.</span>';
    } else {
        campoUbicacionEstado.innerHTML = '<span class="badge bg-warning text-dark"><i class="fas fa-map-marker-alt me-1"></i>Ubicación pendiente de validación. Se intentará geocodificar al confirmar.</span>';
    }

    if (confirmMessage) {
        confirmMessage.classList.add('d-none');
        confirmMessage.textContent = '';
    }
    if (confirmSpinner) {
        confirmSpinner.classList.add('d-none');
    }
    if (checkboxCrearTareas) checkboxCrearTareas.checked = true;
    if (checkboxNormalizarSlugs) checkboxNormalizarSlugs.checked = true;

    // Validar datos del cliente
    const clienteId = button.dataset.clienteId;
    const clienteCompleto = button.dataset.clienteCompleto === 'true';
    const tieneEmail = button.dataset.clienteTieneEmail === 'true';
    const tieneTelefono = button.dataset.clienteTieneTelefono === 'true';
    const tieneDocumento = button.dataset.clienteTieneDocumento === 'true';

    // Ocultar alertas por defecto
    if (alertaClienteIncompleto) alertaClienteIncompleto.classList.add('d-none');
    if (alertaSinCliente) alertaSinCliente.classList.add('d-none');

    let clienteValido = true;

    if (!clienteId) {
        // No hay cliente asignado
        if (alertaSinCliente) alertaSinCliente.classList.remove('d-none');
        clienteValido = false;
    } else if (!clienteCompleto) {
        // Cliente asignado pero datos incompletos
        if (alertaClienteIncompleto) {
            alertaClienteIncompleto.classList.remove('d-none');

            // Configurar el formulario inline con el ID del cliente
            const clienteIdInput = document.getElementById('clienteIdEditar');
            if (clienteIdInput) {
                clienteIdInput.value = clienteId;
            }

            // Limpiar campos del formulario
            const emailInput = document.getElementById('clienteEmailInline');
            const telefonoInput = document.getElementById('clienteTelefonoInline');
            const documentoInput = document.getElementById('clienteDocumentoInline');
            const cuitInput = document.getElementById('clienteCuitInline');

            if (emailInput) emailInput.value = '';
            if (telefonoInput) telefonoInput.value = '';
            if (documentoInput) documentoInput.value = '';
            if (cuitInput) cuitInput.value = '';

            // Mostrar/ocultar campos según lo que ya tiene
            const emailContainer = document.getElementById('campoEmailContainer');
            const telefonoContainer = document.getElementById('campoTelefonoContainer');
            const documentoContainer = document.getElementById('campoDocumentoContainer');
            const cuitContainer = document.getElementById('campoCuitContainer');

            // Necesita email O teléfono - mostrar los que falten
            const necesitaContacto = !tieneEmail && !tieneTelefono;

            // Mostrar campo email si no tiene email (y necesita contacto)
            if (emailContainer) {
                emailContainer.style.display = (!tieneEmail) ? 'block' : 'none';
            }

            // Mostrar campo teléfono si no tiene teléfono (y necesita contacto)
            if (telefonoContainer) {
                telefonoContainer.style.display = (!tieneTelefono) ? 'block' : 'none';
            }

            // Si ya tiene documento (DNI o CUIT), ocultar campos de documento
            // Con tener 1 de los 2 ya está completo
            if (tieneDocumento) {
                if (documentoContainer) documentoContainer.style.display = 'none';
                if (cuitContainer) cuitContainer.style.display = 'none';
            } else {
                if (documentoContainer) documentoContainer.style.display = 'block';
                if (cuitContainer) cuitContainer.style.display = 'block';
            }

            // Limpiar mensaje de guardado
            const mensajeGuardado = document.getElementById('mensajeGuardadoCliente');
            if (mensajeGuardado) mensajeGuardado.innerHTML = '';
        }
        clienteValido = false;
    }

    // Habilitar/deshabilitar botón de confirmar
    if (confirmSubmitBtn) {
        confirmSubmitBtn.disabled = !clienteValido;
        if (!clienteValido) {
            confirmSubmitBtn.title = 'Complete los datos del cliente para confirmar';
        } else {
            confirmSubmitBtn.title = '';
        }
    }

    confirmModal.show();
}

if (confirmForm) {
    confirmForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const presupuestoId = confirmForm.dataset.presupuestoId;
        if (!presupuestoId) {
            return;
        }
        if (confirmSubmitBtn) {
            confirmSubmitBtn.disabled = true;
        }
        if (confirmSpinner) {
            confirmSpinner.classList.remove('d-none');
        }
        if (confirmMessage) {
            confirmMessage.classList.add('d-none');
            confirmMessage.textContent = '';
        }

        const payload = {
            crear_tareas: checkboxCrearTareas ? checkboxCrearTareas.checked : true,
            normalizar_slugs: checkboxNormalizarSlugs ? checkboxNormalizarSlugs.checked : true,
        };

        const headers = {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
        };
        const csrf = document.querySelector('meta[name="csrf-token"]');
        if (csrf) {
            headers['X-CSRFToken'] = csrf.getAttribute('content');
        }

        try {
            const response = await fetch(`/presupuestos/${presupuestoId}/confirmar-obra`, {
                method: 'POST',
                headers,
                body: JSON.stringify(payload),
            });
            const result = await response.json().catch(() => ({}));
            if (!response.ok || result.error) {
                const mensaje = result.error || 'No se pudo confirmar el presupuesto. Intenta nuevamente.';
                if (confirmMessage) {
                    confirmMessage.textContent = mensaje;
                    confirmMessage.classList.remove('d-none');
                } else {
                    showAlert(mensaje, 'danger');
                }
                return;
            }

            if (confirmModal) {
                confirmModal.hide();
            }

            if (result.redirect_url) {
                window.location.href = result.redirect_url;
                return;
            }

            actualizarTarjetaTrasConfirmacion(presupuestoId, result);

            const mensajeExito = result.message || 'Obra creada correctamente.';
            showAlert(mensajeExito, 'success');
        } catch (error) {
            console.error(error);
            if (confirmMessage) {
                confirmMessage.textContent = 'No se pudo confirmar el presupuesto. Intenta nuevamente.';
                confirmMessage.classList.remove('d-none');
            } else {
                showAlert('No se pudo confirmar el presupuesto. Intenta nuevamente.', 'danger');
            }
        } finally {
            if (confirmSubmitBtn) {
                confirmSubmitBtn.disabled = false;
            }
            if (confirmSpinner) {
                confirmSpinner.classList.add('d-none');
            }
        }
    });
}

function actualizarTarjetaTrasConfirmacion(presupuestoId, payload) {
    const card = document.querySelector(`[data-presupuesto-card="${presupuestoId}"]`);
    if (!card) {
        return;
    }
    const wrapper = card.closest('[data-presupuesto-wrapper]');
    const estadoAnterior = card.dataset.presupuestoEstado || '';
    const nuevoEstado = payload.presupuesto_estado || 'confirmado';
    card.dataset.presupuestoEstado = nuevoEstado;

    const badge = card.querySelector(`[data-presupuesto-estado-badge="${presupuestoId}"]`);
    if (badge) {
        badge.className = 'badge bg-success';
        const texto = nuevoEstado.replace(/_/g, ' ');
        badge.textContent = texto.charAt(0).toUpperCase() + texto.slice(1);
    }

    const container = card.querySelector('[data-confirm-container]');
    if (container) {
        const btn = container.querySelector('.btn-confirmar-presupuesto');
        if (btn) {
            btn.remove();
        }
        if (payload.obra_url) {
            const enlace = document.createElement('a');
            enlace.href = payload.obra_url;
            enlace.className = 'btn btn-success';
            enlace.innerHTML = '<i class="fas fa-project-diagram me-1"></i>Ir a la obra';
            enlace.setAttribute('aria-label', 'Ir a la obra creada');
            container.prepend(enlace);
        }
    }

    if (wrapper) {
        wrapper.style.transition = 'opacity 0.25s ease';
        wrapper.style.opacity = '0';
        setTimeout(() => {
            wrapper.remove();
            mostrarEmptyStateSiCorresponde();
        }, 250);
        return;
    }

    if (estadoAnterior === 'borrador' && nuevoEstado !== 'borrador') {
        setTimeout(() => {
            card.remove();
            mostrarEmptyStateSiCorresponde();
        }, 200);
    }
}

function mostrarEmptyStateSiCorresponde() {
    const wrappers = document.querySelectorAll('[data-presupuesto-wrapper]');
    const emptyState = document.querySelector('[data-presupuestos-empty]');
    if (!emptyState) {
        return;
    }
    if (wrappers.length === 0) {
        emptyState.classList.remove('d-none');
        emptyState.removeAttribute('aria-hidden');
    }
}

let presupuestoSeleccionado = null;
const modalPerdidoEl = document.getElementById('modalMarcarPerdido');
const modalPerdido = modalPerdidoEl ? new bootstrap.Modal(modalPerdidoEl) : null;
const botonConfirmarPerdido = document.getElementById('btnConfirmarPerdido');
if (botonConfirmarPerdido) {
    botonConfirmarPerdido.addEventListener('click', confirmarMarcarPerdido);
}

function abrirPerderModal(id, numero) {
    if (!modalPerdido) return;
    presupuestoSeleccionado = { id, numero };
    document.getElementById('perderPresupuestoNumero').textContent = numero;
    document.getElementById('motivoPerdido').value = '';
    document.getElementById('detallePerdido').value = '';
    modalPerdido.show();
}

async function confirmarMarcarPerdido() {
    if (!presupuestoSeleccionado) return;
    const motivo = document.getElementById('motivoPerdido').value.trim();
    const detalle = document.getElementById('detallePerdido').value.trim();

    if (!motivo && !detalle) {
        showAlert('Selecciona un motivo o agrega un detalle para registrar el motivo.', 'warning');
        return;
    }

    try {
        const response = await fetch(`/presupuestos/${presupuestoSeleccionado.id}/perder`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ motivo, detalle })
        });

        const result = await response.json().catch(() => ({}));
        if (!response.ok) {
            showAlert(result.error || 'Error al marcar el presupuesto como perdido.', 'danger');
            return;
        }

        if (modalPerdido) {
            modalPerdido.hide();
        }
        showAlert(result.mensaje || 'Presupuesto marcado como perdido.', 'success');
        setTimeout(() => window.location.reload(), 800);
    } catch (error) {
        console.error(error);
        showAlert('No se pudo completar la operación. Intenta nuevamente.', 'danger');
    }
}

async function restaurarPresupuesto(id) {
    if (!confirm('¿Restaurar este presupuesto a borrador?')) {
        return;
    }

    try {
        const response = await fetch(`/presupuestos/${id}/restaurar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const result = await response.json().catch(() => ({}));
        if (!response.ok) {
            showAlert(result.error || 'Error al restaurar el presupuesto.', 'danger');
            return;
        }

        showAlert(result.mensaje || 'Presupuesto restaurado a borrador.', 'success');
        setTimeout(() => window.location.reload(), 800);
    } catch (error) {
        console.error(error);
        showAlert('No se pudo completar la operación. Intenta nuevamente.', 'danger');
    }
}

async function revertirABorrador(id, numero) {
    if (!confirm(`¿Revertir el presupuesto ${numero} a estado BORRADOR?\n\nEsto permitirá editarlo y eliminarlo nuevamente. Si ya fue confirmado como obra, deberás manejar eso por separado.`)) {
        return;
    }

    try {
        const response = await fetch(`/presupuestos/${id}/revertir-borrador`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const result = await response.json().catch(() => ({}));
        if (!response.ok) {
            showAlert(result.error || 'Error al revertir el presupuesto.', 'danger');
            return;
        }

        showAlert(result.mensaje || 'Presupuesto revertido a borrador exitosamente.', 'success');
        setTimeout(() => window.location.reload(), 800);
    } catch (error) {
        console.error(error);
        showAlert('No se pudo completar la operación. Intenta nuevamente.', 'danger');
    }
}

async function eliminarPresupuesto(id, numero) {
    if (!confirm(`¿Eliminar el presupuesto ${numero}? Esta acción lo archivará y podrás verlo solo desde el filtro de eliminados.`)) {
        return;
    }

    try {
        // Obtener el token CSRF del meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

        const headers = {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        };

        // Agregar token CSRF en header si existe
        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }

        // Crear body con token CSRF
        const body = JSON.stringify({
            csrf_token: csrfToken
        });

        const response = await fetch(`/presupuestos/${id}/eliminar`, {
            method: 'POST',
            headers: headers,
            body: body
        });

        const result = await response.json().catch(() => ({}));
        if (!response.ok) {
            showAlert(result.error || 'Error al eliminar el presupuesto.', 'danger');
            return;
        }

        showAlert(result.mensaje || 'Presupuesto eliminado correctamente.', 'success');
        setTimeout(() => window.location.reload(), 800);
    } catch (error) {
        console.error('Error al eliminar:', error);
        showAlert('No se pudo completar la operación. Intenta nuevamente.', 'danger');
    }
}

function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alertDiv);

    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

// ========================================
// Guardado inline de datos del cliente
// ========================================
const btnGuardarClienteInline = document.getElementById('btnGuardarClienteInline');
const clienteIdEditar = document.getElementById('clienteIdEditar');
const clienteEmailInline = document.getElementById('clienteEmailInline');
const clienteTelefonoInline = document.getElementById('clienteTelefonoInline');
const clienteDocumentoInline = document.getElementById('clienteDocumentoInline');
const clienteCuitInline = document.getElementById('clienteCuitInline');
const mensajeGuardadoCliente = document.getElementById('mensajeGuardadoCliente');

if (btnGuardarClienteInline) {
    btnGuardarClienteInline.addEventListener('click', guardarClienteInline);
}

async function guardarClienteInline() {
    const clienteId = clienteIdEditar ? clienteIdEditar.value : null;
    if (!clienteId) {
        showAlert('No se pudo identificar el cliente', 'danger');
        return;
    }

    const email = clienteEmailInline ? clienteEmailInline.value.trim() : '';
    const telefono = clienteTelefonoInline ? clienteTelefonoInline.value.trim() : '';
    const documento = clienteDocumentoInline ? clienteDocumentoInline.value.trim() : '';
    const cuit = clienteCuitInline ? clienteCuitInline.value.trim() : '';

    // Obtener datos actuales del cliente (qué ya tiene)
    const yaTeníaEmail = presupuestoSeleccionadoConfirmacion?.dataset.clienteTieneEmail === 'true';
    const yaTeníaTelefono = presupuestoSeleccionadoConfirmacion?.dataset.clienteTieneTelefono === 'true';
    const yaTeníaDocumento = presupuestoSeleccionadoConfirmacion?.dataset.clienteTieneDocumento === 'true';

    // Validar: necesita email O teléfono (al menos 1)
    const tieneContacto = email || telefono || yaTeníaEmail || yaTeníaTelefono;
    if (!tieneContacto) {
        showAlert('Debe ingresar al menos un email o teléfono', 'warning');
        return;
    }

    // Validar: necesita DNI O CUIT (al menos 1)
    const tieneIdentificacion = documento || cuit || yaTeníaDocumento;
    if (!tieneIdentificacion) {
        showAlert('Debe ingresar DNI o CUIT', 'warning');
        return;
    }

    // Deshabilitar botón mientras guarda
    btnGuardarClienteInline.disabled = true;
    btnGuardarClienteInline.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Guardando...';

    try {
        const formData = new FormData();
        if (email) formData.append('email', email);
        if (telefono) formData.append('telefono', telefono);
        if (documento) formData.append('documento', documento);
        if (cuit) formData.append('cuit', cuit);

        const headers = {
            'X-Requested-With': 'XMLHttpRequest',
        };
        const csrf = document.querySelector('meta[name="csrf-token"]');
        if (csrf) {
            headers['X-CSRFToken'] = csrf.getAttribute('content');
        }

        const response = await fetch(`/clientes/${clienteId}/actualizar-rapido`, {
            method: 'POST',
            headers,
            body: formData,
        });

        const result = await response.json();

        if (response.ok && result.exito) {
            // Éxito - actualizar UI
            if (mensajeGuardadoCliente) {
                mensajeGuardadoCliente.innerHTML = '<i class="fas fa-check-circle text-success me-1"></i>Guardado';
            }

            // Ocultar alerta de cliente incompleto
            if (alertaClienteIncompleto) {
                alertaClienteIncompleto.classList.add('d-none');
            }

            // Habilitar botón de confirmar
            if (confirmSubmitBtn) {
                confirmSubmitBtn.disabled = false;
                confirmSubmitBtn.title = '';
            }

            // Actualizar data-attributes del botón original
            if (presupuestoSeleccionadoConfirmacion) {
                presupuestoSeleccionadoConfirmacion.dataset.clienteCompleto = 'true';
                presupuestoSeleccionadoConfirmacion.dataset.clienteTieneEmail = email ? 'true' : presupuestoSeleccionadoConfirmacion.dataset.clienteTieneEmail;
                presupuestoSeleccionadoConfirmacion.dataset.clienteTieneTelefono = telefono ? 'true' : presupuestoSeleccionadoConfirmacion.dataset.clienteTieneTelefono;
                presupuestoSeleccionadoConfirmacion.dataset.clienteTieneDocumento = (documento || cuit) ? 'true' : 'false';
            }

            showAlert('Datos del cliente actualizados correctamente', 'success');

        } else {
            showAlert(result.error || 'Error al guardar los datos del cliente', 'danger');
        }
    } catch (error) {
        console.error('Error guardando cliente:', error);
        showAlert('Error de conexión al guardar los datos', 'danger');
    } finally {
        btnGuardarClienteInline.disabled = false;
        btnGuardarClienteInline.innerHTML = '<i class="fas fa-save me-1"></i>Guardar y continuar';
    }
}

// ========================================
// Asignar cliente desde modal (sin cliente)
// ========================================
const selectClienteExistente = document.getElementById('selectClienteExistente');
const btnCrearClienteRapido = document.getElementById('btnCrearClienteRapido');

// Cargar lista de clientes cuando se muestra la alerta de sin cliente
async function cargarClientesExistentes() {
    if (!selectClienteExistente) return;

    try {
        const response = await fetch('/clientes/api/listar');
        const clientes = await response.json();

        // Limpiar opciones existentes
        selectClienteExistente.innerHTML = '<option value="">-- Seleccionar cliente --</option>';

        clientes.forEach(cliente => {
            const option = document.createElement('option');
            option.value = cliente.id;
            option.textContent = cliente.empresa
                ? `${cliente.empresa} - ${cliente.nombre_completo}`
                : cliente.nombre_completo;
            option.dataset.nombre = cliente.nombre_completo;
            option.dataset.email = cliente.email || '';
            option.dataset.telefono = cliente.telefono || '';
            selectClienteExistente.appendChild(option);
        });
    } catch (error) {
        console.error('Error cargando clientes:', error);
    }
}

// Asignar cliente existente al presupuesto
if (selectClienteExistente) {
    selectClienteExistente.addEventListener('change', async function() {
        const clienteId = this.value;
        if (!clienteId || !presupuestoSeleccionadoConfirmacion) return;

        const presupuestoId = presupuestoSeleccionadoConfirmacion.dataset.presupuestoId;
        const selectedOption = this.options[this.selectedIndex];

        try {
            const headers = {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
            };
            const csrf = document.querySelector('meta[name="csrf-token"]');
            if (csrf) {
                headers['X-CSRFToken'] = csrf.getAttribute('content');
            }

            const response = await fetch(`/presupuestos/${presupuestoId}/asignar-cliente`, {
                method: 'POST',
                headers,
                body: JSON.stringify({ cliente_id: clienteId }),
            });

            const result = await response.json();

            if (response.ok && result.exito) {
                // Actualizar UI
                showAlert('Cliente asignado correctamente', 'success');

                // Actualizar data-attributes
                presupuestoSeleccionadoConfirmacion.dataset.clienteId = clienteId;
                presupuestoSeleccionadoConfirmacion.dataset.clienteCompleto = 'true';
                presupuestoSeleccionadoConfirmacion.dataset.cliente = selectedOption.dataset.nombre;

                // Actualizar campo cliente en el modal
                if (campoCliente) {
                    campoCliente.textContent = selectedOption.dataset.nombre;
                }

                // Ocultar alerta de sin cliente
                if (alertaSinCliente) alertaSinCliente.classList.add('d-none');

                // Habilitar botón de confirmar
                if (confirmSubmitBtn) {
                    confirmSubmitBtn.disabled = false;
                    confirmSubmitBtn.title = '';
                }
            } else {
                showAlert(result.error || 'Error al asignar cliente', 'danger');
            }
        } catch (error) {
            console.error('Error asignando cliente:', error);
            showAlert('Error de conexión', 'danger');
        }
    });
}

// Crear cliente nuevo y asignar
if (btnCrearClienteRapido) {
    btnCrearClienteRapido.addEventListener('click', async function() {
        if (!presupuestoSeleccionadoConfirmacion) return;

        const nombre = document.getElementById('nuevoClienteNombre')?.value.trim();
        const apellido = document.getElementById('nuevoClienteApellido')?.value.trim() || '';
        const email = document.getElementById('nuevoClienteEmail')?.value.trim();
        const telefono = document.getElementById('nuevoClienteTelefono')?.value.trim();
        const tipoDoc = document.getElementById('nuevoClienteTipoDoc')?.value;
        const numDoc = document.getElementById('nuevoClienteNumDoc')?.value.trim();

        // Validaciones
        if (!nombre) {
            showAlert('Ingrese el nombre o razón social', 'warning');
            return;
        }
        if (!email) {
            showAlert('Ingrese el email del cliente', 'warning');
            return;
        }
        if (!numDoc) {
            showAlert('Ingrese el número de documento', 'warning');
            return;
        }

        const presupuestoId = presupuestoSeleccionadoConfirmacion.dataset.presupuestoId;

        // Deshabilitar botón
        btnCrearClienteRapido.disabled = true;
        btnCrearClienteRapido.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creando...';

        try {
            const headers = {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
            };
            const csrf = document.querySelector('meta[name="csrf-token"]');
            if (csrf) {
                headers['X-CSRFToken'] = csrf.getAttribute('content');
            }

            // Crear cliente y asignar en un solo request
            const response = await fetch(`/presupuestos/${presupuestoId}/crear-asignar-cliente`, {
                method: 'POST',
                headers,
                body: JSON.stringify({
                    nombre,
                    apellido,
                    email,
                    telefono,
                    tipo_documento: tipoDoc,
                    numero_documento: numDoc
                }),
            });

            const result = await response.json();

            if (response.ok && result.exito) {
                showAlert('Cliente creado y asignado correctamente', 'success');

                // Actualizar data-attributes
                presupuestoSeleccionadoConfirmacion.dataset.clienteId = result.cliente_id;
                presupuestoSeleccionadoConfirmacion.dataset.clienteCompleto = 'true';
                presupuestoSeleccionadoConfirmacion.dataset.cliente = result.cliente_nombre;

                // Actualizar campo cliente en el modal
                if (campoCliente) {
                    campoCliente.textContent = result.cliente_nombre;
                }

                // Ocultar alerta de sin cliente
                if (alertaSinCliente) alertaSinCliente.classList.add('d-none');

                // Habilitar botón de confirmar
                if (confirmSubmitBtn) {
                    confirmSubmitBtn.disabled = false;
                    confirmSubmitBtn.title = '';
                }

                // Limpiar formulario
                document.getElementById('nuevoClienteNombre').value = '';
                document.getElementById('nuevoClienteApellido').value = '';
                document.getElementById('nuevoClienteEmail').value = '';
                document.getElementById('nuevoClienteTelefono').value = '';
                document.getElementById('nuevoClienteNumDoc').value = '';
            } else {
                showAlert(result.error || 'Error al crear cliente', 'danger');
            }
        } catch (error) {
            console.error('Error creando cliente:', error);
            showAlert('Error de conexión', 'danger');
        } finally {
            btnCrearClienteRapido.disabled = false;
            btnCrearClienteRapido.innerHTML = '<i class="fas fa-plus me-1"></i>Crear y asignar cliente';
        }
    });
}

// Modificar abrirModalConfirmacion para cargar clientes si no hay cliente
const originalAbrirModal = abrirModalConfirmacion;
abrirModalConfirmacion = function(button) {
    originalAbrirModal(button);

    // Si no hay cliente, cargar lista de clientes existentes
    const clienteId = button.dataset.clienteId;
    if (!clienteId) {
        cargarClientesExistentes();
    }
};
</script>

{% endblock %}
