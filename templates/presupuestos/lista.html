{% extends "base.html" %}

{% block title %}Presupuestos - OBYRA IA{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-calculator me-2"></i>Gestión de Presupuestos</h2>
                {% if current_user.rol in ['administrador', 'tecnico'] %}
                <div class="btn-group" role="group">
                    <a href="{{ url_for('presupuestos.crear') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Nuevo Presupuesto
                    </a>
                    {% if mostrar_calculadora_ia_header and has_endpoint('cotizacion.calculadora_inteligente') %}
                    <a href="{{ url_for('cotizacion.calculadora_inteligente') }}" class="btn btn-success">
                        <i class="fas fa-brain me-1"></i>Calculadora IA
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label for="estado" class="form-label">Estado</label>
                    <select class="form-select" id="estado" name="estado">
                        <option value="">Todos los estados</option>
                        <option value="borrador" {{ 'selected' if estado == 'borrador' }}>Borrador</option>
                        <option value="enviado" {{ 'selected' if estado == 'enviado' }}>Enviado</option>
                        <option value="aprobado" {{ 'selected' if estado == 'aprobado' }}>Aprobado</option>
                        <option value="confirmado" {{ 'selected' if estado == 'confirmado' }}>Confirmado</option>
                        <option value="rechazado" {{ 'selected' if estado == 'rechazado' }}>Rechazado</option>
                        <option value="perdido" {{ 'selected' if estado == 'perdido' }}>Perdido</option>
                        <option value="vencido" {{ 'selected' if estado == 'vencido' }}>Vencido</option>
                        {% if current_user.rol == 'administrador' %}
                        <option value="eliminado" {{ 'selected' if estado == 'eliminado' }}>Eliminado</option>
                        {% endif %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="vigencia" class="form-label">Vigencia</label>
                    <select class="form-select" id="vigencia" name="vigencia">
                        <option value="">Todas</option>
                        <option value="por_vencer" {{ 'selected' if vigencia == 'por_vencer' }}>Por vencer (7 días)</option>
                        <option value="vencidos" {{ 'selected' if vigencia == 'vencidos' }}>Vencidos</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="buscar" class="form-label">Buscar</label>
                    <input type="text" class="form-control" id="buscar" name="buscar"
                           value="{{ buscar }}" placeholder="Número, obra o cliente...">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-outline-primary me-2">
                        <i class="fas fa-search me-1"></i>Filtrar
                    </button>
                    <a href="{{ url_for('presupuestos.lista') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i>Limpiar
                    </a>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Lista de presupuestos -->
    <div class="row">
        {% if presupuestos %}
            {% for presupuesto in presupuestos %}
            <div class="col-lg-6 col-xl-4 mb-4" data-presupuesto-wrapper="{{ presupuesto.id }}">
                <div class="card h-100 shadow-sm" id="presupuesto-card-{{ presupuesto.id }}"
                     data-presupuesto-card="{{ presupuesto.id }}"
                     data-presupuesto-estado="{{ presupuesto.estado }}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 fw-bold">{{ presupuesto.numero }}</h6>
                        <span class="badge {{ presupuesto.estado|estado_badge }}"
                              data-presupuesto-estado-badge="{{ presupuesto.id }}">
                            {{ presupuesto.estado.title() }}
                        </span>
                    </div>
                    {% set datos_raw = presupuesto.datos_proyecto %}
                    {% set proyecto_json = datos_raw|from_json if datos_raw else {} %}
                    {# Prioridad: obra > datos_proyecto.nombre_obra > datos_proyecto.nombre > ubicacion_texto #}
                    {% set nombre_proyecto = presupuesto.obra.nombre if presupuesto.obra else (proyecto_json.nombre_obra if proyecto_json and proyecto_json.nombre_obra else (proyecto_json.nombre if proyecto_json and proyecto_json.nombre else (presupuesto.ubicacion_normalizada or presupuesto.ubicacion_texto or 'Sin ubicación definida'))) %}
                    {# Prioridad: obra > cliente relacion > datos_proyecto.cliente_nombre > datos_proyecto.cliente #}
                    {% set cliente_proyecto = presupuesto.obra.cliente if presupuesto.obra else (presupuesto.cliente.nombre_completo if presupuesto.cliente else (proyecto_json.cliente_nombre if proyecto_json and proyecto_json.cliente_nombre else (proyecto_json.cliente if proyecto_json and proyecto_json.cliente else 'Cliente por confirmar'))) %}
                    {% set ubicacion_proyecto = presupuesto.ubicacion_normalizada or presupuesto.ubicacion_texto or (proyecto_json.ubicacion if proyecto_json and proyecto_json.ubicacion else None) %}
                    <div class="card-body">
                        <h6 class="card-title">{{ nombre_proyecto }}</h6>
                        <p class="text-muted mb-2">
                            <i class="fas fa-user me-1"></i>{{ cliente_proyecto }}
                        </p>
                        <p class="text-muted mb-3">
                            <i class="fas fa-calendar me-1"></i>{{ presupuesto.fecha|fecha }}
                            {% if presupuesto.fecha_vigencia %}
                                {% set dias_restantes = presupuesto.dias_restantes_vigencia %}
                                <span class="badge {{ presupuesto.clase_vigencia_badge }} ms-2">
                                    {% if presupuesto.esta_vencido %}
                                        <i class="fas fa-exclamation-triangle me-1"></i>Vencido el {{ presupuesto.fecha_vigencia.strftime('%d/%m/%Y') }}
                                    {% else %}
                                        <i class="fas fa-hourglass-half me-1"></i>{{ presupuesto.fecha_vigencia.strftime('%d/%m/%Y') }}
                                        {% if dias_restantes is not none %}
                                            <span class="ms-1">(faltan {{ dias_restantes }} días)</span>
                                        {% endif %}
                                    {% endif %}
                                </span>
                            {% endif %}
                        </p>

                        <div class="d-flex align-items-center gap-2 mb-3">
                            <span class="badge bg-light text-dark border">{{ presupuesto.currency }}</span>
                            {% if presupuesto.currency != 'ARS' and presupuesto.tasa_usd_venta %}
                                <span class="text-muted small">
                                    TC {{ presupuesto.exchange_rate_provider|upper if presupuesto.exchange_rate_provider else 'BNA' }}
                                    {{ presupuesto.tasa_usd_venta|moneda('ARS') }}
                                </span>
                            {% endif %}
                            {% if presupuesto.indice_cac_valor %}
                                <span class="text-muted small">
                                    CAC {{ '{:,.0f}'.format(presupuesto.indice_cac_valor) }}
                                </span>
                            {% endif %}
                        </div>

                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <small class="text-muted d-block">Sin IVA</small>
                                <strong class="text-primary">{{ presupuesto.total_sin_iva|moneda(presupuesto.currency) }}</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Total</small>
                                <strong class="text-success">{{ presupuesto.total_con_iva|moneda(presupuesto.currency) }}</strong>
                            </div>
                        </div>

                        {% if presupuesto.estado == 'perdido' %}
                        <div class="alert alert-warning py-2">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-archive me-2 mt-1"></i>
                                <div>
                                    <strong>Presupuesto perdido</strong>
                                    {% if presupuesto.perdido_motivo %}
                                    <div class="small mt-1">{{ presupuesto.perdido_motivo }}</div>
                                    {% endif %}
                                    {% if presupuesto.perdido_fecha %}
                                    <div class="small text-muted mt-1">{{ presupuesto.perdido_fecha.strftime('%d/%m/%Y %H:%M') }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                    {% if presupuesto.items.count() > 0 %}
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="fas fa-list me-1"></i>{{ presupuesto.items.count() }} items
                        </small>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-footer bg-transparent" data-presupuesto-footer="{{ presupuesto.id }}">
                        <div class="d-grid gap-2" data-confirm-container="{{ presupuesto.id }}">
                            {% set es_admin = tiene_rol('admin') or (current_user.is_authenticated and current_user.es_admin()) %}
                            {% if not presupuesto.confirmado_como_obra and not presupuesto.obra_id and es_admin and presupuesto.estado in ['borrador', 'enviado'] %}
                            <button type="button" class="btn btn-success btn-sm btn-confirmar-presupuesto"
                                    data-action="abrir-confirmar"
                                    data-presupuesto-id="{{ presupuesto.id }}"
                                    data-numero="{{ presupuesto.numero }}"
                                    data-cliente="{{ cliente_proyecto|e }}"
                                    data-obra="{{ nombre_proyecto|e }}"
                                    data-ubicacion="{{ (ubicacion_proyecto or 'Ubicación no especificada')|e }}"
                                    data-ubicacion-valid="{{ 'true' if presupuesto.geocode_status == 'ok' or (presupuesto.geo_latitud and presupuesto.geo_longitud) else 'false' }}"
                                    data-moneda="{{ presupuesto.currency }}"
                                    data-currency-symbol="{{ '$' if presupuesto.currency == 'ARS' else 'USD' }}"
                                    data-tasa="{{ presupuesto.tasa_usd_venta|moneda('ARS') if presupuesto.currency != 'ARS' and presupuesto.tasa_usd_venta else '' }}"
                                    data-tasa-provider="{{ presupuesto.exchange_rate_provider or 'bna' }}"
                                    data-cac="{{ '{:,.0f}'.format(presupuesto.indice_cac_valor) if presupuesto.indice_cac_valor else '' }}"
                                    data-cac-fecha="{{ presupuesto.indice_cac_fecha.strftime('%m/%Y') if presupuesto.indice_cac_fecha else '' }}"
                                    data-subtotal-materiales="{{ presupuesto.subtotal_materiales|moneda(presupuesto.currency) }}"
                                    data-subtotal-mano-obra="{{ presupuesto.subtotal_mano_obra|moneda(presupuesto.currency) }}"
                                    data-subtotal-equipos="{{ presupuesto.subtotal_equipos|moneda(presupuesto.currency) }}"
                                    data-total="{{ presupuesto.total_con_iva|moneda(presupuesto.currency) }}"
                                    data-geo-lat="{{ presupuesto.geo_latitud if presupuesto.geo_latitud is not none else '' }}"
                                    data-geo-lng="{{ presupuesto.geo_longitud if presupuesto.geo_longitud is not none else '' }}"
                                    data-geocode-status="{{ presupuesto.geocode_status or '' }}"
                                    data-geocode-provider="{{ presupuesto.geocode_provider or '' }}"
                                    aria-label="Confirmar presupuesto {{ presupuesto.numero }} y crear obra">
                                <i class="fas fa-check-circle me-1"></i>Confirmar
                            </button>
                            {% endif %}
                            {% if presupuesto.estado == 'eliminado' %}
                            <button class="btn btn-outline-secondary" disabled>
                                <i class="fas fa-box-archive me-1"></i>Presupuesto eliminado
                            </button>
                            {% else %}
                            <a href="{{ url_for('presupuestos.detalle', id=presupuesto.id) }}"
                               class="btn btn-outline-primary">
                                <i class="fas fa-eye me-1"></i>Ver Detalles
                            </a>
                            {% if presupuesto.items.count() > 0 %}
                            <a href="{{ url_for('presupuestos.generar_pdf', id=presupuesto.id) }}"
                               class="btn btn-outline-success btn-sm w-100" target="_blank">
                                <i class="fas fa-file-pdf me-1"></i>Descargar PDF
                            </a>
                            {# El botón de enviar por correo aparece si el presupuesto NO está confirmado como obra #}
                            {% if not presupuesto.confirmado_como_obra %}
                            <a href="{{ url_for('presupuestos.enviar_email', id=presupuesto.id) }}" class="btn btn-outline-info btn-sm w-100">
                                <i class="fas fa-envelope me-1"></i>Enviar por correo
                            </a>
                            {% endif %}
                            {% endif %}
                            {% endif %}

                            {% if (es_admin or tiene_rol('tecnico')) and presupuesto.estado == 'borrador' %}
                            <button class="btn btn-outline-warning btn-sm" onclick="abrirPerderModal({{ presupuesto.id }}, '{{ presupuesto.numero }}')">
                                <i class="fas fa-archive me-1"></i>Marcar como perdido
                            </button>
                            {% endif %}

                            {% if (es_admin or tiene_rol('tecnico')) and presupuesto.estado == 'perdido' %}
                            <button class="btn btn-outline-secondary btn-sm" onclick="restaurarPresupuesto({{ presupuesto.id }})">
                                <i class="fas fa-undo me-1"></i>Restaurar a borrador
                            </button>
                            {% endif %}

                            {% if es_admin and presupuesto.estado in ['enviado', 'aprobado', 'rechazado'] %}
                            <button class="btn btn-outline-warning btn-sm" onclick="revertirABorrador({{ presupuesto.id }}, '{{ presupuesto.numero }}')">
                                <i class="fas fa-undo-alt me-1"></i>Revertir a Borrador
                            </button>
                            {% endif %}

                            {% if es_admin and not presupuesto.confirmado_como_obra %}
                            <button class="btn btn-outline-danger btn-sm" onclick="eliminarPresupuesto({{ presupuesto.id }}, '{{ presupuesto.numero }}')">
                                <i class="fas fa-trash me-1"></i>Eliminar
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% endif %}
        <div class="col-12 {% if presupuestos %}d-none{% endif %}" data-presupuestos-empty>
            <div class="text-center py-5">
                <i class="fas fa-calculator fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No hay presupuestos registrados</h4>
                <p class="text-muted">
                    {% if current_user.rol in ['administrador', 'tecnico'] %}
                        Comienza creando tu primer presupuesto.
                    {% else %}
                        No hay presupuestos disponibles para visualizar.
                    {% endif %}
                </p>
                {% if current_user.rol in ['administrador', 'tecnico'] %}
                <a href="{{ url_for('presupuestos.crear') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i>Crear Primer Presupuesto
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    </div>
</div>

<div class="modal fade" id="modalConfirmarPresupuesto" tabindex="-1"
     aria-labelledby="modalConfirmarPresupuestoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalConfirmarPresupuestoLabel">
                    Confirmar presupuesto y crear obra
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <form id="confirmarPresupuestoForm">
                <div class="modal-body">
                    <p class="text-muted small mb-3">
                        Revisa los datos clave antes de confirmar. Podrás ajustar las tareas luego desde la obra.
                    </p>
                    <div id="confirmModalMessage" class="alert alert-danger d-none" role="alert"></div>
                    <dl class="row mb-3">
                        <dt class="col-sm-4">Presupuesto</dt>
                        <dd class="col-sm-8 fw-semibold" id="confirmPresupuestoNumero"></dd>
                        <dt class="col-sm-4">Obra</dt>
                        <dd class="col-sm-8" id="confirmPresupuestoObra"></dd>
                        <dt class="col-sm-4">Cliente</dt>
                        <dd class="col-sm-8" id="confirmPresupuestoCliente"></dd>
                        <dt class="col-sm-4">Ubicación</dt>
                        <dd class="col-sm-8" id="confirmPresupuestoUbicacion"></dd>
                        <dt class="col-sm-4">Moneda</dt>
                        <dd class="col-sm-8" id="confirmPresupuestoMoneda"></dd>
                        <dt class="col-sm-4">Tipo de cambio</dt>
                        <dd class="col-sm-8" id="confirmPresupuestoTipoCambio"></dd>
                        <dt class="col-sm-4">Índice CAC</dt>
                        <dd class="col-sm-8" id="confirmPresupuestoCAC"></dd>
                    </dl>
                    <div id="confirmUbicacionEstado" class="mb-3"></div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <div class="border rounded p-3 h-100">
                                <div class="text-muted small">Materiales</div>
                                <div class="fw-semibold" id="confirmSubtotalMateriales"></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border rounded p-3 h-100">
                                <div class="text-muted small">Mano de obra</div>
                                <div class="fw-semibold" id="confirmSubtotalManoObra"></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border rounded p-3 h-100">
                                <div class="text-muted small">Equipos</div>
                                <div class="fw-semibold" id="confirmSubtotalEquipos"></div>
                            </div>
                        </div>
                    </div>
                    <div class="border rounded p-3 mb-3 bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">Total estimado (con IVA)</span>
                            <span class="fs-5 fw-bold" id="confirmTotalGeneral"></span>
                        </div>
                    </div>
                    <div class="border rounded p-3">
                        <input type="hidden" id="confirmPresupuestoId" value="">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="confirmCrearTareas" checked>
                            <label class="form-check-label" for="confirmCrearTareas">
                                Crear tareas sugeridas para cada etapa
                            </label>
                        </div>
                        {# Slug y etapa normalizada se asignan automáticamente - no mostrar como opción #}
                        <input type="hidden" id="confirmNormalizarSlugs" value="true">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-link" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnConfirmarPresupuesto">
                        <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"
                              id="spinnerConfirmarPresupuesto"></span>
                        Confirmar y crear obra
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% include 'presupuestos/_perder_modal.html' %}
{% endblock %}

{% block scripts %}
<script>
const confirmModalEl = document.getElementById('modalConfirmarPresupuesto');
const confirmModal = confirmModalEl ? new bootstrap.Modal(confirmModalEl) : null;
const confirmForm = document.getElementById('confirmarPresupuestoForm');
const confirmMessage = document.getElementById('confirmModalMessage');
const confirmSpinner = document.getElementById('spinnerConfirmarPresupuesto');
const confirmSubmitBtn = document.getElementById('btnConfirmarPresupuesto');
const confirmPresupuestoIdInput = document.getElementById('confirmPresupuestoId');
const campoNumero = document.getElementById('confirmPresupuestoNumero');
const campoObra = document.getElementById('confirmPresupuestoObra');
const campoCliente = document.getElementById('confirmPresupuestoCliente');
const campoUbicacion = document.getElementById('confirmPresupuestoUbicacion');
const campoMoneda = document.getElementById('confirmPresupuestoMoneda');
const campoTipoCambio = document.getElementById('confirmPresupuestoTipoCambio');
const campoIndiceCAC = document.getElementById('confirmPresupuestoCAC');
const campoSubtotalMateriales = document.getElementById('confirmSubtotalMateriales');
const campoSubtotalManoObra = document.getElementById('confirmSubtotalManoObra');
const campoSubtotalEquipos = document.getElementById('confirmSubtotalEquipos');
const campoTotalGeneral = document.getElementById('confirmTotalGeneral');
const campoUbicacionEstado = document.getElementById('confirmUbicacionEstado');
const checkboxCrearTareas = document.getElementById('confirmCrearTareas');
const checkboxNormalizarSlugs = document.getElementById('confirmNormalizarSlugs');
let presupuestoSeleccionadoConfirmacion = null;

const confirmButtons = document.querySelectorAll('.btn-confirmar-presupuesto');
confirmButtons.forEach((btn) => {
    btn.addEventListener('click', () => abrirModalConfirmacion(btn));
});

function abrirModalConfirmacion(button) {
    if (!confirmModal) {
        return;
    }
    presupuestoSeleccionadoConfirmacion = button;
    confirmForm.dataset.presupuestoId = button.dataset.presupuestoId;
    if (confirmPresupuestoIdInput) {
        confirmPresupuestoIdInput.value = button.dataset.presupuestoId || '';
    }
    campoNumero.textContent = button.dataset.numero || '';
    campoObra.textContent = button.dataset.obra || '';
    campoCliente.textContent = button.dataset.cliente || '—';
    campoUbicacion.textContent = button.dataset.ubicacion || 'Ubicación no especificada';
    campoMoneda.textContent = button.dataset.moneda || 'ARS';
    campoTipoCambio.textContent = button.dataset.tasa ? `${button.dataset.tasa} (${(button.dataset.tasaProvider || '').toUpperCase()})` : '—';
    campoIndiceCAC.textContent = button.dataset.cac ? `${button.dataset.cac}${button.dataset.cacFecha ? ' (vigencia ' + button.dataset.cacFecha + ')' : ''}` : '—';
    campoSubtotalMateriales.textContent = button.dataset.subtotalMateriales || '—';
    campoSubtotalManoObra.textContent = button.dataset.subtotalManoObra || '—';
    campoSubtotalEquipos.textContent = button.dataset.subtotalEquipos || '—';
    campoTotalGeneral.textContent = button.dataset.total || '—';

    if (button.dataset.ubicacionValid === 'true') {
        campoUbicacionEstado.innerHTML = '<span class="badge bg-success"><i class="fas fa-map-marker-alt me-1"></i>Ubicación validada correctamente.</span>';
    } else {
        campoUbicacionEstado.innerHTML = '<span class="badge bg-warning text-dark"><i class="fas fa-map-marker-alt me-1"></i>Ubicación pendiente de validación. Se intentará geocodificar al confirmar.</span>';
    }

    if (confirmMessage) {
        confirmMessage.classList.add('d-none');
        confirmMessage.textContent = '';
    }
    if (confirmSpinner) {
        confirmSpinner.classList.add('d-none');
    }
    if (confirmSubmitBtn) {
        confirmSubmitBtn.disabled = false;
    }
    if (checkboxCrearTareas) checkboxCrearTareas.checked = true;
    if (checkboxNormalizarSlugs) checkboxNormalizarSlugs.checked = true;

    confirmModal.show();
}

if (confirmForm) {
    confirmForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const presupuestoId = confirmForm.dataset.presupuestoId;
        if (!presupuestoId) {
            return;
        }
        if (confirmSubmitBtn) {
            confirmSubmitBtn.disabled = true;
        }
        if (confirmSpinner) {
            confirmSpinner.classList.remove('d-none');
        }
        if (confirmMessage) {
            confirmMessage.classList.add('d-none');
            confirmMessage.textContent = '';
        }

        const payload = {
            crear_tareas: checkboxCrearTareas ? checkboxCrearTareas.checked : true,
            normalizar_slugs: checkboxNormalizarSlugs ? checkboxNormalizarSlugs.checked : true,
        };

        const headers = {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
        };
        const csrf = document.querySelector('meta[name="csrf-token"]');
        if (csrf) {
            headers['X-CSRFToken'] = csrf.getAttribute('content');
        }

        try {
            const response = await fetch(`/presupuestos/${presupuestoId}/confirmar-obra`, {
                method: 'POST',
                headers,
                body: JSON.stringify(payload),
            });
            const result = await response.json().catch(() => ({}));
            if (!response.ok || result.error) {
                const mensaje = result.error || 'No se pudo confirmar el presupuesto. Intenta nuevamente.';
                if (confirmMessage) {
                    confirmMessage.textContent = mensaje;
                    confirmMessage.classList.remove('d-none');
                } else {
                    showAlert(mensaje, 'danger');
                }
                return;
            }

            if (confirmModal) {
                confirmModal.hide();
            }

            if (result.redirect_url) {
                window.location.href = result.redirect_url;
                return;
            }

            actualizarTarjetaTrasConfirmacion(presupuestoId, result);

            const mensajeExito = result.message || 'Obra creada correctamente.';
            showAlert(mensajeExito, 'success');
        } catch (error) {
            console.error(error);
            if (confirmMessage) {
                confirmMessage.textContent = 'No se pudo confirmar el presupuesto. Intenta nuevamente.';
                confirmMessage.classList.remove('d-none');
            } else {
                showAlert('No se pudo confirmar el presupuesto. Intenta nuevamente.', 'danger');
            }
        } finally {
            if (confirmSubmitBtn) {
                confirmSubmitBtn.disabled = false;
            }
            if (confirmSpinner) {
                confirmSpinner.classList.add('d-none');
            }
        }
    });
}

function actualizarTarjetaTrasConfirmacion(presupuestoId, payload) {
    const card = document.querySelector(`[data-presupuesto-card="${presupuestoId}"]`);
    if (!card) {
        return;
    }
    const wrapper = card.closest('[data-presupuesto-wrapper]');
    const estadoAnterior = card.dataset.presupuestoEstado || '';
    const nuevoEstado = payload.presupuesto_estado || 'confirmado';
    card.dataset.presupuestoEstado = nuevoEstado;

    const badge = card.querySelector(`[data-presupuesto-estado-badge="${presupuestoId}"]`);
    if (badge) {
        badge.className = 'badge bg-success';
        const texto = nuevoEstado.replace(/_/g, ' ');
        badge.textContent = texto.charAt(0).toUpperCase() + texto.slice(1);
    }

    const container = card.querySelector('[data-confirm-container]');
    if (container) {
        const btn = container.querySelector('.btn-confirmar-presupuesto');
        if (btn) {
            btn.remove();
        }
        if (payload.obra_url) {
            const enlace = document.createElement('a');
            enlace.href = payload.obra_url;
            enlace.className = 'btn btn-success';
            enlace.innerHTML = '<i class="fas fa-project-diagram me-1"></i>Ir a la obra';
            enlace.setAttribute('aria-label', 'Ir a la obra creada');
            container.prepend(enlace);
        }
    }

    if (wrapper) {
        wrapper.style.transition = 'opacity 0.25s ease';
        wrapper.style.opacity = '0';
        setTimeout(() => {
            wrapper.remove();
            mostrarEmptyStateSiCorresponde();
        }, 250);
        return;
    }

    if (estadoAnterior === 'borrador' && nuevoEstado !== 'borrador') {
        setTimeout(() => {
            card.remove();
            mostrarEmptyStateSiCorresponde();
        }, 200);
    }
}

function mostrarEmptyStateSiCorresponde() {
    const wrappers = document.querySelectorAll('[data-presupuesto-wrapper]');
    const emptyState = document.querySelector('[data-presupuestos-empty]');
    if (!emptyState) {
        return;
    }
    if (wrappers.length === 0) {
        emptyState.classList.remove('d-none');
        emptyState.removeAttribute('aria-hidden');
    }
}

let presupuestoSeleccionado = null;
const modalPerdidoEl = document.getElementById('modalMarcarPerdido');
const modalPerdido = modalPerdidoEl ? new bootstrap.Modal(modalPerdidoEl) : null;
const botonConfirmarPerdido = document.getElementById('btnConfirmarPerdido');
if (botonConfirmarPerdido) {
    botonConfirmarPerdido.addEventListener('click', confirmarMarcarPerdido);
}

function abrirPerderModal(id, numero) {
    if (!modalPerdido) return;
    presupuestoSeleccionado = { id, numero };
    document.getElementById('perderPresupuestoNumero').textContent = numero;
    document.getElementById('motivoPerdido').value = '';
    document.getElementById('detallePerdido').value = '';
    modalPerdido.show();
}

async function confirmarMarcarPerdido() {
    if (!presupuestoSeleccionado) return;
    const motivo = document.getElementById('motivoPerdido').value.trim();
    const detalle = document.getElementById('detallePerdido').value.trim();

    if (!motivo && !detalle) {
        showAlert('Selecciona un motivo o agrega un detalle para registrar el motivo.', 'warning');
        return;
    }

    try {
        const response = await fetch(`/presupuestos/${presupuestoSeleccionado.id}/perder`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ motivo, detalle })
        });

        const result = await response.json().catch(() => ({}));
        if (!response.ok) {
            showAlert(result.error || 'Error al marcar el presupuesto como perdido.', 'danger');
            return;
        }

        if (modalPerdido) {
            modalPerdido.hide();
        }
        showAlert(result.mensaje || 'Presupuesto marcado como perdido.', 'success');
        setTimeout(() => window.location.reload(), 800);
    } catch (error) {
        console.error(error);
        showAlert('No se pudo completar la operación. Intenta nuevamente.', 'danger');
    }
}

async function restaurarPresupuesto(id) {
    if (!confirm('¿Restaurar este presupuesto a borrador?')) {
        return;
    }

    try {
        const response = await fetch(`/presupuestos/${id}/restaurar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const result = await response.json().catch(() => ({}));
        if (!response.ok) {
            showAlert(result.error || 'Error al restaurar el presupuesto.', 'danger');
            return;
        }

        showAlert(result.mensaje || 'Presupuesto restaurado a borrador.', 'success');
        setTimeout(() => window.location.reload(), 800);
    } catch (error) {
        console.error(error);
        showAlert('No se pudo completar la operación. Intenta nuevamente.', 'danger');
    }
}

async function revertirABorrador(id, numero) {
    if (!confirm(`¿Revertir el presupuesto ${numero} a estado BORRADOR?\n\nEsto permitirá editarlo y eliminarlo nuevamente. Si ya fue confirmado como obra, deberás manejar eso por separado.`)) {
        return;
    }

    try {
        const response = await fetch(`/presupuestos/${id}/revertir-borrador`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const result = await response.json().catch(() => ({}));
        if (!response.ok) {
            showAlert(result.error || 'Error al revertir el presupuesto.', 'danger');
            return;
        }

        showAlert(result.mensaje || 'Presupuesto revertido a borrador exitosamente.', 'success');
        setTimeout(() => window.location.reload(), 800);
    } catch (error) {
        console.error(error);
        showAlert('No se pudo completar la operación. Intenta nuevamente.', 'danger');
    }
}

async function eliminarPresupuesto(id, numero) {
    if (!confirm(`¿Eliminar el presupuesto ${numero}? Esta acción lo archivará y podrás verlo solo desde el filtro de eliminados.`)) {
        return;
    }

    try {
        // Obtener el token CSRF del meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

        const headers = {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        };

        // Agregar token CSRF en header si existe
        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }

        // Crear body con token CSRF
        const body = JSON.stringify({
            csrf_token: csrfToken
        });

        const response = await fetch(`/presupuestos/${id}/eliminar`, {
            method: 'POST',
            headers: headers,
            body: body
        });

        const result = await response.json().catch(() => ({}));
        if (!response.ok) {
            showAlert(result.error || 'Error al eliminar el presupuesto.', 'danger');
            return;
        }

        showAlert(result.mensaje || 'Presupuesto eliminado correctamente.', 'success');
        setTimeout(() => window.location.reload(), 800);
    } catch (error) {
        console.error('Error al eliminar:', error);
        showAlert('No se pudo completar la operación. Intenta nuevamente.', 'danger');
    }
}

function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alertDiv);

    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}
</script>

{% endblock %}
