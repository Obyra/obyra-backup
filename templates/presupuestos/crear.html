{% extends "base.html" %}

{% block title %}Nuevo Presupuesto - OBYRA IA{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-plus text-primary"></i> Nuevo Presupuesto</h2>
                    <p class="text-muted mb-0">Crea un presupuesto completo con análisis inteligente de materiales</p>
                </div>
                <div class="btn-group" role="group">
                    <a href="{{ url_for('presupuestos.lista') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Volver
                    </a>
                    <a href="{{ url_for('presupuestos.calculadora_ia') }}" class="btn btn-success">
                        <i class="fas fa-brain"></i> Calculadora IA
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Formulario Principal -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-building"></i> Información del Proyecto</h5>
                </div>
                <div class="card-body">
                    <form id="nuevoPresupuestoForm" method="POST" enctype="multipart/form-data">
                        <input type="hidden" id="iaEtapasPayload" name="ia_etapas_payload">
                        <input type="hidden" id="presupuestoIdInput" name="presupuesto_id" value="{{ presupuesto.id if presupuesto is defined and presupuesto else '' }}">
                        
                        <!-- Primera fila: Nombre y Tipo de Obra -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="nombre_obra" class="form-label fw-bold">
                                    <i class="fas fa-building text-primary"></i> Nombre de la Obra *
                                </label>
                                <input type="text" class="form-control form-control-lg" 
                                       id="nombre_obra" name="nombre_obra" required
                                       placeholder="Ej: Casa Familiar Rodriguez">
                                <div class="form-text">Nombre descriptivo del proyecto</div>
                            </div>
                            <div class="col-md-6">
                                <label for="tipo_obra" class="form-label fw-bold">
                                    <i class="fas fa-home text-warning"></i> Tipo de Obra *
                                </label>
                                <select class="form-select form-select-lg" id="tipo_obra" name="tipo_obra" required>
                                    <option value="">Seleccionar tipo...</option>
                                    <option value="casa_1_planta">Casa 1 planta</option>
                                    <option value="casa_2_plantas">Casa 2 plantas</option>
                                    <option value="edificio_3_5_pisos">Edificio de 3 a 5 pisos</option>
                                    <option value="edificio_5_10_pisos">Edificio de 5 a 10 pisos</option>
                                </select>
                            </div>
                        </div>

                        <!-- Segunda fila: Ubicación y Tipo de Construcción -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="ubicacion" class="form-label fw-bold">
                                    <i class="fas fa-map-marker-alt text-danger"></i> Ubicación *
                                </label>
                                <input type="text" class="form-control form-control-lg" 
                                       id="ubicacion" name="ubicacion" required
                                       placeholder="Dirección completa o zona">
                                <div class="form-text">Ciudad, provincia o dirección específica</div>
                            </div>
                            <div class="col-md-6">
                                <label for="tipo_construccion" class="form-label fw-bold">
                                    <i class="fas fa-star text-warning"></i> Tipo de Construcción *
                                </label>
                                <select class="form-select form-select-lg" id="tipo_construccion" name="tipo_construccion" required>
                                    <option value="">Seleccionar nivel...</option>
                                    <option value="economica">Económica</option>
                                    <option value="estandar">Estándar</option>
                                    <option value="premium">Premium</option>
                                </select>
                                <div class="form-text">
                                    <small>
                                        <span class="badge bg-light text-dark">Económica: 1.0x</span>
                                        <span class="badge bg-primary">Estándar: 1.3x</span>
                                        <span class="badge bg-warning text-dark">Premium: 1.8x</span>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Tercera fila: Superficie y Fechas -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label for="superficie_m2" class="form-label fw-bold">
                                    <i class="fas fa-ruler-combined text-success"></i> Superficie (m²) *
                                </label>
                                <input type="number" class="form-control form-control-lg" 
                                       id="superficie_m2" name="superficie_m2" 
                                       step="0.01" min="1" required
                                       placeholder="120.50">
                                <div class="form-text">Metros cuadrados totales</div>
                            </div>
                            <div class="col-md-4">
                                <label for="fecha_inicio" class="form-label fw-bold">
                                    <i class="fas fa-calendar-alt text-info"></i> Fecha Inicio
                                </label>
                                <input type="date" class="form-control form-control-lg" 
                                       id="fecha_inicio" name="fecha_inicio">
                                <div class="form-text">Fecha estimada de inicio</div>
                            </div>
                            <div class="col-md-4">
                                <label for="fecha_fin" class="form-label fw-bold">
                                    <i class="fas fa-calendar-check text-info"></i> Fecha Finalización
                                </label>
                                <input type="date" class="form-control form-control-lg" 
                                       id="fecha_fin" name="fecha_fin">
                                <div class="form-text">Fecha estimada de entrega</div>
                            </div>
                        </div>

                        <!-- Cuarta fila: Presupuesto -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="presupuesto_disponible" class="form-label fw-bold">
                                    <i class="fas fa-dollar-sign text-success"></i> Presupuesto Disponible
                                </label>
                                <div class="input-group input-group-lg">
                                    <select class="form-select" id="moneda" name="moneda" style="max-width: 100px;">
                                        <option value="ARS">ARS</option>
                                        <option value="USD">USD</option>
                                    </select>
                                    <input type="number" class="form-control" 
                                           id="presupuesto_disponible" name="presupuesto_disponible" 
                                           step="0.01" min="0" placeholder="0.00">
                                </div>
                                <div class="form-text">Presupuesto máximo disponible (opcional)</div>
                            </div>
                            <div class="col-md-6">
                                <label for="cliente_nombre" class="form-label fw-bold">
                                    <i class="fas fa-user text-secondary"></i> Cliente
                                </label>
                                <input type="text" class="form-control form-control-lg" 
                                       id="cliente_nombre" name="cliente_nombre" 
                                       placeholder="Nombre del cliente">
                                <div class="form-text">Persona o empresa contratante</div>
                        </div>
                    </div>

                    <!-- Quinta fila: Vigencia -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label for="vigencia_dias" class="form-label fw-bold">
                                <i class="fas fa-hourglass-half text-primary"></i> Vigencia (días)
                            </label>
                            <input type="number" class="form-control form-control-lg"
                                   id="vigencia_dias" name="vigencia_dias"
                                   min="1" max="180" value="{{ request.form.get('vigencia_dias', 30) }}"
                                   required>
                            <div class="form-text">Entre 1 y 180 días. Define cuánto tiempo es válido el presupuesto.</div>
                        </div>
                    </div>

                    <!-- Upload de Plano -->
                    <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-file-pdf text-danger"></i> Plano Arquitectónico (PDF)
                            </label>
                            <div class="card border-2 border-dashed" style="border-color: #dee2e6;">
                                <div class="card-body text-center py-4">
                                    <input type="file" class="form-control d-none" 
                                           id="plano_pdf" name="plano_pdf" accept=".pdf"
                                           onchange="mostrarArchivoPlano()">
                                    <div id="dropZone" onclick="document.getElementById('plano_pdf').click();" 
                                         style="cursor: pointer;">
                                        <i class="fas fa-upload fa-2x text-muted mb-2"></i>
                                        <p class="mb-1"><strong>Arrastra y suelta tu plano PDF aquí</strong></p>
                                        <p class="text-muted mb-0">o haz clic para seleccionar archivo</p>
                                    </div>
                                    <div id="archivoPlanoInfo" class="alert alert-info mt-3" style="display: none;">
                                        <i class="fas fa-file-pdf text-danger"></i>
                                        <span id="nombreArchivoPlano"></span>
                                        <button type="button" class="btn btn-sm btn-outline-secondary ms-2" 
                                                onclick="removerArchivo()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-text">
                                <i class="fas fa-info-circle"></i> 
                                Si subes un plano, la IA podrá extraer automáticamente las dimensiones
                            </div>
                        </div>

                        <!-- Sección de Etapas del Proyecto -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <label class="form-label fw-bold mb-0">
                                    <i class="fas fa-tasks text-info"></i> Etapas del Proyecto
                                </label>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="mostrarPanelEtapas()">
                                    <i class="fas fa-plus"></i> Nueva Etapa
                                </button>
                            </div>
                            
                            <!-- Lista de etapas seleccionadas -->
                            <div id="etapasSeleccionadas" class="card bg-light p-3">
                                <div id="listaEtapas" class="text-muted small">
                                    <i class="fas fa-info-circle"></i> No se han seleccionado etapas aún. Haz clic en "Nueva Etapa" para agregar.
                                </div>
                            </div>

                            <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mt-3">
                                <div class="text-muted small">
                                    <i class="fas fa-info-circle"></i>
                                    Marca las etapas que quieres recalcular con IA y ajusta los datos antes de guardar.
                                </div>
                                <div class="d-flex flex-wrap gap-2">
                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="calcularEtapasSeleccionadasIA()">
                                        <i class="fas fa-brain"></i> Calcular etapas seleccionadas con IA
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Botones de acción -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex gap-2 flex-wrap">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-save"></i> Crear Presupuesto
                                    </button>
                                    <button type="button" class="btn btn-success btn-lg" onclick="calcularConIA()">
                                        <i class="fas fa-brain"></i> Calcular con IA
                                    </button>
                                    <button type="button" class="btn btn-outline-success btn-lg" onclick="calcularEtapasSeleccionadasIA()">
                                        <i class="fas fa-layer-group"></i> Calcular etapas seleccionadas con IA
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="limpiarFormulario()">
                                        <i class="fas fa-broom"></i> Limpiar
                                    </button>
                                </div>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>

        <!-- Panel Lateral con información -->
        <div class="col-lg-4">
            
            <!-- Guía rápida -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-lightbulb"></i> Guía Rápida</h6>
                </div>
                <div class="card-body">
                    <div class="small">
                        <p><strong>Para mejores resultados:</strong></p>
                        <ul class="mb-0">
                            <li>Sube un plano PDF para análisis automático</li>
                            <li>Especifica la superficie si no tienes plano</li>
                            <li>Elige el tipo de construcción apropiado</li>
                            <li>Usa "Calcular con IA" para obtener materiales</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Tipos de construcción -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="fas fa-star"></i> Tipos de Construcción</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-12 mb-2">
                            <div class="bg-light p-2 rounded">
                                <strong class="text-success">Económica</strong><br>
                                <small>Materiales básicos, acabados sencillos</small>
                            </div>
                        </div>
                        <div class="col-12 mb-2">
                            <div class="bg-light p-2 rounded">
                                <strong class="text-primary">Estándar</strong><br>
                                <small>Calidad media, acabados intermedios</small>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="bg-light p-2 rounded">
                                <strong class="text-warning">Premium</strong><br>
                                <small>Alta calidad, acabados superiores</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estado del cálculo IA -->
            <div id="calculoIAPanel" class="card shadow-sm" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="fas fa-robot"></i> Cálculo IA Completado</h6>
                </div>
                <div class="card-body">
                    <div id="resultadoIAResumen" class="text-center">
                        <!-- Se completará con JavaScript -->
                    </div>
                    <div class="d-grid mt-3">
                        <button class="btn btn-outline-success btn-sm" onclick="verCalculoCompleto()">
                            <i class="fas fa-eye"></i> Ver Cálculo Completo
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Modal para selección de etapas predefinidas -->
<div class="modal fade" id="modalEtapas" tabindex="-1" aria-labelledby="modalEtapasLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalEtapasLabel">
                    <i class="fas fa-tasks me-2"></i>Seleccionar Etapas del Proyecto
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6 class="mb-3"><i class="fas fa-list-check text-primary"></i> Etapas Predefinidas</h6>
                        <div class="row" id="etapasPredefinidas">
                            <!-- Se cargarán con JavaScript -->
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6 class="mb-3"><i class="fas fa-plus-circle text-success"></i> Etapa Personalizada</h6>
                        <div class="mb-3">
                            <label for="etapaPersonalizadaNombre" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="etapaPersonalizadaNombre" placeholder="Ej: Pintura Especial">
                        </div>
                        <div class="mb-3">
                            <label for="etapaPersonalizadaDescripcion" class="form-label">Descripción</label>
                            <textarea class="form-control" id="etapaPersonalizadaDescripcion" rows="3" placeholder="Descripción detallada..."></textarea>
                        </div>
                        <button type="button" class="btn btn-success btn-sm" onclick="agregarEtapaPersonalizada()">
                            <i class="fas fa-plus"></i> Agregar Personalizada
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Selecciona múltiples etapas o agrega personalizadas
                    </small>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="confirmarEtapasSeleccionadas()">
                    <i class="fas fa-check"></i> Confirmar Selección
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de vista previa IA por etapas -->
<div class="modal fade" id="modalResultadoEtapasIA" tabindex="-1" aria-labelledby="modalResultadoEtapasIALabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalResultadoEtapasIALabel">
                    <i class="fas fa-brain me-2"></i>Resultados IA por etapas seleccionadas
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div id="resultadoEtapasIAContenido" class="mb-3">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p class="mt-2">Calculando...</p>
                    </div>
                </div>
                <div class="alert alert-info" id="resumenEtapasIAMetadatos" style="display: none;"></div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <div class="text-muted small">
                    <i class="fas fa-robot me-1"></i>
                    Los valores calculados se guardarán con el presupuesto cuando confirmes la creación.
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-success" onclick="aplicarResultadosEtapasIA()">
                        <i class="fas fa-save"></i> Aplicar al presupuesto
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const hiddenPresupuestoIdInput = document.getElementById('presupuestoIdInput');
if (typeof window !== 'undefined') {
    window.PRESUPUESTO_ID = hiddenPresupuestoIdInput ? (hiddenPresupuestoIdInput.value || null) : null;
}

let currencyFormatter = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' });

function updateCurrencyFormatter(selectedCurrency) {
    const currency = (selectedCurrency || 'ARS').toUpperCase();
    const locale = currency === 'USD' ? 'en-US' : 'es-AR';
    currencyFormatter = new Intl.NumberFormat(locale, { style: 'currency', currency });
}

const monedaSelect = document.getElementById('moneda');
if (monedaSelect) {
    updateCurrencyFormatter(monedaSelect.value);
    monedaSelect.addEventListener('change', (event) => {
        updateCurrencyFormatter(event.target.value);
    });
}

let datosCalculoIA = null;
let etapasSeleccionadasArray = [];
let etapasSeleccionadasIA = new Set();
let resultadoEtapasIA = null;
const presupuestoId = (typeof window !== 'undefined' && window.PRESUPUESTO_ID) ? window.PRESUPUESTO_ID : null;

function slugifyEtapa(nombre) {
    if (!nombre) return '';
    return nombre
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '');
}

function generarSlugUnico(nombre) {
    const base = slugifyEtapa(nombre);
    let slug = base || `etapa-${Date.now()}`;
    let contador = 1;
    const slugExistente = (valor) => {
        return ETAPAS_PREDEFINIDAS.some(e => e.slug === valor) || etapasSeleccionadasArray.some(e => (e.slug || slugifyEtapa(e.nombre)) === valor);
    };
    while (slugExistente(slug)) {
        slug = `${base}-${contador++}`;
    }
    return slug;
}

function limpiarResultadosEtapasIA(resetBadges = true) {
    resultadoEtapasIA = null;
    const hidden = document.getElementById('iaEtapasPayload');
    if (hidden) hidden.value = '';
    if (resetBadges) {
        etapasSeleccionadasArray.forEach(etapa => {
            etapa.ia_aplicada = false;
        });
        actualizarVistaEtapas(false);
    }
}

function obtenerEtapaPorSlug(slug) {
    return etapasSeleccionadasArray.find(etapa => (etapa.slug || slugifyEtapa(etapa.nombre)) === slug);
}

const ETAPAS_PREDEFINIDAS = [
    { nombre: 'Excavación', descripcion: 'Movimiento de suelos y preparación del terreno', orden: 1, slug: 'excavacion' },
    { nombre: 'Fundaciones', descripcion: 'Construcción de cimientos y estructuras de base', orden: 2, slug: 'fundaciones' },
    { nombre: 'Estructura', descripcion: 'Construcción de estructura principal (hormigón, acero)', orden: 3, slug: 'estructura' },
    { nombre: 'Mampostería', descripcion: 'Construcción de muros y paredes', orden: 4, slug: 'mamposteria' },
    { nombre: 'Techos', descripcion: 'Construcción e impermeabilización de techos', orden: 5, slug: 'techos' },
    { nombre: 'Instalaciones Eléctricas', descripcion: 'Instalación del sistema eléctrico', orden: 6, slug: 'instalaciones-electricas' },
    { nombre: 'Instalaciones Sanitarias', descripcion: 'Instalación de sistemas de agua y desagües', orden: 7, slug: 'instalaciones-sanitarias' },
    { nombre: 'Instalaciones de Gas', descripcion: 'Instalación del sistema de gas natural', orden: 8, slug: 'instalaciones-gas' },
    { nombre: 'Revoque Grueso', descripcion: 'Aplicación de revoque base en paredes', orden: 9, slug: 'revoque-grueso' },
    { nombre: 'Revoque Fino', descripcion: 'Aplicación de revoque terminación', orden: 10, slug: 'revoque-fino' },
    { nombre: 'Pisos', descripcion: 'Colocación de pisos y revestimientos', orden: 11, slug: 'pisos' },
    { nombre: 'Carpintería', descripcion: 'Instalación de puertas, ventanas y muebles', orden: 12, slug: 'carpinteria' },
    { nombre: 'Pintura', descripcion: 'Trabajos de pintura interior y exterior', orden: 13, slug: 'pintura' },
    { nombre: 'Instalaciones Complementarias', descripcion: 'Aire acondicionado, calefacción, etc.', orden: 14, slug: 'instalaciones-complementarias' },
    { nombre: 'Limpieza Final', descripcion: 'Limpieza y acondicionamiento final', orden: 15, slug: 'limpieza-final' }
];

function mostrarPanelEtapas() {
    cargarEtapasPredefinidas();
    const modal = new bootstrap.Modal(document.getElementById('modalEtapas'));
    modal.show();
}

function cargarEtapasPredefinidas() {
    const container = document.getElementById('etapasPredefinidas');
    container.innerHTML = '';
    ETAPAS_PREDEFINIDAS.forEach((etapa) => {
        const yaSeleccionada = etapasSeleccionadasArray.some(e => (e.slug || slugifyEtapa(e.nombre)) === etapa.slug);
        const checkboxId = `etapa_${etapa.slug}`;
        const etapaHTML = `
            <div class="col-md-6 mb-2">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="${checkboxId}" ${yaSeleccionada ? 'checked' : ''}
                           onchange="toggleEtapaPredefinida('${etapa.slug}')">
                    <label class="form-check-label" for="${checkboxId}">
                        <strong>${etapa.nombre}</strong>
                        <br><small class="text-muted">${etapa.descripcion}</small>
                    </label>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', etapaHTML);
    });
}

function toggleEtapaPredefinida(slug) {
    const etapa = ETAPAS_PREDEFINIDAS.find(e => e.slug === slug);
    const checkbox = document.getElementById(`etapa_${slug}`);
    if (!etapa || !checkbox) return;

    if (checkbox.checked) {
        if (!etapasSeleccionadasArray.some(e => (e.slug || slugifyEtapa(e.nombre)) === slug)) {
            etapasSeleccionadasArray.push({ ...etapa, personalizada: false });
            etapasSeleccionadasIA.add(slug);
        }
    } else {
        etapasSeleccionadasArray = etapasSeleccionadasArray.filter(e => (e.slug || slugifyEtapa(e.nombre)) !== slug);
        etapasSeleccionadasIA.delete(slug);
    }
    limpiarResultadosEtapasIA();
    console.log(`📋 Etapas seleccionadas: ${etapasSeleccionadasArray.length}`);
}

function agregarEtapaPersonalizada() {
    const nombre = document.getElementById('etapaPersonalizadaNombre').value.trim();
    const descripcion = document.getElementById('etapaPersonalizadaDescripcion').value.trim();

    if (!nombre) {
        alert('Ingresa el nombre de la etapa personalizada');
        return;
    }

    if (etapasSeleccionadasArray.some(e => e.nombre.toLowerCase() === nombre.toLowerCase())) {
        alert('Ya existe una etapa con ese nombre');
        return;
    }

    const slug = generarSlugUnico(nombre);
    const nuevaEtapa = {
        nombre,
        descripcion: descripcion || 'Etapa personalizada',
        orden: etapasSeleccionadasArray.length + 100,
        personalizada: true,
        slug
    };

    etapasSeleccionadasArray.push(nuevaEtapa);
    etapasSeleccionadasIA.add(slug);
    document.getElementById('etapaPersonalizadaNombre').value = '';
    document.getElementById('etapaPersonalizadaDescripcion').value = '';
    limpiarResultadosEtapasIA();
    actualizarVistaEtapas();
    console.log(`✅ Etapa personalizada agregada: ${nombre}`);
}

function confirmarEtapasSeleccionadas() {
    if (etapasSeleccionadasArray.length === 0) {
        alert('Selecciona al menos una etapa antes de confirmar');
        return;
    }

    if (etapasSeleccionadasIA.size === 0) {
        etapasSeleccionadasArray.forEach(etapa => etapasSeleccionadasIA.add(etapa.slug || slugifyEtapa(etapa.nombre)));
    }

    actualizarVistaEtapas();
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalEtapas'));
    modal.hide();
    console.log(`✅ Confirmadas ${etapasSeleccionadasArray.length} etapas`);
}

function actualizarVistaEtapas(renderBadges = true) {
    const listaEtapas = document.getElementById('listaEtapas');

    if (etapasSeleccionadasArray.length === 0) {
        listaEtapas.innerHTML = '<i class="fas fa-info-circle"></i> No se han seleccionado etapas aún. Haz clic en "Nueva Etapa" para agregar.';
        listaEtapas.className = 'text-muted small';
        return;
    }

    if (etapasSeleccionadasIA.size === 0) {
        etapasSeleccionadasArray.forEach(etapa => etapasSeleccionadasIA.add(etapa.slug || slugifyEtapa(etapa.nombre)));
    }

    const etapasOrdenadas = [...etapasSeleccionadasArray].sort((a, b) => a.orden - b.orden);
    let html = '<div class="row">';

    etapasOrdenadas.forEach((etapa) => {
        const slug = etapa.slug || slugifyEtapa(etapa.nombre);
        const checked = etapasSeleccionadasIA.has(slug);
        const esPersonalizada = etapa.personalizada;
        const iaBadge = etapa.ia_aplicada && renderBadges ? '<span class="badge bg-success-subtle text-success ms-2">IA aplicada</span>' : '';
        const descripcion = etapa.descripcion || 'Sin descripción definida';
        const inputId = `etapaCheck_${slug}`;
        html += `
            <div class="col-md-6 col-xl-4 mb-3">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start gap-2">
                            <div class="flex-grow-1">
                                <div class="form-check">
                                    <input class="form-check-input etapa-ia-checkbox" type="checkbox" id="${inputId}"
                                           data-stage-slug="${slug}" data-stage-nombre="${etapa.nombre.replace(/"/g, '&quot;')}" data-etapa-id="${etapa.id || ''}"
                                           ${checked ? 'checked' : ''} onchange="toggleEtapaIA(this)">
                                    <label class="form-check-label fw-bold text-primary" for="${inputId}">
                                        ${etapa.nombre}
                                        ${esPersonalizada ? '<span class="badge bg-success ms-1">Personalizada</span>' : ''}
                                        ${iaBadge}
                                    </label>
                                </div>
                                <small class="text-muted d-block">${descripcion}</small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerEtapa('${slug}')" title="Remover etapa">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent border-0 pt-0 d-flex justify-content-between align-items-center">
                        <span class="badge bg-light text-muted">Orden ${etapa.orden}</span>
                        <button type="button" class="btn btn-link btn-sm text-decoration-none" onclick="calcularEtapaIndividualIA('${slug}')">
                            <i class="fas fa-bolt me-1"></i>Calcular esta etapa
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    listaEtapas.innerHTML = html;
    listaEtapas.className = '';
}

function removerEtapa(slug) {
    etapasSeleccionadasArray = etapasSeleccionadasArray.filter(e => (e.slug || slugifyEtapa(e.nombre)) !== slug);
    etapasSeleccionadasIA.delete(slug);
    limpiarResultadosEtapasIA();
    actualizarVistaEtapas();
    console.log(`🗑️ Etapa removida: ${slug}`);
}

function toggleEtapaIA(input) {
    const slug = input.dataset.stageSlug;
    if (!slug) return;
    if (input.checked) {
        etapasSeleccionadasIA.add(slug);
    } else {
        etapasSeleccionadasIA.delete(slug);
    }
    limpiarResultadosEtapasIA(false);
}

function calcularEtapasSeleccionadasIA() {
    const seleccionadas = Array.from(document.querySelectorAll('.etapa-ia-checkbox:checked')).map(cb => cb.dataset.stageSlug).filter(Boolean);
    if (seleccionadas.length === 0) {
        alert('Selecciona al menos una etapa para calcular con IA.');
        return;
    }
    const etapas = seleccionadas.map(slug => obtenerEtapaPorSlug(slug)).filter(Boolean);
    solicitarCalculoEtapas(etapas);
}

function calcularEtapaIndividualIA(slug) {
    const etapa = obtenerEtapaPorSlug(slug);
    if (!etapa) {
        alert('No encontramos la etapa solicitada.');
        return;
    }
    solicitarCalculoEtapas([etapa]);
}

function solicitarCalculoEtapas(etapas) {
    if (!etapas || etapas.length === 0) {
        alert('No hay etapas para calcular.');
        return;
    }

    const superficie = parseFloat(document.getElementById('superficie_m2').value || '0');
    if (!superficie || superficie <= 0) {
        alert('Ingresa la superficie en m² antes de calcular con IA por etapas.');
        return;
    }

    const tipoCalculo = document.getElementById('tipo_construccion').value || 'Estándar';
    const contexto = {
        ubicacion: document.getElementById('ubicacion').value || null,
        tipo_obra: document.getElementById('tipo_obra').value || null
    };

    const monedaSelectEl = document.getElementById('moneda');
    const currency = monedaSelectEl ? monedaSelectEl.value : 'ARS';
    updateCurrencyFormatter(currency);

    const payload = {
        etapa_ids: etapas.map(etapa => ({
            slug: etapa.slug || slugifyEtapa(etapa.nombre),
            nombre: etapa.nombre,
            id: etapa.id || null
        })),
        superficie_m2: superficie,
        tipo_calculo: tipoCalculo,
        parametros_contexto: contexto,
        presupuesto_id: presupuestoId,
        currency: currency,
        moneda: currency
    };

    const modalEl = document.getElementById('modalResultadoEtapasIA');
    const modal = new bootstrap.Modal(modalEl);
    document.getElementById('resultadoEtapasIAContenido').innerHTML = `
        <div class="text-center text-muted py-4">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-2 mb-0">Calculando con IA…</p>
        </div>
    `;
    document.getElementById('resumenEtapasIAMetadatos').style.display = 'none';
    modal.show();

    fetch('/presupuestos/ia/calcular/etapas', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
        .then(resp => resp.json())
        .then(data => {
            if (!data || data.ok === false) {
                const mensaje = data && data.error ? data.error : 'No se pudo calcular las etapas seleccionadas.';
                document.getElementById('resultadoEtapasIAContenido').innerHTML = `<div class="alert alert-danger mb-0">${mensaje}</div>`;
                return;
            }
            data.parametros_contexto = payload.parametros_contexto;
            resultadoEtapasIA = data;
            renderResultadoEtapasIA(data);
        })
        .catch(error => {
            console.error('Error IA etapas:', error);
            document.getElementById('resultadoEtapasIAContenido').innerHTML = `<div class="alert alert-danger mb-0">Error de conexión con la IA: ${error.message}</div>`;
        });
}

function renderResultadoEtapasIA(data) {
    if (data.moneda) {
        updateCurrencyFormatter(data.moneda);
    }
    const contenedor = document.getElementById('resultadoEtapasIAContenido');
    const resumen = document.getElementById('resumenEtapasIAMetadatos');
    const etapas = data.etapas || [];

    if (etapas.length === 0) {
        contenedor.innerHTML = '<div class="alert alert-warning mb-0">La IA no generó items para las etapas seleccionadas.</div>';
        resumen.style.display = 'none';
        return;
    }

    const htmlEtapas = etapas.map(etapa => {
        const items = etapa.items || [];
        const filas = items.map(item => {
            const subtotal = (item.cantidad || 0) * (item.precio_unit || 0);
            const precioUnit = item.precio_unit ? currencyFormatter.format(item.precio_unit) : '<span class="badge bg-warning text-dark">Sin precio</span>';
            const subtotalFmt = item.precio_unit ? currencyFormatter.format(subtotal) : '<span class="text-muted">--</span>';
            return `
                <tr>
                    <td class="text-capitalize">${item.tipo || '-'}</td>
                    <td>${item.codigo || '-'}</td>
                    <td>${item.descripcion || '-'}</td>
                    <td class="text-end">${Number(item.cantidad || 0).toFixed(2)}</td>
                    <td>${item.unidad || ''}</td>
                    <td class="text-end">${precioUnit}</td>
                    <td class="text-end">${subtotalFmt}</td>
                    <td>${item.just || 'Regla determinística'}</td>
                </tr>
            `;
        }).join('');

        const subtotalTotal = etapa.subtotal_total ? currencyFormatter.format(etapa.subtotal_total) : currencyFormatter.format(0);
        const confianza = etapa.confianza ? Math.round(etapa.confianza * 100) : null;

        return `
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 text-primary">${etapa.nombre}</h6>
                    <div class="d-flex align-items-center gap-2">
                        ${confianza ? `<span class="badge bg-info-subtle text-info">Confianza ${confianza}%</span>` : ''}
                        <span class="badge bg-secondary-subtle text-secondary">${subtotalTotal}</span>
                    </div>
                </div>
                ${items.length ? `
                    <div class="table-responsive">
                        <table class="table table-sm table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Tipo</th>
                                    <th>Código</th>
                                    <th>Descripción</th>
                                    <th class="text-end">Cantidad</th>
                                    <th>Unidad</th>
                                    <th class="text-end">Precio unit.</th>
                                    <th class="text-end">Subtotal</th>
                                    <th>Justificación</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filas}
                            </tbody>
                        </table>
                    </div>
                ` : '<div class="alert alert-warning mb-0">Sin items sugeridos para esta etapa.</div>'}
                ${etapa.notas ? `<p class="small text-muted mt-2 mb-0">${etapa.notas}</p>` : ''}
            </div>
        `;
    }).join('');

    contenedor.innerHTML = htmlEtapas;
    const totalParcial = data.total_parcial ? currencyFormatter.format(data.total_parcial) : currencyFormatter.format(0);
    resumen.style.display = 'block';
    let tipoCambioTexto = '';
    if (data.tipo_cambio && data.tipo_cambio.valor) {
        const fxFormatter = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' });
        const proveedor = (data.tipo_cambio.proveedor || '').toUpperCase();
        const fechaFx = data.tipo_cambio.fetched_at ? new Date(data.tipo_cambio.fetched_at) : null;
        const fechaTexto = fechaFx ? fechaFx.toLocaleString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';
        tipoCambioTexto = ` · TC ${proveedor} ${fxFormatter.format(data.tipo_cambio.valor)}${fechaTexto ? ' (' + fechaTexto + ')' : ''}`;
    }
    resumen.innerHTML = `<strong>Total parcial IA:</strong> ${totalParcial} · ${etapas.length} etapa(s) analizadas${tipoCambioTexto}.`;
}

function aplicarResultadosEtapasIA() {
    if (!resultadoEtapasIA || resultadoEtapasIA.ok === false) {
        alert('Calcula las etapas con IA antes de aplicar los resultados.');
        return;
    }

    const hidden = document.getElementById('iaEtapasPayload');
    hidden.value = JSON.stringify(resultadoEtapasIA);

    (resultadoEtapasIA.etapas || []).forEach(etapa => {
        const registro = obtenerEtapaPorSlug(etapa.slug);
        if (registro) {
            registro.ia_aplicada = true;
        }
    });

    if (presupuestoId) {
        const persistCurrency = (resultadoEtapasIA.moneda || (monedaSelect ? monedaSelect.value : 'ARS'));
        const persistPayload = {
            etapa_ids: (resultadoEtapasIA.etapas || []).map(etapa => ({
                slug: etapa.slug || slugifyEtapa(etapa.nombre),
                nombre: etapa.nombre,
                id: etapa.etapa_id || etapa.id || null
            })),
            superficie_m2: resultadoEtapasIA.superficie_usada || parseFloat(document.getElementById('superficie_m2').value || '0'),
            tipo_calculo: resultadoEtapasIA.tipo_calculo || document.getElementById('tipo_construccion').value || 'Estándar',
            parametros_contexto: resultadoEtapasIA.parametros_contexto || {},
            presupuesto_id: presupuestoId,
            persistir: true,
            currency: persistCurrency,
            moneda: persistCurrency
        };

        fetch('/presupuestos/ia/calcular/etapas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(persistPayload)
        })
            .then(resp => resp.json())
            .then(respuesta => {
                if (!respuesta || respuesta.ok === false) {
                    console.error('No se pudo guardar el cálculo IA en el presupuesto existente:', respuesta);
                    alert(respuesta && respuesta.error ? respuesta.error : 'No pudimos guardar los ítems calculados. Intentalo nuevamente.');
                } else {
                    console.log('🧾 Resultados IA guardados en presupuesto', respuesta);
                }
            })
            .catch(error => {
                console.error('Error persistiendo resultados IA:', error);
            });
    }

    actualizarVistaEtapas();
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalResultadoEtapasIA'));
    if (modal) modal.hide();
    if (presupuestoId) {
        alert('Se aplicaron los resultados de IA y se guardaron en el presupuesto.');
    } else {
        alert('Se aplicaron los resultados de IA. Se guardarán al crear el presupuesto.');
    }
}

function mostrarArchivoPlano() {
    const input = document.getElementById('plano_pdf');
    const info = document.getElementById('archivoPlanoInfo');
    const nombre = document.getElementById('nombreArchivoPlano');

    if (input.files.length > 0) {
        nombre.textContent = input.files[0].name;
        info.style.display = 'block';
    } else {
        info.style.display = 'none';
    }
}

function removerArchivo() {
    document.getElementById('plano_pdf').value = '';
    document.getElementById('archivoPlanoInfo').style.display = 'none';
}

const dropZone = document.getElementById('dropZone');

dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = '#007bff';
    dropZone.style.backgroundColor = '#f8f9fa';
});

dropZone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = '#dee2e6';
    dropZone.style.backgroundColor = 'transparent';
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = '#dee2e6';
    dropZone.style.backgroundColor = 'transparent';

    const files = e.dataTransfer.files;
    if (files.length > 0 && files[0].type === 'application/pdf') {
        document.getElementById('plano_pdf').files = files;
        mostrarArchivoPlano();
    } else {
        alert('Por favor, sube solo archivos PDF');
    }
});

function calcularConIA() {
    const superficie = document.getElementById('superficie_m2').value;
    const tipo = document.getElementById('tipo_construccion').value;
    const archivo = document.getElementById('plano_pdf').files[0];

    if (!superficie && !archivo) {
        alert('Debes especificar la superficie o subir un plano PDF para usar la IA');
        return;
    }

    if (!tipo) {
        alert('Selecciona el tipo de construcción');
        return;
    }

    const formData = new FormData();
    if (superficie) formData.append('metros_cuadrados', superficie);
    if (tipo) formData.append('tipo_construccion', tipo);
    if (archivo) formData.append('archivo_pdf', archivo);

    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculando...';
    btn.disabled = true;

    fetch('/presupuestos/procesar-calculadora-ia', {
        method: 'POST',
        body: formData
    })
        .then(response => response.json())
        .then(data => {
            btn.innerHTML = originalText;
            btn.disabled = false;

            if (data.exito) {
                datosCalculoIA = data;
                mostrarResultadoIA(data);
            } else {
                alert('Error en el cálculo IA: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            alert('Error de conexión: ' + error.message);
        });
}

function mostrarResultadoIA(data) {
    const panel = document.getElementById('calculoIAPanel');
    const resumen = document.getElementById('resultadoIAResumen');

    const materiales = Object.keys(data.presupuesto.materiales).length;
    const equipos = Object.keys(data.presupuesto.equipos).length;

    resumen.innerHTML = `
        <div class="row text-center">
            <div class="col-6">
                <h4 class="text-success">${data.superficie_calculada.toFixed(0)}</h4>
                <small>m² calculados</small>
            </div>
            <div class="col-6">
                <h4 class="text-primary">${materiales + equipos}</h4>
                <small>items calculados</small>
            </div>
        </div>
        <hr>
        <p class="small mb-0">
            <i class="fas fa-check-circle text-success"></i>
            Tipo: ${data.tipo_usado}
        </p>
    `;

    panel.style.display = 'block';
}

function verCalculoCompleto() {
    if (datosCalculoIA) {
        window.open('/presupuestos/calculadora-ia', '_blank');
    }
}

function limpiarFormulario() {
    if (confirm('¿Estás seguro de que quieres limpiar todos los campos?')) {
        document.getElementById('nuevoPresupuestoForm').reset();
        document.getElementById('archivoPlanoInfo').style.display = 'none';
        document.getElementById('calculoIAPanel').style.display = 'none';
        datosCalculoIA = null;
        etapasSeleccionadasArray = [];
        etapasSeleccionadasIA.clear();
        limpiarResultadosEtapasIA();
        actualizarVistaEtapas();
    }
}

document.getElementById('nuevoPresupuestoForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const nombre = document.getElementById('nombre_obra').value.trim();
    const tipo = document.getElementById('tipo_obra').value;
    const ubicacion = document.getElementById('ubicacion').value.trim();
    const tipoConst = document.getElementById('tipo_construccion').value;
    const superficie = document.getElementById('superficie_m2').value;

    if (!nombre || !tipo || !ubicacion || !tipoConst || !superficie) {
        alert('Por favor, completa todos los campos obligatorios marcados con *');
        return;
    }

    this.querySelectorAll('.etapa-hidden-field').forEach(el => el.remove());

    if (etapasSeleccionadasArray.length > 0) {
        etapasSeleccionadasArray.forEach((etapa, index) => {
            const slug = etapa.slug || slugifyEtapa(etapa.nombre);

            const inputNombre = document.createElement('input');
            inputNombre.type = 'hidden';
            inputNombre.name = `etapas[${index}][nombre]`;
            inputNombre.value = etapa.nombre;
            inputNombre.classList.add('etapa-hidden-field');
            this.appendChild(inputNombre);

            const inputDescripcion = document.createElement('input');
            inputDescripcion.type = 'hidden';
            inputDescripcion.name = `etapas[${index}][descripcion]`;
            inputDescripcion.value = etapa.descripcion || '';
            inputDescripcion.classList.add('etapa-hidden-field');
            this.appendChild(inputDescripcion);

            const inputOrden = document.createElement('input');
            inputOrden.type = 'hidden';
            inputOrden.name = `etapas[${index}][orden]`;
            inputOrden.value = etapa.orden;
            inputOrden.classList.add('etapa-hidden-field');
            this.appendChild(inputOrden);

            const inputSlug = document.createElement('input');
            inputSlug.type = 'hidden';
            inputSlug.name = `etapas[${index}][slug]`;
            inputSlug.value = slug;
            inputSlug.classList.add('etapa-hidden-field');
            this.appendChild(inputSlug);
        });
    }

    this.submit();
});
</script>


{% endblock %}
