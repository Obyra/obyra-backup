{% extends "base.html" %}

{% block title %}Nuevo Presupuesto - OBYRA IA{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-plus text-primary"></i> Nuevo Presupuesto</h2>
                    <p class="text-muted mb-0">Crea un presupuesto completo con an√°lisis inteligente de materiales</p>
                </div>
                <div class="btn-group" role="group">
                    <a href="{{ url_for('presupuestos.lista') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Volver
                    </a>
                    <a href="{{ url_for('presupuestos.calculadora_ia') }}" class="btn btn-success">
                        <i class="fas fa-brain"></i> Calculadora IA
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Formulario Principal -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-building"></i> Informaci√≥n del Proyecto</h5>
                </div>
                <div class="card-body">
                    <form id="nuevoPresupuestoForm" method="POST" enctype="multipart/form-data">
                        
                        <!-- Primera fila: Nombre y Tipo de Obra -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="nombre_obra" class="form-label fw-bold">
                                    <i class="fas fa-building text-primary"></i> Nombre de la Obra *
                                </label>
                                <input type="text" class="form-control form-control-lg" 
                                       id="nombre_obra" name="nombre_obra" required
                                       placeholder="Ej: Casa Familiar Rodriguez">
                                <div class="form-text">Nombre descriptivo del proyecto</div>
                            </div>
                            <div class="col-md-6">
                                <label for="tipo_obra" class="form-label fw-bold">
                                    <i class="fas fa-home text-warning"></i> Tipo de Obra *
                                </label>
                                <select class="form-select form-select-lg" id="tipo_obra" name="tipo_obra" required>
                                    <option value="">Seleccionar tipo...</option>
                                    <option value="casa_1_planta">Casa 1 planta</option>
                                    <option value="casa_2_plantas">Casa 2 plantas</option>
                                    <option value="edificio_3_5_pisos">Edificio de 3 a 5 pisos</option>
                                    <option value="edificio_5_10_pisos">Edificio de 5 a 10 pisos</option>
                                </select>
                            </div>
                        </div>

                        <!-- Segunda fila: Ubicaci√≥n y Tipo de Construcci√≥n -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="ubicacion" class="form-label fw-bold">
                                    <i class="fas fa-map-marker-alt text-danger"></i> Ubicaci√≥n *
                                </label>
                                <input type="text" class="form-control form-control-lg" 
                                       id="ubicacion" name="ubicacion" required
                                       placeholder="Direcci√≥n completa o zona">
                                <div class="form-text">Ciudad, provincia o direcci√≥n espec√≠fica</div>
                            </div>
                            <div class="col-md-6">
                                <label for="tipo_construccion" class="form-label fw-bold">
                                    <i class="fas fa-star text-warning"></i> Tipo de Construcci√≥n *
                                </label>
                                <select class="form-select form-select-lg" id="tipo_construccion" name="tipo_construccion" required>
                                    <option value="">Seleccionar nivel...</option>
                                    <option value="economica">Econ√≥mica</option>
                                    <option value="estandar">Est√°ndar</option>
                                    <option value="premium">Premium</option>
                                </select>
                                <div class="form-text">
                                    <small>
                                        <span class="badge bg-light text-dark">Econ√≥mica: 1.0x</span>
                                        <span class="badge bg-primary">Est√°ndar: 1.3x</span>
                                        <span class="badge bg-warning text-dark">Premium: 1.8x</span>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Tercera fila: Superficie y Fechas -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label for="superficie_m2" class="form-label fw-bold">
                                    <i class="fas fa-ruler-combined text-success"></i> Superficie (m¬≤) *
                                </label>
                                <input type="number" class="form-control form-control-lg" 
                                       id="superficie_m2" name="superficie_m2" 
                                       step="0.01" min="1" required
                                       placeholder="120.50">
                                <div class="form-text">Metros cuadrados totales</div>
                            </div>
                            <div class="col-md-4">
                                <label for="fecha_inicio" class="form-label fw-bold">
                                    <i class="fas fa-calendar-alt text-info"></i> Fecha Inicio
                                </label>
                                <input type="date" class="form-control form-control-lg" 
                                       id="fecha_inicio" name="fecha_inicio">
                                <div class="form-text">Fecha estimada de inicio</div>
                            </div>
                            <div class="col-md-4">
                                <label for="fecha_fin" class="form-label fw-bold">
                                    <i class="fas fa-calendar-check text-info"></i> Fecha Finalizaci√≥n
                                </label>
                                <input type="date" class="form-control form-control-lg" 
                                       id="fecha_fin" name="fecha_fin">
                                <div class="form-text">Fecha estimada de entrega</div>
                            </div>
                        </div>

                        <!-- Cuarta fila: Presupuesto -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="presupuesto_disponible" class="form-label fw-bold">
                                    <i class="fas fa-dollar-sign text-success"></i> Presupuesto Disponible
                                </label>
                                <div class="input-group input-group-lg">
                                    <select class="form-select" id="moneda" name="moneda" style="max-width: 100px;">
                                        <option value="ARS">ARS</option>
                                        <option value="USD">USD</option>
                                    </select>
                                    <input type="number" class="form-control" 
                                           id="presupuesto_disponible" name="presupuesto_disponible" 
                                           step="0.01" min="0" placeholder="0.00">
                                </div>
                                <div class="form-text">Presupuesto m√°ximo disponible (opcional)</div>
                            </div>
                            <div class="col-md-6">
                                <label for="cliente_nombre" class="form-label fw-bold">
                                    <i class="fas fa-user text-secondary"></i> Cliente
                                </label>
                                <input type="text" class="form-control form-control-lg" 
                                       id="cliente_nombre" name="cliente_nombre" 
                                       placeholder="Nombre del cliente">
                                <div class="form-text">Persona o empresa contratante</div>
                            </div>
                        </div>

                        <!-- Upload de Plano -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-file-pdf text-danger"></i> Plano Arquitect√≥nico (PDF)
                            </label>
                            <div class="card border-2 border-dashed" style="border-color: #dee2e6;">
                                <div class="card-body text-center py-4">
                                    <input type="file" class="form-control d-none" 
                                           id="plano_pdf" name="plano_pdf" accept=".pdf"
                                           onchange="mostrarArchivoPlano()">
                                    <div id="dropZone" onclick="document.getElementById('plano_pdf').click();" 
                                         style="cursor: pointer;">
                                        <i class="fas fa-upload fa-2x text-muted mb-2"></i>
                                        <p class="mb-1"><strong>Arrastra y suelta tu plano PDF aqu√≠</strong></p>
                                        <p class="text-muted mb-0">o haz clic para seleccionar archivo</p>
                                    </div>
                                    <div id="archivoPlanoInfo" class="alert alert-info mt-3" style="display: none;">
                                        <i class="fas fa-file-pdf text-danger"></i>
                                        <span id="nombreArchivoPlano"></span>
                                        <button type="button" class="btn btn-sm btn-outline-secondary ms-2" 
                                                onclick="removerArchivo()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-text">
                                <i class="fas fa-info-circle"></i> 
                                Si subes un plano, la IA podr√° extraer autom√°ticamente las dimensiones
                            </div>
                        </div>

                        <!-- Secci√≥n de Etapas del Proyecto -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <label class="form-label fw-bold mb-0">
                                    <i class="fas fa-tasks text-info"></i> Etapas del Proyecto
                                </label>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="mostrarPanelEtapas()">
                                    <i class="fas fa-plus"></i> Nueva Etapa
                                </button>
                            </div>
                            
                            <!-- Lista de etapas seleccionadas -->
                            <div id="etapasSeleccionadas" class="card bg-light p-3">
                                <div id="listaEtapas" class="text-muted small">
                                    <i class="fas fa-info-circle"></i> No se han seleccionado etapas a√∫n. Haz clic en "Nueva Etapa" para agregar.
                                </div>
                            </div>
                        </div>

                        <!-- Botones de acci√≥n -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex gap-2 flex-wrap">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-save"></i> Crear Presupuesto
                                    </button>
                                    <button type="button" class="btn btn-success btn-lg" onclick="calcularConIA()">
                                        <i class="fas fa-brain"></i> Calcular con IA
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="limpiarFormulario()">
                                        <i class="fas fa-broom"></i> Limpiar
                                    </button>
                                </div>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>

        <!-- Panel Lateral con informaci√≥n -->
        <div class="col-lg-4">
            
            <!-- Gu√≠a r√°pida -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-lightbulb"></i> Gu√≠a R√°pida</h6>
                </div>
                <div class="card-body">
                    <div class="small">
                        <p><strong>Para mejores resultados:</strong></p>
                        <ul class="mb-0">
                            <li>Sube un plano PDF para an√°lisis autom√°tico</li>
                            <li>Especifica la superficie si no tienes plano</li>
                            <li>Elige el tipo de construcci√≥n apropiado</li>
                            <li>Usa "Calcular con IA" para obtener materiales</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Tipos de construcci√≥n -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="fas fa-star"></i> Tipos de Construcci√≥n</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-12 mb-2">
                            <div class="bg-light p-2 rounded">
                                <strong class="text-success">Econ√≥mica</strong><br>
                                <small>Materiales b√°sicos, acabados sencillos</small>
                            </div>
                        </div>
                        <div class="col-12 mb-2">
                            <div class="bg-light p-2 rounded">
                                <strong class="text-primary">Est√°ndar</strong><br>
                                <small>Calidad media, acabados intermedios</small>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="bg-light p-2 rounded">
                                <strong class="text-warning">Premium</strong><br>
                                <small>Alta calidad, acabados superiores</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estado del c√°lculo IA -->
            <div id="calculoIAPanel" class="card shadow-sm" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="fas fa-robot"></i> C√°lculo IA Completado</h6>
                </div>
                <div class="card-body">
                    <div id="resultadoIAResumen" class="text-center">
                        <!-- Se completar√° con JavaScript -->
                    </div>
                    <div class="d-grid mt-3">
                        <button class="btn btn-outline-success btn-sm" onclick="verCalculoCompleto()">
                            <i class="fas fa-eye"></i> Ver C√°lculo Completo
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Modal para selecci√≥n de etapas predefinidas -->
<div class="modal fade" id="modalEtapas" tabindex="-1" aria-labelledby="modalEtapasLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalEtapasLabel">
                    <i class="fas fa-tasks me-2"></i>Seleccionar Etapas del Proyecto
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6 class="mb-3"><i class="fas fa-list-check text-primary"></i> Etapas Predefinidas</h6>
                        <div class="row" id="etapasPredefinidas">
                            <!-- Se cargar√°n con JavaScript -->
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6 class="mb-3"><i class="fas fa-plus-circle text-success"></i> Etapa Personalizada</h6>
                        <div class="mb-3">
                            <label for="etapaPersonalizadaNombre" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="etapaPersonalizadaNombre" placeholder="Ej: Pintura Especial">
                        </div>
                        <div class="mb-3">
                            <label for="etapaPersonalizadaDescripcion" class="form-label">Descripci√≥n</label>
                            <textarea class="form-control" id="etapaPersonalizadaDescripcion" rows="3" placeholder="Descripci√≥n detallada..."></textarea>
                        </div>
                        <button type="button" class="btn btn-success btn-sm" onclick="agregarEtapaPersonalizada()">
                            <i class="fas fa-plus"></i> Agregar Personalizada
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Selecciona m√∫ltiples etapas o agrega personalizadas
                    </small>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="confirmarEtapasSeleccionadas()">
                    <i class="fas fa-check"></i> Confirmar Selecci√≥n
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let datosCalculoIA = null;
let etapasSeleccionadasArray = [];

// Etapas predefinidas (se cargan desde el servidor)
const ETAPAS_PREDEFINIDAS = [
    { nombre: 'Excavaci√≥n', descripcion: 'Movimiento de suelos y preparaci√≥n del terreno', orden: 1 },
    { nombre: 'Fundaciones', descripcion: 'Construcci√≥n de cimientos y estructuras de base', orden: 2 },
    { nombre: 'Estructura', descripcion: 'Construcci√≥n de estructura principal (hormig√≥n, acero)', orden: 3 },
    { nombre: 'Mamposter√≠a', descripcion: 'Construcci√≥n de muros y paredes', orden: 4 },
    { nombre: 'Techos', descripcion: 'Construcci√≥n e impermeabilizaci√≥n de techos', orden: 5 },
    { nombre: 'Instalaciones El√©ctricas', descripcion: 'Instalaci√≥n del sistema el√©ctrico', orden: 6 },
    { nombre: 'Instalaciones Sanitarias', descripcion: 'Instalaci√≥n de sistemas de agua y desag√ºes', orden: 7 },
    { nombre: 'Instalaciones de Gas', descripcion: 'Instalaci√≥n del sistema de gas natural', orden: 8 },
    { nombre: 'Revoque Grueso', descripcion: 'Aplicaci√≥n de revoque base en paredes', orden: 9 },
    { nombre: 'Revoque Fino', descripcion: 'Aplicaci√≥n de revoque terminaci√≥n', orden: 10 },
    { nombre: 'Pisos', descripcion: 'Colocaci√≥n de pisos y revestimientos', orden: 11 },
    { nombre: 'Carpinter√≠a', descripcion: 'Instalaci√≥n de puertas, ventanas y muebles', orden: 12 },
    { nombre: 'Pintura', descripcion: 'Trabajos de pintura interior y exterior', orden: 13 },
    { nombre: 'Instalaciones Complementarias', descripcion: 'Aire acondicionado, calefacci√≥n, etc.', orden: 14 },
    { nombre: 'Limpieza Final', descripcion: 'Limpieza y acondicionamiento final', orden: 15 }
];

// Mostrar panel de etapas
function mostrarPanelEtapas() {
    console.log('üèóÔ∏è Abriendo panel de selecci√≥n de etapas');
    
    // Cargar etapas predefinidas en el modal
    cargarEtapasPredefinidas();
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalEtapas'));
    modal.show();
}

// Cargar etapas predefinidas en el modal
function cargarEtapasPredefinidas() {
    const container = document.getElementById('etapasPredefinidas');
    container.innerHTML = '';
    
    ETAPAS_PREDEFINIDAS.forEach((etapa, index) => {
        const yaSeleccionada = etapasSeleccionadasArray.some(e => e.nombre === etapa.nombre);
        
        const etapaHTML = `
            <div class="col-md-6 mb-2">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="etapa_${index}" 
                           ${yaSeleccionada ? 'checked' : ''} 
                           onchange="toggleEtapaPredefinida(${index})">
                    <label class="form-check-label" for="etapa_${index}">
                        <strong>${etapa.nombre}</strong>
                        <br><small class="text-muted">${etapa.descripcion}</small>
                    </label>
                </div>
            </div>
        `;
        
        container.innerHTML += etapaHTML;
    });
}

// Toggle etapa predefinida
function toggleEtapaPredefinida(index) {
    const etapa = ETAPAS_PREDEFINIDAS[index];
    const checkbox = document.getElementById(`etapa_${index}`);
    
    if (checkbox.checked) {
        // Agregar si no existe
        if (!etapasSeleccionadasArray.some(e => e.nombre === etapa.nombre)) {
            etapasSeleccionadasArray.push({
                nombre: etapa.nombre,
                descripcion: etapa.descripcion,
                orden: etapa.orden,
                personalizada: false
            });
        }
    } else {
        // Remover si existe
        etapasSeleccionadasArray = etapasSeleccionadasArray.filter(e => e.nombre !== etapa.nombre);
    }
    
    console.log(`üìã Etapas seleccionadas: ${etapasSeleccionadasArray.length}`);
}

// Agregar etapa personalizada
function agregarEtapaPersonalizada() {
    const nombre = document.getElementById('etapaPersonalizadaNombre').value.trim();
    const descripcion = document.getElementById('etapaPersonalizadaDescripcion').value.trim();
    
    if (!nombre) {
        alert('Ingresa el nombre de la etapa personalizada');
        return;
    }
    
    // Verificar que no exista ya
    if (etapasSeleccionadasArray.some(e => e.nombre.toLowerCase() === nombre.toLowerCase())) {
        alert('Ya existe una etapa con ese nombre');
        return;
    }
    
    // Agregar etapa personalizada
    const nuevaEtapa = {
        nombre: nombre,
        descripcion: descripcion || 'Etapa personalizada',
        orden: etapasSeleccionadasArray.length + 100, // Orden alto para personalizadas
        personalizada: true
    };
    
    etapasSeleccionadasArray.push(nuevaEtapa);
    
    // Limpiar campos
    document.getElementById('etapaPersonalizadaNombre').value = '';
    document.getElementById('etapaPersonalizadaDescripcion').value = '';
    
    // Actualizar vista
    actualizarVistaEtapas();
    
    console.log(`‚úÖ Etapa personalizada agregada: ${nombre}`);
}

// Confirmar etapas seleccionadas
function confirmarEtapasSeleccionadas() {
    if (etapasSeleccionadasArray.length === 0) {
        alert('Selecciona al menos una etapa antes de confirmar');
        return;
    }
    
    // Actualizar vista
    actualizarVistaEtapas();
    
    // Cerrar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalEtapas'));
    modal.hide();
    
    console.log(`‚úÖ Confirmadas ${etapasSeleccionadasArray.length} etapas`);
}

// Actualizar vista de etapas seleccionadas
function actualizarVistaEtapas() {
    const listaEtapas = document.getElementById('listaEtapas');
    
    if (etapasSeleccionadasArray.length === 0) {
        listaEtapas.innerHTML = '<i class="fas fa-info-circle"></i> No se han seleccionado etapas a√∫n. Haz clic en "Nueva Etapa" para agregar.';
        listaEtapas.className = 'text-muted small';
        return;
    }
    
    // Ordenar etapas por orden
    const etapasOrdenadas = [...etapasSeleccionadasArray].sort((a, b) => a.orden - b.orden);
    
    let html = '<div class="row">';
    etapasOrdenadas.forEach((etapa, index) => {
        const esPersonalizada = etapa.personalizada;
        html += `
            <div class="col-md-6 mb-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <strong class="${esPersonalizada ? 'text-success' : 'text-primary'}">${etapa.nombre}</strong>
                        ${esPersonalizada ? '<span class="badge bg-success ms-1">Personalizada</span>' : ''}
                        <br><small class="text-muted">${etapa.descripcion}</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger ms-2" 
                            onclick="removerEtapa(${index})" title="Remover etapa">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    listaEtapas.innerHTML = html;
    listaEtapas.className = '';
}

// Remover etapa
function removerEtapa(index) {
    const etapasOrdenadas = [...etapasSeleccionadasArray].sort((a, b) => a.orden - b.orden);
    const etapaARemover = etapasOrdenadas[index];
    
    etapasSeleccionadasArray = etapasSeleccionadasArray.filter(e => e.nombre !== etapaARemover.nombre);
    actualizarVistaEtapas();
    
    console.log(`üóëÔ∏è Etapa removida: ${etapaARemover.nombre}`);
}

// Manejo de archivo de plano
function mostrarArchivoPlano() {
    const input = document.getElementById('plano_pdf');
    const info = document.getElementById('archivoPlanoInfo');
    const nombre = document.getElementById('nombreArchivoPlano');
    
    if (input.files.length > 0) {
        nombre.textContent = input.files[0].name;
        info.style.display = 'block';
    } else {
        info.style.display = 'none';
    }
}

function removerArchivo() {
    document.getElementById('plano_pdf').value = '';
    document.getElementById('archivoPlanoInfo').style.display = 'none';
}

// Drag and drop para planos
const dropZone = document.getElementById('dropZone');

dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = '#007bff';
    dropZone.style.backgroundColor = '#f8f9fa';
});

dropZone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = '#dee2e6';
    dropZone.style.backgroundColor = 'transparent';
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = '#dee2e6';
    dropZone.style.backgroundColor = 'transparent';
    
    const files = e.dataTransfer.files;
    if (files.length > 0 && files[0].type === 'application/pdf') {
        document.getElementById('plano_pdf').files = files;
        mostrarArchivoPlano();
    } else {
        alert('Por favor, sube solo archivos PDF');
    }
});

// Calcular con IA
function calcularConIA() {
    const superficie = document.getElementById('superficie_m2').value;
    const tipo = document.getElementById('tipo_construccion').value;
    const archivo = document.getElementById('plano_pdf').files[0];
    
    if (!superficie && !archivo) {
        alert('Debes especificar la superficie o subir un plano PDF para usar la IA');
        return;
    }
    
    if (!tipo) {
        alert('Selecciona el tipo de construcci√≥n');
        return;
    }
    
    // Crear FormData
    const formData = new FormData();
    if (superficie) formData.append('metros_cuadrados', superficie);
    if (tipo) formData.append('tipo_construccion', tipo);
    if (archivo) formData.append('archivo_pdf', archivo);
    
    // Mostrar loading
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculando...';
    btn.disabled = true;
    
    // Llamar a la IA
    fetch('/presupuestos/procesar-calculadora-ia', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        
        if (data.exito) {
            datosCalculoIA = data;
            mostrarResultadoIA(data);
        } else {
            alert('Error en el c√°lculo IA: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        alert('Error de conexi√≥n: ' + error.message);
    });
}

// Mostrar resultado del c√°lculo IA
function mostrarResultadoIA(data) {
    const panel = document.getElementById('calculoIAPanel');
    const resumen = document.getElementById('resultadoIAResumen');
    
    const materiales = Object.keys(data.presupuesto.materiales).length;
    const equipos = Object.keys(data.presupuesto.equipos).length;
    
    resumen.innerHTML = `
        <div class="row text-center">
            <div class="col-6">
                <h4 class="text-success">${data.superficie_calculada.toFixed(0)}</h4>
                <small>m¬≤ calculados</small>
            </div>
            <div class="col-6">
                <h4 class="text-primary">${materiales + equipos}</h4>
                <small>items calculados</small>
            </div>
        </div>
        <hr>
        <p class="small mb-0">
            <i class="fas fa-check-circle text-success"></i>
            Tipo: ${data.tipo_usado}
        </p>
    `;
    
    panel.style.display = 'block';
}

// Ver c√°lculo completo
function verCalculoCompleto() {
    if (datosCalculoIA) {
        window.open('/presupuestos/calculadora-ia', '_blank');
    }
}

// Limpiar formulario
function limpiarFormulario() {
    if (confirm('¬øEst√°s seguro de que quieres limpiar todos los campos?')) {
        document.getElementById('nuevoPresupuestoForm').reset();
        document.getElementById('archivoPlanoInfo').style.display = 'none';
        document.getElementById('calculoIAPanel').style.display = 'none';
        datosCalculoIA = null;
        
        // Limpiar etapas seleccionadas
        etapasSeleccionadasArray = [];
        actualizarVistaEtapas();
    }
}

// Validaci√≥n del formulario antes de enviar
document.getElementById('nuevoPresupuestoForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validaciones b√°sicas
    const nombre = document.getElementById('nombre_obra').value.trim();
    const tipo = document.getElementById('tipo_obra').value;
    const ubicacion = document.getElementById('ubicacion').value.trim();
    const tipoConst = document.getElementById('tipo_construccion').value;
    const superficie = document.getElementById('superficie_m2').value;
    
    if (!nombre || !tipo || !ubicacion || !tipoConst || !superficie) {
        alert('Por favor, completa todos los campos obligatorios marcados con *');
        return;
    }
    
    // Agregar etapas seleccionadas al formulario
    if (etapasSeleccionadasArray.length > 0) {
        // Crear campos ocultos para las etapas
        etapasSeleccionadasArray.forEach((etapa, index) => {
            const inputNombre = document.createElement('input');
            inputNombre.type = 'hidden';
            inputNombre.name = `etapas[${index}][nombre]`;
            inputNombre.value = etapa.nombre;
            this.appendChild(inputNombre);
            
            const inputDescripcion = document.createElement('input');
            inputDescripcion.type = 'hidden';
            inputDescripcion.name = `etapas[${index}][descripcion]`;
            inputDescripcion.value = etapa.descripcion;
            this.appendChild(inputDescripcion);
            
            const inputOrden = document.createElement('input');
            inputOrden.type = 'hidden';
            inputOrden.name = `etapas[${index}][orden]`;
            inputOrden.value = etapa.orden;
            this.appendChild(inputOrden);
        });
    }
    
    // Si todo est√° bien, enviar
    this.submit();
});
</script>

{% endblock %}