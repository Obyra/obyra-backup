{% extends "base.html" %}

{% block title %}Nuevo Presupuesto - OBYRA IA{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-plus text-primary"></i> Nuevo Presupuesto</h2>
                    <p class="text-muted mb-0">Crea un presupuesto completo con análisis inteligente de materiales</p>
                </div>
                <div class="btn-group" role="group">
                    <a href="{{ url_for('presupuestos.lista') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Volver
                    </a>
                    {% if has_endpoint('cotizacion.calculadora_inteligente') %}
                    <a href="{{ url_for('cotizacion.calculadora_inteligente') }}" class="btn btn-success">
                        <i class="fas fa-brain"></i> Calculadora IA
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Formulario Principal -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-building"></i> Información del Proyecto</h5>
                </div>
                <div class="card-body">
                    <form id="nuevoPresupuestoForm" method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="numero" id="numeroPresupuesto" value="{{ numero_sugerido }}">
                        <input type="hidden" id="iaEtapasPayload" name="ia_etapas_payload">
                        <input type="hidden" id="presupuestoIdInput" name="presupuesto_id" value="{{ presupuesto.id if presupuesto is defined and presupuesto else '' }}">
                        
                        <!-- Primera fila: Nombre y Tipo de Obra -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="nombre_obra" class="form-label fw-bold">
                                    <i class="fas fa-building text-primary"></i> Nombre de la Obra *
                                </label>
                                <input type="text" class="form-control form-control-lg" 
                                       id="nombre_obra" name="nombre_obra" required
                                       placeholder="Ej: Casa Familiar Rodriguez">
                                <div class="form-text">Nombre descriptivo del proyecto</div>
                            </div>
                            <div class="col-md-6">
                                <label for="tipo_obra" class="form-label fw-bold">
                                    <i class="fas fa-home text-warning"></i> Tipo de Obra *
                                </label>
                                <select class="form-select form-select-lg" id="tipo_obra" name="tipo_obra" required>
                                    <option value="">Seleccionar tipo...</option>
                                    <optgroup label="Casa">
                                        <option value="casa_1_planta">Casa - 1 Planta</option>
                                        <option value="casa_2_plantas">Casa - 2 Plantas</option>
                                        <option value="casa_3_plantas">Casa - 3 Plantas</option>
                                    </optgroup>
                                    <optgroup label="Edificio">
                                        <option value="edificio_3_5_pisos" data-min-pisos="3" data-max-pisos="5">Edificio de 3 a 5 pisos</option>
                                        <option value="edificio_6_10_pisos" data-min-pisos="6" data-max-pisos="10">Edificio de 6 a 10 pisos</option>
                                        <option value="edificio_11_15_pisos" data-min-pisos="11" data-max-pisos="15">Edificio de 11 a 15 pisos</option>
                                        <option value="edificio_16_30_pisos" data-min-pisos="16" data-max-pisos="30">Edificio de 16 a 30 pisos</option>
                                    </optgroup>
                                    <optgroup label="Otros">
                                        <option value="galpon">Galpones</option>
                                        <option value="planta_industrial">Plantas Industriales</option>
                                        <option value="obra_vial">Obras Viales</option>
                                        <option value="infraestructura">Infraestructura</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="col-md-6" id="campo_cantidad_pisos" style="display: none;">
                                <label for="cantidad_pisos" class="form-label fw-bold">
                                    <i class="fas fa-building text-primary"></i> Cantidad de Pisos *
                                </label>
                                <input type="number" class="form-control form-control-lg"
                                       id="cantidad_pisos" name="cantidad_pisos"
                                       min="1" max="50" step="1"
                                       placeholder="Ej: 4">
                                <div class="form-text" id="rango_pisos_text">Especifica la cantidad exacta de pisos</div>
                            </div>
                        </div>

                        <!-- Configuración Edificio por Niveles -->
                        <div id="seccion_edificio_niveles" style="display: none;" class="mb-4">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center py-2">
                                    <h6 class="mb-0"><i class="fas fa-layer-group"></i> Estructura por Niveles</h6>
                                    <button type="button" class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#modalConfigurarNiveles">
                                        <i class="fas fa-cog"></i> Configurar Niveles
                                    </button>
                                </div>
                                <div class="card-body py-2">
                                    <div class="row mb-2">
                                        <div class="col-3">
                                            <label class="form-label fw-bold small mb-1">Subsuelos</label>
                                            <input type="number" class="form-control form-control-sm" id="cant_subsuelos" min="0" max="5" value="0" onchange="generarNivelesDefault()">
                                        </div>
                                        <div class="col-3">
                                            <label class="form-label fw-bold small mb-1">Planta Baja</label>
                                            <select class="form-select form-select-sm" id="tiene_pb" onchange="generarNivelesDefault()">
                                                <option value="1">Si</option>
                                                <option value="0">No</option>
                                            </select>
                                        </div>
                                        <div class="col-3">
                                            <label class="form-label fw-bold small mb-1">Pisos Tipo</label>
                                            <input type="number" class="form-control form-control-sm bg-light" id="cant_pisos_tipo" min="0" value="0" readonly>
                                        </div>
                                        <div class="col-3">
                                            <label class="form-label fw-bold small mb-1">Terraza</label>
                                            <select class="form-select form-select-sm" id="tiene_terraza" onchange="generarNivelesDefault()">
                                                <option value="1">Si</option>
                                                <option value="0">No</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div id="niveles_chips_container" class="d-flex flex-wrap gap-1">
                                        <span class="text-muted small">Configura los niveles para ver el resumen...</span>
                                    </div>
                                    <input type="hidden" id="niveles_json" name="niveles_json">
                                </div>
                            </div>
                        </div>

                        <!-- Segunda fila: Ubicación y Tipo de Construcción -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="ubicacion" class="form-label fw-bold">
                                    <i class="fas fa-map-marker-alt text-muted"></i> Ubicación (opcional)
                                </label>
                                <div class="input-group input-group-lg">
                                    <input type="text" class="form-control" id="ubicacion" name="ubicacion"
                                           placeholder="Dirección completa o zona (opcional)">
                                    <button class="btn btn-outline-secondary" type="button" id="btnValidarUbicacion" title="Buscar ubicación en el mapa">
                                        <i class="fas fa-search-location"></i> Buscar
                                    </button>
                                </div>
                                <div class="form-text text-info" id="ubicacion_feedback">
                                    <i class="fas fa-info-circle"></i> Recomendamos agregar ubicación para visualización en mapa
                                </div>
                                <div id="ubicacion_sugerencias" class="list-group shadow-sm mt-2 d-none"></div>
                                <div id="ubicacion_mapa_wrapper" class="mt-3 d-none">
                                    <div id="ubicacion_mapa" style="height: 220px; border-radius: 12px; border: 1px solid #dee2e6; background: #f8f9fa; z-index: 1;"></div>
                                    <small class="text-muted d-block mt-2" id="ubicacion_meta"></small>
                                </div>
                                <input type="hidden" id="ubicacion_lat" name="ubicacion_lat">
                                <input type="hidden" id="ubicacion_lng" name="ubicacion_lng">
                                <input type="hidden" id="ubicacion_normalizada" name="ubicacion_normalizada">
                                <input type="hidden" id="ubicacion_place_id" name="ubicacion_place_id">
                                <input type="hidden" id="ubicacion_provider" name="ubicacion_provider">
                                <input type="hidden" id="ubicacion_geocode_status" name="ubicacion_geocode_status">
                            </div>
                            <div class="col-md-6">
                                <label for="tipo_construccion" class="form-label fw-bold">
                                    <i class="fas fa-star text-warning"></i> Tipo de Construcción *
                                </label>
                                <select class="form-select form-select-lg" id="tipo_construccion" name="tipo_construccion" required>
                                    <option value="">Seleccionar nivel...</option>
                                    <option value="economica">Económica</option>
                                    <option value="estandar">Estándar</option>
                                    <option value="premium">Premium</option>
                                </select>
                                <div class="form-text">
                                    <small>
                                        <span class="badge bg-light text-dark">Económica: 1.0x</span>
                                        <span class="badge bg-primary">Estándar: 1.3x</span>
                                        <span class="badge bg-warning text-dark">Premium: 1.8x</span>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Tercera fila: Superficie y Fechas -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label for="superficie_m2" class="form-label fw-bold">
                                    <i class="fas fa-ruler-combined text-success"></i> Superficie (m²) *
                                </label>
                                <input type="number" class="form-control form-control-lg"
                                       id="superficie_m2" name="superficie_m2"
                                       step="0.01" min="1" required
                                       placeholder="120.50">
                                <div class="form-text">Metros cuadrados totales</div>
                                {% if current_user.rol in ['administrador', 'tecnico'] or current_user.role in ['admin', 'pm'] %}
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="aplicar_desperdicio" checked>
                                    <label class="form-check-label" for="aplicar_desperdicio">
                                        <i class="fas fa-percent text-warning"></i> Aplicar 10% de desperdicio en materiales
                                    </label>
                                    <div class="form-text text-muted small">
                                        <i class="fas fa-info-circle"></i> Suma 10% adicional a las cantidades calculadas para cubrir desperdicios
                                    </div>
                                </div>
                                {% else %}
                                <input type="hidden" id="aplicar_desperdicio" value="true">
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label for="fecha_inicio" class="form-label fw-bold">
                                    <i class="fas fa-calendar-alt text-info"></i> Fecha Inicio
                                </label>
                                <input type="date" class="form-control form-control-lg" 
                                       id="fecha_inicio" name="fecha_inicio">
                                <div class="form-text">Fecha estimada de inicio</div>
                            </div>
                            <div class="col-md-4">
                                <label for="fecha_fin" class="form-label fw-bold">
                                    <i class="fas fa-calendar-check text-info"></i> Fecha Finalización
                                </label>
                                <input type="date" class="form-control form-control-lg" 
                                       id="fecha_fin" name="fecha_fin">
                                <div class="form-text">Fecha estimada de entrega</div>
                            </div>
                        </div>

                        <!-- Cuarta fila: Presupuesto -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="presupuesto_disponible" class="form-label fw-bold">
                                    <i class="fas fa-dollar-sign text-success"></i> Presupuesto Disponible
                                </label>
                                <div class="input-group input-group-lg">
                                    <select class="form-select" id="moneda" name="moneda" style="max-width: 100px;">
                                        <option value="ARS">ARS</option>
                                        <option value="USD">USD</option>
                                    </select>
                                    <input type="number" class="form-control"
                                           id="presupuesto_disponible" name="presupuesto_disponible"
                                           step="0.01" min="0" placeholder="0.00">
                                </div>
                                <div class="form-text">
                                    Presupuesto máximo disponible (opcional). Si eliges USD usaremos la cotización oficial del Banco Nación.
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="cliente_id" class="form-label fw-bold">
                                    <i class="fas fa-user text-secondary"></i> Cliente
                                </label>
                                <div class="input-group input-group-lg">
                                    <select class="form-select" id="cliente_id" name="cliente_id">
                                        <option value="">Sin cliente asignado</option>
                                        {% for cliente in clientes %}
                                        <option value="{{ cliente.id }}">
                                            {{ cliente.nombre_completo }} - {{ cliente.email }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalCrearCliente" title="Crear nuevo cliente">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <a href="{{ url_for('clientes.lista') }}" class="btn btn-outline-secondary" target="_blank" title="Ver todos los clientes">
                                        <i class="fas fa-users"></i>
                                    </a>
                                </div>
                                <div class="form-text">Selecciona el cliente o créalo haciendo clic en +</div>
                        </div>
                    </div>

                    <!-- Quinta fila: Vigencia -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label for="vigencia_dias" class="form-label fw-bold">
                                <i class="fas fa-hourglass-half text-primary"></i> Vigencia (días)
                            </label>
                            <input type="number" class="form-control form-control-lg"
                                   id="vigencia_dias" name="vigencia_dias"
                                   min="1" max="180" value="{{ request.form.get('vigencia_dias', 30) }}"
                                   required>
                            <div class="form-text">Entre 1 y 180 días. Define cuánto tiempo es válido el presupuesto.</div>
                        </div>
                    </div>

                    <!-- Upload de Plano -->
                    <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-file-pdf text-danger"></i> Plano Arquitectónico (PDF)
                            </label>
                            <div class="card border-2 border-dashed" style="border-color: #dee2e6;">
                                <div class="card-body text-center py-4">
                                    <input type="file" class="form-control d-none" 
                                           id="plano_pdf" name="plano_pdf" accept=".pdf"
                                           onchange="mostrarArchivoPlano()">
                                    <div id="dropZone" onclick="document.getElementById('plano_pdf').click();" 
                                         style="cursor: pointer;">
                                        <i class="fas fa-upload fa-2x text-muted mb-2"></i>
                                        <p class="mb-1"><strong>Arrastra y suelta tu plano PDF aquí</strong></p>
                                        <p class="text-muted mb-0">o haz clic para seleccionar archivo</p>
                                    </div>
                                    <div id="archivoPlanoInfo" class="alert alert-info mt-3" style="display: none;">
                                        <i class="fas fa-file-pdf text-danger"></i>
                                        <span id="nombreArchivoPlano"></span>
                                        <button type="button" class="btn btn-sm btn-outline-secondary ms-2" 
                                                onclick="removerArchivo()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-text">
                                <i class="fas fa-info-circle"></i> 
                                Si subes un plano, la IA podrá extraer automáticamente las dimensiones
                            </div>
                        </div>

                        <!-- Sección de Etapas del Proyecto -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <label class="form-label fw-bold mb-0">
                                    <i class="fas fa-tasks text-info"></i> Etapas del Proyecto
                                </label>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="mostrarPanelEtapas()">
                                    <i class="fas fa-plus"></i> Nueva Etapa
                                </button>
                            </div>
                            
                            <!-- Lista de etapas seleccionadas -->
                            <div id="etapasSeleccionadas" class="card bg-light p-3">
                                <div id="listaEtapas" class="text-muted small">
                                    <i class="fas fa-info-circle"></i> No se han seleccionado etapas aún. Haz clic en "Nueva Etapa" para agregar.
                                </div>
                            </div>

                            <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mt-3">
                                <div class="text-muted small">
                                    <i class="fas fa-info-circle"></i>
                                    Marca las etapas que quieres recalcular con IA y ajusta los datos antes de guardar.
                                </div>
                                <div class="d-flex flex-wrap gap-2">
                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="calcularEtapasSeleccionadasIA()">
                                        <i class="fas fa-brain"></i> Calcular etapas seleccionadas con IA
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Botones de acción -->
                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-save"></i> CREAR PRESUPUESTO
                                </button>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>

        <!-- Panel Lateral con información -->
        <div class="col-lg-4">
            
            <!-- Guía rápida -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-lightbulb"></i> Guía Rápida</h6>
                </div>
                <div class="card-body">
                    <div class="small">
                        <p><strong>Para mejores resultados:</strong></p>
                        <ul class="mb-0">
                            <li>Sube un plano PDF para análisis automático</li>
                            <li>Especifica la superficie si no tienes plano</li>
                            <li>Elige el tipo de construcción apropiado</li>
                            <li>Usa "Calcular con IA" para obtener materiales</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Tipos de construcción -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="fas fa-star"></i> Tipos de Construcción</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-12 mb-2">
                            <div class="bg-light p-2 rounded">
                                <strong class="text-success">Económica</strong><br>
                                <small>Materiales básicos, acabados sencillos</small>
                            </div>
                        </div>
                        <div class="col-12 mb-2">
                            <div class="bg-light p-2 rounded">
                                <strong class="text-primary">Estándar</strong><br>
                                <small>Calidad media, acabados intermedios</small>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="bg-light p-2 rounded">
                                <strong class="text-warning">Premium</strong><br>
                                <small>Alta calidad, acabados superiores</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estado del cálculo IA -->
            <div id="calculoIAPanel" class="card shadow-sm" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="fas fa-robot"></i> Cálculo IA Completado</h6>
                </div>
                <div class="card-body">
                    <div id="resultadoIAResumen" class="text-center">
                        <!-- Se completará con JavaScript -->
                    </div>
                    <div class="d-grid mt-3">
                        <button class="btn btn-outline-success btn-sm" onclick="verCalculoCompleto()">
                            <i class="fas fa-eye"></i> Ver Cálculo Completo
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Modal para selección de etapas predefinidas -->
<div class="modal fade" id="modalEtapas" tabindex="-1" aria-labelledby="modalEtapasLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalEtapasLabel">
                    <i class="fas fa-tasks me-2"></i>Seleccionar Etapas del Proyecto
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-9">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0"><i class="fas fa-list-check text-primary"></i> Etapas Predefinidas</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="seleccionarTodasEtapas">
                                <label class="form-check-label" for="seleccionarTodasEtapas">
                                    Seleccionar todas
                                </label>
                            </div>
                        </div>
                        <div class="row" id="etapasPredefinidas">
                            <!-- Se cargarán con JavaScript -->
                        </div>
                    </div>
                    <div class="col-md-3">
                        <h6 class="mb-3"><i class="fas fa-plus-circle text-success"></i> Etapa Personalizada</h6>
                        <div class="mb-3">
                            <label for="etapaPersonalizadaNombre" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="etapaPersonalizadaNombre" placeholder="Ej: Pintura Especial">
                        </div>
                        <div class="mb-3">
                            <label for="etapaPersonalizadaDescripcion" class="form-label">Descripción</label>
                            <textarea class="form-control" id="etapaPersonalizadaDescripcion" rows="3" placeholder="Descripción detallada..."></textarea>
                        </div>
                        <button type="button" class="btn btn-success btn-sm" onclick="agregarEtapaPersonalizada()">
                            <i class="fas fa-plus"></i> Agregar Personalizada
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Selecciona múltiples etapas o agrega personalizadas
                    </small>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="confirmarEtapasSeleccionadas()">
                    <i class="fas fa-check"></i> Confirmar Selección
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de vista previa IA por etapas -->
<div class="modal fade" id="modalResultadoEtapasIA" tabindex="-1" aria-labelledby="modalResultadoEtapasIALabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalResultadoEtapasIALabel">
                    <i class="fas fa-brain me-2"></i>Resultados IA por etapas seleccionadas
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div id="resultadoEtapasIAContenido" class="mb-3">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p class="mt-2">Calculando...</p>
                    </div>
                </div>
                <div class="alert alert-info" id="resumenEtapasIAMetadatos" style="display: none;"></div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <div class="text-muted small">
                    <i class="fas fa-robot me-1"></i>
                    Los valores calculados se guardarán con el presupuesto cuando confirmes la creación.
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-success" onclick="aplicarResultadosEtapasIA()">
                        <i class="fas fa-save"></i> Aplicar al presupuesto
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const hiddenPresupuestoIdInput = document.getElementById('presupuestoIdInput');
if (typeof window !== 'undefined') {
    window.PRESUPUESTO_ID = hiddenPresupuestoIdInput ? (hiddenPresupuestoIdInput.value || null) : null;
}

let currencyFormatter = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' });

function updateCurrencyFormatter(selectedCurrency) {
    const currency = (selectedCurrency || 'ARS').toUpperCase();
    const locale = currency === 'USD' ? 'en-US' : 'es-AR';
    currencyFormatter = new Intl.NumberFormat(locale, { style: 'currency', currency });
}

const monedaSelect = document.getElementById('moneda');
if (monedaSelect) {
    updateCurrencyFormatter(monedaSelect.value);
    monedaSelect.addEventListener('change', (event) => {
        updateCurrencyFormatter(event.target.value);
    });
}

let datosCalculoIA = null;
let etapasSeleccionadasArray = [];
let etapasSeleccionadasIA = new Set();
let resultadoEtapasIA = null;
const presupuestoId = (typeof window !== 'undefined' && window.PRESUPUESTO_ID) ? window.PRESUPUESTO_ID : null;

let ubicacionMap = null;
let ubicacionMarker = null;
let sugerenciasActuales = [];
let sugerenciaSeleccionada = -1;
let ubicacionDebounceTimer = null;
let ultimaConsultaUbicacion = '';

const geocodeSugerenciasCache = new Map();
const MIN_CARACTERES_UBICACION = 3;
const UBICACION_DEBOUNCE_MS = 300;

const ubicacionInput = document.getElementById('ubicacion');
const btnValidarUbicacion = document.getElementById('btnValidarUbicacion');
const ubicacionFeedback = document.getElementById('ubicacion_feedback');
const ubicacionSugerencias = document.getElementById('ubicacion_sugerencias');
const ubicacionMapaWrapper = document.getElementById('ubicacion_mapa_wrapper');
const ubicacionMeta = document.getElementById('ubicacion_meta');

document.addEventListener('DOMContentLoaded', () => {
    if (ubicacionInput) {
        ubicacionInput.addEventListener('input', manejarCambioUbicacion);
        ubicacionInput.addEventListener('keydown', manejarTeclasUbicacion);
    }
    if (btnValidarUbicacion) {
        btnValidarUbicacion.addEventListener('click', () => buscarUbicacion(null, { autoSelectFirst: true }));
    }
    document.addEventListener('click', (event) => {
        if (!ubicacionSugerencias || ubicacionSugerencias.classList.contains('d-none')) {
            return;
        }
        if (event.target === ubicacionInput) {
            return;
        }
        if (ubicacionSugerencias.contains(event.target)) {
            return;
        }
        ocultarSugerencias();
    });

    // Event listener para checkbox "Seleccionar todas"
    const checkboxSeleccionarTodas = document.getElementById('seleccionarTodasEtapas');
    if (checkboxSeleccionarTodas) {
        checkboxSeleccionarTodas.addEventListener('change', function() {
            const checkboxesEtapas = document.querySelectorAll('.etapa-predefinida-checkbox');
            const marcar = this.checked;

            checkboxesEtapas.forEach(checkbox => {
                if (checkbox.checked !== marcar) {
                    checkbox.checked = marcar;
                    // Extraer el slug del ID del checkbox (formato: etapa_{slug})
                    const slug = checkbox.id.replace('etapa_', '');
                    toggleEtapaPredefinida(slug);
                }
            });
        });
    }

    // Event listener para mostrar campo de cantidad de pisos en edificios
    const tipoObraSelect = document.getElementById('tipo_obra');
    const campoCantidadPisos = document.getElementById('campo_cantidad_pisos');
    const cantidadPisosInput = document.getElementById('cantidad_pisos');
    const rangoPisosText = document.getElementById('rango_pisos_text');

    const seccionEdificioNiveles = document.getElementById('seccion_edificio_niveles');

    if (tipoObraSelect && campoCantidadPisos) {
        tipoObraSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const minPisos = selectedOption.dataset.minPisos;
            const maxPisos = selectedOption.dataset.maxPisos;
            const val = this.value;
            const esEdificio = val.startsWith('edificio_');

            if (minPisos && maxPisos) {
                campoCantidadPisos.style.display = 'block';
                cantidadPisosInput.min = minPisos;
                cantidadPisosInput.max = maxPisos;
                cantidadPisosInput.required = true;
                const valorMedio = Math.round((parseInt(minPisos) + parseInt(maxPisos)) / 2);
                cantidadPisosInput.value = valorMedio;
                cantidadPisosInput.placeholder = `Entre ${minPisos} y ${maxPisos} pisos`;
                rangoPisosText.textContent = `Rango permitido: ${minPisos} a ${maxPisos} pisos`;
            } else {
                campoCantidadPisos.style.display = 'none';
                cantidadPisosInput.required = false;
                cantidadPisosInput.value = '';
            }

            // Mostrar/ocultar sección de niveles para edificios
            if (seccionEdificioNiveles) {
                seccionEdificioNiveles.style.display = esEdificio ? 'block' : 'none';
                if (esEdificio) {
                    actualizarPisosTipo();
                    generarNivelesDefault();
                } else {
                    window.nivelesConfig = [];
                    actualizarChipsNiveles();
                }
            }
        });

        // Cuando cambia cantidad de pisos, recalcular pisos tipo y regenerar niveles
        if (cantidadPisosInput) {
            cantidadPisosInput.addEventListener('change', function() {
                actualizarPisosTipo();
                generarNivelesDefault();
            });
        }
    }
});

function actualizarFeedbackUbicacion(texto, tipo = 'muted') {
    if (!ubicacionFeedback) return;
    ubicacionFeedback.textContent = texto;
    ubicacionFeedback.classList.remove('text-success', 'text-danger', 'text-muted');
    if (tipo === 'success') {
        ubicacionFeedback.classList.add('text-success');
    } else if (tipo === 'danger') {
        ubicacionFeedback.classList.add('text-danger');
    } else {
        ubicacionFeedback.classList.add('text-muted');
    }
}

function limpiarGeocodificacion(resetVisual = false) {
    ['ubicacion_lat', 'ubicacion_lng', 'ubicacion_normalizada', 'ubicacion_place_id', 'ubicacion_provider', 'ubicacion_geocode_status']
        .forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.value = '';
            }
        });

    sugerenciaSeleccionada = -1;
    sugerenciasActuales = [];
    if (resetVisual) {
        ultimaConsultaUbicacion = '';
    }
    if (ubicacionSugerencias) {
        ubicacionSugerencias.classList.add('d-none');
        ubicacionSugerencias.innerHTML = '';
    }

    if (resetVisual) {
        if (ubicacionMapaWrapper) {
            ubicacionMapaWrapper.classList.add('d-none');
        }
        if (ubicacionMeta) {
            ubicacionMeta.textContent = '';
        }
        if (ubicacionMarker) {
            ubicacionMarker.remove();
            ubicacionMarker = null;
        }
        actualizarFeedbackUbicacion('Ciudad, provincia o dirección específica', 'muted');
    }
}

function manejarCambioUbicacion(event) {
    limpiarGeocodificacion(true);

    if (ubicacionDebounceTimer) {
        clearTimeout(ubicacionDebounceTimer);
        ubicacionDebounceTimer = null;
    }

    const valor = (event.target && typeof event.target.value === 'string') ? event.target.value : '';
    const consulta = valor.trim();

    if (consulta.length < MIN_CARACTERES_UBICACION) {
        ultimaConsultaUbicacion = '';
        return;
    }

    ubicacionDebounceTimer = setTimeout(() => {
        ultimaConsultaUbicacion = consulta;
        buscarUbicacion(consulta, { autoSelectFirst: false, triggeredByInput: true });
    }, UBICACION_DEBOUNCE_MS);
}

function manejarTeclasUbicacion(event) {
    if (!sugerenciasActuales || sugerenciasActuales.length === 0) {
        return;
    }
    if (!ubicacionSugerencias || ubicacionSugerencias.classList.contains('d-none')) {
        return;
    }

    switch (event.key) {
        case 'ArrowDown':
            event.preventDefault();
            sugerenciaSeleccionada = (sugerenciaSeleccionada + 1) % sugerenciasActuales.length;
            renderSugerencias(sugerenciaSeleccionada);
            break;
        case 'ArrowUp':
            event.preventDefault();
            sugerenciaSeleccionada = sugerenciaSeleccionada <= 0
                ? sugerenciasActuales.length - 1
                : sugerenciaSeleccionada - 1;
            renderSugerencias(sugerenciaSeleccionada);
            break;
        case 'Enter':
            if (sugerenciaSeleccionada >= 0 && sugerenciaSeleccionada < sugerenciasActuales.length) {
                event.preventDefault();
                aplicarGeocodificacion(sugerenciasActuales[sugerenciaSeleccionada], sugerenciaSeleccionada);
            }
            break;
        case 'Escape':
            event.preventDefault();
            ocultarSugerencias();
            break;
        default:
            break;
    }
}

function ocultarSugerencias() {
    if (!ubicacionSugerencias) return;
    ubicacionSugerencias.classList.add('d-none');
}

function enfocarSugerenciaActiva() {
    if (!ubicacionSugerencias) return;
    const activa = ubicacionSugerencias.querySelector('.active');
    if (activa) {
        activa.scrollIntoView({ block: 'nearest' });
    }
}

function inicializarMapaUbicacion(lat, lng) {
    if (typeof L === 'undefined') {
        console.warn('Leaflet no está disponible.');
        return;
    }
    // Asegurar que el contenedor sea visible antes de inicializar
    if (ubicacionMapaWrapper) {
        ubicacionMapaWrapper.classList.remove('d-none');
    }
    if (!ubicacionMap) {
        ubicacionMap = L.map('ubicacion_mapa', {
            scrollWheelZoom: false,
        });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap, &copy; CARTO',
            maxZoom: 20,
            subdomains: 'abcd',
        }).addTo(ubicacionMap);
    }
    ubicacionMap.setView([lat, lng], 15);
    if (ubicacionMarker) {
        ubicacionMarker.setLatLng([lat, lng]);
    } else {
        ubicacionMarker = L.marker([lat, lng]).addTo(ubicacionMap);
    }
    // Forzar recalculo de tamaño varias veces para asegurar renderizado
    requestAnimationFrame(() => {
        ubicacionMap.invalidateSize();
        setTimeout(() => ubicacionMap.invalidateSize(), 300);
        setTimeout(() => ubicacionMap.invalidateSize(), 800);
    });
}

function renderSugerencias(selectedIndex = null) {
    if (!ubicacionSugerencias) return;
    ubicacionSugerencias.innerHTML = '';
    if (!sugerenciasActuales || sugerenciasActuales.length === 0) {
        ubicacionSugerencias.classList.add('d-none');
        return;
    }

    sugerenciasActuales.forEach((item, index) => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'list-group-item list-group-item-action';
        button.dataset.index = String(index);
        if (selectedIndex !== null && index === selectedIndex) {
            button.classList.add('active');
        }
        button.textContent = item.display_name || item.normalized || 'Dirección sugerida';
        button.addEventListener('click', () => aplicarGeocodificacion(item, index));
        ubicacionSugerencias.appendChild(button);
    });
    ubicacionSugerencias.classList.remove('d-none');
    enfocarSugerenciaActiva();
}

function aplicarGeocodificacion(data, index = 0) {
    if (!data) {
        return;
    }

    const latNum = Number(data.lat);
    const lngNum = Number(data.lon);
    if (Number.isFinite(latNum) && Number.isFinite(lngNum)) {
        const latInput = document.getElementById('ubicacion_lat');
        const lngInput = document.getElementById('ubicacion_lng');
        if (latInput) latInput.value = latNum;
        if (lngInput) lngInput.value = lngNum;
        if (ubicacionMapaWrapper) {
            ubicacionMapaWrapper.classList.remove('d-none');
        }
        inicializarMapaUbicacion(latNum, lngNum);
    }

    const normalizada = data.normalized || data.display_name || (ubicacionInput ? ubicacionInput.value.trim() : '');
    if (ubicacionInput && normalizada) {
        ubicacionInput.value = normalizada;
    }
    const normalizedInput = document.getElementById('ubicacion_normalizada');
    if (normalizedInput) normalizedInput.value = normalizada;

    const placeInput = document.getElementById('ubicacion_place_id');
    if (placeInput) placeInput.value = data.place_id || '';

    const providerInput = document.getElementById('ubicacion_provider');
    if (providerInput) providerInput.value = data.provider || '';

    const statusInput = document.getElementById('ubicacion_geocode_status');
    if (statusInput) statusInput.value = data.status || 'ok';

    if (ubicacionMeta) {
        const fuente = (data.provider || 'nominatim').toUpperCase();
        ubicacionMeta.textContent = `Fuente: ${fuente} · Lat ${latNum.toFixed(5)}, Lng ${lngNum.toFixed(5)}`;
    }

    actualizarFeedbackUbicacion('Ubicación validada correctamente.', 'success');
    sugerenciaSeleccionada = index;
    renderSugerencias(index);
    ultimaConsultaUbicacion = normalizada || ultimaConsultaUbicacion;
    ocultarSugerencias();
}

async function buscarUbicacion(query = null, options = {}) {
    if (!ubicacionInput) {
        return;
    }
    const { autoSelectFirst = false, triggeredByInput = false } = options;
    const direccion = (query !== null && typeof query === 'string') ? query.trim() : ubicacionInput.value.trim();
    if (!direccion) {
        actualizarFeedbackUbicacion('Ingresa una dirección para validar.', 'danger');
        limpiarGeocodificacion(true);
        return;
    }

    ultimaConsultaUbicacion = direccion;

    const cacheKey = direccion.toLowerCase();
    const cached = geocodeSugerenciasCache.get(cacheKey);
    if (cached) {
        sugerenciasActuales = cached;
        if (sugerenciasActuales.length === 0) {
            actualizarFeedbackUbicacion('No encontramos coincidencias para la dirección ingresada.', 'danger');
            return;
        }
        sugerenciaSeleccionada = sugerenciasActuales.length ? 0 : -1;
        renderSugerencias(sugerenciaSeleccionada);
        if (autoSelectFirst) {
            aplicarGeocodificacion(sugerenciasActuales[0], 0);
        } else {
            actualizarFeedbackUbicacion('Selecciona una sugerencia para validar la dirección.', 'muted');
        }
        return;
    }

    actualizarFeedbackUbicacion('Buscando coincidencias…', 'muted');

    if (btnValidarUbicacion && !triggeredByInput) {
        btnValidarUbicacion.disabled = true;
    }

    try {
        const response = await fetch(`/obras/api/buscar-direcciones?q=${encodeURIComponent(direccion)}`);
        if (!response.ok) {
            throw new Error('No se pudo validar la dirección');
        }
        const data = await response.json();
        sugerenciasActuales = (data && data.results) ? data.results : [];
        geocodeSugerenciasCache.set(cacheKey, sugerenciasActuales);

        if (sugerenciasActuales.length === 0) {
            limpiarGeocodificacion(true);
            actualizarFeedbackUbicacion('No encontramos coincidencias para la dirección ingresada.', 'danger');
            return;
        }

        sugerenciaSeleccionada = 0;
        renderSugerencias(sugerenciaSeleccionada);
        if (autoSelectFirst) {
            aplicarGeocodificacion(sugerenciasActuales[0], 0);
        } else {
            actualizarFeedbackUbicacion('Selecciona una sugerencia para validar la dirección.', 'muted');
        }
    } catch (error) {
        console.error('Error geocodificando:', error);
        limpiarGeocodificacion(true);
        actualizarFeedbackUbicacion('No se pudo validar la ubicación. Intenta nuevamente más tarde.', 'danger');
    } finally {
        if (btnValidarUbicacion && !triggeredByInput) {
            btnValidarUbicacion.disabled = false;
        }
    }
}

function slugifyEtapa(nombre) {
    if (!nombre) return '';
    return nombre
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '');
}

function generarSlugUnico(nombre) {
    const base = slugifyEtapa(nombre);
    let slug = base || `etapa-${Date.now()}`;
    let contador = 1;
    const slugExistente = (valor) => {
        return ETAPAS_PREDEFINIDAS.some(e => e.slug === valor) || etapasSeleccionadasArray.some(e => (e.slug || slugifyEtapa(e.nombre)) === valor);
    };
    while (slugExistente(slug)) {
        slug = `${base}-${contador++}`;
    }
    return slug;
}

function limpiarResultadosEtapasIA(resetBadges = true) {
    resultadoEtapasIA = null;
    const hidden = document.getElementById('iaEtapasPayload');
    if (hidden) hidden.value = '';
    if (resetBadges) {
        etapasSeleccionadasArray.forEach(etapa => {
            etapa.ia_aplicada = false;
        });
        actualizarVistaEtapas(false);
    }
}

function obtenerEtapaPorSlug(slug) {
    return etapasSeleccionadasArray.find(etapa => (etapa.slug || slugifyEtapa(etapa.nombre)) === slug);
}

const ETAPAS_PREDEFINIDAS = [
    { nombre: 'Preliminares y Obrador', descripcion: 'Permisos, obrador y replanteo general', orden: 5, slug: 'preliminares-obrador' },
    { nombre: 'Demoliciones', descripcion: 'Demolición de estructuras existentes', orden: 6, slug: 'demoliciones' },
    { nombre: 'Movimiento de Suelos', descripcion: 'Excavación masiva, rellenos y compactación', orden: 7, slug: 'movimiento-de-suelos' },
    { nombre: 'Apuntalamientos', descripcion: 'Sostenimiento provisorio de estructuras', orden: 8, slug: 'apuntalamientos' },
    { nombre: 'Depresión de Napa / Bombeo', descripcion: 'Control de nivel freático y achique', orden: 9, slug: 'depresion-de-napa' },
    { nombre: 'Excavación', descripcion: 'Movimiento de suelos y preparación del terreno', orden: 10, slug: 'excavacion' },
    { nombre: 'Fundaciones', descripcion: 'Cimientos y estructuras de base', orden: 20, slug: 'fundaciones' },
    { nombre: 'Estructura', descripcion: 'Hormigón / acero', orden: 30, slug: 'estructura' },
    { nombre: 'Mampostería', descripcion: 'Muros y paredes', orden: 40, slug: 'mamposteria' },
    { nombre: 'Construcción en Seco', descripcion: 'Steel/wood frame, placas de yeso (Durlock)', orden: 42, slug: 'construccion-en-seco' },
    { nombre: 'Techos', descripcion: 'Cubiertas e impermeabilización', orden: 50, slug: 'techos' },
    { nombre: 'Instalaciones Eléctricas', descripcion: 'Sistema eléctrico', orden: 60, slug: 'instalaciones-electricas' },
    { nombre: 'Instalaciones Sanitarias', descripcion: 'Agua y desagües', orden: 70, slug: 'instalaciones-sanitarias' },
    { nombre: 'Instalaciones de Gas', descripcion: 'Sistema de gas natural', orden: 80, slug: 'instalaciones-gas' },
    { nombre: 'Ventilaciones y Conductos', descripcion: 'Conductos de ventilación, extracción y tiro', orden: 82, slug: 'ventilaciones-conductos' },
    { nombre: 'Impermeabilizaciones y Aislaciones', descripcion: 'Membranas, hidrófugos, aislación térmica y acústica', orden: 85, slug: 'impermeabilizaciones-aislaciones' },
    { nombre: 'Revoque Grueso', descripcion: 'Base en paredes', orden: 90, slug: 'revoque-grueso' },
    { nombre: 'Cielorrasos', descripcion: 'Cielorrasos aplicados, suspendidos y desmontables', orden: 95, slug: 'cielorrasos' },
    { nombre: 'Yesería y Enlucidos', descripcion: 'Enlucido de yeso, estucados y molduras', orden: 98, slug: 'yeseria-enlucidos' },
    { nombre: 'Revoque Fino', descripcion: 'Terminación', orden: 100, slug: 'revoque-fino' },
    { nombre: 'Contrapisos y Carpetas', descripcion: 'Contrapisos, carpetas de nivelación y pendientes', orden: 105, slug: 'contrapisos-carpetas' },
    { nombre: 'Pisos', descripcion: 'Colocación y revestimientos', orden: 110, slug: 'pisos' },
    { nombre: 'Revestimientos', descripcion: 'Cerámicos, porcellanato, piedra y terminaciones', orden: 112, slug: 'revestimientos' },
    { nombre: 'Carpintería', descripcion: 'Puertas, ventanas, muebles', orden: 120, slug: 'carpinteria' },
    { nombre: 'Pintura', descripcion: 'Interior y exterior', orden: 130, slug: 'pintura' },
    { nombre: 'Provisiones y Colocaciones', descripcion: 'Griferías, sanitarios, accesorios y terminaciones', orden: 135, slug: 'provisiones-colocaciones' },
    { nombre: 'Instalaciones Complementarias', descripcion: 'A/A, calefacción, etc.', orden: 140, slug: 'instalaciones-complementarias' },
    { nombre: 'Limpieza Final', descripcion: 'Acondicionamiento final', orden: 150, slug: 'limpieza-final' }
];

function mostrarPanelEtapas() {
    cargarEtapasPredefinidas();
    const modal = new bootstrap.Modal(document.getElementById('modalEtapas'));
    modal.show();
}

function cargarEtapasPredefinidas() {
    const container = document.getElementById('etapasPredefinidas');
    container.innerHTML = '';
    ETAPAS_PREDEFINIDAS.forEach((etapa) => {
        const yaSeleccionada = etapasSeleccionadasArray.some(e => (e.slug || slugifyEtapa(e.nombre)) === etapa.slug);
        const checkboxId = `etapa_${etapa.slug}`;
        const etapaHTML = `
            <div class="col-md-4 mb-2">
                <div class="form-check">
                    <input class="form-check-input etapa-predefinida-checkbox" type="checkbox" id="${checkboxId}" ${yaSeleccionada ? 'checked' : ''}
                           onchange="toggleEtapaPredefinida('${etapa.slug}')">
                    <label class="form-check-label" for="${checkboxId}">
                        <strong>${etapa.nombre}</strong>
                        <br><small class="text-muted">${etapa.descripcion}</small>
                    </label>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', etapaHTML);
    });

    // Actualizar el estado del checkbox "Seleccionar todas"
    actualizarCheckboxSeleccionarTodas();
}

function actualizarCheckboxSeleccionarTodas() {
    const checkboxTodas = document.getElementById('seleccionarTodasEtapas');
    if (!checkboxTodas) return;

    const checkboxesEtapas = document.querySelectorAll('.etapa-predefinida-checkbox');
    const todasMarcadas = Array.from(checkboxesEtapas).every(cb => cb.checked);
    const algunaMarcada = Array.from(checkboxesEtapas).some(cb => cb.checked);

    checkboxTodas.checked = todasMarcadas;
    checkboxTodas.indeterminate = algunaMarcada && !todasMarcadas;
}

function toggleEtapaPredefinida(slug) {
    const etapa = ETAPAS_PREDEFINIDAS.find(e => e.slug === slug);
    const checkbox = document.getElementById(`etapa_${slug}`);
    if (!etapa || !checkbox) return;

    if (checkbox.checked) {
        if (!etapasSeleccionadasArray.some(e => (e.slug || slugifyEtapa(e.nombre)) === slug)) {
            etapasSeleccionadasArray.push({ ...etapa, personalizada: false });
            etapasSeleccionadasIA.add(slug);
        }
    } else {
        etapasSeleccionadasArray = etapasSeleccionadasArray.filter(e => (e.slug || slugifyEtapa(e.nombre)) !== slug);
        etapasSeleccionadasIA.delete(slug);
    }
    limpiarResultadosEtapasIA();
    actualizarCheckboxSeleccionarTodas();
    console.log(`📋 Etapas seleccionadas: ${etapasSeleccionadasArray.length}`);
}

function agregarEtapaPersonalizada() {
    const nombre = document.getElementById('etapaPersonalizadaNombre').value.trim();
    const descripcion = document.getElementById('etapaPersonalizadaDescripcion').value.trim();

    if (!nombre) {
        alert('Ingresa el nombre de la etapa personalizada');
        return;
    }

    if (etapasSeleccionadasArray.some(e => e.nombre.toLowerCase() === nombre.toLowerCase())) {
        alert('Ya existe una etapa con ese nombre');
        return;
    }

    const slug = generarSlugUnico(nombre);
    const nuevaEtapa = {
        nombre,
        descripcion: descripcion || 'Etapa personalizada',
        orden: etapasSeleccionadasArray.length + 100,
        personalizada: true,
        slug
    };

    etapasSeleccionadasArray.push(nuevaEtapa);
    etapasSeleccionadasIA.add(slug);
    document.getElementById('etapaPersonalizadaNombre').value = '';
    document.getElementById('etapaPersonalizadaDescripcion').value = '';
    limpiarResultadosEtapasIA();
    actualizarVistaEtapas();
    console.log(`✅ Etapa personalizada agregada: ${nombre}`);
}

function confirmarEtapasSeleccionadas() {
    if (etapasSeleccionadasArray.length === 0) {
        alert('Selecciona al menos una etapa antes de confirmar');
        return;
    }

    if (etapasSeleccionadasIA.size === 0) {
        etapasSeleccionadasArray.forEach(etapa => etapasSeleccionadasIA.add(etapa.slug || slugifyEtapa(etapa.nombre)));
    }

    actualizarVistaEtapas();
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalEtapas'));
    modal.hide();
    console.log(`✅ Confirmadas ${etapasSeleccionadasArray.length} etapas`);
}

function actualizarVistaEtapas(renderBadges = true) {
    const listaEtapas = document.getElementById('listaEtapas');

    if (etapasSeleccionadasArray.length === 0) {
        listaEtapas.innerHTML = '<i class="fas fa-info-circle"></i> No se han seleccionado etapas aún. Haz clic en "Nueva Etapa" para agregar.';
        listaEtapas.className = 'text-muted small';
        return;
    }

    if (etapasSeleccionadasIA.size === 0) {
        etapasSeleccionadasArray.forEach(etapa => etapasSeleccionadasIA.add(etapa.slug || slugifyEtapa(etapa.nombre)));
    }

    const etapasOrdenadas = [...etapasSeleccionadasArray].sort((a, b) => a.orden - b.orden);
    let html = '<div class="row">';

    etapasOrdenadas.forEach((etapa) => {
        const slug = etapa.slug || slugifyEtapa(etapa.nombre);
        const checked = etapasSeleccionadasIA.has(slug);
        const esPersonalizada = etapa.personalizada;
        const iaBadge = etapa.ia_aplicada && renderBadges ? '<span class="badge bg-success-subtle text-success ms-2">IA aplicada</span>' : '';
        const descripcion = etapa.descripcion || 'Sin descripción definida';
        const inputId = `etapaCheck_${slug}`;
        html += `
            <div class="col-md-6 col-xl-4 mb-3">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start gap-2">
                            <div class="flex-grow-1">
                                <div class="form-check">
                                    <input class="form-check-input etapa-ia-checkbox" type="checkbox" id="${inputId}"
                                           data-stage-slug="${slug}" data-stage-nombre="${etapa.nombre.replace(/"/g, '&quot;')}" data-etapa-id="${etapa.id || ''}"
                                           ${checked ? 'checked' : ''} onchange="toggleEtapaIA(this)">
                                    <label class="form-check-label fw-bold text-primary" for="${inputId}">
                                        ${etapa.nombre}
                                        ${esPersonalizada ? '<span class="badge bg-success ms-1">Personalizada</span>' : ''}
                                        ${iaBadge}
                                    </label>
                                </div>
                                <small class="text-muted d-block">${descripcion}</small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerEtapa('${slug}')" title="Remover etapa">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent border-0 pt-0 d-flex justify-content-between align-items-center">
                        <span class="badge bg-light text-muted">Orden ${etapa.orden}</span>
                        <button type="button" class="btn btn-link btn-sm text-decoration-none" onclick="calcularEtapaIndividualIA('${slug}')">
                            <i class="fas fa-bolt me-1"></i>Calcular esta etapa
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    listaEtapas.innerHTML = html;
    listaEtapas.className = '';
}

function removerEtapa(slug) {
    etapasSeleccionadasArray = etapasSeleccionadasArray.filter(e => (e.slug || slugifyEtapa(e.nombre)) !== slug);
    etapasSeleccionadasIA.delete(slug);
    limpiarResultadosEtapasIA();
    actualizarVistaEtapas();
    console.log(`🗑️ Etapa removida: ${slug}`);
}

function toggleEtapaIA(input) {
    const slug = input.dataset.stageSlug;
    if (!slug) return;
    if (input.checked) {
        etapasSeleccionadasIA.add(slug);
    } else {
        etapasSeleccionadasIA.delete(slug);
    }
    limpiarResultadosEtapasIA(false);
}

function calcularEtapasSeleccionadasIA() {
    const seleccionadas = Array.from(document.querySelectorAll('.etapa-ia-checkbox:checked')).map(cb => cb.dataset.stageSlug).filter(Boolean);
    if (seleccionadas.length === 0) {
        alert('Selecciona al menos una etapa para calcular con IA.');
        return;
    }
    const etapas = seleccionadas.map(slug => obtenerEtapaPorSlug(slug)).filter(Boolean);
    solicitarCalculoEtapas(etapas);
}

function calcularEtapaIndividualIA(slug) {
    const etapa = obtenerEtapaPorSlug(slug);
    if (!etapa) {
        alert('No encontramos la etapa solicitada.');
        return;
    }
    solicitarCalculoEtapas([etapa]);
}

function solicitarCalculoEtapas(etapas) {
    if (!etapas || etapas.length === 0) {
        alert('No hay etapas para calcular.');
        return;
    }

    const superficie = parseFloat(document.getElementById('superficie_m2').value || '0');
    if (!superficie || superficie <= 0) {
        alert('Ingresa la superficie en m² antes de calcular con IA por etapas.');
        return;
    }

    const tipoCalculo = document.getElementById('tipo_construccion').value || 'Estándar';
    const contexto = {
        ubicacion: document.getElementById('ubicacion').value || null,
        tipo_obra: document.getElementById('tipo_obra').value || null
    };

    const monedaSelectEl = document.getElementById('moneda');
    const currency = monedaSelectEl ? monedaSelectEl.value : 'ARS';
    updateCurrencyFormatter(currency);

    // Manejar tanto checkbox (para admin) como hidden input (para otros usuarios)
    const desperdicioEl = document.getElementById('aplicar_desperdicio');
    const aplicarDesperdicio = desperdicioEl ?
        (desperdicioEl.type === 'checkbox' ? desperdicioEl.checked : desperdicioEl.value === 'true') : true;

    const payload = {
        etapa_ids: etapas.map(etapa => ({
            slug: etapa.slug || slugifyEtapa(etapa.nombre),
            nombre: etapa.nombre,
            id: etapa.id || null
        })),
        superficie_m2: superficie,
        tipo_calculo: tipoCalculo,
        parametros_contexto: contexto,
        presupuesto_id: presupuestoId,
        currency: currency,
        moneda: currency,
        aplicar_desperdicio: aplicarDesperdicio
    };

    // Incluir niveles del edificio si están configurados
    const nivelesData = window.nivelesConfig || [];
    const nivelesConArea = nivelesData.filter(n => parseFloat(n.area_m2) > 0);
    if (nivelesConArea.length > 0) {
        payload.niveles = nivelesConArea;
    }

    const modalEl = document.getElementById('modalResultadoEtapasIA');
    const modal = new bootstrap.Modal(modalEl);
    document.getElementById('resultadoEtapasIAContenido').innerHTML = `
        <div class="text-center text-muted py-4">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-2 mb-0">Calculando con IA…</p>
        </div>
    `;
    document.getElementById('resumenEtapasIAMetadatos').style.display = 'none';
    modal.show();

    // Get CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    const headers = { 'Content-Type': 'application/json' };
    if (csrfToken) {
        headers['X-CSRFToken'] = csrfToken;
    }

    fetch('/presupuestos/ia/calcular/etapas', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(payload)
    })
        .then(resp => {
            if (!resp.ok) {
                return resp.text().then(text => {
                    throw new Error(`Error del servidor (${resp.status}): ${text.substring(0, 200)}`);
                });
            }
            return resp.json();
        })
        .then(data => {
            if (!data || data.ok === false) {
                const mensaje = data && data.error ? data.error : 'No se pudo calcular las etapas seleccionadas.';
                document.getElementById('resultadoEtapasIAContenido').innerHTML = `<div class="alert alert-danger mb-0">${mensaje}</div>`;
                return;
            }
            data.parametros_contexto = payload.parametros_contexto;
            resultadoEtapasIA = data;

            // AUTOMÁTICAMENTE guardar el payload en el campo hidden
            const hidden = document.getElementById('iaEtapasPayload');
            if (hidden) {
                hidden.value = JSON.stringify(data);
                console.log('Payload IA guardado automaticamente:', data);
            }

            renderResultadoEtapasIA(data);
        })
        .catch(error => {
            console.error('Error IA etapas:', error);
            document.getElementById('resultadoEtapasIAContenido').innerHTML = `<div class="alert alert-danger mb-0">Error al calcular: ${error.message}</div>`;
        });
}

function renderResultadoEtapasIA(data) {
    if (data.moneda) {
        updateCurrencyFormatter(data.moneda);
    }
    const contenedor = document.getElementById('resultadoEtapasIAContenido');
    const resumen = document.getElementById('resumenEtapasIAMetadatos');
    const etapas = data.etapas || [];

    if (etapas.length === 0) {
        contenedor.innerHTML = '<div class="alert alert-warning mb-0">La IA no generó items para las etapas seleccionadas.</div>';
        resumen.style.display = 'none';
        return;
    }

    const htmlEtapas = etapas.map(etapa => {
        const items = etapa.items || [];
        const filas = items.map(item => {
            const subtotal = (item.cantidad || 0) * (item.precio_unit || 0);
            const precioUnit = item.precio_unit ? currencyFormatter.format(item.precio_unit) : '<span class="badge bg-warning text-dark">Sin precio</span>';
            const subtotalFmt = item.precio_unit ? currencyFormatter.format(subtotal) : '<span class="text-muted">--</span>';
            return `
                <tr style="font-size: 0.8rem;">
                    <td class="text-capitalize" style="padding: 0.4rem;">${item.tipo || '-'}</td>
                    <td style="padding: 0.4rem;">${item.codigo || '-'}</td>
                    <td style="padding: 0.4rem; max-width: 200px; white-space: normal;">${item.descripcion || '-'}</td>
                    <td class="text-end" style="padding: 0.4rem;">${Number(item.cantidad || 0).toFixed(2)}</td>
                    <td style="padding: 0.4rem;">${item.unidad || ''}</td>
                    <td class="text-end" style="padding: 0.4rem;">${precioUnit}</td>
                    <td class="text-end" style="padding: 0.4rem; font-weight: 600;">${subtotalFmt}</td>
                    <td style="padding: 0.4rem; font-size: 0.7rem; max-width: 150px; white-space: normal;">${item.just || 'Regla determinística'}</td>
                </tr>
            `;
        }).join('');

        const subtotalTotal = etapa.subtotal_total ? currencyFormatter.format(etapa.subtotal_total) : currencyFormatter.format(0);
        const confianza = etapa.confianza ? Math.round(etapa.confianza * 100) : null;

        return `
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 text-primary">${etapa.nombre}</h6>
                    <div class="d-flex align-items-center gap-2">
                        ${confianza ? `<span class="badge bg-info-subtle text-info">Confianza ${confianza}%</span>` : ''}
                        <span class="badge bg-secondary-subtle text-secondary">${subtotalTotal}</span>
                    </div>
                </div>
                ${items.length ? `
                    <div class="table-responsive" style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                        <table class="table table-sm table-hover align-middle" style="font-size: 0.8rem; white-space: nowrap; min-width: 100%;">
                            <thead class="table-light" style="position: sticky; top: 0; z-index: 10; background: #f8f9fa;">
                                <tr>
                                    <th style="font-size: 0.7rem; padding: 0.4rem;">Tipo</th>
                                    <th style="font-size: 0.7rem; padding: 0.4rem;">Código</th>
                                    <th style="font-size: 0.7rem; padding: 0.4rem; min-width: 150px;">Descripción</th>
                                    <th class="text-end" style="font-size: 0.7rem; padding: 0.4rem;">Cant.</th>
                                    <th style="font-size: 0.7rem; padding: 0.4rem;">Unidad</th>
                                    <th class="text-end" style="font-size: 0.7rem; padding: 0.4rem;">P. Unit.</th>
                                    <th class="text-end" style="font-size: 0.7rem; padding: 0.4rem;">Subtotal</th>
                                    <th style="font-size: 0.65rem; padding: 0.4rem; min-width: 100px;">Justificación</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filas}
                            </tbody>
                        </table>
                    </div>
                    <div class="small text-muted mt-1" style="font-size: 0.7rem;">
                        <i class="fas fa-hand-point-right"></i> Desliza horizontalmente para ver más columnas
                    </div>
                ` : '<div class="alert alert-warning mb-0">Sin items sugeridos para esta etapa.</div>'}
                ${etapa.desglose_niveles && etapa.desglose_niveles.length ? `
                    <details class="mt-3">
                        <summary class="fw-bold text-primary" style="cursor:pointer; font-size: 0.85rem;">
                            <i class="fas fa-layer-group me-1"></i>Desglose por Nivel (${etapa.desglose_niveles.length} niveles)
                        </summary>
                        <div class="mt-2">
                            ${etapa.desglose_niveles.map(dn => {
                                const hm3 = dn.hormigon_m3 || 0;
                                const am2 = dn.albanileria_m2 || 0;
                                let matInfo = '';
                                if (hm3 > 0) matInfo += 'H° ' + hm3 + ' m³ ';
                                if (am2 > 0) matInfo += 'Alb. ' + am2 + ' m² ';
                                return '<div class="mb-2 ms-2 border-start border-3 border-primary ps-2">' +
                                    '<div class="d-flex justify-content-between align-items-center">' +
                                        '<span class="fw-bold small">' + (dn.nivel_nombre || 'Nivel') + '</span>' +
                                        '<span class="badge bg-primary-subtle text-primary small">' + (dn.subtotal ? currencyFormatter.format(dn.subtotal) : '-') + ' · ' + (dn.m2_efectivo ? dn.m2_efectivo.toFixed(0) + ' m² ef.' : '') + '</span>' +
                                    '</div>' +
                                    '<div class="small text-muted">' + (typeof dn.items === 'number' ? dn.items : 0) + ' items' + (matInfo ? ' · ' + matInfo : '') + '</div>' +
                                '</div>';
                            }).join('')}
                        </div>
                    </details>
                ` : ''}
                ${etapa.notas ? `<p class="small text-muted mt-2 mb-0">${etapa.notas}</p>` : ''}
                ${(etapa.items_constructora && etapa.items_constructora.length) ? `
                    <details class="mt-3">
                        <summary class="fw-bold text-success" style="cursor:pointer; font-size: 0.85rem;">
                            <i class="fas fa-hard-hat me-1"></i>Referencia Constructoras (${etapa.items_constructora.length} items)
                        </summary>
                        <div class="table-responsive mt-2" style="overflow-x: auto;">
                            <table class="table table-sm table-bordered align-middle" style="font-size: 0.75rem; white-space: nowrap;">
                                <thead class="table-success">
                                    <tr>
                                        <th style="padding: 0.3rem;">Constructora</th>
                                        <th style="padding: 0.3rem;">Código</th>
                                        <th style="padding: 0.3rem; min-width: 200px;">Descripción</th>
                                        <th style="padding: 0.3rem;">Unidad</th>
                                        <th class="text-end" style="padding: 0.3rem;">P. Unit.</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${etapa.items_constructora.map(ic => `
                                        <tr>
                                            <td style="padding: 0.3rem;"><span class="badge bg-success-subtle text-success">${ic.constructora}</span></td>
                                            <td style="padding: 0.3rem;">${ic.codigo || '-'}</td>
                                            <td style="padding: 0.3rem; white-space: normal; max-width: 300px;">${ic.descripcion}</td>
                                            <td style="padding: 0.3rem;">${ic.unidad || '-'}</td>
                                            <td class="text-end" style="padding: 0.3rem;">${ic.precio_unitario ? currencyFormatter.format(ic.precio_unitario) : '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </details>
                ` : ''}
            </div>
        `;
    }).join('');

    contenedor.innerHTML = htmlEtapas;
    const totalParcial = data.total_parcial ? currencyFormatter.format(data.total_parcial) : currencyFormatter.format(0);
    resumen.style.display = 'block';
    let tipoCambioTexto = '';
    if (data.tipo_cambio && data.tipo_cambio.valor) {
        const fxFormatter = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' });
        const proveedor = (data.tipo_cambio.proveedor || '').toUpperCase();
        const fechaFx = data.tipo_cambio.as_of ? new Date(data.tipo_cambio.as_of) : (data.tipo_cambio.fetched_at ? new Date(data.tipo_cambio.fetched_at) : null);
        const fechaTexto = fechaFx ? fechaFx.toLocaleDateString('es-AR') : '';
        tipoCambioTexto = ` · TC ${proveedor} ${fxFormatter.format(data.tipo_cambio.valor)}${fechaTexto ? ' (' + fechaTexto + ')' : ''}`;
    }
    let cacTexto = '';
    if (data.cac && data.cac.valor) {
        const periodo = data.cac.periodo ? new Date(data.cac.periodo).toLocaleDateString('es-AR', { month: 'long', year: 'numeric' }) : '';
        cacTexto = ` · CAC ${Number(data.cac.valor).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}${periodo ? ' (' + periodo + ')' : ''}`;
    }
    resumen.innerHTML = `<strong>Total parcial IA:</strong> ${totalParcial} · ${etapas.length} etapa(s) analizadas${tipoCambioTexto}${cacTexto}.`;
}

function aplicarResultadosEtapasIA() {
    if (!resultadoEtapasIA || resultadoEtapasIA.ok === false) {
        alert('Calcula las etapas con IA antes de aplicar los resultados.');
        return;
    }

    const hidden = document.getElementById('iaEtapasPayload');
    hidden.value = JSON.stringify(resultadoEtapasIA);

    (resultadoEtapasIA.etapas || []).forEach(etapa => {
        const registro = obtenerEtapaPorSlug(etapa.slug);
        if (registro) {
            registro.ia_aplicada = true;
        }
    });

    if (presupuestoId) {
        const persistCurrency = (resultadoEtapasIA.moneda || (monedaSelect ? monedaSelect.value : 'ARS'));
        const persistPayload = {
            etapa_ids: (resultadoEtapasIA.etapas || []).map(etapa => ({
                slug: etapa.slug || slugifyEtapa(etapa.nombre),
                nombre: etapa.nombre,
                id: etapa.etapa_id || etapa.id || null
            })),
            superficie_m2: resultadoEtapasIA.superficie_usada || parseFloat(document.getElementById('superficie_m2').value || '0'),
            tipo_calculo: resultadoEtapasIA.tipo_calculo || document.getElementById('tipo_construccion').value || 'Estándar',
            parametros_contexto: resultadoEtapasIA.parametros_contexto || {},
            presupuesto_id: presupuestoId,
            persistir: true,
            currency: persistCurrency,
            moneda: persistCurrency
        };

        const persistHeaders = { 'Content-Type': 'application/json' };
        if (csrfToken) {
            persistHeaders['X-CSRFToken'] = csrfToken;
        }

        fetch('/presupuestos/ia/calcular/etapas', {
            method: 'POST',
            headers: persistHeaders,
            body: JSON.stringify(persistPayload)
        })
            .then(resp => {
                if (!resp.ok) {
                    return resp.text().then(text => {
                        throw new Error(`Error del servidor (${resp.status})`);
                    });
                }
                return resp.json();
            })
            .then(respuesta => {
                if (!respuesta || respuesta.ok === false) {
                    console.error('No se pudo guardar el calculo IA en el presupuesto existente:', respuesta);
                    alert(respuesta && respuesta.error ? respuesta.error : 'No pudimos guardar los items calculados. Intentalo nuevamente.');
                } else {
                    console.log('Resultados IA guardados en presupuesto', respuesta);
                }
            })
            .catch(error => {
                console.error('Error persistiendo resultados IA:', error);
            });
    }

    actualizarVistaEtapas();
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalResultadoEtapasIA'));
    if (modal) modal.hide();
    if (presupuestoId) {
        alert('Se aplicaron los resultados de IA y se guardaron en el presupuesto.');
    } else {
        alert('Se aplicaron los resultados de IA. Se guardarán al crear el presupuesto.');
    }
}

function mostrarArchivoPlano() {
    const input = document.getElementById('plano_pdf');
    const info = document.getElementById('archivoPlanoInfo');
    const nombre = document.getElementById('nombreArchivoPlano');

    if (input.files.length > 0) {
        nombre.textContent = input.files[0].name;
        info.style.display = 'block';
    } else {
        info.style.display = 'none';
    }
}

function removerArchivo() {
    document.getElementById('plano_pdf').value = '';
    document.getElementById('archivoPlanoInfo').style.display = 'none';
}

const dropZone = document.getElementById('dropZone');

dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = '#007bff';
    dropZone.style.backgroundColor = '#f8f9fa';
});

dropZone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = '#dee2e6';
    dropZone.style.backgroundColor = 'transparent';
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = '#dee2e6';
    dropZone.style.backgroundColor = 'transparent';

    const files = e.dataTransfer.files;
    if (files.length > 0 && files[0].type === 'application/pdf') {
        document.getElementById('plano_pdf').files = files;
        mostrarArchivoPlano();
    } else {
        alert('Por favor, sube solo archivos PDF');
    }
});

function calcularConIA() {
    const superficie = document.getElementById('superficie_m2').value;
    const tipo = document.getElementById('tipo_construccion').value;
    const archivo = document.getElementById('plano_pdf').files[0];

    if (!superficie && !archivo) {
        alert('Debes especificar la superficie o subir un plano PDF para usar la IA');
        return;
    }

    if (!tipo) {
        alert('Selecciona el tipo de construcción');
        return;
    }

    const formData = new FormData();
    if (superficie) formData.append('metros_cuadrados', superficie);
    if (tipo) formData.append('tipo_construccion', tipo);
    if (archivo) formData.append('archivo_pdf', archivo);

    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculando...';
    btn.disabled = true;

    fetch('/presupuestos/procesar-calculadora-ia', {
        method: 'POST',
        body: formData
    })
        .then(response => response.json())
        .then(data => {
            btn.innerHTML = originalText;
            btn.disabled = false;

            if (data.exito) {
                datosCalculoIA = data;
                mostrarResultadoIA(data);
            } else {
                alert('Error en el cálculo IA: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            alert('Error de conexión: ' + error.message);
        });
}

function mostrarResultadoIA(data) {
    const panel = document.getElementById('calculoIAPanel');
    const resumen = document.getElementById('resultadoIAResumen');

    const materiales = Object.keys(data.presupuesto.materiales).length;
    const equipos = Object.keys(data.presupuesto.equipos).length;

    resumen.innerHTML = `
        <div class="row text-center">
            <div class="col-6">
                <h4 class="text-success">${data.superficie_calculada.toFixed(0)}</h4>
                <small>m² calculados</small>
            </div>
            <div class="col-6">
                <h4 class="text-primary">${materiales + equipos}</h4>
                <small>items calculados</small>
            </div>
        </div>
        <hr>
        <p class="small mb-0">
            <i class="fas fa-check-circle text-success"></i>
            Tipo: ${data.tipo_usado}
        </p>
    `;

    panel.style.display = 'block';
}

function verCalculoCompleto() {
    if (datosCalculoIA) {
        window.open('/presupuestos/calculadora-ia', '_blank');
    }
}

function limpiarFormulario() {
    if (confirm('¿Estás seguro de que quieres limpiar todos los campos?')) {
        document.getElementById('nuevoPresupuestoForm').reset();
        document.getElementById('archivoPlanoInfo').style.display = 'none';
        document.getElementById('calculoIAPanel').style.display = 'none';
        datosCalculoIA = null;
        etapasSeleccionadasArray = [];
        etapasSeleccionadasIA.clear();
        limpiarResultadosEtapasIA();
        actualizarVistaEtapas();
        // Limpiar niveles del edificio
        window.nivelesConfig = [];
        actualizarChipsNiveles();
        const secEdif = document.getElementById('seccion_edificio_niveles');
        if (secEdif) secEdif.style.display = 'none';
    }
}

document.getElementById('nuevoPresupuestoForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const nombre = document.getElementById('nombre_obra').value.trim();
    const tipo = document.getElementById('tipo_obra').value;
    const ubicacion = document.getElementById('ubicacion').value.trim();
    const tipoConst = document.getElementById('tipo_construccion').value;
    const superficie = document.getElementById('superficie_m2').value;

    if (!nombre || !tipo || !ubicacion || !tipoConst || !superficie) {
        alert('Por favor, completa todos los campos obligatorios marcados con *');
        return;
    }

    this.querySelectorAll('.etapa-hidden-field').forEach(el => el.remove());

    if (etapasSeleccionadasArray.length > 0) {
        etapasSeleccionadasArray.forEach((etapa, index) => {
            const slug = etapa.slug || slugifyEtapa(etapa.nombre);

            const inputNombre = document.createElement('input');
            inputNombre.type = 'hidden';
            inputNombre.name = `etapas[${index}][nombre]`;
            inputNombre.value = etapa.nombre;
            inputNombre.classList.add('etapa-hidden-field');
            this.appendChild(inputNombre);

            const inputDescripcion = document.createElement('input');
            inputDescripcion.type = 'hidden';
            inputDescripcion.name = `etapas[${index}][descripcion]`;
            inputDescripcion.value = etapa.descripcion || '';
            inputDescripcion.classList.add('etapa-hidden-field');
            this.appendChild(inputDescripcion);

            const inputOrden = document.createElement('input');
            inputOrden.type = 'hidden';
            inputOrden.name = `etapas[${index}][orden]`;
            inputOrden.value = etapa.orden;
            inputOrden.classList.add('etapa-hidden-field');
            this.appendChild(inputOrden);

            const inputSlug = document.createElement('input');
            inputSlug.type = 'hidden';
            inputSlug.name = `etapas[${index}][slug]`;
            inputSlug.value = slug;
            inputSlug.classList.add('etapa-hidden-field');
            this.appendChild(inputSlug);
        });
    }

    this.submit();
});

// Función global para actualizar selector cuando se crea un cliente desde ventana popup
// ══════════════════════════════════════════════════════
// EDIFICIO POR NIVELES — Funciones de gestión
// ══════════════════════════════════════════════════════

window.nivelesConfig = [];

function actualizarPisosTipo() {
    const cantPisos = parseInt(document.getElementById('cantidad_pisos').value || '0');
    const tienePB = parseInt(document.getElementById('tiene_pb').value || '1');
    const tieneTerraza = parseInt(document.getElementById('tiene_terraza').value || '1');
    const cantSubsuelos = parseInt(document.getElementById('cant_subsuelos').value || '0');
    const pisosTipo = Math.max(0, cantPisos - (tienePB ? 1 : 0) - (tieneTerraza ? 1 : 0));
    document.getElementById('cant_pisos_tipo').value = pisosTipo;
    return pisosTipo;
}

function generarNivelesDefault() {
    const cantSubsuelos = parseInt(document.getElementById('cant_subsuelos').value || '0');
    const tienePB = parseInt(document.getElementById('tiene_pb').value || '1');
    const tieneTerraza = parseInt(document.getElementById('tiene_terraza').value || '1');
    const pisosTipo = actualizarPisosTipo();

    const niveles = [];
    let orden = 0;

    // Subsuelos
    for (let i = cantSubsuelos; i >= 1; i--) {
        niveles.push({
            tipo_nivel: 'subsuelo',
            nombre: `S-${i}`,
            orden: orden++,
            repeticiones: 1,
            area_m2: 0,
            hormigon_m3: 0,
            albanileria_m2: 0,
            atributos: {}
        });
    }

    // Planta Baja
    if (tienePB) {
        niveles.push({
            tipo_nivel: 'pb',
            nombre: 'PB',
            orden: orden++,
            repeticiones: 1,
            area_m2: 0,
            hormigon_m3: 0,
            albanileria_m2: 0,
            atributos: {}
        });
    }

    // Pisos Tipo (agrupados como una sola fila con repeticiones)
    if (pisosTipo > 0) {
        niveles.push({
            tipo_nivel: 'piso_tipo',
            nombre: 'Pisos Tipo',
            orden: orden++,
            repeticiones: pisosTipo,
            area_m2: 0,
            hormigon_m3: 0,
            albanileria_m2: 0,
            atributos: {}
        });
    }

    // Terraza
    if (tieneTerraza) {
        niveles.push({
            tipo_nivel: 'terraza',
            nombre: 'Terraza',
            orden: orden++,
            repeticiones: 1,
            area_m2: 0,
            hormigon_m3: 0,
            albanileria_m2: 0,
            atributos: {}
        });
    }

    window.nivelesConfig = niveles;
    actualizarChipsNiveles();
}

function actualizarChipsNiveles() {
    const container = document.getElementById('niveles_chips_container');
    if (!container) return;

    const niveles = window.nivelesConfig || [];
    if (niveles.length === 0) {
        container.innerHTML = '<span class="text-muted small">Configura los niveles para ver el resumen...</span>';
        document.getElementById('niveles_json').value = '';
        return;
    }

    const tipoColor = { subsuelo: 'secondary', pb: 'primary', piso_tipo: 'info', piso_especial: 'warning', terraza: 'success' };

    let totalM2 = 0;
    const chips = niveles.map(n => {
        const supTotal = (parseFloat(n.area_m2) || 0) * (n.repeticiones || 1);
        totalM2 += supTotal;
        const color = tipoColor[n.tipo_nivel] || 'dark';
        const rep = n.repeticiones > 1 ? ` ×${n.repeticiones}` : '';
        const areaText = n.area_m2 > 0 ? ` ${n.area_m2} m²${rep}` : '';
        const hm3 = parseFloat(n.hormigon_m3) || 0;
        const am2 = parseFloat(n.albanileria_m2) || 0;
        let matText = '';
        if (hm3 > 0) matText += ` H°${hm3}m³`;
        if (am2 > 0) matText += ` Alb.${am2}m²`;
        return `<span class="badge bg-${color}">${n.nombre}${areaText}${matText}</span>`;
    });

    if (totalM2 > 0) {
        chips.push(`<span class="badge bg-dark"><i class="fas fa-sigma"></i> ${totalM2.toFixed(0)} m² total</span>`);
    }
    container.innerHTML = chips.join(' ');

    // Actualizar campo hidden y superficie total
    document.getElementById('niveles_json').value = JSON.stringify(niveles);
    if (totalM2 > 0) {
        const supInput = document.getElementById('superficie_m2');
        if (supInput) supInput.value = totalM2.toFixed(2);
    }
}

function renderTablaModalNiveles() {
    const container = document.getElementById('nivelesModalContainer');
    if (!container) return;

    const niveles = window.nivelesConfig || [];
    if (niveles.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-3">No hay niveles configurados. Ajusta los controles de la sección edificio.</div>';
        actualizarTotalModalNiveles();
        return;
    }

    const tipoColor = { subsuelo: 'secondary', pb: 'primary', piso_tipo: 'info', piso_especial: 'warning', terraza: 'success' };

    container.innerHTML = niveles.map((n, i) => {
        const supTotal = (parseFloat(n.area_m2) || 0) * (n.repeticiones || 1);
        const color = tipoColor[n.tipo_nivel] || 'dark';
        const attrs = n.atributos || {};

        return `
        <div class="card mb-2 border-${color}" data-nivel-index="${i}">
            <div class="card-header bg-${color} bg-opacity-10 py-2 d-flex justify-content-between align-items-center">
                <div>
                    <input type="text" class="form-control form-control-sm d-inline-block fw-bold" value="${n.nombre}"
                           onchange="window.nivelesConfig[${i}].nombre = this.value" style="width: 80px;">
                    <span class="badge bg-${color} ms-1">${n.tipo_nivel}</span>
                </div>
                <span class="fw-bold" id="supTotalNivel_${i}">${supTotal.toFixed(2)} m²</span>
            </div>
            <div class="card-body py-2">
                <div class="row g-2 mb-2">
                    <div class="col-6 col-md-3">
                        <label class="form-label small mb-0 fw-bold">Repeticiones</label>
                        <input type="number" class="form-control form-control-sm" value="${n.repeticiones}"
                               min="1" max="50"
                               onchange="window.nivelesConfig[${i}].repeticiones = parseInt(this.value) || 1; actualizarFilaSupNivel(${i});">
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="form-label small mb-0 fw-bold">Area m²</label>
                        <input type="number" class="form-control form-control-sm" value="${n.area_m2}"
                               min="0" step="0.01" placeholder="Superficie"
                               onchange="window.nivelesConfig[${i}].area_m2 = parseFloat(this.value) || 0; actualizarFilaSupNivel(${i});">
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="form-label small mb-0 fw-bold text-primary">Hormigon m³</label>
                        <input type="number" class="form-control form-control-sm border-primary" value="${n.hormigon_m3 || ''}"
                               min="0" step="0.01" placeholder="Vol. hormigon"
                               onchange="window.nivelesConfig[${i}].hormigon_m3 = parseFloat(this.value) || 0;">
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="form-label small mb-0 fw-bold text-success">Albanileria m²</label>
                        <input type="number" class="form-control form-control-sm border-success" value="${n.albanileria_m2 || ''}"
                               min="0" step="0.01" placeholder="Sup. albanileria"
                               onchange="window.nivelesConfig[${i}].albanileria_m2 = parseFloat(this.value) || 0;">
                    </div>
                </div>
                <details class="mt-1">
                    <summary class="small text-muted" style="cursor:pointer;">Opciones avanzadas</summary>
                    <div class="row g-2 mt-1">
                        <div class="col-4 col-md-2">
                            <label class="form-label small mb-0">Napa</label>
                            <select class="form-select form-select-sm"
                                    onchange="setAtributoNivel(${i}, 'napa', this.value === '1')">
                                <option value="0" ${!attrs.napa ? 'selected' : ''}>No</option>
                                <option value="1" ${attrs.napa ? 'selected' : ''}>Si</option>
                            </select>
                        </div>
                        <div class="col-4 col-md-2">
                            <label class="form-label small mb-0">Cocheras</label>
                            <select class="form-select form-select-sm"
                                    onchange="setAtributoNivel(${i}, 'cocheras', this.value === '1')">
                                <option value="0" ${!attrs.cocheras ? 'selected' : ''}>No</option>
                                <option value="1" ${attrs.cocheras ? 'selected' : ''}>Si</option>
                            </select>
                        </div>
                        <div class="col-4 col-md-2">
                            <label class="form-label small mb-0">Altura (m)</label>
                            <input type="number" class="form-control form-control-sm"
                                   step="0.1" min="2" max="6" value="${attrs.altura_libre || ''}"
                                   onchange="setAtributoNivel(${i}, 'altura_libre', parseFloat(this.value) || null)">
                        </div>
                        <div class="col-4 col-md-2">
                            <label class="form-label small mb-0">Losa (cm)</label>
                            <input type="number" class="form-control form-control-sm"
                                   step="1" min="10" max="40" value="${attrs.espesor_losa || ''}"
                                   onchange="setAtributoNivel(${i}, 'espesor_losa', parseInt(this.value) || null)">
                        </div>
                        <div class="col-4 col-md-2">
                            <label class="form-label small mb-0">Complejidad</label>
                            <select class="form-select form-select-sm"
                                    onchange="setAtributoNivel(${i}, 'complejidad', this.value)">
                                <option value="baja" ${attrs.complejidad === 'baja' ? 'selected' : ''}>Baja</option>
                                <option value="media" ${!attrs.complejidad || attrs.complejidad === 'media' ? 'selected' : ''}>Media</option>
                                <option value="alta" ${attrs.complejidad === 'alta' ? 'selected' : ''}>Alta</option>
                            </select>
                        </div>
                    </div>
                </details>
            </div>
        </div>
        `;
    }).join('');

    actualizarTotalModalNiveles();
}

function actualizarFilaSupNivel(index) {
    const n = window.nivelesConfig[index];
    if (!n) return;
    const supTotal = (parseFloat(n.area_m2) || 0) * (n.repeticiones || 1);
    const el = document.getElementById(`supTotalNivel_${index}`);
    if (el) el.textContent = supTotal.toFixed(2) + ' m²';
    actualizarTotalModalNiveles();
}

function actualizarTotalModalNiveles() {
    const el = document.getElementById('totalSuperficieNiveles');
    if (!el) return;
    const total = (window.nivelesConfig || []).reduce((sum, n) => {
        return sum + (parseFloat(n.area_m2) || 0) * (n.repeticiones || 1);
    }, 0);
    el.textContent = total.toFixed(2) + ' m²';
}

function setAtributoNivel(index, key, value) {
    const n = window.nivelesConfig[index];
    if (!n) return;
    if (!n.atributos) n.atributos = {};
    n.atributos[key] = value;
}

function aplicarConfigNiveles() {
    // Validar que todos los niveles tengan area > 0
    const sinArea = (window.nivelesConfig || []).filter(n => !n.area_m2 || parseFloat(n.area_m2) <= 0);
    if (sinArea.length > 0) {
        if (!confirm(`Hay ${sinArea.length} nivel(es) sin área configurada (${sinArea.map(n => n.nombre).join(', ')}). ¿Aplicar igual?`)) {
            return;
        }
    }

    actualizarChipsNiveles();

    // Cerrar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfigurarNiveles'));
    if (modal) modal.hide();
}

// Función global para actualizar selector cuando se crea un cliente desde ventana popup
window.actualizarSelectorCliente = function(clienteData) {
    const selector = document.getElementById('cliente_id');
    if (selector && clienteData && clienteData.id) {
        // Crear nueva opción con los datos del cliente
        const option = document.createElement('option');
        option.value = clienteData.id;
        option.textContent = clienteData.nombre_completo + ' - ' + clienteData.email;
        option.selected = true;

        // Agregar al selector
        selector.appendChild(option);

        // Mostrar mensaje de éxito
        const mensaje = document.createElement('div');
        mensaje.className = 'alert alert-success alert-dismissible fade show mt-2';
        mensaje.innerHTML = `
            <strong>¡Éxito!</strong> Cliente "${clienteData.nombre_completo}" agregado y seleccionado.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        selector.parentElement.parentElement.appendChild(mensaje);

        // Remover mensaje después de 5 segundos
        setTimeout(function() {
            mensaje.remove();
        }, 5000);
    }
};
</script>

<!-- Modal Configurar Niveles del Edificio -->
<div class="modal fade" id="modalConfigurarNiveles" tabindex="-1" aria-labelledby="modalConfigurarNivelesLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white py-2">
                <h5 class="modal-title" id="modalConfigurarNivelesLabel">
                    <i class="fas fa-layer-group me-2"></i>Configurar Niveles del Edificio
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info py-2 small mb-3">
                    <i class="fas fa-info-circle me-1"></i>
                    Configura el <strong>área m²</strong>, <strong>hormigón (m³)</strong> y <strong>albañilería (m²)</strong> de cada nivel.
                    Puedes completar ambos para el mismo nivel. El botón <i class="fas fa-cog"></i> expande opciones avanzadas.
                </div>
                <div id="nivelesModalContainer">
                </div>
                <div class="bg-dark text-white rounded p-2 mt-2 d-flex justify-content-between">
                    <span class="fw-bold">TOTAL SUPERFICIE</span>
                    <span class="fw-bold" id="totalSuperficieNiveles">0.00 m²</span>
                </div>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary btn-sm" onclick="aplicarConfigNiveles()">
                    <i class="fas fa-check"></i> Aplicar Configuración
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Render tabla al abrir el modal -->
<script>
document.getElementById('modalConfigurarNiveles').addEventListener('show.bs.modal', function() {
    renderTablaModalNiveles();
});
</script>

<!-- Modal para Crear Cliente -->
<div class="modal fade" id="modalCrearCliente" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-user-plus"></i> Crear Nuevo Cliente</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formCrearClienteModal">
                    <h6 class="mb-3">Información de la Empresa</h6>

                    <div class="mb-3">
                        <label class="form-label">Razón Social / Nombre de la Empresa <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="modal_empresa" name="empresa" required>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Tipo de Documento <span class="text-danger">*</span></label>
                            <select class="form-select" id="modal_tipo_documento" name="tipo_documento" required>
                                <option value="CUIT" selected>CUIT</option>
                                <option value="DNI">DNI</option>
                                <option value="CUIL">CUIL</option>
                                <option value="Pasaporte">Pasaporte</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">Número de Documento <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="modal_numero_documento" name="numero_documento" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="modal_email" name="email">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Teléfono</label>
                            <input type="text" class="form-control" id="modal_telefono" name="telefono">
                        </div>
                    </div>

                    <h6 class="mb-3 mt-4">Contacto Principal (opcional)</h6>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="modal_contacto_nombre" name="contacto_nombre">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Apellido</label>
                            <input type="text" class="form-control" id="modal_contacto_apellido" name="contacto_apellido">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Email del Contacto</label>
                            <input type="email" class="form-control" id="modal_contacto_email" name="contacto_email">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Rol</label>
                            <input type="text" class="form-control" id="modal_contacto_rol" name="contacto_rol" placeholder="Ej: Gerente General">
                        </div>
                    </div>

                    <div id="modal_error" class="alert alert-danger d-none"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarClienteModal()">
                    <i class="fas fa-save"></i> Crear Cliente
                </button>
            </div>
        </div>
    </div>
</div>

<script>
async function guardarClienteModal() {
    const form = document.getElementById('formCrearClienteModal');
    const errorDiv = document.getElementById('modal_error');
    errorDiv.classList.add('d-none');

    // Validar formulario
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    // Preparar datos
    const contactos = [];
    const nombre = document.getElementById('modal_contacto_nombre').value.trim();
    const apellido = document.getElementById('modal_contacto_apellido').value.trim();

    if (nombre || apellido) {
        contactos.push({
            nombre: nombre,
            apellido: apellido,
            email: document.getElementById('modal_contacto_email').value.trim(),
            telefono: '',
            rol: document.getElementById('modal_contacto_rol').value.trim()
        });
    }

    const data = {
        empresa: document.getElementById('modal_empresa').value.trim(),
        tipo_documento: document.getElementById('modal_tipo_documento').value,
        numero_documento: document.getElementById('modal_numero_documento').value.trim(),
        email: document.getElementById('modal_email').value.trim(),
        telefono: document.getElementById('modal_telefono').value.trim(),
        contactos: contactos
    };

    try {
        const response = await fetch('/clientes/api/crear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrf_token]').value
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok && result.success) {
            // Agregar el cliente al dropdown
            const select = document.getElementById('cliente_id');
            const option = document.createElement('option');
            option.value = result.cliente.id;
            option.textContent = `${result.cliente.nombre_completo} - ${result.cliente.email || 'Sin email'}`;
            option.selected = true;
            select.appendChild(option);

            // Limpiar y cerrar modal
            form.reset();
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalCrearCliente'));
            modal.hide();

            // Mostrar mensaje de éxito
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show mt-2';
            alert.innerHTML = `
                <strong>¡Éxito!</strong> Cliente "${result.cliente.nombre_completo}" creado y seleccionado.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            select.parentElement.parentElement.appendChild(alert);

            setTimeout(() => alert.remove(), 5000);
        } else {
            errorDiv.textContent = result.error || 'Error al crear el cliente';
            errorDiv.classList.remove('d-none');
        }
    } catch (error) {
        errorDiv.textContent = 'Error de conexión. Intenta nuevamente.';
        errorDiv.classList.remove('d-none');
    }
}
</script>

{% endblock %}
