{% extends "base.html" %}

{% block title %}{{ presupuesto.numero }} - OBYRA IA{% endblock %}

{% block content %}
{% set obra = presupuesto.obra %}
{% set obra_nombre = obra.nombre if obra else (datos_proyecto.get('nombre_obra', 'Sin obra asociada') if datos_proyecto else 'Sin obra asociada') %}
{% set obra_cliente = obra.cliente if obra and obra.cliente else (datos_proyecto.get('cliente_nombre', 'Sin especificar') if datos_proyecto else 'Sin especificar') %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h2><i class="fas fa-calculator me-2"></i>{{ presupuesto.numero }}</h2>
                    <p class="text-muted mb-0">Obra: <span id="obra-nombre-resumen">{{ obra_nombre }}</span></p>
                    <p class="text-muted mb-0">Cliente: <span id="obra-cliente-resumen">{{ obra_cliente }}</span></p>
                </div>
                <div class="text-end">
                    <span class="badge {{ presupuesto.estado|estado_badge }} fs-6 mb-2">
                        {{ presupuesto.estado.title() }}
                    </span>

                    {% if presupuesto.estado == 'perdido' %}
                    <div class="alert alert-warning py-2 px-3 mt-2 text-start d-inline-block">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-archive me-2 mt-1"></i>
                            <div>
                                <strong>Marcado como perdido</strong>
                                {% if presupuesto.perdido_motivo %}
                                <div class="small mt-1">{{ presupuesto.perdido_motivo }}</div>
                                {% endif %}
                                {% if presupuesto.perdido_fecha %}
                                <div class="small text-muted mt-1">{{ presupuesto.perdido_fecha.strftime('%d/%m/%Y %H:%M') }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <div class="d-flex flex-wrap gap-2 justify-content-end mt-2">
                        {% if request.args.get('desde_obra') %}
                        <a href="{{ url_for('obras.detalle', id=request.args.get('desde_obra')) }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Volver a Obra
                        </a>
                        {% else %}
                        <a href="{{ url_for('presupuestos.lista') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Volver
                        </a>
                        {% endif %}
                        {% if presupuesto.items.count() > 0 %}
                        <button type="button" class="btn btn-success" onclick="descargarPDF({{ presupuesto.id }}, '{{ presupuesto.numero }}')">
                            <i class="fas fa-file-pdf me-1"></i>PDF
                        </button>
                        <button type="button" class="btn btn-info" onclick="enviarPorCorreo({{ presupuesto.id }})">
                            <i class="fas fa-envelope me-1"></i>Enviar por Correo
                        </button>
                        {% endif %}
                        {% if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'aprobado' and not presupuesto.confirmado_como_obra and not presupuesto.obra_id %}
                        <button type="button" class="btn btn-primary" onclick="confirmarComoObra({{ presupuesto.id }})">
                            <i class="fas fa-check-circle me-1"></i>Confirmar y Crear Obra
                        </button>
                        {% endif %}
                        {% if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' %}
                        <button class="btn btn-outline-warning" onclick="abrirPerderModal({{ presupuesto.id }}, '{{ presupuesto.numero }}')">
                            <i class="fas fa-archive me-1"></i>Marcar como perdido
                        </button>
                        {% endif %}
                        {% if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'perdido' %}
                        <button class="btn btn-outline-secondary" onclick="restaurarPresupuesto({{ presupuesto.id }})">
                            <i class="fas fa-undo me-1"></i>Restaurar a borrador
                        </button>
                        {% endif %}
                        {% if current_user.rol == 'administrador' and presupuesto.estado in ['borrador', 'perdido'] %}
                        <button class="btn btn-outline-danger" onclick="eliminarPresupuesto({{ presupuesto.id }}, '{{ presupuesto.numero }}')">
                            <i class="fas fa-trash me-1"></i>Eliminar
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% if presupuesto.fecha_vigencia %}
                <div class="mt-3 text-end">
                    {% set dias_restantes = presupuesto.dias_restantes_vigencia %}
                    {% set badge_class = presupuesto.clase_vigencia_badge %}
                    <span class="badge {{ badge_class }} fs-6" data-bs-toggle="tooltip"
                          title="Quedan {{ dias_restantes if dias_restantes is not none else '—' }} días para el vencimiento">
                        {% if presupuesto.esta_vencido %}
                            <i class="fas fa-exclamation-triangle me-1"></i>Vencido el {{ presupuesto.fecha_vigencia.strftime('%d/%m/%Y') }}
                        {% else %}
                            <i class="fas fa-hourglass-half me-1"></i>Vence el {{ presupuesto.fecha_vigencia.strftime('%d/%m/%Y') }}
                            {% if dias_restantes is not none %}
                                <span class="ms-1">(faltan {{ dias_restantes }} días)</span>
                            {% endif %}
                        {% endif %}
                    </span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Información del presupuesto -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Fecha:</strong> {{ presupuesto.fecha|fecha }}<br>
                            <strong>IVA:</strong> {{ presupuesto.iva_porcentaje }}%<br>
                        </div>
                        <div class="col-md-6">
                            <strong>Items:</strong> {{ presupuesto.items.count() }}<br>
                            <strong>Creado:</strong> {{ presupuesto.fecha_creacion.strftime('%d/%m/%Y %H:%M') }}<br>
                            {% if presupuesto.fecha_vigencia %}
                            {% set dias_restantes = presupuesto.dias_restantes_vigencia %}
                            <strong>Vigencia:</strong> {{ presupuesto.fecha_vigencia.strftime('%d/%m/%Y') }}
                            ({{ presupuesto.vigencia_dias }} días{% if dias_restantes is not none %}, faltan {{ dias_restantes if dias_restantes >= 0 else 0 }} días{% endif %})<br>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Información editable de la obra -->
                    <hr>
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-building me-2"></i>Información de la Obra
                        {% set es_admin = tiene_rol('admin') or (current_user.is_authenticated and current_user.es_admin()) %}
                        {% if (es_admin or tiene_rol('tecnico')) and presupuesto.estado in ['borrador', 'enviado'] and not presupuesto.confirmado_como_obra %}
                        <button class="btn btn-outline-primary btn-sm ms-2" onclick="toggleEditarObra()">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        {% endif %}
                    </h6>
                    
                    <div id="info-obra-view">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Nombre:</strong> <span id="obra-nombre">{{ obra_nombre }}</span><br>
                                <strong>Cliente:</strong> <span id="obra-cliente">{{ obra_cliente }}</span><br>
                                <strong>Descripción:</strong> <span id="obra-descripcion">{{ obra.descripcion if obra and obra.descripcion else 'Sin descripción' }}</span><br>
                            </div>
                            <div class="col-md-6">
                                <strong>Dirección:</strong> <span id="obra-direccion">{{ obra.direccion if obra and obra.direccion else (datos_proyecto.get('ubicacion', 'Sin especificar') if datos_proyecto else 'Sin especificar') }}</span><br>
                                <strong>Tipo de Obra:</strong> <span id="obra-tipo">{{ datos_proyecto.get('tipo_obra', 'Sin especificar') if datos_proyecto else 'Sin especificar' }}</span><br>
                                <strong>Superficie:</strong> <span id="obra-superficie">{{ datos_proyecto.get('superficie_m2', 'Sin especificar') if datos_proyecto else 'Sin especificar' }} m²</span><br>
                            </div>
                        </div>
                    </div>
                    
                    <div id="info-obra-edit" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <label class="form-label fw-bold">Nombre:</label>
                                    <input type="text" class="form-control form-control-sm" id="edit-obra-nombre"
                                           value="{{ obra.nombre if obra else (datos_proyecto.get('nombre_obra', '') if datos_proyecto else '') }}">
                                </div>
                                <div class="mb-2">
                                    <label class="form-label fw-bold">Cliente:</label>
                                    <div class="input-group input-group-sm">
                                        <select class="form-select form-select-sm" id="edit-obra-cliente-select">
                                            <option value="">-- Seleccionar cliente --</option>
                                            <!-- Se cargan dinámicamente -->
                                        </select>
                                        <button type="button" class="btn btn-outline-success" onclick="abrirModalNuevoCliente()" title="Crear nuevo cliente">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <input type="hidden" id="edit-obra-cliente" value="{{ obra.cliente if obra else (datos_proyecto.get('cliente_nombre', '') if datos_proyecto else '') }}">
                                    <input type="hidden" id="edit-obra-cliente-id" value="{{ presupuesto.cliente_id if presupuesto.cliente_id else '' }}">
                                </div>
                                <div class="mb-2">
                                    <label class="form-label fw-bold">Descripción:</label>
                                    <textarea class="form-control form-control-sm" id="edit-obra-descripcion" rows="2">{{ obra.descripcion if obra and obra.descripcion else (datos_proyecto.get('descripcion', '') if datos_proyecto else '') }}</textarea>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <label class="form-label fw-bold">Dirección:</label>
                                    <input type="text" class="form-control form-control-sm" id="edit-obra-direccion"
                                           value="{{ obra.direccion if obra and obra.direccion else (datos_proyecto.get('ubicacion', '') if datos_proyecto else '') }}">
                                </div>
                                <div class="mb-2">
                                    <label class="form-label fw-bold">Tipo de Obra:</label>
                                    <input type="text" class="form-control form-control-sm" id="edit-obra-tipo"
                                           value="{{ datos_proyecto.get('tipo_obra', '') if datos_proyecto else '' }}">
                                </div>
                                <div class="mb-2">
                                    <label class="form-label fw-bold">Superficie (m²):</label>
                                    <input type="number" class="form-control form-control-sm" id="edit-obra-superficie"
                                           value="{{ datos_proyecto.get('superficie_m2', '') if datos_proyecto else '' }}">
                                </div>
                            </div>
                        </div>
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-success btn-sm" onclick="guardarObra()">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="cancelarEditarObra()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    </div>
                    {% if presupuesto.observaciones %}
                    <hr>
                    <strong>Observaciones:</strong><br>
                    <p class="mb-0">{{ presupuesto.observaciones }}</p>
                    {% endif %}
                </div>
            </div>
            {% set total_items_ia = ia_materiales|length + ia_mano_obra|length + ia_equipos|length + ia_herramientas|length %}
            {% if total_items_ia > 0 %}
            <div class="card mt-4">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 text-primary"><i class="fas fa-robot me-2"></i>Items generados por IA - Organizados por Etapa</h6>
                    <div>
                        <span class="badge bg-success me-2">
                            USD {{ "{:,.2f}".format(totales_ia_usd.general|float) }}
                        </span>
                        <span class="badge bg-primary">
                            ARS {{ "{:,.2f}".format(totales_ia.general|float) }}
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    {% for etapa_nombre, items_etapa in ia_por_etapa.items() %}
                    {% set tiene_items = items_etapa.materiales|length + items_etapa.mano_obra|length + items_etapa.equipos|length + items_etapa.herramientas|length %}
                    {% if tiene_items > 0 %}
                    <div class="card mb-4 border-primary">
                        <div class="card-header bg-primary bg-opacity-10 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 text-primary fw-bold">
                                <i class="fas fa-layer-group me-2"></i>{{ etapa_nombre }}
                            </h6>
                            {% if subtotales_por_etapa[etapa_nombre] %}
                            <div>
                                <span class="badge bg-success me-1">USD {{ "{:,.2f}".format(subtotales_por_etapa[etapa_nombre].total_usd|float) }}</span>
                                <span class="badge bg-primary">ARS {{ "{:,.2f}".format(subtotales_por_etapa[etapa_nombre].total|float) }}</span>
                            </div>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            {% if items_etapa.materiales %}
                            <h6 class="text-secondary"><i class="fas fa-cubes me-1"></i> Materiales</h6>
                            <div class="table-responsive mb-3">
                                <table class="table table-sm table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Descripcion</th>
                                            <th class="text-center">Unidad</th>
                                            <th class="text-end">Cantidad</th>
                                            <th class="text-end">P.Unit USD</th>
                                            <th class="text-end">P.Unit ARS</th>
                                            <th class="text-end">Subtotal USD</th>
                                            <th class="text-end">Subtotal ARS</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in items_etapa.materiales %}
                                        <tr>
                                            <td>{{ item.descripcion }}</td>
                                            <td class="text-center">{{ item.unidad }}</td>
                                            <td class="text-end">{{ "{:,.3f}".format(item.cantidad|float) }}</td>
                                            <td class="text-end text-success">${{ "{:,.2f}".format((item.price_unit_currency or 0)|float) }}</td>
                                            <td class="text-end text-primary">${{ "{:,.2f}".format((item.price_unit_ars or item.precio_unitario or 0)|float) }}</td>
                                            <td class="text-end text-success fw-bold">${{ "{:,.2f}".format((item.total_currency or 0)|float) }}</td>
                                            <td class="text-end text-primary fw-bold">${{ "{:,.2f}".format((item.total_ars or item.total or 0)|float) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% endif %}

                            {% if items_etapa.mano_obra %}
                            <h6 class="text-secondary"><i class="fas fa-hard-hat me-1"></i> Mano de Obra</h6>
                            <div class="table-responsive mb-3">
                                <table class="table table-sm table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Descripcion</th>
                                            <th class="text-center">Unidad</th>
                                            <th class="text-end">Cantidad</th>
                                            <th class="text-end">P.Unit USD</th>
                                            <th class="text-end">P.Unit ARS</th>
                                            <th class="text-end">Subtotal USD</th>
                                            <th class="text-end">Subtotal ARS</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in items_etapa.mano_obra %}
                                        <tr>
                                            <td>{{ item.descripcion }}</td>
                                            <td class="text-center">{{ item.unidad }}</td>
                                            <td class="text-end">{{ "{:,.3f}".format(item.cantidad|float) }}</td>
                                            <td class="text-end text-success">${{ "{:,.2f}".format((item.price_unit_currency or 0)|float) }}</td>
                                            <td class="text-end text-primary">${{ "{:,.2f}".format((item.price_unit_ars or item.precio_unitario or 0)|float) }}</td>
                                            <td class="text-end text-success fw-bold">${{ "{:,.2f}".format((item.total_currency or 0)|float) }}</td>
                                            <td class="text-end text-primary fw-bold">${{ "{:,.2f}".format((item.total_ars or item.total or 0)|float) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% endif %}

                            {% if items_etapa.equipos %}
                            <h6 class="text-secondary"><i class="fas fa-truck me-1"></i> Equipos</h6>
                            <div class="table-responsive mb-3">
                                <table class="table table-sm table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Descripcion</th>
                                            <th class="text-center">Unidad</th>
                                            <th class="text-end">Cantidad</th>
                                            <th class="text-end">P.Unit USD</th>
                                            <th class="text-end">P.Unit ARS</th>
                                            <th class="text-end">Subtotal USD</th>
                                            <th class="text-end">Subtotal ARS</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in items_etapa.equipos %}
                                        <tr>
                                            <td>{{ item.descripcion }}</td>
                                            <td class="text-center">{{ item.unidad }}</td>
                                            <td class="text-end">{{ "{:,.3f}".format(item.cantidad|float) }}</td>
                                            <td class="text-end text-success">${{ "{:,.2f}".format((item.price_unit_currency or 0)|float) }}</td>
                                            <td class="text-end text-primary">${{ "{:,.2f}".format((item.price_unit_ars or item.precio_unitario or 0)|float) }}</td>
                                            <td class="text-end text-success fw-bold">${{ "{:,.2f}".format((item.total_currency or 0)|float) }}</td>
                                            <td class="text-end text-primary fw-bold">${{ "{:,.2f}".format((item.total_ars or item.total or 0)|float) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% endif %}

                            {% if items_etapa.herramientas %}
                            <h6 class="text-secondary"><i class="fas fa-tools me-1"></i> Herramientas</h6>
                            <div class="table-responsive mb-3">
                                <table class="table table-sm table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Descripcion</th>
                                            <th class="text-center">Unidad</th>
                                            <th class="text-end">Cantidad</th>
                                            <th class="text-end">P.Unit USD</th>
                                            <th class="text-end">P.Unit ARS</th>
                                            <th class="text-end">Subtotal USD</th>
                                            <th class="text-end">Subtotal ARS</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in items_etapa.herramientas %}
                                        <tr>
                                            <td>{{ item.descripcion }}</td>
                                            <td class="text-center">{{ item.unidad }}</td>
                                            <td class="text-end">{{ "{:,.3f}".format(item.cantidad|float) }}</td>
                                            <td class="text-end text-success">${{ "{:,.2f}".format((item.price_unit_currency or 0)|float) }}</td>
                                            <td class="text-end text-primary">${{ "{:,.2f}".format((item.price_unit_ars or item.precio_unitario or 0)|float) }}</td>
                                            <td class="text-end text-success fw-bold">${{ "{:,.2f}".format((item.total_currency or 0)|float) }}</td>
                                            <td class="text-end text-primary fw-bold">${{ "{:,.2f}".format((item.total_ars or item.total or 0)|float) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}

                    <!-- Resumen de totales por categoria -->
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="fw-bold mb-3"><i class="fas fa-calculator me-2"></i>Resumen Totales IA</h6>
                            <div class="table-responsive">
                                <table class="table table-sm mb-0">
                                    <thead>
                                        <tr>
                                            <th>Categoria</th>
                                            <th class="text-end">Total USD</th>
                                            <th class="text-end">Total ARS</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><i class="fas fa-cubes me-1 text-muted"></i> Materiales</td>
                                            <td class="text-end text-success">${{ "{:,.2f}".format(totales_ia_usd.materiales|float) }}</td>
                                            <td class="text-end text-primary">${{ "{:,.2f}".format(totales_ia.materiales|float) }}</td>
                                        </tr>
                                        <tr>
                                            <td><i class="fas fa-hard-hat me-1 text-muted"></i> Mano de Obra</td>
                                            <td class="text-end text-success">${{ "{:,.2f}".format(totales_ia_usd.mano_obra|float) }}</td>
                                            <td class="text-end text-primary">${{ "{:,.2f}".format(totales_ia.mano_obra|float) }}</td>
                                        </tr>
                                        <tr>
                                            <td><i class="fas fa-truck me-1 text-muted"></i> Equipos</td>
                                            <td class="text-end text-success">${{ "{:,.2f}".format(totales_ia_usd.equipos|float) }}</td>
                                            <td class="text-end text-primary">${{ "{:,.2f}".format(totales_ia.equipos|float) }}</td>
                                        </tr>
                                        <tr>
                                            <td><i class="fas fa-tools me-1 text-muted"></i> Herramientas</td>
                                            <td class="text-end text-success">${{ "{:,.2f}".format(totales_ia_usd.herramientas|float) }}</td>
                                            <td class="text-end text-primary">${{ "{:,.2f}".format(totales_ia.herramientas|float) }}</td>
                                        </tr>
                                    </tbody>
                                    <tfoot class="table-dark">
                                        <tr>
                                            <th>TOTAL GENERAL IA</th>
                                            <th class="text-end">${{ "{:,.2f}".format(totales_ia_usd.general|float) }} USD</th>
                                            <th class="text-end">${{ "{:,.2f}".format(totales_ia.general|float) }} ARS</th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

{% if presupuesto.currency != 'ARS' %}
    {% if presupuesto.tasa_usd_venta or presupuesto.exchange_rate_value %}
    <div class="alert alert-info">
        <i class="fas fa-exchange-alt me-2"></i>
        Tipo de cambio utilizado:
        {{ (presupuesto.tasa_usd_venta or presupuesto.exchange_rate_value)|moneda('ARS') }}
        {% if presupuesto.exchange_rate_provider %}
            — {{ presupuesto.exchange_rate_provider|upper }}
        {% endif %}
        {% set fecha_tc = presupuesto.exchange_rate_as_of or (presupuesto.exchange_rate_fetched_at.date() if presupuesto.exchange_rate_fetched_at else None) %}
        {% if fecha_tc %}
            <span class="ms-2 text-muted">({{ fecha_tc.strftime('%d/%m/%Y') }})</span>
        {% endif %}
    </div>
    {% endif %}
{% endif %}

{% if presupuesto.indice_cac_valor %}
<div class="alert alert-secondary">
    <i class="fas fa-chart-line me-2"></i>
    Índice CAC aplicado: {{ '{:,.2f}'.format(presupuesto.indice_cac_valor) }}
    {% if presupuesto.indice_cac_fecha %}
        <span class="ms-2 text-muted">({{ presupuesto.indice_cac_fecha.strftime('%B %Y')|title }})</span>
    {% endif %}
</div>
{% endif %}

        <div class="col-lg-4">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="text-muted">Resumen del Presupuesto</h6>

                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <strong class="text-success d-block" id="resumen-materiales-usd">{{ subtotal_materiales_usd|moneda('USD') }}</strong>
                            <strong class="text-primary d-block" id="resumen-materiales-ars">{{ subtotal_materiales_ars|moneda('ARS') }}</strong>
                            <small class="text-muted">Materiales</small>
                        </div>
                        <div class="col-4">
                            <strong class="text-success d-block" id="resumen-mano-obra-usd">{{ subtotal_mano_obra_usd|moneda('USD') }}</strong>
                            <strong class="text-primary d-block" id="resumen-mano-obra-ars">{{ subtotal_mano_obra_ars|moneda('ARS') }}</strong>
                            <small class="text-muted">Mano de Obra</small>
                        </div>
                        <div class="col-4">
                            <strong class="text-success d-block" id="resumen-equipos-usd">{{ subtotal_equipos_usd|moneda('USD') }}</strong>
                            <strong class="text-primary d-block" id="resumen-equipos-ars">{{ subtotal_equipos_ars|moneda('ARS') }}</strong>
                            <small class="text-muted">Equipos</small>
                        </div>
                    </div>

                    <hr>

                    <div class="row text-center">
                        <div class="col-6">
                            <strong class="text-success d-block" id="resumen-sin-iva-usd">{{ subtotal_usd|moneda('USD') }}</strong>
                            <strong class="text-primary d-block" id="resumen-sin-iva-ars">{{ subtotal_ars|moneda('ARS') }}</strong>
                            <small class="text-muted">Sin IVA</small>
                        </div>
                        <div class="col-6">
                            <strong class="text-success d-block h5" id="resumen-total-usd">{{ total_con_iva_usd|moneda('USD') }}</strong>
                            <strong class="text-primary d-block h5" id="resumen-total-ars">{{ total_con_iva_ars|moneda('ARS') }}</strong>
                            <small class="text-muted">Total con IVA</small>
                        </div>
</div>

{% include 'presupuestos/_perder_modal.html' %}

{% if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado not in ['aprobado', 'perdido', 'eliminado'] %}
                    <hr>
                    <div class="d-grid">
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#cambiarEstadoModal">
                            <i class="fas fa-edit me-1"></i>Cambiar Estado
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Materiales -->
    {% if materiales or current_user.rol in ['administrador', 'tecnico'] %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-cubes me-2"></i>Materiales</h5>
                    {% if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' %}
                    <button class="btn btn-sm btn-primary" onclick="abrirModalItem('material')">
                        <i class="fas fa-plus me-1"></i>Agregar Material
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if materiales %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Descripcion</th>
                                    <th>Unidad</th>
                                    <th class="text-end">Cantidad</th>
                                    <th class="text-end">P. Unitario</th>
                                    <th class="text-end">Total USD</th>
                                    <th class="text-end">Total ARS</th>
                                    {% if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' %}
                                    <th width="50"></th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in materiales %}
                                <tr data-item-id="{{ item.id }}"
                                    data-item-tipo="material"
                                    data-item-descripcion="{{ item.descripcion }}"
                                    data-item-unidad="{{ item.unidad }}"
                                    data-item-cantidad="{{ item.cantidad or 0 }}"
                                    data-item-precio="{{ item.price_unit_currency or item.precio_unitario or 0 }}"
                                    data-item-currency="{{ item.currency or presupuesto.currency }}"
                                    data-item-fx-rate="{{ item.fx_rate_value or '' }}"
                                    data-item-precio-ars="{{ item.price_unit_ars or '' }}"
                                    data-item-total-currency="{{ item.total_currency or item.total or 0 }}"
                                    data-item-total-ars="{{ item.total_ars or '' }}"
                                    data-item-editable="{{ 'true' if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' else 'false' }}"
                                    data-item-can-delete="{{ 'true' if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' else 'false' }}"
                                    data-item-delete-url="{{ url_for('presupuestos.eliminar_item', id=item.id) if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' else '' }}"
                                    data-item-delete-confirm="¿Eliminar este item?">
                                    <td>{{ item.descripcion }}</td>
                                    <td>{{ item.unidad }}</td>
                                    <td class="text-end">{{ item.cantidad|entero }}</td>
                                    <td class="text-end">{{ (item.price_unit_ars or item.precio_unitario)|moneda('ARS') }}</td>
                                    <td class="text-end fw-bold text-success">{{ (item.total_currency or 0)|moneda('USD') }}</td>
                                    <td class="text-end fw-bold text-primary">{{ (item.total_ars or item.total or 0)|moneda('ARS') }}</td>
                                    {% if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' %}
                                    <td class="text-end">
                                        <div class="d-flex gap-2 justify-content-end">
                                            <button class="btn btn-outline-primary btn-sm" type="button" onclick="editarItem({{ item.id }})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <form method="POST" action="{{ url_for('presupuestos.eliminar_item', id=item.id) }}"
                                                  style="display: inline;" onsubmit="return confirm('¿Eliminar este item?')">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-info">
                                    <th colspan="4" class="text-end">Subtotal Materiales:</th>
                                    <th class="text-end text-success">{{ subtotal_materiales_usd|moneda('USD') }}</th>
                                    <th class="text-end text-primary">{{ subtotal_materiales_ars|moneda('ARS') }}</th>
                                    {% if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' %}
                                    <th></th>
                                    {% endif %}
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-cubes fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No hay materiales agregados.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Mano de Obra -->
    {% if mano_obra or current_user.rol in ['administrador', 'tecnico'] %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>Mano de Obra</h5>
                    {% if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' %}
                    <button class="btn btn-sm btn-primary" onclick="abrirModalItem('mano_obra')">
                        <i class="fas fa-plus me-1"></i>Agregar Mano de Obra
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if mano_obra %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Descripcion</th>
                                    <th class="text-center">Personas</th>
                                    <th class="text-center">Dias</th>
                                    <th class="text-end">Jornales</th>
                                    <th>Unidad</th>
                                    <th class="text-end">P. Unitario</th>
                                    <th class="text-end">Total USD</th>
                                    <th class="text-end">Total ARS</th>
                                    {% if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' %}
                                    <th width="50"></th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in mano_obra %}
                                <tr data-item-id="{{ item.id }}"
                                    data-item-tipo="mano_obra"
                                    data-item-descripcion="{{ item.descripcion }}"
                                    data-item-unidad="{{ item.unidad }}"
                                    data-item-cantidad="{{ item.cantidad or 0 }}"
                                    data-item-precio="{{ item.price_unit_currency or item.precio_unitario or 0 }}"
                                    data-item-currency="{{ item.currency or presupuesto.currency }}"
                                    data-item-fx-rate="{{ item.fx_rate_value or '' }}"
                                    data-item-precio-ars="{{ item.price_unit_ars or '' }}"
                                    data-item-total-currency="{{ item.total_currency or item.total or 0 }}"
                                    data-item-total-ars="{{ item.total_ars or '' }}"
                                    data-item-personas="{{ item.personas or 1 }}"
                                    data-item-dias="{{ (item.duracion_dias or ((item.jornales or item.cantidad) / (item.personas or 1)))|round(1) }}"
                                    data-item-jornales="{{ item.jornales or item.cantidad }}"
                                    data-item-editable="{{ 'true' if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' else 'false' }}"
                                    data-item-can-delete="{{ 'true' if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' else 'false' }}"
                                    data-item-delete-url="{{ url_for('presupuestos.eliminar_item', id=item.id) if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' else '' }}"
                                    data-item-delete-confirm="¿Eliminar este item?">
                                    <td>{{ item.descripcion }}</td>
                                    <td class="text-center">{{ item.personas or 1 }}</td>
                                    <td class="text-center">{{ (item.duracion_dias or ((item.jornales or item.cantidad) / (item.personas or 1)))|entero }}</td>
                                    <td class="text-end">{{ (item.jornales or item.cantidad)|entero }}</td>
                                    <td>{{ item.unidad }}</td>
                                    <td class="text-end">{{ (item.price_unit_ars or item.precio_unitario)|moneda('ARS') }}</td>
                                    <td class="text-end fw-bold text-success">{{ (item.total_currency or 0)|moneda('USD') }}</td>
                                    <td class="text-end fw-bold text-primary">{{ (item.total_ars or item.total or 0)|moneda('ARS') }}</td>
                                    {% if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' %}
                                    <td class="text-end">
                                        <div class="d-flex gap-2 justify-content-end">
                                            <button class="btn btn-outline-primary btn-sm" type="button" onclick="editarItem({{ item.id }})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <form method="POST" action="{{ url_for('presupuestos.eliminar_item', id=item.id) }}"
                                                  style="display: inline;" onsubmit="return confirm('¿Eliminar este item?')">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-warning">
                                    <th colspan="6" class="text-end">Subtotal Mano de Obra:</th>
                                    <th class="text-end text-success">{{ subtotal_mano_obra_usd|moneda('USD') }}</th>
                                    <th class="text-end text-primary">{{ subtotal_mano_obra_ars|moneda('ARS') }}</th>
                                    {% if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' %}
                                    <th></th>
                                    {% endif %}
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-users fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No hay mano de obra agregada.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Equipos -->
    {% if equipos or current_user.rol in ['administrador', 'tecnico'] %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Equipos</h5>
                    {% if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' %}
                    <button class="btn btn-sm btn-primary" onclick="abrirModalItem('equipo')">
                        <i class="fas fa-plus me-1"></i>Agregar Equipo
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if equipos %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Descripcion</th>
                                    <th>Unidad</th>
                                    <th class="text-end">Cantidad</th>
                                    <th class="text-end">P. Unitario</th>
                                    <th class="text-end">Total USD</th>
                                    <th class="text-end">Total ARS</th>
                                    {% if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' %}
                                    <th width="50"></th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in equipos %}
                                <tr data-item-id="{{ item.id }}"
                                    data-item-tipo="equipo"
                                    data-item-descripcion="{{ item.descripcion }}"
                                    data-item-unidad="{{ item.unidad }}"
                                    data-item-cantidad="{{ item.cantidad or 0 }}"
                                    data-item-precio="{{ item.price_unit_currency or item.precio_unitario or 0 }}"
                                    data-item-currency="{{ item.currency or presupuesto.currency }}"
                                    data-item-fx-rate="{{ item.fx_rate_value or '' }}"
                                    data-item-precio-ars="{{ item.price_unit_ars or '' }}"
                                    data-item-total-currency="{{ item.total_currency or item.total or 0 }}"
                                    data-item-total-ars="{{ item.total_ars or '' }}"
                                    data-item-editable="{{ 'true' if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' else 'false' }}"
                                    data-item-can-delete="{{ 'true' if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' else 'false' }}"
                                    data-item-delete-url="{{ url_for('presupuestos.eliminar_item', id=item.id) if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' else '' }}"
                                    data-item-delete-confirm="¿Eliminar este item?">
                                    <td>{{ item.descripcion }}</td>
                                    <td>{{ item.unidad }}</td>
                                    <td class="text-end">{{ item.cantidad|entero }}</td>
                                    <td class="text-end">{{ (item.price_unit_ars or item.precio_unitario)|moneda('ARS') }}</td>
                                    <td class="text-end fw-bold text-success">{{ (item.total_currency or 0)|moneda('USD') }}</td>
                                    <td class="text-end fw-bold text-primary">{{ (item.total_ars or item.total or 0)|moneda('ARS') }}</td>
                                    {% if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' %}
                                    <td class="text-end">
                                        <div class="d-flex gap-2 justify-content-end">
                                            <button class="btn btn-outline-primary btn-sm" type="button" onclick="editarItem({{ item.id }})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <form method="POST" action="{{ url_for('presupuestos.eliminar_item', id=item.id) }}"
                                                  style="display: inline;" onsubmit="return confirm('¿Eliminar este item?')">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-secondary">
                                    <th colspan="4" class="text-end">Subtotal Equipos:</th>
                                    <th class="text-end text-success">{{ subtotal_equipos_usd|moneda('USD') }}</th>
                                    <th class="text-end text-primary">{{ subtotal_equipos_ars|moneda('ARS') }}</th>
                                    {% if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' %}
                                    <th></th>
                                    {% endif %}
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-tools fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No hay equipos agregados.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modales -->
{% if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado == 'borrador' %}

<!-- Modal Agregar Item -->
<div class="modal fade" id="agregarItemModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('presupuestos.agregar_item', id=presupuesto.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-header">
                    <h5 class="modal-title">Agregar <span id="tipoItemTexto"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="tipo" id="tipoItem">

                    <!-- Selector de Item de Inventario (solo para materiales) -->
                    <div class="mb-3" id="selectorInventario" style="display: none;">
                        <label class="form-label">
                            <i class="fas fa-warehouse me-1"></i>Vincular con Inventario
                            <small class="text-muted">(opcional)</small>
                        </label>
                        <select class="form-select" name="item_inventario_id" id="itemInventarioSelect">
                            <option value="">-- Sin vincular (ingreso manual) --</option>
                            {% for item_inv in items_inventario|default([]) %}
                            <option value="{{ item_inv.id }}"
                                    data-nombre="{{ item_inv.nombre }}"
                                    data-unidad="{{ item_inv.unidad }}"
                                    data-stock="{{ item_inv.stock_actual }}">
                                {{ item_inv.nombre }}{% if item_inv.descripcion %} - {{ item_inv.descripcion }}{% endif %}
                                (Stock: {{ item_inv.stock_actual }} {{ item_inv.unidad }})
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Al vincular, se mostrará el stock real en la obra</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <input type="text" class="form-control" name="descripcion" id="descripcionItem"
                               placeholder="Descripción del item" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Unidad</label>
                                <select class="form-select" name="unidad" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="unidad">Unidad</option>
                                    <option value="metro">Metro</option>
                                    <option value="metro2">Metro²</option>
                                    <option value="metro3">Metro³</option>
                                    <option value="kilogramo">Kilogramo</option>
                                    <option value="tonelada">Tonelada</option>
                                    <option value="litro">Litro</option>
                                    <option value="hora">Hora</option>
                                    <option value="dia">Día</option>
                                    <option value="bolsa">Bolsa</option>
                                    <option value="caja">Caja</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Cantidad</label>
                                <input type="number" class="form-control" name="cantidad" 
                                       placeholder="0" step="0.001" min="0" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Moneda</label>
                                <select class="form-select" name="currency" required>
                                    <option value="ARS" {{ 'selected' if presupuesto.currency == 'ARS' else '' }}>Pesos (ARS)</option>
                                    <option value="USD" {{ 'selected' if presupuesto.currency == 'USD' else '' }}>Dólares (USD)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Precio Unitario</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" name="precio_unitario"
                                           placeholder="0.00" step="0.01" min="0" required>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Agregar Item</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endif %}

{% if current_user.rol in ['administrador', 'tecnico'] and presupuesto.estado != 'aprobado' %}

<!-- Modal Cambiar Estado -->
<div class="modal fade" id="cambiarEstadoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('presupuestos.cambiar_estado', id=presupuesto.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-header">
                    <h5 class="modal-title">Cambiar Estado del Presupuesto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nuevo Estado</label>
                        <select class="form-select" name="estado" required>
                            <option value="">Seleccionar estado...</option>
                            <option value="borrador" {{ 'selected' if presupuesto.estado == 'borrador' }}>Borrador</option>
                            <option value="enviado" {{ 'selected' if presupuesto.estado == 'enviado' }}>Enviado</option>
                            <option value="aprobado" {{ 'selected' if presupuesto.estado == 'aprobado' }}>Aprobado</option>
                            <option value="rechazado" {{ 'selected' if presupuesto.estado == 'rechazado' }}>Rechazado</option>
                        </select>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>Nota:</strong> Una vez aprobado, el presupuesto no podrá ser modificado.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Cambiar Estado</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endif %}
{% endblock %}

{% block scripts %}
<script>
const modalPerdidoEl = document.getElementById('modalMarcarPerdido');
const modalPerdido = modalPerdidoEl ? new bootstrap.Modal(modalPerdidoEl) : null;
let presupuestoSeleccionado = null;
const botonConfirmarPerdido = document.getElementById('btnConfirmarPerdido');
if (botonConfirmarPerdido) {
    botonConfirmarPerdido.addEventListener('click', confirmarMarcarPerdido);
}

const initialObraId = {{ (obra.id if obra else None)|tojson }};
let currentObraId = initialObraId;

function abrirPerderModal(id, numero) {
    if (!modalPerdido) return;
    presupuestoSeleccionado = { id, numero };
    const numeroSpan = document.getElementById('perderPresupuestoNumero');
    if (numeroSpan) {
        numeroSpan.textContent = numero;
    }
    const motivo = document.getElementById('motivoPerdido');
    const detalle = document.getElementById('detallePerdido');
    if (motivo) motivo.value = '';
    if (detalle) detalle.value = '';
    modalPerdido.show();
}

async function confirmarMarcarPerdido() {
    if (!presupuestoSeleccionado) return;
    const motivo = document.getElementById('motivoPerdido')?.value.trim() || '';
    const detalle = document.getElementById('detallePerdido')?.value.trim() || '';

    if (!motivo && !detalle) {
        showAlert('Selecciona un motivo o agrega un detalle para registrar el motivo.', 'warning');
        return;
    }

    try {
        const response = await fetch(`/presupuestos/${presupuestoSeleccionado.id}/perder`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ motivo, detalle })
        });

        const result = await response.json().catch(() => ({}));
        if (!response.ok) {
            showAlert(result.error || 'Error al marcar el presupuesto como perdido.', 'danger');
            return;
        }

        modalPerdido?.hide();
        showAlert(result.mensaje || 'Presupuesto marcado como perdido.', 'success');
        setTimeout(() => window.location.reload(), 800);
    } catch (error) {
        console.error(error);
        showAlert('No se pudo completar la operación. Intenta nuevamente.', 'danger');
    }
}

async function restaurarPresupuesto(id) {
    if (!confirm('¿Restaurar este presupuesto a borrador?')) {
        return;
    }

    try {
        const response = await fetch(`/presupuestos/${id}/restaurar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const result = await response.json().catch(() => ({}));
        if (!response.ok) {
            showAlert(result.error || 'Error al restaurar el presupuesto.', 'danger');
            return;
        }

        showAlert(result.mensaje || 'Presupuesto restaurado a borrador.', 'success');
        setTimeout(() => window.location.reload(), 800);
    } catch (error) {
        console.error(error);
        showAlert('No se pudo completar la operación. Intenta nuevamente.', 'danger');
    }
}

async function eliminarPresupuesto(id, numero) {
    if (!confirm(`¿Eliminar el presupuesto ${numero}? Esta acción lo archivará y podrás verlo solo desde el filtro de eliminados.`)) {
        return;
    }

    try {
        // Obtener el token CSRF del meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

        const headers = {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        };

        // Agregar token CSRF en header si existe
        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }

        // Crear body con token CSRF
        const body = JSON.stringify({
            csrf_token: csrfToken
        });

        const response = await fetch(`/presupuestos/${id}/eliminar`, {
            method: 'POST',
            headers: headers,
            body: body
        });

        const result = await response.json().catch(() => ({}));
        if (!response.ok) {
            showAlert(result.error || 'Error al eliminar el presupuesto.', 'danger');
            return;
        }

        showAlert(result.mensaje || 'Presupuesto eliminado correctamente.', 'success');
        setTimeout(() => window.location.href = '/presupuestos', 800);
    } catch (error) {
        console.error('Error al eliminar:', error);
        showAlert('No se pudo completar la operación. Intenta nuevamente.', 'danger');
    }
}

async function confirmarComoObra(id) {
    if (!confirm('¿Confirmar este presupuesto y crear la obra?\n\nEsto pasará el presupuesto al módulo de obras para su ejecución.')) {
        return;
    }

    try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

        const headers = {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        };

        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }

        const response = await fetch(`/presupuestos/${id}/confirmar-obra`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
                crear_tareas: true,
                normalizar_slugs: true
            })
        });

        const result = await response.json().catch(() => ({}));

        if (!response.ok || result.error) {
            showAlert(result.error || 'Error al confirmar el presupuesto.', 'danger');
            return;
        }

        showAlert(result.message || 'Obra creada correctamente.', 'success');

        // Redirigir a la obra creada si hay URL
        if (result.redirect_url) {
            setTimeout(() => window.location.href = result.redirect_url, 1000);
        } else if (result.obra_url) {
            setTimeout(() => window.location.href = result.obra_url, 1000);
        } else {
            setTimeout(() => window.location.reload(), 1000);
        }
    } catch (error) {
        console.error('Error al confirmar:', error);
        showAlert('No se pudo completar la operación. Intenta nuevamente.', 'danger');
    }
}

function abrirModalItem(tipo) {
    const tipos = {
        'material': 'Material',
        'mano_obra': 'Mano de Obra',
        'equipo': 'Equipo'
    };

    document.getElementById('tipoItem').value = tipo;
    document.getElementById('tipoItemTexto').textContent = tipos[tipo];

    // Mostrar selector de inventario solo para materiales
    const selectorInventario = document.getElementById('selectorInventario');
    if (tipo === 'material') {
        selectorInventario.style.display = 'block';
    } else {
        selectorInventario.style.display = 'none';
        document.getElementById('itemInventarioSelect').value = '';
    }

    // Limpiar formulario
    document.getElementById('descripcionItem').value = '';
    document.getElementById('itemInventarioSelect').value = '';

    new bootstrap.Modal(document.getElementById('agregarItemModal')).show();
}

// Autocompletar campos cuando se selecciona un item de inventario
document.getElementById('itemInventarioSelect')?.addEventListener('change', function() {
    const option = this.options[this.selectedIndex];
    if (option.value) {
        const nombre = option.dataset.nombre || '';
        const unidad = option.dataset.unidad || '';

        // Autocompletar descripción con el nombre del inventario
        document.getElementById('descripcionItem').value = nombre;

        // Autocompletar unidad si existe el select
        const unidadSelect = document.querySelector('select[name="unidad"]');
        if (unidadSelect) {
            // Buscar opción que coincida
            for (let i = 0; i < unidadSelect.options.length; i++) {
                if (unidadSelect.options[i].value.toLowerCase() === unidad.toLowerCase()) {
                    unidadSelect.selectedIndex = i;
                    break;
                }
            }
        }
    }
});

// Funciones para editar información de la obra
let clientesCargados = [];

async function cargarClientes() {
    try {
        const response = await fetch('/clientes/api/listar');
        if (!response.ok) throw new Error('Error al cargar clientes');
        clientesCargados = await response.json();

        const select = document.getElementById('edit-obra-cliente-select');
        const clienteIdActual = document.getElementById('edit-obra-cliente-id').value;

        // Limpiar opciones existentes
        select.innerHTML = '<option value="">-- Seleccionar cliente --</option>';

        // Agregar clientes
        clientesCargados.forEach(cliente => {
            const option = document.createElement('option');
            option.value = cliente.id;
            option.textContent = cliente.empresa ? `${cliente.empresa} (${cliente.nombre_completo})` : cliente.nombre_completo;
            option.dataset.nombre = cliente.nombre_completo;
            option.dataset.empresa = cliente.empresa || '';

            // Seleccionar el cliente actual si existe
            if (clienteIdActual && cliente.id == clienteIdActual) {
                option.selected = true;
            }
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error cargando clientes:', error);
        showAlert('Error al cargar la lista de clientes', 'warning');
    }
}

function toggleEditarObra() {
    const viewDiv = document.getElementById('info-obra-view');
    const editDiv = document.getElementById('info-obra-edit');

    if (viewDiv.style.display === 'none') {
        viewDiv.style.display = 'block';
        editDiv.style.display = 'none';
    } else {
        viewDiv.style.display = 'none';
        editDiv.style.display = 'block';
        // Cargar clientes al abrir el modo edición
        cargarClientes();
    }
}

function cancelarEditarObra() {
    document.getElementById('info-obra-view').style.display = 'block';
    document.getElementById('info-obra-edit').style.display = 'none';
}

function abrirModalNuevoCliente() {
    // Abrir crear cliente en nueva ventana
    const ventana = window.open('/clientes/crear', 'crearCliente', 'width=800,height=700,scrollbars=yes');

    // Escuchar mensaje cuando se cree el cliente
    window.addEventListener('message', function handler(event) {
        if (event.data && event.data.tipo === 'clienteCreado') {
            // Recargar la lista de clientes y seleccionar el nuevo
            cargarClientes().then(() => {
                const select = document.getElementById('edit-obra-cliente-select');
                if (event.data.cliente_id) {
                    select.value = event.data.cliente_id;
                    document.getElementById('edit-obra-cliente-id').value = event.data.cliente_id;
                }
            });
            window.removeEventListener('message', handler);
        }
    });
}

// Actualizar cliente_id cuando cambia el select
document.getElementById('edit-obra-cliente-select')?.addEventListener('change', function() {
    document.getElementById('edit-obra-cliente-id').value = this.value;
    // Actualizar también el campo de texto oculto con el nombre
    const selectedOption = this.options[this.selectedIndex];
    if (selectedOption && selectedOption.value) {
        const nombreCompleto = selectedOption.dataset.empresa
            ? selectedOption.dataset.empresa
            : selectedOption.dataset.nombre;
        document.getElementById('edit-obra-cliente').value = nombreCompleto || '';
    } else {
        document.getElementById('edit-obra-cliente').value = '';
    }
});

async function guardarObra() {
    const clienteSelect = document.getElementById('edit-obra-cliente-select');
    const clienteId = document.getElementById('edit-obra-cliente-id').value;

    // Obtener nombre del cliente seleccionado
    let clienteNombre = '';
    if (clienteSelect && clienteSelect.selectedIndex > 0) {
        const selectedOption = clienteSelect.options[clienteSelect.selectedIndex];
        clienteNombre = selectedOption.dataset.empresa || selectedOption.dataset.nombre || selectedOption.textContent;
    }

    const data = {
        obra_id: currentObraId,
        nombre: document.getElementById('edit-obra-nombre').value.trim(),
        cliente: clienteNombre,
        cliente_id: clienteId ? parseInt(clienteId) : null,
        descripcion: document.getElementById('edit-obra-descripcion').value.trim(),
        direccion: document.getElementById('edit-obra-direccion').value.trim(),
        tipo_obra: document.getElementById('edit-obra-tipo').value.trim(),
        superficie_m2: document.getElementById('edit-obra-superficie').value.trim()
    };

    if (!data.nombre) {
        showAlert('El nombre de la obra es obligatorio.', 'warning');
        return;
    }

    if (data.obra_id === null) {
        delete data.obra_id;
    }

    try {
        const response = await fetch(`/presupuestos/{{ presupuesto.id }}/editar-obra`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (!response.ok) {
            showAlert(result.error || 'Error al actualizar la obra', 'danger');
            return;
        }

        if (result.exito) {
            if (result.obra_id) {
                currentObraId = result.obra_id;
            }

            // Actualizar los valores mostrados
            const nombre = data.nombre || 'Sin obra asociada';
            const cliente = data.cliente || 'Sin especificar';
            document.getElementById('obra-nombre').textContent = nombre;
            document.getElementById('obra-cliente').textContent = cliente;
            const resumenNombre = document.getElementById('obra-nombre-resumen');
            if (resumenNombre) {
                resumenNombre.textContent = nombre;
            }
            const resumenCliente = document.getElementById('obra-cliente-resumen');
            if (resumenCliente) {
                resumenCliente.textContent = cliente;
            }
            document.getElementById('obra-descripcion').textContent = data.descripcion || 'Sin descripción';
            document.getElementById('obra-direccion').textContent = data.direccion || 'Sin especificar';
            document.getElementById('obra-tipo').textContent = data.tipo_obra || 'Sin especificar';
            document.getElementById('obra-superficie').textContent = data.superficie_m2 ? `${data.superficie_m2} m²` : 'Sin especificar m²';

            // Actualizar el cliente_id guardado
            if (data.cliente_id) {
                document.getElementById('edit-obra-cliente-id').value = data.cliente_id;
            }

            // Volver a vista normal
            cancelarEditarObra();

            // Mostrar mensaje de éxito
            showAlert(result.mensaje || 'Obra actualizada correctamente', 'success');
        } else {
            showAlert(result.error || 'Error al actualizar la obra', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error de conexión al actualizar la obra', 'danger');
    }
}

const resumenCurrency = {{ presupuesto.currency|tojson }};
const currencyFormatters = {};

function getCurrencyFormatter(currency) {
    const key = currency || 'ARS';
    if (!currencyFormatters[key]) {
        try {
            currencyFormatters[key] = new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: key === 'USD' ? 'USD' : 'ARS',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        } catch (error) {
            currencyFormatters[key] = new Intl.NumberFormat('es-AR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
    }
    return currencyFormatters[key];
}

function formatCurrencyValue(value, currency) {
    if (value === null || value === undefined || value === '') {
        return '—';
    }
    const numeric = Number(String(value).replace(',', '.'));
    if (!Number.isFinite(numeric)) {
        return '—';
    }
    const formatter = getCurrencyFormatter(currency);
    return formatter.format(numeric);
}

function parseDecimalString(value, fallback = 0) {
    if (value === null || value === undefined || value === '') {
        return fallback;
    }
    const numeric = Number(String(value).replace(',', '.'));
    return Number.isFinite(numeric) ? numeric : fallback;
}

function formatNumber(value, decimals = 2) {
    const numeric = parseDecimalString(value, 0);
    return numeric.toLocaleString('es-AR', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    });
}

const htmlEscaper = document.createElement('div');
function escapeHtml(value) {
    htmlEscaper.textContent = value ?? '';
    return htmlEscaper.innerHTML;
}

function getActionCellHtml(row, itemId) {
    if (row.dataset.itemEditable !== 'true') {
        return '';
    }
    const canDelete = row.dataset.itemCanDelete === 'true';
    const deleteUrl = row.dataset.itemDeleteUrl || '';
    const confirmMessage = row.dataset.itemDeleteConfirm || '¿Eliminar este item?';
    const deleteButton = (canDelete && deleteUrl)
        ? `<form method="POST" action="${deleteUrl}"
                 style="display: inline;" onsubmit="return confirm(${JSON.stringify(confirmMessage)});">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="btn btn-sm btn-outline-danger">
                    <i class="fas fa-trash"></i>
                </button>
            </form>`
        : '';

    return `<td class="text-end">
        <div class="d-flex gap-2 justify-content-end">
            <button class="btn btn-outline-primary btn-sm" type="button" onclick="editarItem(${itemId})">
                <i class="fas fa-edit"></i>
            </button>
            ${deleteButton}
        </div>
    </td>`;
}

function renderItemDisplay(row) {
    const itemId = row.dataset.itemId;
    const tipo = (row.dataset.itemTipo || '').toLowerCase();
    const descripcion = escapeHtml(row.dataset.itemDescripcion || '');
    const unidad = escapeHtml(row.dataset.itemUnidad || (tipo === 'mano_obra' ? 'jornal' : ''));
    const currency = row.dataset.itemCurrency || resumenCurrency || 'ARS';
    const cantidad = parseDecimalString(row.dataset.itemCantidad, 0);
    const precio = parseDecimalString(row.dataset.itemPrecio, 0);
    const total = parseDecimalString(row.dataset.itemTotalCurrency, cantidad * precio);
    const precioArs = parseDecimalString(row.dataset.itemPrecioArs, NaN);
    const totalArs = parseDecimalString(row.dataset.itemTotalArs, NaN);
    const approxPrecioHtml = currency !== 'ARS' && Number.isFinite(precioArs)
        ? `<div class="small text-muted">≈ ${formatCurrencyValue(precioArs, 'ARS')}</div>`
        : '';
    const approxTotalHtml = currency !== 'ARS' && Number.isFinite(totalArs)
        ? `<div class="small text-muted">≈ ${formatCurrencyValue(totalArs, 'ARS')}</div>`
        : '';

    if (tipo === 'mano_obra') {
        const personas = parseInt(row.dataset.itemPersonas || '1', 10) || 1;
        const dias = parseDecimalString(row.dataset.itemDias, 1);
        const jornales = parseDecimalString(row.dataset.itemJornales, personas * dias);
        const cells = [
            `<td>${descripcion}</td>`,
            `<td class="text-center">${personas}</td>`,
            `<td class="text-center">${formatNumber(dias, 1)}</td>`,
            `<td class="text-end">${formatNumber(jornales, 1)}</td>`,
            `<td>${unidad}</td>`,
            `<td class="text-end">${formatCurrencyValue(precio, currency)}${approxPrecioHtml}</td>`,
            `<td class="text-end fw-bold">${formatCurrencyValue(total, currency)}</td>`
        ];
        // Add ARS column if presupuesto is in USD
        if (resumenCurrency === 'USD') {
            const arsCell = Number.isFinite(totalArs)
                ? `<td class="text-end fw-bold text-muted">${formatCurrencyValue(totalArs, 'ARS')}</td>`
                : `<td class="text-end fw-bold text-muted">-</td>`;
            cells.push(arsCell);
        }
        const actionCell = getActionCellHtml(row, itemId);
        row.innerHTML = cells.join('') + actionCell;
        return;
    }

    const quantityCell = `<td class="text-end">${formatNumber(cantidad, 2)}</td>`;
    const priceCell = `<td class="text-end">${formatCurrencyValue(precio, currency)}${approxPrecioHtml}</td>`;
    const totalCell = `<td class="text-end fw-bold">${formatCurrencyValue(total, currency)}</td>`;
    const cells = [
        `<td>${descripcion}</td>`,
        `<td>${unidad}</td>`,
        quantityCell,
        priceCell,
        totalCell
    ];
    // Add ARS column if presupuesto is in USD
    if (resumenCurrency === 'USD') {
        const arsCell = Number.isFinite(totalArs)
            ? `<td class="text-end fw-bold text-muted">${formatCurrencyValue(totalArs, 'ARS')}</td>`
            : `<td class="text-end fw-bold text-muted">-</td>`;
        cells.push(arsCell);
    }
    const actionCell = getActionCellHtml(row, itemId);
    row.innerHTML = cells.join('') + actionCell;
}

// Funciones para editar items del presupuesto
function editarItem(itemId) {
    const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
    if (!row) return;

    const tipo = (row.dataset.itemTipo || '').toLowerCase();
    const descripcion = row.dataset.itemDescripcion || '';
    const unidad = row.dataset.itemUnidad || (tipo === 'mano_obra' ? 'jornal' : '');
    const cantidad = parseDecimalString(row.dataset.itemCantidad, 0);
    const precioUnitario = parseDecimalString(row.dataset.itemPrecio, 0);
    const currency = row.dataset.itemCurrency || 'ARS';
    const personas = parseInt(row.dataset.itemPersonas || '1', 10) || 1;
    const dias = parseDecimalString(row.dataset.itemDias, 1);
    const jornales = parseDecimalString(row.dataset.itemJornales, personas * dias);

    if (tipo === 'mano_obra') {
        const totalEstimado = personas * dias * precioUnitario;
        row.innerHTML = `
            <td><input type="text" class="form-control form-control-sm" value="${escapeHtml(descripcion)}" id="edit-desc-${itemId}"></td>
            <td><input type="number" min="1" step="1" class="form-control form-control-sm text-center" value="${personas}" id="edit-personas-${itemId}" onchange="actualizarEdicionJornales(${itemId})"></td>
            <td><input type="number" min="0.5" step="0.1" class="form-control form-control-sm text-center" value="${dias.toFixed(1)}" id="edit-dias-${itemId}" onchange="actualizarEdicionJornales(${itemId})"></td>
            <td class="text-end"><span id="edit-jornales-${itemId}">${(personas * dias).toFixed(1)}</span></td>
            <td>${escapeHtml(unidad)}</td>
            <td>
                <div class="input-group input-group-sm">
                    <select class="form-select" id="edit-currency-${itemId}" style="max-width: 70px;">
                        <option value="ARS" ${currency === 'ARS' ? 'selected' : ''}>ARS</option>
                        <option value="USD" ${currency === 'USD' ? 'selected' : ''}>USD</option>
                    </select>
                    <input type="number" class="form-control text-end" value="${precioUnitario.toFixed(2)}" step="0.01" id="edit-precio-${itemId}" oninput="actualizarEdicionJornales(${itemId})">
                </div>
            </td>
            <td class="text-end"><span id="edit-total-${itemId}">${totalEstimado.toFixed(2)}</span></td>
            <td class="text-end">
                <div class="d-flex gap-2 justify-content-end">
                    <button class="btn btn-success btn-sm" onclick="guardarItem(${itemId})">
                        <i class="fas fa-save"></i>
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="cancelarEditarItem(${itemId})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </td>
        `;
        return;
    }

    const baseUnidades = ['unidad', 'm²', 'm³', 'kg', 'metros', 'litros', 'día', 'jornal'];
    const opciones = [];
    [unidad, ...baseUnidades].forEach((opt) => {
        if (opt && !opciones.includes(opt)) {
            opciones.push(opt);
        }
    });
    const opcionesHtml = opciones.map((opt) => `<option value="${escapeHtml(opt)}" ${opt === unidad ? 'selected' : ''}>${escapeHtml(opt)}</option>`).join('');
    const totalEstimado = cantidad * precioUnitario;
    row.innerHTML = `
        <td><input type="text" class="form-control form-control-sm" value="${escapeHtml(descripcion)}" id="edit-desc-${itemId}"></td>
        <td>
            <select class="form-select form-select-sm" id="edit-unidad-${itemId}">
                ${opcionesHtml}
            </select>
        </td>
        <td><input type="number" class="form-control form-control-sm text-end" value="${cantidad.toFixed(2)}" step="0.01" id="edit-cant-${itemId}" oninput="actualizarEdicionTotalSimple(${itemId})"></td>
        <td>
            <div class="input-group input-group-sm">
                <select class="form-select" id="edit-currency-${itemId}" style="max-width: 70px;">
                    <option value="ARS" ${currency === 'ARS' ? 'selected' : ''}>ARS</option>
                    <option value="USD" ${currency === 'USD' ? 'selected' : ''}>USD</option>
                </select>
                <input type="number" class="form-control text-end" value="${precioUnitario.toFixed(2)}" step="0.01" id="edit-precio-${itemId}" oninput="actualizarEdicionTotalSimple(${itemId})">
            </div>
        </td>
        <td class="text-end"><span id="edit-total-${itemId}">${totalEstimado.toFixed(2)}</span></td>
        <td class="text-end">
            <div class="d-flex gap-2 justify-content-end">
                <button class="btn btn-success btn-sm" onclick="guardarItem(${itemId})">
                    <i class="fas fa-save"></i>
                </button>
                <button class="btn btn-secondary btn-sm" onclick="cancelarEditarItem(${itemId})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </td>
    `;
}

function cancelarEditarItem(itemId) {
    const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
    if (!row) return;
    renderItemDisplay(row);
}

async function guardarItem(itemId) {
    const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
    if (!row) return;

    const tipo = (row.dataset.itemTipo || '').toLowerCase();
    const currencySelect = document.getElementById(`edit-currency-${itemId}`);
    const data = {
        descripcion: document.getElementById(`edit-desc-${itemId}`).value,
        precio_unitario: parseFloat(document.getElementById(`edit-precio-${itemId}`).value),
        currency: currencySelect ? currencySelect.value : 'ARS'
    };

    if (!Number.isFinite(data.precio_unitario)) {
        data.precio_unitario = 0;
    }

    if (tipo === 'mano_obra') {
        const personasInput = document.getElementById(`edit-personas-${itemId}`);
        const diasInput = document.getElementById(`edit-dias-${itemId}`);
        let personasVal = parseInt(personasInput.value, 10);
        if (!Number.isFinite(personasVal) || personasVal < 1) {
            personasVal = 1;
        }
        let diasVal = parseFloat(diasInput.value);
        if (!Number.isFinite(diasVal) || diasVal <= 0) {
            diasVal = 0.1;
        }
        const jornalesVal = personasVal * diasVal;
        data.personas = personasVal;
        data.dias = parseFloat(diasVal.toFixed(1));
        data.jornales = parseFloat(jornalesVal.toFixed(1));
        data.cantidad = data.jornales;
    } else {
        data.unidad = document.getElementById(`edit-unidad-${itemId}`).value;
        let cantidadVal = parseFloat(document.getElementById(`edit-cant-${itemId}`).value);
        if (!Number.isFinite(cantidadVal)) {
            cantidadVal = 0;
        }
        data.cantidad = cantidadVal;
    }

    try {
        // Obtener el token CSRF del meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

        // Agregar token CSRF al body de datos
        if (csrfToken) {
            data.csrf_token = csrfToken;
        }

        const headers = {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        };

        const response = await fetch(`/presupuestos/item/${itemId}/editar`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.exito) {
            row.dataset.itemDescripcion = data.descripcion || row.dataset.itemDescripcion || '';
            row.dataset.itemCurrency = data.currency || row.dataset.itemCurrency || 'ARS';
            if (tipo === 'mano_obra') {
                row.dataset.itemUnidad = row.dataset.itemUnidad || 'jornal';
                row.dataset.itemCantidad = data.cantidad;
                row.dataset.itemPrecio = data.precio_unitario;
                row.dataset.itemPersonas = data.personas;
                row.dataset.itemDias = data.dias;
                row.dataset.itemJornales = data.jornales;
            } else {
                row.dataset.itemUnidad = data.unidad;
                row.dataset.itemCantidad = data.cantidad;
                row.dataset.itemPrecio = data.precio_unitario;
            }

            if (typeof result.nuevo_total !== 'undefined') {
                row.dataset.itemTotalCurrency = result.nuevo_total;
            } else if (typeof data.cantidad !== 'undefined' && typeof data.precio_unitario !== 'undefined') {
                row.dataset.itemTotalCurrency = data.cantidad * data.precio_unitario;
            }

            // Update ARS values from backend response
            if (result.price_unit_ars !== null && result.price_unit_ars !== undefined) {
                row.dataset.itemPrecioArs = result.price_unit_ars;
            } else {
                row.dataset.itemPrecioArs = '';
            }

            if (result.total_ars !== null && result.total_ars !== undefined) {
                row.dataset.itemTotalArs = result.total_ars;
            } else {
                row.dataset.itemTotalArs = '';
            }

            renderItemDisplay(row);
            actualizarTotales(result);
            showAlert('Item actualizado correctamente', 'success');
        } else {
            showAlert(result.error || 'Error al actualizar el item', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error de conexión al actualizar el item', 'danger');
    }
}

function actualizarEdicionJornales(itemId) {
    const personasInput = document.getElementById(`edit-personas-${itemId}`);
    const diasInput = document.getElementById(`edit-dias-${itemId}`);
    const jornalesSpan = document.getElementById(`edit-jornales-${itemId}`);
    const precioInput = document.getElementById(`edit-precio-${itemId}`);
    const totalSpan = document.getElementById(`edit-total-${itemId}`);
    if (!personasInput || !diasInput || !jornalesSpan) {
        return;
    }
    let personasVal = parseInt(personasInput.value, 10);
    if (!Number.isFinite(personasVal) || personasVal < 1) {
        personasVal = 1;
    }
    let diasVal = parseFloat(diasInput.value);
    if (!Number.isFinite(diasVal) || diasVal <= 0) {
        diasVal = 0.1;
    }
    personasInput.value = personasVal;
    diasInput.value = diasVal.toFixed(1);
    jornalesSpan.textContent = (personasVal * diasVal).toFixed(1);
    if (precioInput && totalSpan) {
        const precioVal = parseFloat(precioInput.value) || 0;
        totalSpan.textContent = (personasVal * diasVal * precioVal).toFixed(2);
    }
}

function actualizarEdicionTotalSimple(itemId) {
    const cantidadInput = document.getElementById(`edit-cant-${itemId}`);
    const precioInput = document.getElementById(`edit-precio-${itemId}`);
    const totalSpan = document.getElementById(`edit-total-${itemId}`);
    if (!cantidadInput || !precioInput || !totalSpan) {
        return;
    }
    const cantidadVal = parseFloat(cantidadInput.value) || 0;
    const precioVal = parseFloat(precioInput.value) || 0;
    totalSpan.textContent = (cantidadVal * precioVal).toFixed(2);
}

function actualizarTotales(result) {
    if (!result) {
        return;
    }
    const currency = resumenCurrency || 'ARS';

    // Actualizar el resumen en el card superior
    const materialesEl = document.querySelector('.text-info.d-block');
    const manoObraEl = document.querySelector('.text-warning.d-block');
    const equiposEl = document.querySelector('.text-secondary.d-block');
    const sinIvaEl = document.querySelector('.text-primary.d-block');
    const totalEl = document.querySelector('.text-success.d-block.h5');

    if (materialesEl) materialesEl.textContent = formatCurrencyValue(result.subtotal_materiales, currency);
    if (manoObraEl) manoObraEl.textContent = formatCurrencyValue(result.subtotal_mano_obra, currency);
    if (equiposEl) equiposEl.textContent = formatCurrencyValue(result.subtotal_equipos, currency);
    if (sinIvaEl) sinIvaEl.textContent = formatCurrencyValue(result.total_sin_iva, currency);
    if (totalEl) totalEl.textContent = formatCurrencyValue(result.total_con_iva, currency);

    // Actualizar los subtotales en las tablas de Materiales, Mano de Obra y Equipos
    // Seleccionamos el segundo <th> de cada fila, que es donde está el valor del subtotal
    const materialesFooter = document.querySelector('.table-info th.text-end:nth-of-type(2)');
    if (materialesFooter) materialesFooter.textContent = formatCurrencyValue(result.subtotal_materiales, currency);

    const manoObraFooter = document.querySelector('.table-warning th.text-end:nth-of-type(2)');
    if (manoObraFooter) manoObraFooter.textContent = formatCurrencyValue(result.subtotal_mano_obra, currency);

    const equiposFooter = document.querySelector('.table-secondary th.text-end:nth-of-type(2)');
    if (equiposFooter) equiposFooter.textContent = formatCurrencyValue(result.subtotal_equipos, currency);
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

async function descargarPDF(presupuestoId, numero) {
    const btn = event.currentTarget;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generando...';
    btn.disabled = true;

    try {
        const response = await fetch(`/presupuestos/${presupuestoId}/pdf`);
        if (!response.ok) {
            throw new Error('Error al generar el PDF');
        }
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `presupuesto_${numero}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
    } catch (error) {
        console.error('Error descargando PDF:', error);
        alert('Error al descargar el PDF. Intente nuevamente.');
    } finally {
        btn.innerHTML = originalHTML;
        btn.disabled = false;
    }
}

async function enviarPorCorreo(presupuestoId) {
    // Solicitar email del destinatario
    const email = prompt('Ingrese el email del destinatario:');
    if (!email) return;

    // Validar email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        alert('Por favor ingrese un email válido');
        return;
    }

    try {
        const response = await fetch(`/presupuestos/${presupuestoId}/enviar-email`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrf_token]').value
            },
            body: JSON.stringify({ email: email })
        });

        const result = await response.json();

        if (response.ok && result.success) {
            alert(`✅ Presupuesto enviado exitosamente a ${email}`);
        } else {
            alert(`❌ Error: ${result.error || 'No se pudo enviar el correo'}`);
        }
    } catch (error) {
        alert('❌ Error de conexión. Intenta nuevamente.');
    }
}
</script>
{% endblock %}
