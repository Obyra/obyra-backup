{% extends "base.html" %}

{% block title %}Fichar - {{ obra.nombre }}{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <!-- Header -->
    <div class="row mb-3">
        <div class="col-12">
            <a href="{{ url_for('fichadas.index') }}" class="btn btn-sm btn-outline-secondary mb-2">
                <i class="fas fa-arrow-left me-1"></i>Volver
            </a>
            <h5 class="mb-1"><i class="fas fa-building me-2"></i>{{ obra.nombre }}</h5>
            <p class="text-muted small mb-0">
                <i class="fas fa-map-marker-alt me-1"></i>{{ obra.direccion or 'Sin dirección' }}
            </p>
        </div>
    </div>

    <!-- Mapa -->
    <div class="row mb-3">
        <div class="col-12">
            <div id="mapaFichada" style="height: 250px; width: 100%; border-radius: 12px; border: 2px solid #dee2e6;"></div>
        </div>
    </div>

    <!-- Estado de ubicación -->
    <div class="row mb-3">
        <div class="col-12">
            <div id="estadoUbicacion" class="alert alert-info text-center">
                <i class="fas fa-spinner fa-spin me-2"></i>Obteniendo tu ubicación...
            </div>
        </div>
    </div>

    <!-- Botón de fichada -->
    <div class="row mb-3">
        <div class="col-12">
            <button id="btnFichar"
                    class="btn btn-{{ 'danger' if proximo_tipo == 'egreso' else 'success' }} btn-lg w-100 py-4"
                    style="font-size: 1.4rem; border-radius: 16px;"
                    onclick="registrarFichada()"
                    disabled>
                <i class="fas fa-{{ 'sign-out-alt' if proximo_tipo == 'egreso' else 'sign-in-alt' }} me-2"></i>
                FICHAR {{ proximo_tipo|upper }}
            </button>
        </div>
    </div>

    <!-- Fichadas del día -->
    {% if fichadas_del_dia %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-clock me-1"></i>Fichadas de hoy</h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm mb-0">
                        <tbody>
                            {% for f in fichadas_del_dia %}
                            <tr>
                                <td class="ps-3">
                                    <i class="fas fa-{{ 'sign-in-alt text-success' if f.tipo == 'ingreso' else 'sign-out-alt text-danger' }} me-1"></i>
                                    {{ f.tipo|capitalize }}
                                </td>
                                <td>{{ f.fecha_hora.strftime('%H:%M:%S') }}</td>
                                <td>
                                    {% if f.distancia_obra is not none %}
                                    {{ f.distancia_obra|round(0)|int }} m
                                    {% endif %}
                                </td>
                                <td>
                                    {% if f.dentro_rango %}
                                    <span class="badge bg-success"><i class="fas fa-check"></i></span>
                                    {% else %}
                                    <span class="badge bg-warning text-dark"><i class="fas fa-exclamation-triangle"></i></span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
.leaflet-container { border-radius: 12px; }
</style>
<script>
const OBRA_LAT = {{ obra.latitud|float if obra.latitud else 'null' }};
const OBRA_LNG = {{ obra.longitud|float if obra.longitud else 'null' }};
const OBRA_ID = {{ obra.id }};
const OBRA_RADIO = {{ obra.radio_fichada_metros or 200 }};
const PROXIMO_TIPO = '{{ proximo_tipo }}';
const ES_ADMIN = {{ 'true' if es_admin else 'false' }};

let miLat = null, miLng = null, miPrecision = null;
let mapa = null, marcadorObra = null, marcadorMio = null, circuloRadio = null;

// Inicializar mapa
document.addEventListener('DOMContentLoaded', function() {
    const centro = OBRA_LAT ? [OBRA_LAT, OBRA_LNG] : [-34.6037, -58.3816];
    mapa = L.map('mapaFichada', { zoomControl: true }).setView(centro, 16);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap, &copy; CARTO',
        maxZoom: 20, subdomains: 'abcd'
    }).addTo(mapa);

    // Fix de renderizado: forzar recalcular tamaño del mapa
    setTimeout(function() { mapa.invalidateSize(); }, 200);

    if (OBRA_LAT) {
        // Marcador de la obra (rojo)
        const iconObra = L.divIcon({
            html: '<i class="fas fa-building" style="color:#dc3545;font-size:24px;"></i>',
            iconSize: [24, 24], iconAnchor: [12, 24], className: ''
        });
        marcadorObra = L.marker([OBRA_LAT, OBRA_LNG], { icon: iconObra })
            .addTo(mapa)
            .bindPopup('<b>{{ obra.nombre }}</b>');

        // Círculo de radio permitido
        circuloRadio = L.circle([OBRA_LAT, OBRA_LNG], {
            radius: OBRA_RADIO,
            color: '#0d6efd', fillColor: '#0d6efd', fillOpacity: 0.1,
            weight: 2, dashArray: '5,5'
        }).addTo(mapa);
    }

    // Obtener ubicación del usuario
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(onPosicion, onErrorGPS, {
            enableHighAccuracy: true, timeout: 15000, maximumAge: 5000
        });
    } else {
        actualizarEstado('error', 'Tu navegador no soporta geolocalización');
    }
});

function onPosicion(pos) {
    miLat = pos.coords.latitude;
    miLng = pos.coords.longitude;
    miPrecision = pos.coords.accuracy;

    // Marcador del usuario (azul)
    const iconMio = L.divIcon({
        html: '<i class="fas fa-user-circle" style="color:#0d6efd;font-size:22px;"></i>',
        iconSize: [22, 22], iconAnchor: [11, 22], className: ''
    });

    if (marcadorMio) {
        marcadorMio.setLatLng([miLat, miLng]);
    } else {
        marcadorMio = L.marker([miLat, miLng], { icon: iconMio })
            .addTo(mapa).bindPopup('Tu ubicación');
    }

    // Ajustar vista para ver ambos marcadores
    if (OBRA_LAT && marcadorObra) {
        const bounds = L.latLngBounds([
            [OBRA_LAT, OBRA_LNG], [miLat, miLng]
        ]);
        mapa.fitBounds(bounds.pad(0.3));
    }

    // Calcular distancia y habilitar/deshabilitar botón
    const btn = document.getElementById('btnFichar');
    if (OBRA_LAT) {
        const dist = calcularDistancia(miLat, miLng, OBRA_LAT, OBRA_LNG);
        const dentro = dist <= OBRA_RADIO;

        if (dentro) {
            actualizarEstado('ok', `Estás a ${Math.round(dist)}m de la obra (dentro del rango de ${OBRA_RADIO}m)`);
            btn.disabled = false;
        } else if (ES_ADMIN) {
            actualizarEstado('warning', `Estás a ${Math.round(dist)}m de la obra (fuera del rango de ${OBRA_RADIO}m). Como admin podés fichar igualmente.`);
            btn.disabled = false;
        } else {
            actualizarEstado('warning', `Estás a ${Math.round(dist)}m de la obra. Necesitás estar dentro de ${OBRA_RADIO}m para fichar.`);
            btn.disabled = true;
        }
    } else {
        actualizarEstado('error', 'La obra no tiene coordenadas configuradas. Contactá al administrador.');
        btn.disabled = true;
    }
}

function onErrorGPS(err) {
    let msg = 'No se pudo obtener tu ubicación';
    if (err.code === 1) msg = 'Permiso de ubicación denegado. Habilitalo en la configuración del navegador.';
    else if (err.code === 2) msg = 'Ubicación no disponible';
    else if (err.code === 3) msg = 'Tiempo agotado obteniendo ubicación';
    actualizarEstado('error', msg);
    document.getElementById('btnFichar').disabled = true;
}

function actualizarEstado(tipo, mensaje) {
    const div = document.getElementById('estadoUbicacion');
    div.className = 'alert text-center';
    if (tipo === 'ok') {
        div.className += ' alert-success';
        div.innerHTML = `<i class="fas fa-check-circle me-2"></i>${mensaje}`;
    } else if (tipo === 'warning') {
        div.className += ' alert-warning';
        div.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${mensaje}`;
    } else {
        div.className += ' alert-danger';
        div.innerHTML = `<i class="fas fa-times-circle me-2"></i>${mensaje}`;
    }
}

function calcularDistancia(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const rad = Math.PI / 180;
    const dLat = (lat2 - lat1) * rad;
    const dLon = (lon2 - lon1) * rad;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*rad) * Math.cos(lat2*rad) * Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

async function registrarFichada() {
    const btn = document.getElementById('btnFichar');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Registrando...';

    try {
        const resp = await fetch('/fichadas/api/fichar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                obra_id: OBRA_ID,
                tipo: PROXIMO_TIPO,
                latitud: miLat,
                longitud: miLng,
                precision_gps: miPrecision
            })
        });
        const data = await resp.json();

        if (data.ok) {
            const f = data.fichada;
            let msg = `${PROXIMO_TIPO.toUpperCase()} registrado a las ${f.fecha_hora}`;
            if (f.distancia_metros !== null) {
                msg += ` (${f.distancia_metros}m de la obra)`;
            }
            if (f.dentro_rango) {
                actualizarEstado('ok', msg);
            } else {
                actualizarEstado('warning', msg + ' - FUERA DE RANGO');
            }
            // Recargar después de 2 segundos
            setTimeout(() => { window.location.reload(); }, 2000);
        } else {
            actualizarEstado('error', data.error || 'Error al registrar fichada');
            btn.disabled = false;
            btn.innerHTML = `<i class="fas fa-${PROXIMO_TIPO === 'egreso' ? 'sign-out-alt' : 'sign-in-alt'} me-2"></i>FICHAR ${PROXIMO_TIPO.toUpperCase()}`;
        }
    } catch (err) {
        actualizarEstado('error', 'Error de conexión: ' + err.message);
        btn.disabled = false;
        btn.innerHTML = `<i class="fas fa-${PROXIMO_TIPO === 'egreso' ? 'sign-out-alt' : 'sign-in-alt'} me-2"></i>FICHAR ${PROXIMO_TIPO.toUpperCase()}`;
    }
}
</script>
{% endblock %}
