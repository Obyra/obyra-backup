{% extends "base.html" %}

{% block title %}Nuevo Requerimiento de Compra - OBYRA{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('requerimientos.lista') }}">Requerimientos</a></li>
                    <li class="breadcrumb-item active">Nuevo</li>
                </ol>
            </nav>
            <h2><i class="fas fa-plus text-primary me-2"></i>Nuevo Requerimiento de Compra</h2>
            <p class="text-muted">Solicita materiales o equipos que faltan en la obra</p>
        </div>
    </div>

    <form method="POST" id="formRequerimiento">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="items_json" id="itemsJson" value="[]">

        <div class="row">
            <!-- Columna izquierda: Datos del requerimiento -->
            <div class="col-lg-5">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Datos del Requerimiento</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="obra_id" class="form-label fw-bold">Obra *</label>
                            <select class="form-select" id="obra_id" name="obra_id" required onchange="cargarMaterialesObra()">
                                <option value="">Seleccionar obra...</option>
                                {% for obra in obras %}
                                <option value="{{ obra.id }}" {% if obra_seleccionada and obra.id == obra_seleccionada.id %}selected{% endif %}>
                                    {{ obra.nombre }} - {{ obra.cliente }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="motivo" class="form-label fw-bold">Motivo de la solicitud *</label>
                            <textarea class="form-control" id="motivo" name="motivo" rows="3" required
                                      placeholder="Ej: Se necesita material adicional para completar etapa de pintura..."></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="prioridad" class="form-label fw-bold">Prioridad</label>
                                <select class="form-select" id="prioridad" name="prioridad">
                                    <option value="baja">Baja</option>
                                    <option value="normal" selected>Normal</option>
                                    <option value="alta">Alta</option>
                                    <option value="urgente">Urgente</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="fecha_necesidad" class="form-label fw-bold">Fecha necesidad</label>
                                <input type="date" class="form-control" id="fecha_necesidad" name="fecha_necesidad">
                                <div class="form-text">Cuando se necesita el material</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Materiales con deficit (si hay obra seleccionada) -->
                <div class="card mb-4" id="cardMaterialesObra" style="{% if not obra_seleccionada %}display: none;{% endif %}">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Materiales con Deficit</h6>
                    </div>
                    <div class="card-body p-0">
                        <div id="listaMaterialesObra" class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                            {% if materiales_obra %}
                                {% for mat in materiales_obra %}
                                    {% if mat.deficit > 0 %}
                                    <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                            onclick="agregarMaterialDesdeObra({{ mat|tojson|safe }})">
                                        <div>
                                            <strong>{{ mat.descripcion }}</strong>
                                            <small class="text-muted d-block">{{ mat.codigo }}</small>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-danger">Falta: {{ mat.deficit }} {{ mat.unidad }}</span>
                                            <small class="text-muted d-block">Plan: {{ mat.cantidad_planificada }} | Obra: {{ mat.cantidad_actual_obra }}</small>
                                        </div>
                                    </button>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                            <div class="text-center text-muted py-3">
                                Selecciona una obra para ver materiales con deficit
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna derecha: Items del requerimiento -->
            <div class="col-lg-7">
                <div class="card">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Items a Solicitar</h5>
                        <button type="button" class="btn btn-light btn-sm" onclick="mostrarModalAgregarItem()">
                            <i class="fas fa-plus me-1"></i>Agregar Item
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div id="listaItems" class="list-group list-group-flush">
                            <div class="text-center text-muted py-4" id="sinItems">
                                <i class="fas fa-box-open fa-2x mb-2"></i>
                                <p class="mb-0">No hay items agregados</p>
                                <small>Haz clic en "Agregar Item" o selecciona materiales con deficit</small>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Total items: <strong id="totalItems">0</strong></span>
                            <span>Costo estimado: <strong id="costoEstimado">$0.00</strong></span>
                        </div>
                    </div>
                </div>

                <div class="mt-4 d-flex gap-2">
                    <button type="submit" class="btn btn-primary btn-lg" id="btnEnviar" disabled>
                        <i class="fas fa-paper-plane me-1"></i>Enviar Requerimiento
                    </button>
                    <a href="{{ url_for('requerimientos.lista') }}" class="btn btn-outline-secondary btn-lg">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Modal agregar item -->
<div class="modal fade" id="modalAgregarItem" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Agregar Item</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Seleccionar del Inventario</label>
                    <select class="form-select" id="itemInventarioSelect" onchange="autocompletarItem()">
                        <option value="">-- Escribir manualmente --</option>
                        {% for item in items_inventario %}
                        <option value="{{ item.id }}"
                                data-nombre="{{ item.nombre }}"
                                data-codigo="{{ item.codigo }}"
                                data-unidad="{{ item.unidad or 'unidad' }}"
                                data-precio="{{ item.precio_promedio or 0 }}">
                            [{{ item.codigo }}] {{ item.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label for="itemDescripcion" class="form-label fw-bold">Descripcion *</label>
                    <input type="text" class="form-control" id="itemDescripcion" required
                           placeholder="Ej: Pintura latex interior blanco">
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="itemCantidad" class="form-label fw-bold">Cantidad *</label>
                        <input type="number" class="form-control" id="itemCantidad"
                               step="0.01" min="0.01" value="1" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="itemUnidad" class="form-label fw-bold">Unidad</label>
                        <select class="form-select" id="itemUnidad">
                            <option value="unidad">Unidad</option>
                            <option value="kg">Kg</option>
                            <option value="lts">Litros</option>
                            <option value="m2">m2</option>
                            <option value="m3">m3</option>
                            <option value="ml">Metros</option>
                            <option value="bolsa">Bolsa</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="itemTipo" class="form-label fw-bold">Tipo</label>
                        <select class="form-select" id="itemTipo">
                            <option value="material">Material</option>
                            <option value="maquinaria">Maquinaria</option>
                            <option value="herramienta">Herramienta</option>
                            <option value="equipo">Equipo</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="itemCosto" class="form-label">Costo estimado unitario (opcional)</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" id="itemCosto" step="0.01" min="0">
                    </div>
                </div>

                <div class="mb-3">
                    <label for="itemNotas" class="form-label">Notas</label>
                    <textarea class="form-control" id="itemNotas" rows="2"
                              placeholder="Especificaciones adicionales..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="agregarItem()">
                    <i class="fas fa-plus me-1"></i>Agregar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let items = [];
let itemIdCounter = 0;

function cargarMaterialesObra() {
    const obraId = document.getElementById('obra_id').value;
    const card = document.getElementById('cardMaterialesObra');
    const lista = document.getElementById('listaMaterialesObra');

    if (!obraId) {
        card.style.display = 'none';
        return;
    }

    card.style.display = 'block';
    lista.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Cargando...</div>';

    fetch(`/requerimientos/api/materiales-obra/${obraId}`)
        .then(resp => resp.json())
        .then(data => {
            if (data.ok && data.materiales) {
                const conDeficit = data.materiales.filter(m => m.deficit > 0);
                if (conDeficit.length === 0) {
                    lista.innerHTML = '<div class="text-center text-muted py-3">No hay materiales con deficit</div>';
                    return;
                }

                lista.innerHTML = conDeficit.map(mat => `
                    <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                            onclick='agregarMaterialDesdeObra(${JSON.stringify(mat)})'>
                        <div>
                            <strong>${mat.descripcion}</strong>
                            <small class="text-muted d-block">${mat.codigo || '-'}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-danger">Falta: ${mat.deficit.toFixed(2)} ${mat.unidad}</span>
                            <small class="text-muted d-block">Plan: ${mat.cantidad_planificada} | Obra: ${mat.cantidad_actual_obra}</small>
                        </div>
                    </button>
                `).join('');
            } else {
                lista.innerHTML = '<div class="text-center text-muted py-3">Error al cargar materiales</div>';
            }
        })
        .catch(err => {
            console.error(err);
            lista.innerHTML = '<div class="text-center text-danger py-3">Error de conexion</div>';
        });
}

function agregarMaterialDesdeObra(mat) {
    // Verificar si ya existe
    const existe = items.find(i => i.item_inventario_id === mat.item_inventario_id && mat.item_inventario_id);
    if (existe) {
        alert('Este material ya fue agregado al requerimiento');
        return;
    }

    const item = {
        id: ++itemIdCounter,
        item_inventario_id: mat.item_inventario_id,
        descripcion: mat.descripcion,
        codigo: mat.codigo || '',
        cantidad: mat.deficit,
        unidad: mat.unidad,
        cantidad_planificada: mat.cantidad_planificada,
        cantidad_actual_obra: mat.cantidad_actual_obra,
        costo_estimado: null,
        notas: '',
        tipo: mat.tipo || 'material'
    };

    items.push(item);
    renderItems();
}

function mostrarModalAgregarItem() {
    // Limpiar formulario
    document.getElementById('itemInventarioSelect').value = '';
    document.getElementById('itemDescripcion').value = '';
    document.getElementById('itemCantidad').value = '1';
    document.getElementById('itemUnidad').value = 'unidad';
    document.getElementById('itemTipo').value = 'material';
    document.getElementById('itemCosto').value = '';
    document.getElementById('itemNotas').value = '';

    const modal = new bootstrap.Modal(document.getElementById('modalAgregarItem'));
    modal.show();
}

function autocompletarItem() {
    const select = document.getElementById('itemInventarioSelect');
    const option = select.options[select.selectedIndex];

    if (select.value) {
        document.getElementById('itemDescripcion').value = option.dataset.nombre || '';
        document.getElementById('itemUnidad').value = option.dataset.unidad || 'unidad';
        const precio = parseFloat(option.dataset.precio || 0);
        if (precio > 0) {
            document.getElementById('itemCosto').value = precio;
        }
    }
}

function agregarItem() {
    const descripcion = document.getElementById('itemDescripcion').value.trim();
    const cantidad = parseFloat(document.getElementById('itemCantidad').value);

    if (!descripcion) {
        alert('Ingrese una descripcion');
        return;
    }
    if (!cantidad || cantidad <= 0) {
        alert('Ingrese una cantidad valida');
        return;
    }

    const selectInv = document.getElementById('itemInventarioSelect');
    const itemInventarioId = selectInv.value ? parseInt(selectInv.value) : null;

    const item = {
        id: ++itemIdCounter,
        item_inventario_id: itemInventarioId,
        descripcion: descripcion,
        codigo: '',
        cantidad: cantidad,
        unidad: document.getElementById('itemUnidad').value,
        cantidad_planificada: 0,
        cantidad_actual_obra: 0,
        costo_estimado: parseFloat(document.getElementById('itemCosto').value) || null,
        notas: document.getElementById('itemNotas').value.trim(),
        tipo: document.getElementById('itemTipo').value
    };

    items.push(item);
    renderItems();

    // Cerrar modal
    bootstrap.Modal.getInstance(document.getElementById('modalAgregarItem')).hide();
}

function eliminarItem(itemId) {
    items = items.filter(i => i.id !== itemId);
    renderItems();
}

function renderItems() {
    const lista = document.getElementById('listaItems');
    const sinItems = document.getElementById('sinItems');

    if (items.length === 0) {
        lista.innerHTML = '';
        lista.appendChild(sinItems);
        sinItems.style.display = 'block';
    } else {
        sinItems.style.display = 'none';
        lista.innerHTML = items.map(item => `
            <div class="list-group-item d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${item.descripcion}</h6>
                        <span class="badge bg-primary">${item.cantidad} ${item.unidad}</span>
                    </div>
                    <small class="text-muted">
                        <span class="badge bg-secondary me-1">${item.tipo}</span>
                        ${item.codigo ? `<span class="me-2">Cod: ${item.codigo}</span>` : ''}
                        ${item.costo_estimado ? `<span class="text-success">$${item.costo_estimado.toFixed(2)} c/u</span>` : ''}
                    </small>
                    ${item.notas ? `<p class="mb-0 mt-1 small text-muted">${item.notas}</p>` : ''}
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="eliminarItem(${item.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `).join('');
    }

    actualizarTotales();
    actualizarJson();
}

function actualizarTotales() {
    document.getElementById('totalItems').textContent = items.length;

    const costoTotal = items.reduce((sum, item) => {
        if (item.costo_estimado) {
            return sum + (item.costo_estimado * item.cantidad);
        }
        return sum;
    }, 0);

    document.getElementById('costoEstimado').textContent = '$' + costoTotal.toLocaleString('es-AR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });

    // Habilitar/deshabilitar boton
    document.getElementById('btnEnviar').disabled = items.length === 0;
}

function actualizarJson() {
    document.getElementById('itemsJson').value = JSON.stringify(items);
}

// Inicializar si hay obra seleccionada
document.addEventListener('DOMContentLoaded', () => {
    const obraId = document.getElementById('obra_id').value;
    if (obraId) {
        cargarMaterialesObra();
    }
});
</script>
{% endblock %}
