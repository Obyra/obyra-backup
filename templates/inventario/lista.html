{% extends "base.html" %}

{% block title %}Inventario - OBYRA IA{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-boxes me-2"></i>Gestión de Inventario</h2>
                <div>
                    <a href="{{ url_for('inventario.alertas_stock') }}" class="btn btn-warning me-2" id="btnAlertasStock">
                        <i class="fas fa-exclamation-triangle me-1"></i>Alertas
                        <span class="badge bg-danger ms-1" id="badgeAlertas" style="display:none;">0</span>
                    </a>
                    <a href="{{ url_for('inventario.analisis') }}" class="btn btn-success me-2">
                        <i class="fas fa-chart-line me-1"></i>Análisis y Reportes
                    </a>
                    {% if current_user.rol in ['administrador', 'tecnico'] %}
                    <a href="{{ url_for('inventario.uso_obra') }}" class="btn btn-primary me-2">
                        <i class="fas fa-shopping-cart me-1"></i>Compras
                    </a>
                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalGestionCategorias">
                        <i class="fas fa-tags me-1"></i>Categorías
                    </button>
                    {% endif %}
                    {% if current_user.rol == 'administrador' %}
                    <a href="{{ url_for('inventario.categorias') }}" class="btn btn-outline-secondary ms-1">
                        <i class="fas fa-cog me-1"></i>Gestión Global
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-4">
                    <label for="categoria" class="form-label">Categoría</label>
                    <select class="form-select" id="categoria" name="categoria">
                        <option value="">Todas las categorías</option>
                        {% if categorias_nuevas %}
                            {% for categoria in categorias_nuevas %}
                            <option value="{{ categoria.id }}" {{ 'selected' if categoria_id == categoria.id }}>
                                {{ categoria.nombre }}
                            </option>
                            {% endfor %}
                        {% endif %}
                        {% for categoria in categorias %}
                        <option value="{{ categoria.id }}" {{ 'selected' if categoria_id == categoria.id }}>
                            {{ categoria.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-5">
                    <label for="buscar" class="form-label">Buscar</label>
                    <input type="text" class="form-control" id="buscar" name="buscar"
                           value="{{ buscar }}" placeholder="Buscar por código, nombre o descripción (ej: cemento, MAT, arena)...">
                    <div class="form-text text-muted">
                        <i class="fas fa-info-circle me-1"></i>Busca coincidencias parciales en cualquier parte del texto
                    </div>
                </div>
                <div class="col-md-3 d-flex align-items-end flex-wrap gap-2">
                    <div class="form-check me-2">
                        <input class="form-check-input" type="checkbox" id="con_stock" name="con_stock" value="1"
                               {{ 'checked' if con_stock }}>
                        <label class="form-check-label" for="con_stock">
                            Solo con stock
                        </label>
                    </div>
                    <div class="form-check me-2">
                        <input class="form-check-input" type="checkbox" id="stock_bajo" name="stock_bajo" value="1"
                               {{ 'checked' if stock_bajo }}>
                        <label class="form-check-label" for="stock_bajo">
                            Stock bajo
                        </label>
                    </div>
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="fas fa-search me-1"></i>Filtrar
                    </button>
                    <a href="{{ url_for('inventario.lista') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i>Limpiar
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Botón volver cuando hay filtro activo -->
    {% if categoria_id or buscar or con_stock or stock_bajo %}
    <div class="mb-3">
        <a href="{{ url_for('inventario.lista') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Volver a todas las categorías
        </a>
    </div>
    {% endif %}

    <!-- Vista de Carpetas por Etapa (solo cuando no hay filtros activos) -->
    {% if arbol_categorias and not buscar and not categoria_id and not con_stock and not stock_bajo %}
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center py-3">
            <h5 class="mb-0"><i class="fas fa-hard-hat me-2"></i>Etapas de Construcción</h5>
            <div>
                <span class="badge bg-light text-primary me-2">{{ arbol_categorias|length }} etapas</span>
                <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#vistaTabla" aria-expanded="false">
                    <i class="fas fa-table me-1"></i>Ver tabla completa
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="accordion" id="acordeonEtapas">
                {% for etapa in arbol_categorias %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading-{{ etapa.id }}">
                        <button class="accordion-button collapsed py-3" type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#collapse-{{ etapa.id }}"
                                aria-expanded="false"
                                aria-controls="collapse-{{ etapa.id }}">
                            <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                <div>
                                    <i class="fas fa-folder text-warning me-2"></i>
                                    <strong>{{ etapa.nombre }}</strong>
                                </div>
                                <span class="badge bg-primary rounded-pill">{{ etapa.total_items }} artículos</span>
                            </div>
                        </button>
                    </h2>
                    <div id="collapse-{{ etapa.id }}" class="accordion-collapse collapse"
                         aria-labelledby="heading-{{ etapa.id }}"
                         data-bs-parent="#acordeonEtapas">
                        <div class="accordion-body p-0">
                            <!-- Subcategorías como lista -->
                            <div class="list-group list-group-flush">
                                {% for subcat in etapa.subcategorias %}
                                {% if subcat.items_count > 0 %}
                                <a href="{{ url_for('inventario.lista', categoria=subcat.id) }}"
                                   class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3 ps-5">
                                    <span>
                                        <i class="fas fa-box text-secondary me-2"></i>
                                        {{ subcat.nombre }}
                                    </span>
                                    <span class="badge bg-secondary rounded-pill">{{ subcat.items_count }}</span>
                                </a>
                                {% endif %}
                                {% endfor %}
                            </div>
                            <!-- Botón ver todos -->
                            <div class="p-3 bg-light border-top">
                                <a href="{{ url_for('inventario.lista', categoria=etapa.id) }}" class="btn btn-primary w-100">
                                    <i class="fas fa-list me-2"></i>Ver todos los artículos de {{ etapa.nombre }}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Tabla de items -->
    <div class="row {% if arbol_categorias and not buscar and not categoria_id %}collapse{% endif %}" id="vistaTabla">
        <div class="col-12">
            {% if items_con_obras %}
            <div class="">
                <table class="table table-hover table-striped align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>Código</th>
                            <th>Nombre</th>
                            <th>Categoría</th>
                            <th class="text-center">Stock<br><small class="fw-normal">(disponible)</small></th>
                            <th class="text-center">Ubicación<br><small class="fw-normal">(depósito/obra)</small></th>
                            <th class="text-center">Stock Mínimo</th>
                            <th class="text-center" style="width: 150px;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item_data in items_con_obras %}
                        {% set item = item_data.item %}
                        {% set obras = item_data.obras %}
                        {% set reservas = item_data.reservas or [] %}
                        {% set stock_reservado = item_data.stock_reservado or 0 %}
                        {% set stock_fisico_inicial = item_data.stock_fisico_inicial or 0 %}
                        {% set traslados_obras = item_data.traslados_obras or [] %}
                        {% set total_trasladado = item_data.total_trasladado or 0 %}
                        {% set ubicaciones_stock = item_data.ubicaciones_stock or [] %}
                        <tr class="{{ 'table-warning' if item.necesita_reposicion }}" id="item-row-{{ item.id }}">
                            <td>
                                <strong>{{ item.codigo }}</strong>
                                {% if item.necesita_reposicion %}
                                <i class="fas fa-exclamation-triangle text-warning ms-1" title="Necesita reposición"></i>
                                {% endif %}
                            </td>
                            <td>
                                <div>{{ item.nombre }}</div>
                                {% if item.descripcion %}
                                <small class="text-muted">{{ item.descripcion[:60] }}{% if item.descripcion|length > 60 %}...{% endif %}</small>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ item.categoria.nombre if item.categoria else 'Sin categoría' }}</span>
                            </td>
                            <td class="text-center">
                                <strong class="{{ 'text-danger' if item.necesita_reposicion else 'text-success' }}">
                                    {{ item.stock_actual|numero(2) }}
                                </strong>
                                {% if stock_reservado > 0 %}
                                <br>
                                <span class="badge bg-info" title="Stock reservado para obras">
                                    <i class="fas fa-lock me-1"></i>{{ stock_reservado|numero(2) }} reservado
                                </span>
                                {% endif %}
                                <br>
                                <small class="text-muted">{{ item.unidad }}</small>
                            </td>
                            <td class="text-center">
                                {% if ubicaciones_stock %}
                                <div class="d-flex flex-column gap-1">
                                    {% for ub in ubicaciones_stock %}
                                    {% if ub.location_tipo == 'WAREHOUSE' %}
                                    <span class="badge bg-secondary text-light"
                                          title="Stock en {{ ub.location_nombre }}">
                                        {{ ub.location_icono }} {{ ub.cantidad|numero(2) }} - {{ ub.location_nombre[:15] }}{% if ub.location_nombre|length > 15 %}...{% endif %}
                                    </span>
                                    {% else %}
                                    <a href="{{ url_for('obras.detalle', id=ub.obra_id) if ub.obra_id else '#' }}"
                                       class="badge bg-warning text-dark text-decoration-none"
                                       title="Stock en obra {{ ub.location_nombre }}">
                                        {{ ub.location_icono }} {{ ub.cantidad|numero(2) }} - {{ ub.location_nombre[:15] }}{% if ub.location_nombre|length > 15 %}...{% endif %}
                                    </a>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                                {% elif traslados_obras %}
                                <!-- Fallback a sistema legacy -->
                                <div class="d-flex flex-column gap-1">
                                    {% for traslado in traslados_obras %}
                                    <a href="{{ url_for('obras.detalle', id=traslado.obra_id) }}"
                                       class="badge bg-warning text-dark text-decoration-none"
                                       title="Stock en {{ traslado.obra_nombre }}">
                                        <i class="fas fa-hard-hat me-1"></i>{{ traslado.cantidad|numero(2) }} - {{ traslado.obra_nombre[:15] }}{% if traslado.obra_nombre|length > 15 %}...{% endif %}
                                    </a>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <span class="text-muted">Sin asignar</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <strong class="text-warning">{{ item.stock_minimo|numero(2) }}</strong>
                            </td>
                            <td class="text-center">
                                <div class="d-flex justify-content-center gap-1 flex-wrap">
                                    <a href="{{ url_for('inventario.detalle', id=item.id) }}"
                                       class="btn btn-outline-primary btn-sm"
                                       title="Ver detalles">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if current_user.rol in ['administrador', 'tecnico'] %}
                                    <button type="button" class="btn btn-outline-secondary btn-sm"
                                            title="Acciones"
                                            onclick="abrirModalAcciones('{{ item.id }}', '{{ item.nombre }}', '{{ item.codigo }}', {{ item.stock_actual|float }})">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="fas fa-boxes fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No hay items de inventario</h4>
                    <p class="text-muted">
                        {% if current_user.rol in ['administrador', 'tecnico'] %}
                            Comienza registrando una compra para agregar items al inventario.
                        {% else %}
                            No hay items disponibles para visualizar.
                        {% endif %}
                    </p>
                    {% if current_user.rol in ['administrador', 'tecnico'] %}
                    <a href="{{ url_for('inventario.uso_obra') }}" class="btn btn-primary">
                        <i class="fas fa-shopping-cart me-1"></i>Ir a Compras
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Paginación -->
            {% if pagination and pagination.pages > 1 %}
            <nav aria-label="Navegación de inventario" class="mt-4">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <div class="text-muted">
                        Mostrando {{ ((page - 1) * per_page) + 1 }} - {{ [page * per_page, total_items]|min }} de {{ total_items }} artículos
                    </div>
                    <ul class="pagination mb-0">
                        {% if pagination.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('inventario.lista', page=1, categoria=categoria_id, buscar=buscar, stock_bajo=stock_bajo) }}">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('inventario.lista', page=pagination.prev_num, categoria=categoria_id, buscar=buscar, stock_bajo=stock_bajo) }}">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>
                        {% endif %}

                        {% for p in pagination.iter_pages(left_edge=1, left_current=2, right_current=2, right_edge=1) %}
                            {% if p %}
                                {% if p == page %}
                                <li class="page-item active">
                                    <span class="page-link">{{ p }}</span>
                                </li>
                                {% else %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('inventario.lista', page=p, categoria=categoria_id, buscar=buscar, stock_bajo=stock_bajo) }}">{{ p }}</a>
                                </li>
                                {% endif %}
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                            {% endif %}
                        {% endfor %}

                        {% if pagination.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('inventario.lista', page=pagination.next_num, categoria=categoria_id, buscar=buscar, stock_bajo=stock_bajo) }}">
                                <i class="fas fa-angle-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('inventario.lista', page=pagination.pages, categoria=categoria_id, buscar=buscar, stock_bajo=stock_bajo) }}">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal de Acciones del Item -->
<div class="modal fade" id="modalAcciones" tabindex="-1" aria-labelledby="modalAccionesLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white py-2">
                <h6 class="modal-title" id="modalAccionesLabel">
                    <i class="fas fa-cog me-2"></i>Acciones
                </h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="list-group list-group-flush">
                    <input type="hidden" id="accion_item_id">
                    <input type="hidden" id="accion_item_nombre">
                    <input type="hidden" id="accion_item_codigo">
                    <input type="hidden" id="accion_item_stock">

                    <button type="button" class="list-group-item list-group-item-action" onclick="ejecutarAccion('uso')">
                        <i class="fas fa-wrench text-primary me-2"></i>Dar de baja por uso
                    </button>
                    <button type="button" class="list-group-item list-group-item-action" onclick="ejecutarAccion('rotura')">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>Dar de baja por rotura
                    </button>
                    <button type="button" class="list-group-item list-group-item-action" onclick="ejecutarAccion('traslado')">
                        <i class="fas fa-exchange-alt text-success me-2"></i>Trasladar a otro depósito
                    </button>
                    {% if current_user.rol == 'administrador' %}
                    <button type="button" class="list-group-item list-group-item-action text-danger" onclick="ejecutarAccion('eliminar')">
                        <i class="fas fa-trash me-2"></i>Eliminar item
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para dar de baja -->
<div class="modal fade" id="modalBaja" tabindex="-1" aria-labelledby="modalBajaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalBajaLabel">
                    <i class="fas fa-minus-circle me-2"></i>Dar de Baja Item
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formBaja" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" id="baja_item_id" name="item_id">
                <input type="hidden" id="baja_tipo" name="tipo_baja">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong id="baja_mensaje"></strong>
                    </div>
                    <p><strong>Item:</strong> <span id="baja_item_nombre"></span></p>

                    <div class="mb-3">
                        <label for="baja_cantidad" class="form-label">Cantidad *</label>
                        <input type="number" class="form-control" id="baja_cantidad" name="cantidad"
                               step="0.001" min="0.001" required>
                    </div>

                    <div class="mb-3">
                        <label for="baja_observaciones" class="form-label">Observaciones</label>
                        <textarea class="form-control" id="baja_observaciones" name="observaciones"
                                  rows="3" placeholder="Describe el motivo de la baja..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-check me-1"></i>Confirmar Baja
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para traslado -->
<div class="modal fade" id="modalTraslado" tabindex="-1" aria-labelledby="modalTrasladoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTrasladoLabel">
                    <i class="fas fa-exchange-alt me-2"></i>Trasladar a Otro Depósito
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formTraslado" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" id="traslado_item_id" name="item_id">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        El stock se restará del depósito actual y se sumará al depósito destino.
                    </div>
                    <p><strong>Item:</strong> <span id="traslado_item_nombre"></span></p>
                    <p><strong>Stock disponible:</strong> <span id="traslado_stock_actual"></span></p>

                    <div class="mb-3">
                        <label for="traslado_obra_destino" class="form-label">Depósito/Obra Destino *</label>
                        <select class="form-select" id="traslado_obra_destino" name="obra_destino_id" required>
                            <option value="">Seleccionar destino...</option>
                            {% for obra in obras_disponibles %}
                            <option value="{{ obra.id }}">{{ obra.nombre }} - {{ obra.direccion }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Selecciona la obra o depósito donde se trasladará el item</div>
                    </div>

                    <div class="mb-3">
                        <label for="traslado_cantidad" class="form-label">Cantidad a Trasladar *</label>
                        <input type="number" class="form-control" id="traslado_cantidad" name="cantidad"
                               step="0.001" min="0.001" required>
                        <div class="form-text">Máximo: <span id="traslado_max_cantidad"></span></div>
                    </div>

                    <div class="mb-3">
                        <label for="traslado_observaciones" class="form-label">Observaciones</label>
                        <textarea class="form-control" id="traslado_observaciones" name="observaciones"
                                  rows="2" placeholder="Notas adicionales sobre el traslado..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check me-1"></i>Confirmar Traslado
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para gestionar categorías visibles -->
<div class="modal fade" id="modalGestionCategorias" tabindex="-1" aria-labelledby="modalGestionCategoriasLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalGestionCategoriasLabel">
                    <i class="fas fa-tags me-2"></i>Gestionar Categorías Visibles
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Selecciona las categorías que deseas ver en el filtro. Los cambios se aplican inmediatamente.
                </div>

                <div class="mb-3">
                    <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="seleccionarTodas()">
                        <i class="fas fa-check-square me-1"></i>Seleccionar todas
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deseleccionarTodas()">
                        <i class="fas fa-square me-1"></i>Deseleccionar todas
                    </button>
                </div>

                <div class="row">
                    {% if categorias_nuevas %}
                    <div class="col-12 mb-3">
                        <h6 class="border-bottom pb-2 mb-3">Categorías Principales</h6>
                        <div class="row">
                            {% for categoria in categorias_nuevas %}
                            <div class="col-md-6 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input categoria-checkbox"
                                           type="checkbox"
                                           value="{{ categoria.id }}"
                                           id="cat_{{ categoria.id }}"
                                           data-nombre="{{ categoria.nombre }}"
                                           checked>
                                    <label class="form-check-label" for="cat_{{ categoria.id }}">
                                        {{ categoria.nombre }}
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if categorias %}
                    <div class="col-12">
                        <h6 class="border-bottom pb-2 mb-3">Otras Categorías</h6>
                        <div class="row">
                            {% for categoria in categorias %}
                            <div class="col-md-6 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input categoria-checkbox"
                                           type="checkbox"
                                           value="{{ categoria.id }}"
                                           id="cat_old_{{ categoria.id }}"
                                           data-nombre="{{ categoria.nombre }}"
                                           checked>
                                    <label class="form-check-label" for="cat_old_{{ categoria.id }}">
                                        {{ categoria.nombre }}
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="guardarCategorias()">
                    <i class="fas fa-save me-1"></i>Guardar y Aplicar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Modal de acciones
function abrirModalAcciones(itemId, itemNombre, itemCodigo, stockActual) {
    document.getElementById('accion_item_id').value = itemId;
    document.getElementById('accion_item_nombre').value = itemNombre;
    document.getElementById('accion_item_codigo').value = itemCodigo;
    document.getElementById('accion_item_stock').value = stockActual;

    // Actualizar título del modal
    document.getElementById('modalAccionesLabel').innerHTML =
        '<i class="fas fa-cog me-2"></i>' + itemNombre;

    const modal = new bootstrap.Modal(document.getElementById('modalAcciones'));
    modal.show();
}

function ejecutarAccion(accion) {
    const itemId = document.getElementById('accion_item_id').value;
    const itemNombre = document.getElementById('accion_item_nombre').value;
    const itemCodigo = document.getElementById('accion_item_codigo').value;
    const stockActual = parseFloat(document.getElementById('accion_item_stock').value);

    // Cerrar modal de acciones
    const modalAcciones = bootstrap.Modal.getInstance(document.getElementById('modalAcciones'));
    modalAcciones.hide();

    // Ejecutar acción correspondiente
    setTimeout(() => {
        switch(accion) {
            case 'uso':
                abrirModalBaja(itemId, itemNombre, 'uso');
                break;
            case 'rotura':
                abrirModalBaja(itemId, itemNombre, 'rotura');
                break;
            case 'traslado':
                abrirModalTraslado(itemId, itemNombre, stockActual);
                break;
            case 'eliminar':
                confirmarEliminar(itemId, itemNombre, itemCodigo, stockActual);
                break;
        }
    }, 300);
}

// Modal de baja
function abrirModalBaja(itemId, itemNombre, tipoBaja) {
    document.getElementById('baja_item_id').value = itemId;
    document.getElementById('baja_item_nombre').textContent = itemNombre;
    document.getElementById('baja_tipo').value = tipoBaja;

    const formBaja = document.getElementById('formBaja');
    formBaja.action = `/inventario/dar_baja/${itemId}`;

    if (tipoBaja === 'uso') {
        document.getElementById('baja_mensaje').textContent =
            'Vas a dar de baja este item por uso/consumo. Esta acción reducirá el stock actual.';
    } else if (tipoBaja === 'rotura') {
        document.getElementById('baja_mensaje').textContent =
            'Vas a dar de baja este item por rotura/daño. Esta acción reducirá el stock actual.';
    }

    document.getElementById('baja_cantidad').value = '';
    document.getElementById('baja_observaciones').value = '';

    const modal = new bootstrap.Modal(document.getElementById('modalBaja'));
    modal.show();
}

// Modal de traslado
function abrirModalTraslado(itemId, itemNombre, stockActual) {
    document.getElementById('traslado_item_id').value = itemId;
    document.getElementById('traslado_item_nombre').textContent = itemNombre;
    document.getElementById('traslado_stock_actual').textContent = stockActual.toFixed(3);
    document.getElementById('traslado_max_cantidad').textContent = stockActual.toFixed(3);

    const formTraslado = document.getElementById('formTraslado');
    formTraslado.action = `/inventario/trasladar/${itemId}`;

    document.getElementById('traslado_cantidad').value = '';
    document.getElementById('traslado_cantidad').max = stockActual;
    document.getElementById('traslado_observaciones').value = '';

    const modal = new bootstrap.Modal(document.getElementById('modalTraslado'));
    modal.show();
}

// Validación del formulario de traslado
document.getElementById('formTraslado').addEventListener('submit', function(e) {
    const cantidad = parseFloat(document.getElementById('traslado_cantidad').value);
    const max = parseFloat(document.getElementById('traslado_cantidad').max);

    if (cantidad > max) {
        e.preventDefault();
        alert('La cantidad a trasladar no puede ser mayor al stock disponible (' + max.toFixed(3) + ')');
        return false;
    }
});

// ===== Gestión de Categorías Visibles =====
const STORAGE_KEY = 'inventario_categorias_visibles';

// Cargar categorías guardadas del localStorage
function cargarCategoriasGuardadas() {
    const guardadas = localStorage.getItem(STORAGE_KEY);
    if (!guardadas) {
        return null; // Todas seleccionadas por defecto
    }
    try {
        return JSON.parse(guardadas);
    } catch (e) {
        console.error('Error al parsear categorías guardadas:', e);
        return null;
    }
}

// Aplicar categorías guardadas a los checkboxes
function aplicarCategoriasGuardadas() {
    const guardadas = cargarCategoriasGuardadas();
    if (!guardadas) return; // Si no hay guardadas, dejar todas marcadas

    document.querySelectorAll('.categoria-checkbox').forEach(checkbox => {
        const categoriaId = checkbox.value;
        checkbox.checked = guardadas.includes(categoriaId);
    });
}

// Aplicar filtro al dropdown de categorías
function aplicarFiltroDropdown() {
    const guardadas = cargarCategoriasGuardadas();
    if (!guardadas) return; // Si no hay guardadas, mostrar todas

    const dropdown = document.getElementById('categoria');
    if (!dropdown) return;

    Array.from(dropdown.options).forEach(option => {
        if (option.value === '') return; // Mantener "Todas las categorías"

        if (!guardadas.includes(option.value)) {
            option.style.display = 'none';
        } else {
            option.style.display = '';
        }
    });
}

// Seleccionar todas las categorías
function seleccionarTodas() {
    document.querySelectorAll('.categoria-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
}

// Deseleccionar todas las categorías
function deseleccionarTodas() {
    document.querySelectorAll('.categoria-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
}

// Guardar categorías seleccionadas
function guardarCategorias() {
    const seleccionadas = [];
    document.querySelectorAll('.categoria-checkbox:checked').forEach(checkbox => {
        seleccionadas.push(checkbox.value);
    });

    if (seleccionadas.length === 0) {
        alert('Debes seleccionar al menos una categoría');
        return;
    }

    localStorage.setItem(STORAGE_KEY, JSON.stringify(seleccionadas));

    // Aplicar el filtro inmediatamente
    aplicarFiltroDropdown();

    // Cerrar el modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalGestionCategorias'));
    if (modal) {
        modal.hide();
    }

    // Mostrar mensaje de éxito
    const mensaje = document.createElement('div');
    mensaje.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    mensaje.style.zIndex = '9999';
    mensaje.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        Categorías actualizadas: ${seleccionadas.length} seleccionadas
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(mensaje);

    setTimeout(() => {
        mensaje.remove();
    }, 3000);
}

// Inicializar cuando se abre el modal
document.getElementById('modalGestionCategorias').addEventListener('show.bs.modal', function() {
    aplicarCategoriasGuardadas();
});

// Aplicar filtro al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    aplicarFiltroDropdown();
});

// ===== Eliminar Item =====
function confirmarEliminar(itemId, itemNombre, itemCodigo, stockActual) {
    let mensaje = `¿Estás seguro de que deseas eliminar el item "${itemNombre}" (${itemCodigo})?`;

    if (stockActual > 0) {
        mensaje += `\n\n⚠️ ADVERTENCIA: Este item tiene ${stockActual.toFixed(2)} unidades en stock.`;
        mensaje += `\nSi lo eliminas, el stock quedará registrado pero el item no aparecerá en la lista.`;
    }

    mensaje += `\n\nEsta acción no se puede deshacer.`;

    if (confirm(mensaje)) {
        // Enviar formulario de eliminación
        const form = document.getElementById('formEliminar');
        form.action = `/inventario/${itemId}/eliminar`;
        form.submit();
    }
}
</script>

<!-- Formulario oculto para eliminar -->
<form id="formEliminar" method="POST" style="display: none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
</form>

<script>
// Cargar conteo de alertas de stock
document.addEventListener('DOMContentLoaded', function() {
    fetch('/inventario/api/alertas-stock/count')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.count > 0) {
                const badge = document.getElementById('badgeAlertas');
                badge.textContent = data.count;
                badge.style.display = 'inline';
                // Si hay criticos, cambiar el boton a rojo
                if (data.critico > 0) {
                    document.getElementById('btnAlertasStock').classList.remove('btn-warning');
                    document.getElementById('btnAlertasStock').classList.add('btn-danger');
                }
            }
        })
        .catch(err => console.log('Error cargando alertas:', err));
});
</script>
{% endblock %}
