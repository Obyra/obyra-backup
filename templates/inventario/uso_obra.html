{% extends "base.html" %}

{% block title %}Uso en Obra - Inventario{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0"><i class="fas fa-hard-hat me-2"></i>Compra y registro de obra</h2>
                <a href="{{ url_for('inventario.lista') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Volver al inventario
                </a>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <strong><i class="fas fa-tools me-2"></i>Nuevo uso de inventario</strong>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="mb-3">
                            <label for="obra_id" class="form-label">Obra / Dep√≥sito *</label>
                            <select class="form-select" id="obra_id" name="obra_id" required>
                                <option value="">Seleccionar destino...</option>
                                <option value="general" {% if request.form.get('obra_id') == 'general' %}selected{% endif %}>
                                    üì¶ Dep√≥sito General (Stock Central)
                                </option>
                                <optgroup label="Obras">
                                {% for obra in obras %}
                                <option value="{{ obra.id }}" {% if request.form.get('obra_id') == obra.id|string %}selected{% endif %}>
                                    üèóÔ∏è {{ obra.nombre }}
                                </option>
                                {% endfor %}
                                </optgroup>
                            </select>
                            <div class="form-text">Seleccion√° el destino donde se dar√° de alta el art√≠culo.</div>
                        </div>

                        <div class="mb-3">
                            <label for="fecha_compra" class="form-label">Fecha *</label>
                            <input type="date"
                                   class="form-control"
                                   id="fecha_compra"
                                   name="fecha_compra"
                                   value="{{ request.form.get('fecha_compra') or today.strftime('%Y-%m-%d') }}"
                                   required>
                            <div class="form-text">Fecha de la compra/registro</div>
                        </div>

                        <div class="mb-3">
                            <label for="item_id" class="form-label">Art√≠culo *</label>
                            <div class="d-flex gap-2">
                                <select class="form-select select2-search flex-grow-1" id="item_id" name="item_id" required>
                                    <option value="">Buscar por c√≥digo o nombre...</option>
                                    {% for item in items %}
                                    <option value="{{ item.id }}"
                                            data-codigo="{{ item.codigo }}"
                                            data-nombre="{{ item.nombre }}"
                                            data-categoria="{{ item.categoria.nombre if item.categoria else '' }}"
                                            data-unidad="{{ item.unidad }}"
                                            {% if request.form.get('item_id') == item.id|string %}selected{% endif %}>
                                        [{{ item.codigo }}] {{ item.nombre }}{% if item.categoria %} - {{ item.categoria.nombre }}{% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#modalNuevoItem" title="Crear nuevo art√≠culo">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div class="form-text">
                                <i class="fas fa-search me-1"></i>Busc√° por c√≥digo o nombre, o cre√° uno nuevo con el bot√≥n <i class="fas fa-plus text-success"></i>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="cantidad" class="form-label">Cantidad *</label>
                            <div class="input-group">
                                <input type="number"
                                       class="form-control"
                                       id="cantidad"
                                       name="cantidad"
                                       step="0.01"
                                       min="0.01"
                                       value="{{ request.form.get('cantidad', '') }}"
                                       required>
                                <span class="input-group-text" id="unidad-display">
                                    <i class="fas fa-balance-scale"></i>
                                </span>
                            </div>
                            <div class="form-text">La cantidad se dar√° de alta autom√°ticamente en el destino seleccionado.</div>
                        </div>

                        <div class="mb-3">
                            <label for="proveedor" class="form-label">Proveedor</label>
                            <input type="text"
                                   class="form-control"
                                   id="proveedor"
                                   name="proveedor"
                                   placeholder="Nombre del proveedor"
                                   value="{{ request.form.get('proveedor', '') }}">
                            <div class="form-text">Opcional: Registr√° el proveedor de la compra</div>
                        </div>

                        <div class="mb-3">
                            <label for="remito" class="form-label">Remito</label>
                            <input type="text"
                                   class="form-control"
                                   id="remito"
                                   name="remito"
                                   placeholder="N√∫mero de remito o factura"
                                   value="{{ request.form.get('remito', '') }}">
                            <div class="form-text">Opcional: N√∫mero de remito o factura</div>
                        </div>

                        <div class="alert alert-info d-flex align-items-start">
                            <i class="fas fa-info-circle me-2 mt-1"></i>
                            <div>
                                Al registrar una compra, la cantidad ingresada se dar√° de alta autom√°ticamente en el dep√≥sito u obra seleccionada.
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-2">
                            <a href="{{ url_for('inventario.lista') }}" class="btn btn-outline-secondary">
                                Cancelar
                            </a>
                            <button type="submit" class="btn btn-warning text-dark">
                                <i class="fas fa-save me-1"></i>Registrar compra
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header">
                    <strong><i class="fas fa-info me-2"></i>Consejos para el registro de compras</strong>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>Seleccion√° el dep√≥sito u obra donde se recibir√° el material comprado.</li>
                        <li>Utiliz√° los campos de proveedor y remito para llevar un mejor control de las compras.</li>
                        <li>La cantidad ingresada se sumar√° autom√°ticamente al stock del destino seleccionado.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal Crear Nuevo Item -->
<div class="modal fade" id="modalNuevoItem" tabindex="-1" aria-labelledby="modalNuevoItemLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalNuevoItemLabel">
                    <i class="fas fa-plus-circle me-2"></i>Crear Nuevo Art√≠culo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formNuevoItem">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                    <div class="mb-3">
                        <label for="nuevo_codigo" class="form-label">C√≥digo *</label>
                        <input type="text" class="form-control" id="nuevo_codigo" name="codigo" required
                               placeholder="Ej: MAT001, HER001">
                        <div class="form-text">C√≥digo √∫nico para identificar el art√≠culo</div>
                    </div>

                    <div class="mb-3">
                        <label for="nuevo_nombre" class="form-label">Nombre *</label>
                        <input type="text" class="form-control" id="nuevo_nombre" name="nombre" required
                               placeholder="Ej: Cemento Portland 50kg">
                    </div>

                    <div class="mb-3">
                        <label for="nuevo_categoria" class="form-label">Categor√≠a</label>
                        <select class="form-select" id="nuevo_categoria" name="categoria_id">
                            <option value="">Sin categor√≠a</option>
                            {% for cat in categorias %}
                            <option value="{{ cat.id }}">{{ cat.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nuevo_unidad" class="form-label">Unidad *</label>
                                <select class="form-select" id="nuevo_unidad" name="unidad" required>
                                    <option value="unidad">Unidad</option>
                                    <option value="kg">Kilogramo (kg)</option>
                                    <option value="tonelada">Tonelada</option>
                                    <option value="litro">Litro</option>
                                    <option value="m2">Metro cuadrado (m¬≤)</option>
                                    <option value="m3">Metro c√∫bico (m¬≥)</option>
                                    <option value="ml">Metro lineal (ml)</option>
                                    <option value="bolsa">Bolsa</option>
                                    <option value="rollo">Rollo</option>
                                    <option value="caja">Caja</option>
                                    <option value="pack">Pack</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nuevo_stock_minimo" class="form-label">Stock M√≠nimo</label>
                                <input type="number" class="form-control" id="nuevo_stock_minimo" name="stock_minimo"
                                       value="0" min="0" step="0.01">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="nuevo_descripcion" class="form-label">Descripci√≥n</label>
                        <textarea class="form-control" id="nuevo_descripcion" name="descripcion" rows="2"
                                  placeholder="Descripci√≥n opcional del art√≠culo"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnGuardarNuevoItem">
                    <i class="fas fa-save me-1"></i>Crear Art√≠culo
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Inicializar Select2 en el campo de √≠tem de inventario
    $('#item_id').select2({
        theme: 'bootstrap-5',
        placeholder: 'Buscar por c√≥digo o nombre...',
        allowClear: true,
        width: '100%',
        language: {
            noResults: function() {
                return 'No se encontraron resultados';
            },
            searching: function() {
                return 'Buscando...';
            },
            inputTooShort: function() {
                return 'Ingres√° al menos 1 car√°cter';
            }
        },
        // B√∫squeda personalizada
        matcher: function(params, data) {
            // Si no hay t√©rmino de b√∫squeda, mostrar todas las opciones
            if ($.trim(params.term) === '') {
                return data;
            }

            // Si es la opci√≥n placeholder, no mostrarla
            if (!data.id) {
                return null;
            }

            // Obtener los datos del elemento
            var codigo = $(data.element).data('codigo') || '';
            var nombre = $(data.element).data('nombre') || '';
            var categoria = $(data.element).data('categoria') || '';

            // Convertir todo a min√∫sculas para b√∫squeda insensible a may√∫sculas
            var searchTerm = params.term.toLowerCase();
            var codigoLower = codigo.toString().toLowerCase();
            var nombreLower = nombre.toString().toLowerCase();
            var categoriaLower = categoria.toString().toLowerCase();

            // Buscar coincidencias parciales en c√≥digo, nombre o categor√≠a
            if (codigoLower.indexOf(searchTerm) > -1 ||
                nombreLower.indexOf(searchTerm) > -1 ||
                categoriaLower.indexOf(searchTerm) > -1) {
                return data;
            }

            return null;
        }
    });

    // Tambi√©n inicializar Select2 en el campo de obra para consistencia
    $('#obra_id').select2({
        theme: 'bootstrap-5',
        placeholder: 'Seleccionar destino...',
        allowClear: true,
        width: '100%',
        language: {
            noResults: function() {
                return 'No se encontraron resultados';
            }
        }
    });

    // Actualizar la unidad de medida cuando se selecciona un art√≠culo
    $('#item_id').on('change', function() {
        var selectedOption = $(this).find('option:selected');
        var unidad = selectedOption.data('unidad');

        if (unidad) {
            $('#unidad-display').html(unidad);
        } else {
            $('#unidad-display').html('<i class="fas fa-balance-scale"></i>');
        }
    });

    // Si hay un art√≠culo preseleccionado, mostrar su unidad
    if ($('#item_id').val()) {
        $('#item_id').trigger('change');
    }

    // ========== CREAR NUEVO ITEM ==========
    $('#btnGuardarNuevoItem').on('click', function() {
        const btn = $(this);
        const form = $('#formNuevoItem');

        // Validar campos requeridos
        const codigo = $('#nuevo_codigo').val().trim();
        const nombre = $('#nuevo_nombre').val().trim();
        const unidad = $('#nuevo_unidad').val();

        if (!codigo || !nombre || !unidad) {
            alert('Por favor complet√° los campos obligatorios: C√≥digo, Nombre y Unidad');
            return;
        }

        // Deshabilitar bot√≥n mientras procesa
        btn.prop('disabled', true);
        btn.html('<i class="fas fa-spinner fa-spin me-1"></i>Creando...');

        // Preparar datos
        const formData = {
            codigo: codigo,
            nombre: nombre,
            unidad: unidad,
            categoria_id: $('#nuevo_categoria').val() || null,
            stock_minimo: parseFloat($('#nuevo_stock_minimo').val()) || 0,
            descripcion: $('#nuevo_descripcion').val().trim()
        };

        // Enviar al servidor
        $.ajax({
            url: '/inventario/api/crear-item',
            method: 'POST',
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': $('input[name="csrf_token"]').val()
            },
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.ok) {
                    // Agregar el nuevo item al select
                    const newOption = new Option(
                        `[${response.item.codigo}] ${response.item.nombre}`,
                        response.item.id,
                        true,
                        true
                    );
                    $(newOption).attr('data-codigo', response.item.codigo);
                    $(newOption).attr('data-nombre', response.item.nombre);
                    $(newOption).attr('data-unidad', response.item.unidad);
                    $(newOption).attr('data-categoria', response.item.categoria || '');

                    $('#item_id').append(newOption).trigger('change');

                    // Cerrar modal y limpiar form
                    $('#modalNuevoItem').modal('hide');
                    form[0].reset();

                    // Mostrar mensaje de √©xito
                    alert('‚úÖ Art√≠culo creado exitosamente: ' + response.item.nombre);
                } else {
                    alert('Error: ' + (response.error || 'No se pudo crear el art√≠culo'));
                }
            },
            error: function(xhr) {
                let errorMsg = 'Error al crear el art√≠culo';
                try {
                    const resp = JSON.parse(xhr.responseText);
                    errorMsg = resp.error || errorMsg;
                } catch(e) {}
                alert(errorMsg);
            },
            complete: function() {
                btn.prop('disabled', false);
                btn.html('<i class="fas fa-save me-1"></i>Crear Art√≠culo');
            }
        });
    });

    // Limpiar formulario al cerrar modal
    $('#modalNuevoItem').on('hidden.bs.modal', function() {
        $('#formNuevoItem')[0].reset();
    });
});
</script>
{% endblock %}
