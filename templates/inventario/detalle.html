{% extends "base.html" %}

{% block title %}Detalle de Inventario - {{ item.nombre }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-4">
        <div>
            <h2 class="mb-1"><i class="fas fa-box-open me-2 text-primary"></i>{{ item.nombre }}</h2>
            <div class="text-muted">
                <span class="me-3"><strong>Código:</strong> {{ item.codigo }}</span>
                <span class="me-3"><strong>Categoría:</strong> {{ item.categoria.nombre }}</span>
                <span class="badge bg-info text-dark">{{ item.categoria.tipo|title }}</span>
            </div>
        </div>
        <div class="mt-3 mt-lg-0">
            <a class="btn btn-outline-secondary me-2" href="{{ url_for('inventario.lista') }}">
                <i class="fas fa-arrow-left me-1"></i>Volver al listado
            </a>
            {% if current_user.rol in ['administrador', 'tecnico'] %}
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalMovimiento">
                <i class="fas fa-exchange-alt me-1"></i>Registrar movimiento
            </button>
            {% endif %}
            <a class="btn btn-outline-warning ms-lg-2 mt-2 mt-lg-0" href="{{ url_for('inventario.uso_obra') }}">
                <i class="fas fa-hard-hat me-1"></i>Registrar uso en obra
            </a>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <p class="text-muted mb-1">Stock actual</p>
                    <h3 class="mb-0 {{ 'text-danger' if item.necesita_reposicion else 'text-success' }}">{{ item.stock_actual|numero(2) }} {{ item.unidad }}</h3>
                    {% if item.necesita_reposicion %}
                    <span class="badge bg-warning text-dark mt-2"><i class="fas fa-exclamation-triangle me-1"></i>Necesita reposición</span>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <p class="text-muted mb-1">Stock mínimo</p>
                    <h3 class="mb-0 text-warning">{{ item.stock_minimo|numero(2) }} {{ item.unidad }}</h3>
                    <small class="text-muted">Última actualización: {{ item.fecha_creacion.strftime('%d/%m/%Y') if item.fecha_creacion else 'N/D' }}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <p class="text-muted mb-1">Precio promedio</p>
                    <h3 class="mb-0 text-primary">{{ item.precio_promedio|moneda }}</h3>
                    <small class="text-muted">Valor unitario</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <p class="text-muted mb-1">Valor estimado en stock</p>
                    <h3 class="mb-0 text-success">{{ (item.stock_actual * item.precio_promedio)|moneda }}</h3>
                    <small class="text-muted">Cálculo automático</small>
                </div>
            </div>
        </div>
    </div>

    {% if item.descripcion %}
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h5 class="card-title"><i class="fas fa-align-left me-2"></i>Descripción</h5>
            <p class="mb-0 text-muted">{{ item.descripcion }}</p>
        </div>
    </div>
    {% endif %}

    <div class="row g-4">
        <div class="col-xl-6">
            <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-stream me-2"></i>Últimos movimientos</h5>
                    {% if current_user.rol in ['administrador', 'tecnico'] %}
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalMovimiento">
                        <i class="fas fa-plus me-1"></i>Nuevo
                    </button>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    {% if movimientos %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th class="text-end">Cantidad</th>
                                    <th class="text-end">Precio</th>
                                    <th>Motivo</th>
                                    <th>Registrado por</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for movimiento in movimientos %}
                                <tr>
                                    <td>{{ movimiento.fecha.strftime('%d/%m/%Y %H:%M') if movimiento.fecha else 'N/D' }}</td>
                                    <td>
                                        <span class="badge {% if movimiento.tipo == 'entrada' %}bg-success{% elif movimiento.tipo == 'salida' %}bg-danger{% else %}bg-secondary{% endif %}">
                                            {{ movimiento.tipo|title }}
                                        </span>
                                    </td>
                                    <td class="text-end">{{ movimiento.cantidad|numero(2) }} {{ item.unidad }}</td>
                                    <td class="text-end">{{ movimiento.precio_unitario|moneda }}</td>
                                    <td>{{ movimiento.motivo or '—' }}</td>
                                    <td>{{ movimiento.usuario.nombre }} {{ movimiento.usuario.apellido }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="p-4 text-center text-muted">
                        <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                        <p class="mb-0">Todavía no hay movimientos registrados para este item.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-xl-6">
            <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-hard-hat me-2"></i>Uso reciente en obras</h5>
                    <a class="btn btn-sm btn-outline-warning" href="{{ url_for('inventario.uso_obra') }}">
                        <i class="fas fa-plus me-1"></i>Registrar uso
                    </a>
                </div>
                <div class="card-body p-0">
                    {% if usos_obra %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Obra</th>
                                    <th class="text-end">Cantidad</th>
                                    <th>Usuario</th>
                                    <th>Observaciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for uso in usos_obra %}
                                <tr>
                                    <td>{{ uso.fecha_uso.strftime('%d/%m/%Y') if uso.fecha_uso else 'N/D' }}</td>
                                    <td>{{ uso.obra.nombre }}</td>
                                    <td class="text-end">{{ uso.cantidad_usada|numero(2) }} {{ item.unidad }}</td>
                                    <td>{{ uso.usuario.nombre }} {{ uso.usuario.apellido }}</td>
                                    <td>{{ uso.observaciones or '—' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="p-4 text-center text-muted">
                        <i class="fas fa-industry fa-2x mb-2"></i>
                        <p class="mb-0">No se registraron usos de este item en obras recientemente.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% if current_user.rol in ['administrador', 'tecnico'] %}
<div class="modal fade" id="modalMovimiento" tabindex="-1" aria-labelledby="modalMovimientoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('inventario.registrar_movimiento', id=item.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalMovimientoLabel">Registrar movimiento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="tipo" class="form-label">Tipo de movimiento</label>
                            <select class="form-select" id="tipo" name="tipo" required>
                                <option value="entrada">Entrada</option>
                                <option value="salida">Salida</option>
                                <option value="ajuste">Ajuste</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="cantidad" class="form-label">Cantidad</label>
                            <input type="number" step="0.01" min="0" class="form-control" id="cantidad" name="cantidad" required>
                        </div>
                        <div class="col-md-4">
                            <label for="precio_unitario" class="form-label">Precio unitario</label>
                            <input type="number" step="0.01" min="0" class="form-control" id="precio_unitario" name="precio_unitario" placeholder="0.00">
                            <small class="text-muted">Opcional para salidas y ajustes</small>
                        </div>
                        <div class="col-md-6">
                            <label for="motivo" class="form-label">Motivo</label>
                            <input type="text" class="form-control" id="motivo" name="motivo" placeholder="Compra, consumo, ajuste...">
                        </div>
                        <div class="col-md-6">
                            <label for="observaciones" class="form-label">Observaciones</label>
                            <textarea class="form-control" id="observaciones" name="observaciones" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar movimiento</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
