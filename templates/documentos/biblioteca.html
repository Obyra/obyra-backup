{% extends "base.html" %}

{% block title %}Biblioteca de Documentos{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-4">
        <div>
            <h2 class="mb-1"><i class="fas fa-book me-2 text-primary"></i>Biblioteca digital</h2>
            <p class="text-muted mb-0">Filtra, busca y descarga los documentos de tus obras.</p>
        </div>
        <div class="mt-3 mt-lg-0">
            <a href="{{ url_for('documentos.subir_documento') }}" class="btn btn-primary">
                <i class="fas fa-upload me-1"></i>Subir documento
            </a>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="obra_id" class="form-label">Obra</label>
                    <select class="form-select" id="obra_id" name="obra_id">
                        <option value="">Todas</option>
                        {% for obra in obras %}
                        <option value="{{ obra.id }}" {% if request.args.get('obra_id') == obra.id|string %}selected{% endif %}>{{ obra.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="tipo_id" class="form-label">Tipo de documento</label>
                    <select class="form-select" id="tipo_id" name="tipo_id">
                        <option value="">Todos</option>
                        {% for tipo in tipos_documento %}
                        <option value="{{ tipo.id }}" {% if request.args.get('tipo_id') == tipo.id|string %}selected{% endif %}>{{ tipo.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="estado" class="form-label">Estado</label>
                    <select class="form-select" id="estado" name="estado">
                        <option value="">Todos</option>
                        {% for opcion in ['borrador', 'revision', 'aprobado', 'obsoleto'] %}
                        <option value="{{ opcion }}" {% if request.args.get('estado') == opcion %}selected{% endif %}>{{ opcion|title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="q" class="form-label">Buscar</label>
                    <input type="search" class="form-control" id="q" name="q" value="{{ request.args.get('q', '') }}" placeholder="Nombre o descripción">
                </div>
                <div class="col-md-1 d-grid">
                    <button type="submit" class="btn btn-outline-primary"><i class="fas fa-search"></i></button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            {% if documentos %}
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Nombre</th>
                            <th>Obra</th>
                            <th>Tipo</th>
                            <th>Estado</th>
                            <th>Versión</th>
                            <th>Actualizado</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for documento in documentos %}
                        <tr>
                            <td>{{ documento.nombre }}</td>
                            <td>{{ documento.obra.nombre if documento.obra else '—' }}</td>
                            <td>{{ documento.tipo_documento.nombre if documento.tipo_documento else '—' }}</td>
                            <td>
                                <span class="badge
                                    {% if documento.estado == 'aprobado' %} bg-success
                                    {% elif documento.estado == 'revision' %} bg-warning text-dark
                                    {% elif documento.estado == 'borrador' %} bg-secondary
                                    {% else %} bg-dark
                                    {% endif %}">
                                    {{ documento.estado|title }}
                                </span>
                            </td>
                            <td>{{ documento.version }}</td>
                            <td>{{ documento.fecha_modificacion.strftime('%d/%m/%Y %H:%M') if documento.fecha_modificacion else 'N/D' }}</td>
                            <td class="text-end">
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{{ url_for('documentos.ver_documento', documento_id=documento.id) }}" class="btn btn-outline-primary" title="Ver detalle">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{{ url_for('documentos.descargar_documento', documento_id=documento.id) }}" class="btn btn-outline-success" title="Descargar">
                                        <i class="fas fa-download"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center text-muted py-5">
                <i class="fas fa-folder-open fa-3x mb-3"></i>
                <p class="mb-0">No se encontraron documentos con los filtros seleccionados.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
