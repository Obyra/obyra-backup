{% extends "base.html" %}

{% block title %}Certificaciones · {{ obra.nombre }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-4 gap-3">
        <div>
            <h2 class="h3 mb-1"><i class="fas fa-certificate me-2"></i>Certificaciones de obra</h2>
            <p class="text-muted mb-0">{{ obra.nombre }} · {{ obra.cliente }}</p>
        </div>
        <a href="{{ url_for('obras.detalle', id=obra.id) }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Volver a la obra
        </a>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <p class="text-muted text-uppercase small mb-1">Certificado</p>
                    <h4 class="mb-0">{{ resumen['certificado_ars']|moneda }}</h4>
                    {% if resumen['certificado_usd'] %}
                    <small class="text-muted">USD {{ resumen['certificado_usd']|float|round(2) }}</small>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <p class="text-muted text-uppercase small mb-1">Pagado</p>
                    <h4 class="mb-0">{{ resumen['pagado_ars']|moneda }}</h4>
                    {% if resumen['pagado_usd'] %}
                    <small class="text-muted">USD {{ resumen['pagado_usd']|float|round(2) }}</small>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <p class="text-muted text-uppercase small mb-1">En borrador</p>
                    <h4 class="mb-0">{{ resumen['borrador_ars']|moneda }}</h4>
                    <small class="text-muted">{{ porcentajes[1] }}% pendiente</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <p class="text-muted text-uppercase small mb-1">Contexto monetario</p>
                    <h6 class="mb-0">Moneda base: {{ contexto.currency }}</h6>
                    {% if contexto.tasa_usd %}
                    <small class="text-muted d-block">TC Banco Nacion: {{ contexto.tasa_usd }}</small>
                    {% endif %}
                    {% if contexto.indice_cac %}
                    <small class="text-muted">Indice CAC: {{ contexto.indice_cac }}</small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs" id="certTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-pendientes" data-bs-toggle="tab" data-bs-target="#pane-pendientes" type="button" role="tab">A certificar</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-certificadas" data-bs-toggle="tab" data-bs-target="#pane-certificadas" type="button" role="tab">Certificadas</button>
        </li>
    </ul>
    <div class="tab-content border border-top-0 rounded-bottom shadow-sm bg-white" id="certTabsContent">
        <!-- Tab: A certificar -->
        <div class="tab-pane fade show active" id="pane-pendientes" role="tabpanel" aria-labelledby="tab-pendientes">
            <div class="p-3">

                {# Borradores existentes #}
                {% set borradores = pendientes|selectattr('tipo', 'equalto', 'borrador')|list %}
                {% if borradores %}
                <h6 class="text-muted mb-2"><i class="fas fa-file-alt me-1"></i>Borradores pendientes</h6>
                <div class="table-responsive mb-4">
                    <table class="table table-sm align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Estado</th>
                                <th>Periodo</th>
                                <th>% Avance</th>
                                <th>Monto (ARS)</th>
                                {% if puede_aprobar %}<th class="text-end">Acciones</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in borradores %}
                            <tr>
                                <td><span class="badge bg-secondary">Borrador</span></td>
                                <td>
                                    {% if item.periodo and (item.periodo[0] or item.periodo[1]) %}
                                        {{ item.periodo[0].strftime('%d/%m/%Y') if item.periodo[0] else '-' }}
                                        &rarr;
                                        {{ item.periodo[1].strftime('%d/%m/%Y') if item.periodo[1] else '-' }}
                                    {% else %}
                                        <span class="text-muted">Sin periodo</span>
                                    {% endif %}
                                </td>
                                <td><strong>{{ item.porcentaje }}%</strong></td>
                                <td>{{ item.monto_ars|moneda }}</td>
                                {% if puede_aprobar %}
                                <td class="text-end">
                                    <button type="button" class="btn btn-sm btn-primary"
                                            data-bs-toggle="modal" data-bs-target="#modalConfirmarCertificacion"
                                            data-porcentaje="{{ item.porcentaje }}"
                                            data-certificacion-id="{{ item.id or '' }}"
                                            data-monto-ars="{{ item.monto_ars }}"
                                            data-monto-usd="{{ item.monto_usd }}">
                                        <i class="fas fa-check me-1"></i>Aprobar
                                    </button>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}

                {# Desglose por etapa — nueva sección principal #}
                {% if desglose_etapas and desglose_etapas.etapas %}
                <form method="post" action="{{ url_for('obras.historial_certificaciones', id=obra.id) }}" id="formCertDesglose">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="aprobar" value="true">
                    <input type="hidden" name="items_etapa" id="hiddenItemsEtapa">

                    <h6 class="text-muted mb-2"><i class="fas fa-layer-group me-1"></i>Desglose por etapa (segun avance de tareas)</h6>

                    {% if desglose_etapas.ya_certificado_ars > 0 %}
                    <div class="alert alert-info small py-2 mb-3">
                        <i class="fas fa-info-circle me-1"></i>
                        Ya certificado: <strong>{{ desglose_etapas.ya_certificado_ars|moneda }}</strong>
                        de {{ desglose_etapas.presupuesto_total|moneda }} (presupuesto total)
                    </div>
                    {% endif %}

                    <div class="table-responsive mb-3">
                        <table class="table align-middle mb-0" id="tablaDesglose">
                            <thead class="table-light">
                                <tr>
                                    <th>Etapa</th>
                                    <th class="text-center">Avance</th>
                                    <th class="text-end">Presupuestado</th>
                                    <th class="text-end" style="min-width: 180px;">Monto a certificar</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for etapa in desglose_etapas.etapas %}
                                <tr>
                                    <td>
                                        <div class="fw-semibold">{{ etapa.etapa_nombre }}</div>
                                        <small class="text-muted">{{ etapa.tareas_completadas }}/{{ etapa.tareas_total }} tareas</small>
                                    </td>
                                    <td class="text-center">
                                        <div class="d-flex align-items-center justify-content-center gap-2">
                                            <div class="progress flex-grow-1" style="height: 8px; max-width: 80px;">
                                                <div class="progress-bar {% if etapa.porcentaje_avance >= 100 %}bg-success{% elif etapa.porcentaje_avance >= 50 %}bg-primary{% else %}bg-warning{% endif %}"
                                                     style="width: {{ etapa.porcentaje_avance }}%"></div>
                                            </div>
                                            <span class="small fw-semibold">{{ etapa.porcentaje_avance }}%</span>
                                        </div>
                                    </td>
                                    <td class="text-end text-muted">{{ etapa.costo_presupuestado|moneda }}</td>
                                    <td class="text-end">
                                        <input type="number"
                                               class="form-control form-control-sm text-end input-monto-etapa"
                                               data-etapa-id="{{ etapa.etapa_id }}"
                                               data-etapa-nombre="{{ etapa.etapa_nombre }}"
                                               data-porcentaje="{{ etapa.porcentaje_avance }}"
                                               value="{{ etapa.monto_certificable|float|round(2) }}"
                                               step="0.01" min="0"
                                               max="{{ etapa.costo_presupuestado|float|round(2) }}"
                                               {% if not puede_aprobar %}disabled{% endif %}>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr class="fw-bold">
                                    <td colspan="3" class="text-end">Total a certificar:</td>
                                    <td class="text-end">
                                        <span id="totalCertificar">{{ desglose_etapas.total_certificable|moneda }}</span>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    {% if puede_aprobar %}
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label small text-muted">Periodo desde</label>
                            <input type="date" class="form-control form-control-sm" name="periodo_desde">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small text-muted">Periodo hasta</label>
                            <input type="date" class="form-control form-control-sm" name="periodo_hasta">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small text-muted">Notas</label>
                            <input type="text" class="form-control form-control-sm" name="notas" placeholder="Detalle opcional...">
                        </div>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary" id="btnCertificarDesglose">
                            <i class="fas fa-certificate me-1"></i>Certificar
                        </button>
                    </div>
                    {% endif %}
                </form>

                {% elif not borradores %}
                <div class="text-center py-5">
                    <i class="fas fa-layer-group fa-2x text-muted mb-2"></i>
                    <p class="mb-0 text-muted">No hay montos a certificar. El desglose se calculara automaticamente cuando las tareas tengan presupuesto vinculado y reporten avance.</p>
                </div>
                {% endif %}

            </div>
        </div>

        <!-- Tab: Certificadas -->
        <div class="tab-pane fade" id="pane-certificadas" role="tabpanel" aria-labelledby="tab-certificadas">
            <div class="p-3">
                {% if certificaciones_aprobadas %}
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Periodo</th>
                                <th scope="col">% Avance</th>
                                <th scope="col">Certificado (ARS)</th>
                                <th scope="col">Certificado (USD)</th>
                                <th scope="col">Pagado</th>
                                <th scope="col">Saldo</th>
                                <th scope="col">Estado</th>
                                {% if puede_aprobar %}<th scope="col" class="text-end">Acciones</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in certificaciones_aprobadas %}
                            <tr>
                                <td>
                                    {% if row.periodo %}
                                        <div>
                                            {% if row.periodo[0] %}{{ row.periodo[0].strftime('%d/%m/%Y') }}{% else %}-{% endif %}
                                            &rarr;
                                            {% if row.periodo[1] %}{{ row.periodo[1].strftime('%d/%m/%Y') }}{% else %}-{% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-muted">Sin periodo</span>
                                    {% endif %}
                                    <div class="text-muted small">{{ row.aprobada_en|fecha }}</div>
                                </td>
                                <td><strong>{{ row.porcentaje }}%</strong></td>
                                <td>{{ row.monto_ars|moneda }}</td>
                                <td>
                                    {% if row.monto_usd %}
                                        USD {{ row.monto_usd|float|round(2) }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div>{{ row.pagado_ars|moneda }}</div>
                                    {% if row.pagado_usd %}<small class="text-muted">USD {{ row.pagado_usd|float|round(2) }}</small>{% endif %}
                                </td>
                                <td>{{ row.saldo_ars|moneda }}</td>
                                <td>
                                    <span class="badge bg-success">{{ row.estado|capitalize }}</span>
                                </td>
                                {% if puede_aprobar %}
                                <td class="text-end">
                                    <button type="button" class="btn btn-sm btn-outline-primary"
                                            data-bs-toggle="modal" data-bs-target="#modalRegistrarPago"
                                            data-certificacion-id="{{ row.id }}"
                                            data-saldo="{{ row.saldo_ars }}">
                                        <i class="fas fa-coins me-1"></i>Registrar pago
                                    </button>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-file-invoice-dollar fa-2x text-muted mb-2"></i>
                    <p class="mb-0 text-muted">Aun no se registraron certificaciones aprobadas.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if puede_aprobar %}
<!-- Modal aprobar borrador -->
<div class="modal fade" id="modalConfirmarCertificacion" tabindex="-1" aria-labelledby="modalConfirmarCertificacionLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <form method="post" action="{{ url_for('obras.historial_certificaciones', id=obra.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-header">
                    <h5 class="modal-title" id="modalConfirmarCertificacionLabel"><i class="fas fa-check-circle me-2"></i>Confirmar certificacion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info small" id="certResumenContexto">
                        <div><strong>Moneda base:</strong> {{ contexto.currency }}</div>
                        {% if contexto.tasa_usd %}<div><strong>Tipo de cambio:</strong> {{ contexto.tasa_usd }}</div>{% endif %}
                    </div>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Porcentaje a certificar</label>
                            <input type="number" class="form-control" name="porcentaje" id="inputPorcentaje" min="0" max="100" step="0.1" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Monto estimado (ARS)</label>
                            <input type="text" class="form-control" id="inputMontoArs" readonly>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Monto estimado (USD)</label>
                            <input type="text" class="form-control" id="inputMontoUsd" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Periodo desde</label>
                            <input type="date" class="form-control" name="periodo_desde">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Periodo hasta</label>
                            <input type="date" class="form-control" name="periodo_hasta">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Notas</label>
                            <textarea class="form-control" name="notas" rows="3" placeholder="Detalle adicional, cuadrillas, etc."></textarea>
                        </div>
                    </div>
                    <input type="hidden" name="aprobar" value="true">
                    <input type="hidden" name="certificacion_id" id="inputCertificacionId">
                    <input type="hidden" name="fuente" value="tareas">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Confirmar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal registrar pago -->
<div class="modal fade" id="modalRegistrarPago" tabindex="-1" aria-labelledby="modalRegistrarPagoLabel" aria-hidden="true" data-action-template="{{ url_for('obras.registrar_pago_certificacion', cert_id=0) }}">
    <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content">
            <form method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-header">
                    <h5 class="modal-title" id="modalRegistrarPagoLabel"><i class="fas fa-coins me-2"></i>Registrar pago</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Monto</label>
                        <input type="number" class="form-control" name="monto" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Moneda</label>
                        <select class="form-select" name="moneda">
                            <option value="ARS" selected>ARS</option>
                            <option value="USD">USD</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Metodo de pago</label>
                        <select class="form-select" name="metodo" required>
                            <option value="transferencia">Transferencia</option>
                            <option value="efectivo">Efectivo</option>
                            <option value="mep">MEP</option>
                            <option value="cheque">Cheque</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo de cambio (si USD)</label>
                        <input type="number" class="form-control" step="0.0001" name="tc_usd">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Fecha de pago</label>
                        <input type="date" class="form-control" name="fecha_pago">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notas</label>
                        <textarea class="form-control" name="notas" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i>Registrar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
(function () {
    // --- Desglose por etapa: recalcular total y serializar al submit ---
    const form = document.getElementById('formCertDesglose');
    const inputs = document.querySelectorAll('.input-monto-etapa');
    const totalSpan = document.getElementById('totalCertificar');
    const hiddenItems = document.getElementById('hiddenItemsEtapa');

    function formatARS(value) {
        return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value);
    }

    function recalcularTotal() {
        let total = 0;
        inputs.forEach(function(input) {
            total += parseFloat(input.value) || 0;
        });
        if (totalSpan) {
            totalSpan.textContent = formatARS(total);
        }
    }

    inputs.forEach(function(input) {
        input.addEventListener('input', recalcularTotal);
    });

    if (form) {
        form.addEventListener('submit', function(e) {
            const items = [];
            inputs.forEach(function(input) {
                const monto = parseFloat(input.value) || 0;
                if (monto > 0) {
                    items.push({
                        etapa_id: parseInt(input.dataset.etapaId),
                        etapa_nombre: input.dataset.etapaNombre,
                        porcentaje: parseFloat(input.dataset.porcentaje) || 0,
                        monto: monto
                    });
                }
            });

            if (items.length === 0) {
                e.preventDefault();
                alert('No hay montos a certificar. Edita al menos un monto mayor a cero.');
                return;
            }

            hiddenItems.value = JSON.stringify(items);
        });
    }

    // --- Modal confirmar borrador ---
    const confirmModal = document.getElementById('modalConfirmarCertificacion');
    if (confirmModal) {
        confirmModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const porcentaje = button?.dataset.porcentaje || '';
            const montoArs = button?.dataset.montoArs || '';
            const montoUsd = button?.dataset.montoUsd || '';
            const certId = button?.dataset.certificacionId || '';

            confirmModal.querySelector('#inputPorcentaje').value = porcentaje;
            confirmModal.querySelector('#inputMontoArs').value = montoArs ? formatARS(montoArs) : '';
            confirmModal.querySelector('#inputMontoUsd').value = montoUsd ? 'USD ' + parseFloat(montoUsd).toFixed(2) : '';
            confirmModal.querySelector('#inputCertificacionId').value = certId;
        });
    }

    // --- Modal registrar pago ---
    const pagoModal = document.getElementById('modalRegistrarPago');
    if (pagoModal) {
        const actionTemplate = pagoModal.dataset.actionTemplate;
        pagoModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const certId = button?.dataset.certificacionId;
            const form = pagoModal.querySelector('form');
            if (certId && actionTemplate) {
                form.action = actionTemplate.replace('0', certId);
            }
        });
    }
})();
</script>
{% endblock %}
