{% extends "base.html" %}

{% block title %}Obras - OBYRA IA{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-building me-2"></i>Distribuci√≥n de Obras por Zonas</h2>
                <div class="d-flex gap-2">
                    <span class="badge bg-slate-200 text-slate-700" title="Cantidad de obras que cumplen el filtro" style="background-color: #f1f5f9; color: #374151; cursor: default;">
                        {{ obras.total if obras else 0 }} obras
                    </span>
                    {# Bot√≥n Nueva Obra deshabilitado - Las obras solo se crean desde el m√≥dulo de Presupuestos #}
                    {% if false %}
                    {% if current_user.rol in ['administrador', 'tecnico'] %}
                    <a href="{{ url_for('obras.crear') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Nueva Obra
                    </a>
                    {% endif %}
                    {% endif %}
                    
                    {# alternativa reversible: ocultar bot√≥n Backfill Tareas #}
                    {% if false %}
                    {% if current_user.rol == 'administrador' and current_user.is_super_admin %}
                    <form method="POST" action="{{ url_for('obras.admin_backfill_tareas') }}" style="display: inline;" 
                          onsubmit="return confirm('¬øEst√°s segura de ejecutar el backfill de tareas predefinidas? Esto agregar√° tareas a etapas existentes que tengan menos de 5 tareas.')">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-warning ms-2">
                            <i class="fas fa-magic me-1"></i>Backfill Tareas
                        </button>
                    </form>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label for="estado" class="form-label">Estado</label>
                    <select class="form-select" id="estado" name="estado">
                        <option value="">Todos los estados</option>
                        <option value="planificacion" {{ 'selected' if estado == 'planificacion' }}>Planificaci√≥n</option>
                        <option value="en_curso" {{ 'selected' if estado == 'en_curso' }}>En Curso</option>
                        <option value="pausada" {{ 'selected' if estado == 'pausada' }}>Pausada</option>
                        <option value="finalizada" {{ 'selected' if estado == 'finalizada' }}>Finalizada</option>
                        <option value="cancelada" {{ 'selected' if estado == 'cancelada' }}>Cancelada</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="buscar" class="form-label">Buscar</label>
                    <input type="text" class="form-control" id="buscar" name="buscar"
                           value="{{ buscar }}" placeholder="Nombre, cliente o direcci√≥n...">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-outline-primary me-2">
                        <i class="fas fa-search me-1"></i>Filtrar
                    </button>
                    <a href="{{ url_for('obras.lista') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i>Limpiar
                    </a>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Mapa de obras - Ancho completo -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-map-marked-alt me-2"></i>Mapa de Obras
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div id="mapa" style="height: 500px; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lista de obras debajo del mapa -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>üìã Lista de Obras
                    </h5>
                </div>
                <div class="card-body">
                    {% if obras and obras.items %}
                        <div class="row">
                            {% for obra in obras.items %}
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="obra-item card h-100" data-obra-id="{{ obra.id }}">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="mb-1 fw-bold">{{ obra.nombre }}</h6>
                                            <span class="badge 
                                                {% if obra.estado == 'planificacion' %}bg-secondary
                                                {% elif obra.estado == 'en_curso' %}bg-success
                                                {% elif obra.estado == 'pausada' %}bg-warning
                                                {% elif obra.estado == 'finalizada' %}bg-info
                                                {% elif obra.estado == 'cancelada' %}bg-danger
                                                {% else %}bg-secondary{% endif %}">
                                                {{ obra.estado.replace('_', ' ').title() }}
                                            </span>
                                        </div>
                                        
                                        <p class="text-muted mb-1 small">
                                            <i class="fas fa-user me-1"></i>{{ obra.cliente }}
                                        </p>
                                        {% if obra.direccion %}
                                        <p class="text-muted mb-2 small">
                                            <i class="fas fa-map-marker-alt me-1"></i>{{ obra.direccion[:40] }}{% if obra.direccion|length > 40 %}...{% endif %}
                                        </p>
                                        {% endif %}
                                        
                                        <div class="row text-center mb-3">
                                            <div class="col-6">
                                                <div class="progress mb-1" style="height: 6px;">
                                                    <div class="progress-bar" role="progressbar" 
                                                         style="width: {{ obra.progreso }}%"></div>
                                                </div>
                                                <small class="fw-bold">{{ obra.progreso }}%</small>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-success fw-bold">
                                                    {% if obra.presupuesto_total %}
                                                        ${{ "{:,.0f}".format(obra.presupuesto_total) }}
                                                    {% else %}
                                                        Sin presupuesto
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card-footer">
                                        <div class="d-flex gap-2">
                                            <a href="{{ url_for('obras.detalle', id=obra.id) }}" class="btn btn-sm btn-outline-primary flex-fill">
                                                <i class="fas fa-eye me-1"></i>Detalles
                                            </a>
                                            {% if obra.latitud and obra.longitud %}
                                            <button class="btn btn-sm btn-outline-info d-flex align-items-center" onclick="centrarEnObra({{ obra.id }})" title="Ver en mapa">
                                                <i class="fas fa-map-marker-alt"></i>
                                                <span class="d-none d-md-inline ms-1">Ver en mapa</span>
                                            </button>
                                            {% elif obra.direccion %}
                                            <a class="btn btn-sm btn-outline-info d-flex align-items-center" href="https://www.google.com/maps/search/?api=1&query={{ obra.direccion|urlencode }}" target="_blank" rel="noopener" title="Abrir en Google Maps">
                                                <i class="fas fa-map-marker-alt"></i>
                                                <span class="d-none d-md-inline ms-1">Abrir mapa</span>
                                            </a>
                                            {% endif %}
                                            {% if current_user.rol == 'administrador' %}
                                            <button class="btn btn-sm btn-outline-danger d-flex align-items-center" onclick="confirmarEliminarObra({{ obra.id }}, '{{ obra.nombre }}')" title="Eliminar obra">
                                                <i class="fas fa-trash-alt"></i>
                                                <span class="d-none d-md-inline ms-1">Eliminar</span>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-building fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">No hay obras registradas</h6>
                            <p class="text-muted">
                                {% if current_user.rol in ['administrador', 'tecnico'] %}
                                    Las obras se crean desde el m√≥dulo de Presupuestos.
                                {% else %}
                                    No tienes obras asignadas actualmente.
                                {% endif %}
                            </p>
                        </div>

                        <!-- Controles de paginaci√≥n -->
                        {% if obras.pages > 1 %}
                        <nav aria-label="Paginaci√≥n" class="mt-4">
                            <ul class="pagination justify-content-center">
                                <li class="page-item {% if not obras.has_prev %}disabled{% endif %}">
                                    <a class="page-link" href="{{ url_for(request.endpoint, page=obras.prev_num, estado=estado, buscar=buscar) }}">Anterior</a>
                                </li>
                                {% for page_num in obras.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                                    {% if page_num %}
                                        <li class="page-item {% if page_num == obras.page %}active{% endif %}">
                                            <a class="page-link" href="{{ url_for(request.endpoint, page=page_num, estado=estado, buscar=buscar) }}">{{ page_num }}</a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled"><span class="page-link">...</span></li>
                                    {% endif %}
                                {% endfor %}
                                <li class="page-item {% if not obras.has_next %}disabled{% endif %}">
                                    <a class="page-link" href="{{ url_for(request.endpoint, page=obras.next_num, estado=estado, buscar=buscar) }}">Siguiente</a>
                                </li>
                            </ul>
                        </nav>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<style>
#mapa { height: 500px !important; width: 100% !important; z-index: 1; }
.leaflet-container { height: 500px !important; width: 100% !important; }
.leaflet-popup-content-wrapper { padding: 0 !important; border-radius: 12px !important; }
.leaflet-popup-content { margin: 0 !important; }
</style>
<script>
let mapa;
let marcadores = [];
const marcadoresPorId = {};

// Datos de obras inyectados como JSON seguro (evita problemas con caracteres especiales)
const OBRAS_DATA = [
{% for obra in obras.items if obras %}
{% if obra.latitud and obra.longitud %}
{
    id: {{ obra.id }},
    lat: {{ obra.latitud|float }},
    lng: {{ obra.longitud|float }},
    nombre: {{ obra.nombre|tojson }},
    cliente: {{ obra.cliente|tojson }},
    direccion: {{ (obra.direccion or 'Sin direcci√≥n')|tojson }},
    estado: {{ obra.estado|tojson }},
    progreso: {{ obra.progreso or 0 }}
},
{% endif %}
{% endfor %}
];

document.addEventListener('DOMContentLoaded', function() {
    var el = document.getElementById('mapa');
    if (!el) { el.innerHTML = '<p class="text-danger p-3">Contenedor no encontrado</p>'; return; }
    if (typeof L === 'undefined') { el.innerHTML = '<p class="text-danger p-3">Error: Leaflet no carg√≥. Recarg√° la p√°gina (Ctrl+F5).</p>'; return; }

    try {
        // Fix iconos
        delete L.Icon.Default.prototype._getIconUrl;
        L.Icon.Default.mergeOptions({
            iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-2x.png',
            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png'
        });

        mapa = L.map('mapa', { zoomControl: true }).setView([-34.6037, -58.3816], 11);

        L.tileLayer('https://mt{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&hl=es', {
            subdomains: ['0','1','2','3'],
            attribution: '&copy; Google Maps',
            maxZoom: 20
        }).addTo(mapa);

        setTimeout(function() { mapa.invalidateSize(); }, 300);

        // Agregar marcadores desde OBRAS_DATA
        var colores = { planificacion: '#6c757d', en_curso: '#198754', pausada: '#fd7e14', finalizada: '#0dcaf0', cancelada: '#dc3545' };

        OBRAS_DATA.forEach(function(o) {
            var colorEstado = colores[o.estado] || '#6c757d';
            var popup = '<div style="padding:12px;min-width:240px;">'
                + '<h6 style="margin:0 0 6px;font-weight:bold;">' + o.nombre + '</h6>'
                + '<p style="margin:0 0 4px;font-size:13px;color:#666;"><i class="fas fa-user me-1"></i>' + o.cliente + '</p>'
                + '<p style="margin:0 0 8px;font-size:13px;color:#666;"><i class="fas fa-map-marker-alt me-1 text-danger"></i>' + o.direccion + '</p>'
                + '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">'
                + '<span class="badge" style="background:' + colorEstado + ';color:#fff;">' + o.estado.replace('_', ' ') + '</span>'
                + '<strong style="color:#0d6efd;">' + o.progreso + '%</strong></div>'
                + '<div class="progress" style="height:5px;"><div class="progress-bar" style="width:' + o.progreso + '%;background:#0d6efd;"></div></div>'
                + '<div style="margin-top:10px;"><a href="/obras/' + o.id + '" class="btn btn-primary btn-sm w-100"><i class="fas fa-eye me-1"></i>Ver Detalles</a></div>'
                + '</div>';
            var m = L.marker([o.lat, o.lng]).addTo(mapa).bindPopup(popup);
            marcadores.push(m);
            marcadoresPorId[o.id] = m;
        });

        if (marcadores.length > 0) {
            mapa.fitBounds(L.featureGroup(marcadores).getBounds().pad(0.1));
        }

    } catch (err) {
        el.innerHTML = '<div class="alert alert-danger m-3"><i class="fas fa-exclamation-triangle me-2"></i>Error al cargar mapa: ' + err.message + '</div>';
    }
});

function centrarEnObra(obraId) {
    if (!mapa) {
        return;
    }
    const marcador = marcadoresPorId[obraId];
    if (!marcador) {
        console.warn('No se encontr√≥ marcador para la obra', obraId);
        return;
    }
    const posicion = marcador.getLatLng();
    mapa.setView(posicion, 16);
    marcador.openPopup();
    console.log('üéØ Centrado en obra:', obraId, posicion);
}

// Funci√≥n para ver detalles de la obra
function verDetallesObra(obraId) {
    console.log(`üèóÔ∏è Abriendo detalles de obra ID: ${obraId}`);
    window.location.href = `/obras/${obraId}`;
}

// Funci√≥n para abrir ventana de clima en pantalla completa
async function abrirVentanaClima(lat, lng, nombreObra, direccion, obraId) {
    console.log(`‚òÅÔ∏è Abriendo ventana de clima para ${nombreObra}: ${lat}, ${lng}`);

    // Crear ventana modal de clima (siempre mostrar, incluso si hay que geocodificar)
    const modalHTML = `
        <div class="modal fade" id="modalClima" tabindex="-1" aria-labelledby="modalClimaLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="modalClimaLabel">
                            <i class="fas fa-cloud-sun me-2"></i>Informaci√≥n Clim√°tica - ${nombreObra}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="contenidoClima">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2" id="mensajeCargaClima">Cargando informaci√≥n clim√°tica...</p>
                        </div>
                    </div>
                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-outline-primary" onclick="verDetallesObra(${obraId})">
                            <i class="fas fa-eye me-1"></i>Ver Detalles de la Obra
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Agregar modal al DOM si no existe
    let modalExistente = document.getElementById('modalClima');
    if (modalExistente) {
        modalExistente.remove();
    }

    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalClima'));
    modal.show();

    // Si no hay coordenadas, intentar geocodificar la direcci√≥n
    if (!lat || !lng || lat === 'null' || lng === 'null' || lat === null || lng === null) {
        console.log(`üìç Sin coordenadas, intentando geocodificar: ${direccion}`);

        if (!direccion || direccion === 'Sin direcci√≥n') {
            document.getElementById('contenidoClima').innerHTML = `
                <div class="alert alert-warning">
                    <h5 class="alert-heading"><i class="fas fa-map-marker-alt me-2"></i>Sin ubicaci√≥n</h5>
                    <p class="mb-2">Esta obra no tiene una direcci√≥n configurada.</p>
                    <p class="mb-0">Por favor, edita la obra y agrega una direcci√≥n para ver la informaci√≥n clim√°tica.</p>
                    <hr>
                    <a href="/obras/${obraId}/editar" class="btn btn-warning btn-sm">
                        <i class="fas fa-edit me-1"></i>Editar Obra
                    </a>
                </div>
            `;
            return;
        }

        document.getElementById('mensajeCargaClima').textContent = 'Buscando ubicaci√≥n de la obra...';

        try {
            // Intentar geocodificar la direcci√≥n
            const response = await fetch(`/obras/api/buscar-direcciones?q=${encodeURIComponent(direccion)}`);
            if (response.ok) {
                const resultados = await response.json();
                if (resultados && resultados.length > 0) {
                    lat = resultados[0].lat;
                    lng = resultados[0].lng;
                    console.log(`‚úÖ Geocodificaci√≥n exitosa: ${lat}, ${lng}`);

                    // Actualizar coordenadas en la base de datos (en background)
                    fetch(`/obras/${obraId}/actualizar-coordenadas`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': CSRF_TOKEN
                        },
                        body: JSON.stringify({ latitud: lat, longitud: lng })
                    }).catch(err => console.warn('No se pudieron guardar las coordenadas:', err));
                } else {
                    throw new Error('No se encontr√≥ la ubicaci√≥n');
                }
            } else {
                throw new Error('Error al buscar la direcci√≥n');
            }
        } catch (error) {
            console.error('‚ùå Error al geocodificar:', error);
            document.getElementById('contenidoClima').innerHTML = `
                <div class="alert alert-warning">
                    <h5 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Ubicaci√≥n no encontrada</h5>
                    <p class="mb-2">No se pudo determinar la ubicaci√≥n de esta obra.</p>
                    <p class="mb-0"><strong>Direcci√≥n registrada:</strong> ${direccion}</p>
                    <hr>
                    <p class="small mb-2">Prueba editando la obra con una direcci√≥n m√°s espec√≠fica (ej: "Av. Corrientes 1234, Buenos Aires").</p>
                    <a href="/obras/${obraId}/editar" class="btn btn-warning btn-sm">
                        <i class="fas fa-edit me-1"></i>Editar Obra
                    </a>
                </div>
            `;
            return;
        }
    }

    // Cargar datos del clima
    document.getElementById('mensajeCargaClima').textContent = 'Cargando informaci√≥n clim√°tica...';
    cargarDatosClima(lat, lng, nombreObra, direccion);
}

// Funci√≥n para cargar datos de clima en el modal
async function cargarDatosClima(lat, lng, nombreObra, direccion) {
    const contenidoDiv = document.getElementById('contenidoClima');

    console.log(`üå§Ô∏è Cargando clima para coordenadas: ${lat}, ${lng}`);

    // Validar que las coordenadas sean n√∫meros v√°lidos
    lat = parseFloat(lat);
    lng = parseFloat(lng);

    if (isNaN(lat) || isNaN(lng)) {
        console.error('‚ùå Coordenadas inv√°lidas:', lat, lng);
        contenidoDiv.innerHTML = `
            <div class="alert alert-danger">
                <h5 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Error</h5>
                <p class="mb-0">Las coordenadas de la obra son inv√°lidas. Por favor, edita la obra y corrige la direcci√≥n.</p>
            </div>
        `;
        return;
    }

    try {
        // API de Open-Meteo - clima actual + pron√≥stico 7 d√≠as
        const urlActual = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true&timezone=auto`;
        const urlPronostico = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto`;

        console.log('üì° Consultando Open-Meteo:', urlActual);

        const [climaActual, pronostico] = await Promise.all([
            fetch(urlActual),
            fetch(urlPronostico)
        ]);

        if (!climaActual.ok || !pronostico.ok) {
            const errorText = await climaActual.text();
            console.error('‚ùå Error de API:', climaActual.status, errorText);
            throw new Error(`Error de API: ${climaActual.status}`);
        }

        const dataActual = await climaActual.json();
        const dataPronostico = await pronostico.json();

        console.log('‚úÖ Datos recibidos:', dataActual, dataPronostico);

        if (!dataActual.current_weather) {
            throw new Error('La API no devolvi√≥ datos del clima actual');
        }
        
        const clima = dataActual.current_weather;
        const pronos = dataPronostico.daily;
        
        // Convertir c√≥digo del tiempo a descripci√≥n
        const descripcionClima = obtenerDescripcionClima(clima.weathercode);
        const iconoClima = obtenerIconoClima(clima.weathercode);
        
        // Generar pron√≥stico de 7 d√≠as
        let pronosticoHTML = '';
        for (let i = 0; i < Math.min(7, pronos.time.length); i++) {
            const fecha = new Date(pronos.time[i]);
            const dia = fecha.toLocaleDateString('es-ES', { weekday: 'long' });
            const diaCapitalizado = dia.charAt(0).toUpperCase() + dia.slice(1);
            const fechaFormateada = fecha.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
            const tempMax = Math.round(pronos.temperature_2m_max[i]);
            const tempMin = Math.round(pronos.temperature_2m_min[i]);
            const weathercode = pronos.weathercode[i];
            const iconoDia = obtenerIconoClima(weathercode);
            const descripcionDia = obtenerDescripcionClima(weathercode);
            
            pronosticoHTML += `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="card-body text-center p-3">
                            <h6 class="card-title fw-bold text-primary">${diaCapitalizado}</h6>
                            <p class="small text-muted mb-2">${fechaFormateada}</p>
                            <div class="mb-3">
                                <i class="${iconoDia}" style="font-size: 32px;"></i>
                            </div>
                            <div class="mb-2">
                                <span class="h5 fw-bold text-dark">${tempMax}¬∞</span>
                                <span class="text-muted ms-2">${tempMin}¬∞</span>
                            </div>
                            <p class="small text-muted mb-0">${descripcionDia}</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Crear elementos de forma segura sin usar interpolaci√≥n directa
        contenidoDiv.innerHTML = `
            <div class="row">
                <!-- Informaci√≥n de la obra -->
                <div class="col-12 mb-4">
                    <div class="card border-0 bg-light">
                        <div class="card-body">
                            <h6 class="card-title text-primary mb-2">
                                <i class="fas fa-building me-2"></i><span class="obra-nombre"></span>
                            </h6>
                            <p class="mb-0 small text-muted">
                                <i class="fas fa-map-marker-alt me-1"></i><span class="obra-direccion"></span>
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Clima actual -->
                <div class="col-12 mb-4">
                    <div class="card border-0 shadow-sm bg-primary text-white">
                        <div class="card-body text-center p-4">
                            <h5 class="card-title fw-bold mb-3">Clima Actual</h5>
                            <div class="mb-3">
                                <i class="icono-clima" style="font-size: 48px;"></i>
                            </div>
                            <div class="h2 fw-bold mb-2"><span class="temperatura"></span>¬∞C</div>
                            <p class="mb-2 descripcion-clima"></p>
                            <p class="small mb-0">
                                <i class="fas fa-wind me-1"></i>Viento: <span class="velocidad-viento"></span> km/h
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Pron√≥stico 7 d√≠as -->
                <div class="col-12">
                    <h5 class="mb-3 fw-bold text-center">
                        <i class="fas fa-calendar-week me-2"></i>Pron√≥stico 7 d√≠as
                    </h5>
                    <div class="row pronostico-container">
                    </div>
                </div>
            </div>
        `;

        // Insertar datos de forma segura usando textContent
        contenidoDiv.querySelector('.obra-nombre').textContent = nombreObra;
        contenidoDiv.querySelector('.obra-direccion').textContent = direccion || 'Sin direcci√≥n especificada';
        contenidoDiv.querySelector('.icono-clima').className = iconoClima;
        contenidoDiv.querySelector('.temperatura').textContent = clima.temperature;
        contenidoDiv.querySelector('.descripcion-clima').textContent = descripcionClima;
        contenidoDiv.querySelector('.velocidad-viento').textContent = clima.windspeed;
        contenidoDiv.querySelector('.pronostico-container').innerHTML = pronosticoHTML;

        console.log(`‚úÖ Clima completo cargado para obra`);
        
    } catch (error) {
        console.error('‚ùå Error al cargar clima:', error);
        contenidoDiv.innerHTML = `
            <div class="alert alert-danger">
                <h5 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Error</h5>
                <p class="mb-2">No se pudo cargar la informaci√≥n clim√°tica.</p>
                <p class="mb-0 small"><strong>Detalle:</strong> ${error.message}</p>
                <p class="mb-0 small"><strong>Coordenadas:</strong> ${lat}, ${lng}</p>
                <hr>
                <button class="btn btn-outline-danger btn-sm" onclick="cargarDatosClima(${lat}, ${lng}, '${nombreObra.replace(/'/g, "\\'")}', '${(direccion || '').replace(/'/g, "\\'")}')">
                    <i class="fas fa-redo me-1"></i>Reintentar
                </button>
            </div>
        `;
    }
}

function obtenerDescripcionClima(codigo) {
    const descripciones = {
        0: 'Despejado',
        1: 'Mayormente despejado', 
        2: 'Parcialmente nublado',
        3: 'Nublado',
        45: 'Neblina',
        48: 'Neblina con escarcha',
        51: 'Llovizna ligera',
        53: 'Llovizna moderada', 
        55: 'Llovizna intensa',
        56: 'Llovizna helada ligera',
        57: 'Llovizna helada intensa',
        61: 'Lluvia ligera',
        63: 'Lluvia moderada',
        65: 'Lluvia intensa',
        66: 'Lluvia helada ligera',
        67: 'Lluvia helada intensa',
        71: 'Nevada ligera',
        73: 'Nevada moderada',
        75: 'Nevada intensa',
        77: 'Granizo',
        80: 'Chubascos ligeros',
        81: 'Chubascos moderados',
        82: 'Chubascos intensos',
        85: 'Chubascos de nieve ligeros',
        86: 'Chubascos de nieve intensos',
        95: 'Tormenta',
        96: 'Tormenta con granizo ligero',
        99: 'Tormenta con granizo intenso'
    };
    
    console.log(`üå§Ô∏è C√≥digo de clima recibido: ${codigo}`);
    const descripcion = descripciones[codigo];
    if (!descripcion) {
        console.warn(`‚ö†Ô∏è C√≥digo de clima desconocido: ${codigo}`);
        return `C√≥digo ${codigo}`;
    }
    return descripcion;
}

function obtenerIconoClima(codigo) {
    // Despejado y mayormente despejado
    if (codigo === 0 || codigo === 1) return 'fas fa-sun text-warning';
    
    // Parcialmente nublado y nublado
    if (codigo === 2 || codigo === 3) return 'fas fa-cloud text-secondary';
    
    // Neblina
    if (codigo >= 45 && codigo <= 48) return 'fas fa-smog text-muted';
    
    // Llovizna y lluvia (incluyendo helada)
    if ((codigo >= 51 && codigo <= 67)) return 'fas fa-cloud-rain text-primary';
    
    // Nieve y granizo
    if ((codigo >= 71 && codigo <= 77) || (codigo >= 85 && codigo <= 86)) return 'fas fa-snowflake text-info';
    
    // Chubascos
    if (codigo >= 80 && codigo <= 82) return 'fas fa-cloud-showers-heavy text-primary';
    
    // Tormentas
    if (codigo >= 95 && codigo <= 99) return 'fas fa-bolt text-danger';
    
    // Default para c√≥digos no reconocidos
    return 'fas fa-cloud text-secondary';
}

// Redimensionar mapa cuando sea necesario
window.addEventListener('resize', function() {
    if (mapa) {
        setTimeout(() => {
            mapa.invalidateSize();
            console.log('üîÑ Mapa redimensionado');
        }, 200);
    }
});

// CSRF Token para formularios din√°micos
const CSRF_TOKEN = "{{ csrf_token() }}";

// Funci√≥n para confirmar eliminaci√≥n de obra
function confirmarEliminarObra(obraId, obraNombre) {
    if (confirm(`¬øEst√°s seguro de que deseas eliminar la obra "${obraNombre}"?\n\nEsta acci√≥n eliminar√°:\n‚Ä¢ La obra y todos sus datos\n‚Ä¢ Todas las etapas y tareas asociadas\n‚Ä¢ Todas las asignaciones de personal\n‚Ä¢ Todas las certificaciones\n\nEsta acci√≥n NO se puede deshacer.`)) {
        // Crear formulario din√°mico para enviar eliminaci√≥n
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/obras/eliminar/${obraId}`;

        // Agregar token CSRF
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = CSRF_TOKEN;
        form.appendChild(csrfInput);

        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}