{% block scripts %}
<!-- Exponer el ID de la obra ANTES de cargar wizard.js -->
<script>
  window.obraId = {{ obra.id }};
</script>

<!-- üî• WIZARD JavaScript (usa window.obraId) -->
<script src="{{ url_for('static', filename='js/wizard.js') }}"></script>

<style>
.cursor-pointer { cursor: pointer !important; } 
.cursor-pointer:hover { color: #0056b3 !important; }
</style>

<script>
function abrirModalTarea(etapaId, nombreEtapa) {
    const form = document.getElementById('formNuevaTarea');
    form.action = '/obras/tareas/crear';

    let etapaIdInput = form.querySelector('input[name="etapa_id"]');
    if (!etapaIdInput) {
        etapaIdInput = document.createElement('input');
        etapaIdInput.type = 'hidden';
        etapaIdInput.name = 'etapa_id';
        form.appendChild(etapaIdInput);
    }
    etapaIdInput.value = etapaId;

    let obraIdInput = form.querySelector('input[name="obra_id"]');
    if (!obraIdInput) {
        obraIdInput = document.createElement('input');
        obraIdInput.type = 'hidden';
        obraIdInput.name = 'obra_id';
        form.appendChild(obraIdInput);
    }
    obraIdInput.value = window.obraId || (window.location.pathname.match(/\/obras\/(\d+)/)?.[1] ?? '');

    document.getElementById('nombreEtapa').textContent = nombreEtapa;

    const tareasInput = document.querySelector('#nuevaTareaModal input[name="nombre"]');
    const horasInput = document.querySelector('#nuevaTareaModal input[name="horas_estimadas"]');
    const responsableSelect = document.querySelector('#nuevaTareaModal select[name="responsable_id"]');
    const fechaInicioInput = document.querySelector('#nuevaTareaModal input[name="fecha_inicio_plan"]');
    const fechaFinInput = document.querySelector('#nuevaTareaModal input[name="fecha_fin_plan"]');

    tareasInput.value = '';
    if (horasInput) horasInput.value = '';
    if (responsableSelect) responsableSelect.value = '';
    if (fechaInicioInput) fechaInicioInput.value = '';
    if (fechaFinInput) fechaFinInput.value = '';

    document.getElementById('listaTareasSugeridas').innerHTML = '';
    document.getElementById('tareasSuperidasContainer').style.display = 'none';

    const tareasDisponibles = obtenerTareasPredefinidas(nombreEtapa);
    if (tareasDisponibles && tareasDisponibles.length > 0) {
        mostrarTareasSugeridas(tareasDisponibles, nombreEtapa);
        tareasInput.placeholder = `Ej: ${tareasDisponibles[0].nombre || 'Nueva tarea'}`;
    } else {
        tareasInput.placeholder = 'Nombre de la tarea';
    }
    tareasInput.disabled = false;

    new bootstrap.Modal(document.getElementById('nuevaTareaModal')).show();
}

// Datos de tareas predefinidas cargados desde Python
const TAREAS_PREDEFINIDAS_DICT = {{ TAREAS_POR_ETAPA|tojson|safe }};

function obtenerTareasPredefinidas(nombreEtapa) {
    try { return TAREAS_PREDEFINIDAS_DICT[nombreEtapa] || []; }
    catch { return []; }
}

function mostrarTareasSugeridas(tareas, nombreEtapa) {
    if (!tareas || tareas.length === 0) return;
    const container = document.getElementById('tareasSuperidasContainer');
    const listaTareas = document.getElementById('listaTareasSugeridas');
    const etapaSpan = document.getElementById('etapaSeleccionada');
    etapaSpan.textContent = nombreEtapa;

    const checkboxesHTML = tareas.map((tarea, index) => `
        <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" name="sugeridas[]" value="${index}" id="tareaCheck${index}"
                   data-nombre="${tarea.nombre}" onchange="actualizarSeleccionSugeridas()">
            <label class="form-check-label" for="tareaCheck${index}">
                <strong>${tarea.nombre}</strong><br>
                <small class="text-muted">${tarea.descripcion || 'Sin descripci√≥n'}</small>
            </label>
        </div>
    `).join('');
    listaTareas.innerHTML = checkboxesHTML + `
        <div class="form-text mt-2">
            <i class="fas fa-info-circle"></i> Si seleccion√°s varias sugeridas, se crear√°n varias tareas con el mismo responsable, horas y fechas.
        </div>`;
    container.style.display = 'block';
    window.tareasActuales = tareas;
}

function actualizarSeleccionSugeridas() {
    const checks = document.querySelectorAll('input[name="sugeridas[]"]:checked');
    const tareasInput = document.querySelector('#nuevaTareaModal input[name="nombre"]');
    if (checks.length === 0) {
        tareasInput.disabled = false; tareasInput.value = ''; tareasInput.placeholder = 'Nombre de la tarea';
    } else if (checks.length === 1) {
        const tarea = window.tareasActuales[checks[0].value];
        tareasInput.disabled = false; tareasInput.value = tarea.nombre;
    } else {
        tareasInput.disabled = true; tareasInput.value = `${checks.length} tareas seleccionadas`;
        tareasInput.placeholder = `${checks.length} tareas seleccionadas`;
    }
}

function toggleTareasEtapa(etapaId) {
    const tareasDiv = document.getElementById(`tareas-${etapaId}`);
    const chevron = document.getElementById(`chevron-${etapaId}`);
    const container = document.getElementById(`tareas-container-${etapaId}`);
    if (tareasDiv.classList.contains('show')) {
        tareasDiv.classList.remove('show');
        chevron.classList.remove('fa-chevron-up'); chevron.classList.add('fa-chevron-down');
    } else {
        tareasDiv.classList.add('show');
        chevron.classList.remove('fa-chevron-down'); chevron.classList.add('fa-chevron-up');
        if (container.innerHTML.includes('spinner-border')) cargarTareasEtapa(etapaId);
    }
}

function cargarTareasEtapa(etapaId) {
    const container = document.getElementById(`tareas-container-${etapaId}`);
    fetch(`/obras/etapas/${etapaId}/tareas`)
      .then(r => r.json())
      .then(data => container.innerHTML = data.ok ? data.html : '<div class="text-center py-2"><small class="text-danger">Error al cargar tareas</small></div>')
      .catch(() => container.innerHTML = '<div class="text-center py-2"><small class="text-danger">Error al cargar tareas</small></div>');
}

function getBadgeClass(estado) {
  switch(estado){case 'completada':return'bg-success';case'en_progreso':return'bg-warning';case'pausada':return'bg-secondary';default:return'bg-info';}
}

function seleccionarTodas(){ document.querySelectorAll('input[name="etapas[]"]').forEach(c=>c.checked=true); }
function deseleccionarTodas(){ document.querySelectorAll('input[name="etapas[]"]').forEach(c=>c.checked=false); }

function actualizarEstadoTarea(tareaId, nuevoEstado) {
    if (!confirm(`¬øCambiar estado de la tarea a "${nuevoEstado}"?`)) return;
    const form = document.createElement('form');
    form.method = 'POST'; form.action = `/obras/tarea/${tareaId}/actualizar_estado`;
    const hidden = document.createElement('input');
    hidden.type='hidden'; hidden.name='estado'; hidden.value=nuevoEstado;
    form.appendChild(hidden); document.body.appendChild(form); form.submit();
}

// Validaci√≥n del modal de certificaci√≥n
document.addEventListener('DOMContentLoaded', function() {
  const certificarForm = document.querySelector('#certificarAvanceModal form');
  if (!certificarForm) return;
  certificarForm.addEventListener('submit', function(e){
    const porcentaje = parseFloat(document.getElementById('porcentaje_avance').value);
    const progresoActual = {{ obra.progreso }};
    if (porcentaje <= 0) { e.preventDefault(); alert('El porcentaje debe ser mayor a 0'); return; }
    if (porcentaje + progresoActual > 100) {
      if (!confirm(`El total ser√≠a ${porcentaje + progresoActual}%, excediendo el 100%. ¬øContinuar?`)) {
        e.preventDefault(); return;
      }
    }
  });
});

// ==== Selecci√≥n de etapas/tareas para modal de ‚ÄúNueva etapa‚Äù (cat√°logo local) ====
let etapasSeleccionadasObra = [];
let tareasSeleccionadasObra = [];

const ETAPAS_PREDEFINIDAS_OBRA = [ /* ... (tu lista completa de etapas tal como la ten√≠as) ... */ ];
const TAREAS_POR_ETAPA_OBRA = { /* ... (tu mapping completo tal como lo ten√≠as) ... */ };

document.getElementById('nuevaEtapaModal')?.addEventListener('shown.bs.modal', function () {
  cargarEtapasPredefinidas();
  etapasSeleccionadasObra = [];
  tareasSeleccionadasObra = [];
  actualizarVistaEtapasSeleccionadas();
  actualizarTareasPredefinidas();
});

function cargarEtapasPredefinidas() {
  const container = document.getElementById('etapasPredefinidas'); container.innerHTML = '';
  ETAPAS_PREDEFINIDAS_OBRA.forEach((etapa, index) => {
    const ya = etapasSeleccionadasObra.some(e => e.nombre === etapa.nombre);
    container.insertAdjacentHTML('beforeend', `
      <div class="col-md-6 mb-2">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="etapa_obra_${index}" ${ya?'checked':''}
                 onchange="toggleEtapaPredefinidaObra(${index})">
          <label class="form-check-label" for="etapa_obra_${index}">
            <strong>${etapa.nombre}</strong><br><small class="text-muted">${etapa.descripcion}</small>
          </label>
        </div>
      </div>`);
  });
}

function toggleEtapaPredefinidaObra(index) {
  const etapa = ETAPAS_PREDEFINIDAS_OBRA[index];
  const cb = document.getElementById(`etapa_obra_${index}`);
  if (cb.checked) {
    if (!etapasSeleccionadasObra.some(e => e.nombre === etapa.nombre)) {
      etapasSeleccionadasObra.push({ nombre: etapa.nombre, descripcion: etapa.descripcion, orden: etapa.orden, personalizada: false });
    }
  } else {
    etapasSeleccionadasObra = etapasSeleccionadasObra.filter(e => e.nombre !== etapa.nombre);
  }
  actualizarVistaEtapasSeleccionadas(); actualizarTareasPredefinidas();
}

function agregarEtapaPersonalizadaObra() {
  const nombre = document.getElementById('etapaPersonalizadaNombre').value.trim();
  const descripcion = document.getElementById('etapaPersonalizadaDescripcion').value.trim();
  if (!nombre) { alert('Ingresa el nombre de la etapa personalizada'); return; }
  if (etapasSeleccionadasObra.some(e => e.nombre.toLowerCase() === nombre.toLowerCase())) { alert('Ya existe una etapa con ese nombre'); return; }
  etapasSeleccionadasObra.push({ nombre, descripcion: descripcion || 'Etapa personalizada', orden: etapasSeleccionadasObra.length + 100, personalizada: true });
  document.getElementById('etapaPersonalizadaNombre').value=''; document.getElementById('etapaPersonalizadaDescripcion').value='';
  actualizarVistaEtapasSeleccionadas();
}

function actualizarVistaEtapasSeleccionadas() {
  const container = document.getElementById('etapasSeleccionadasContainer');
  const lista = document.getElementById('listaEtapasSeleccionadas');
  if (etapasSeleccionadasObra.length === 0) { container.style.display='none'; return; }
  container.style.display = 'block';
  const etapasOrdenadas = [...etapasSeleccionadasObra].sort((a,b)=>a.orden-b.orden);
  let html = '<div class="row">';
  etapasOrdenadas.forEach(etapa => {
    const badge = etapa.personalizada ? '<span class="badge bg-success ms-1">Personalizada</span>' : '';
    html += `
      <div class="col-md-6 mb-2">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <strong class="${etapa.personalizada ? 'text-success' : 'text-primary'}">${etapa.nombre}</strong>${badge}
            <br><small class="text-muted">${etapa.descripcion}</small>
          </div>
          <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removerEtapaObra('${etapa.nombre}')">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>`;
  });
  html += '</div>';
  lista.innerHTML = html;
}

function removerEtapaObra(nombreEtapa) {
  etapasSeleccionadasObra = etapasSeleccionadasObra.filter(e => e.nombre !== nombreEtapa);
  actualizarVistaEtapasSeleccionadas(); cargarEtapasPredefinidas();
}

function confirmarEtapasSeleccionadasObra() {
  if (etapasSeleccionadasObra.length === 0) { alert('Selecciona al menos una etapa'); return; }
  const form = document.createElement('form'); form.method='POST'; form.action='{{ url_for("obras.agregar_etapas", id=obra.id) }}';
  etapasSeleccionadasObra.forEach(etapa => {
    const input = document.createElement('input'); input.type='hidden'; input.name='etapas[]';
    const tareasEtapa = tareasSeleccionadasObra.filter(t=>t.etapa===etapa.nombre);
    input.value = JSON.stringify({ nombre: etapa.nombre, descripcion: etapa.descripcion, orden: etapa.orden,
      tareas: tareasEtapa.map(t=>({ nombre: t.nombre, personalizada: t.personalizada })) });
    form.appendChild(input);
  });
  document.body.appendChild(form); form.submit();
}

function actualizarTareasPredefinidas() {
  const container = document.getElementById('tareasContainer');
  const tareasDiv = document.getElementById('tareasPredefinidas');
  if (etapasSeleccionadasObra.length === 0) { container.style.display='none'; return; }
  container.style.display='block';
  let html = '';
  etapasSeleccionadasObra.forEach(etapa => {
    const tareas = TAREAS_POR_ETAPA_OBRA[etapa.nombre] || [];
    if (tareas.length === 0) return;
    html += `
      <div class="mb-3 border-bottom pb-2">
        <h6 class="text-primary mb-2"><i class="fas fa-layer-group me-1"></i>${etapa.nombre}
          <small class="text-muted">(${tareas.length} tareas)</small></h6>
        <div class="row">`;
    tareas.forEach((tarea, idx) => {
      const tareaId = `tarea_${etapa.nombre}_${idx}`;
      const ya = tareasSeleccionadasObra.some(t => t.etapa === etapa.nombre && t.nombre === tarea);
      html += `
        <div class="col-md-6 mb-2">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="${tareaId}" ${ya?'checked':''}
                   onchange="toggleTareaPredefinida('${etapa.nombre}', '${tarea.replace(/'/g,"\\'")}', ${idx})">
            <label class="form-check-label" for="${tareaId}" style="line-height:1.4;">${tarea}</label>
          </div>
        </div>`;
    });
    html += `
        </div>
        <div class="mt-2">
          <button type="button" class="btn btn-sm btn-outline-success" onclick="seleccionarTodasTareasEtapa('${etapa.nombre}')">
            <i class="fas fa-check-square me-1"></i>Seleccionar Todas
          </button>
          <button type="button" class="btn btn-sm btn-outline-secondary ms-1" onclick="deseleccionarTodasTareasEtapa('${etapa.nombre}')">
            <i class="fas fa-square me-1"></i>Deseleccionar Todas
          </button>
          <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="mostrarFormularioTareaPersonalizada('${etapa.nombre}')">
            <i class="fas fa-plus me-1"></i>Agregar Tarea Personalizada
          </button>
        </div>
        <div id="formTareaPersonalizada_${etapa.nombre}" class="mt-2" style="display:none;">
          <div class="input-group input-group-sm">
            <input type="text" class="form-control" placeholder="Nombre de la tarea personalizada" id="inputTareaPersonalizada_${etapa.nombre}">
            <button class="btn btn-success" type="button" onclick="agregarTareaPersonalizada('${etapa.nombre}')"><i class="fas fa-plus"></i></button>
            <button class="btn btn-secondary" type="button" onclick="ocultarFormularioTareaPersonalizada('${etapa.nombre}')"><i class="fas fa-times"></i></button>
          </div>
        </div>
      </div>`;
  });
  tareasDiv.innerHTML = html || '<p class="text-muted text-center">Selecciona etapas para ver las tareas asociadas</p>';
}

function toggleTareaPredefinida(etapaNombre, tareaNombre, index) {
  const tareaId = `tarea_${etapaNombre}_${index}`;
  const cb = document.getElementById(tareaId);
  if (cb.checked) {
    if (!tareasSeleccionadasObra.some(t => t.etapa===etapaNombre && t.nombre===tareaNombre)) {
      tareasSeleccionadasObra.push({ etapa: etapaNombre, nombre: tareaNombre, personalizada: false });
    }
  } else {
    tareasSeleccionadasObra = tareasSeleccionadasObra.filter(t => !(t.etapa===etapaNombre && t.nombre===tareaNombre));
  }
}

function seleccionarTodasTareasEtapa(etapaNombre) {
  (TAREAS_POR_ETAPA_OBRA[etapaNombre]||[]).forEach((tarea, idx) => {
    const id = `tarea_${etapaNombre}_${idx}`; const cb = document.getElementById(id);
    if (cb && !cb.checked) { cb.checked = true; tareasSeleccionadasObra.push({ etapa: etapaNombre, nombre: tarea, personalizada: false }); }
  });
}

function deseleccionarTodasTareasEtapa(etapaNombre) {
  (TAREAS_POR_ETAPA_OBRA[etapaNombre]||[]).forEach((_, idx) => {
    const id = `tarea_${etapaNombre}_${idx}`; const cb = document.getElementById(id);
    if (cb && cb.checked) cb.checked = false;
  });
  tareasSeleccionadasObra = tareasSeleccionadasObra.filter(t => t.etapa !== etapaNombre);
}

function mostrarFormularioTareaPersonalizada(etapaNombre) {
  document.getElementById(`formTareaPersonalizada_${etapaNombre}`).style.display = 'block';
  document.getElementById(`inputTareaPersonalizada_${etapaNombre}`).focus();
}
function ocultarFormularioTareaPersonalizada(etapaNombre) {
  document.getElementById(`formTareaPersonalizada_${etapaNombre}`).style.display = 'none';
  document.getElementById(`inputTareaPersonalizada_${etapaNombre}`).value = '';
}
function agregarTareaPersonalizada(etapaNombre) {
  const input = document.getElementById(`inputTareaPersonalizada_${etapaNombre}`);
  const nombre = input.value.trim();
  if (!nombre) { alert('Ingresa el nombre de la tarea personalizada'); return; }
  if (tareasSeleccionadasObra.some(t => t.etapa===etapaNombre && t.nombre.toLowerCase()===nombre.toLowerCase())) { alert('Ya existe una tarea con ese nombre en esta etapa'); return; }
  tareasSeleccionadasObra.push({ etapa: etapaNombre, nombre, personalizada: true });
  input.value=''; ocultarFormularioTareaPersonalizada(etapaNombre); actualizarTareasPredefinidas();
}

// Confirmar/eliminar Etapas y Tareas individuales
function confirmarEliminarEtapa(etapaId, nombreEtapa) {
  if (confirm(`¬øEliminar la etapa "${nombreEtapa}" y todas sus tareas?`)) eliminarEtapa(etapaId);
}
function eliminarEtapa(etapaId) {
  const form = document.createElement('form');
  form.method='POST'; form.action=`/obras/{{ obra.id }}/etapas/${etapaId}/eliminar`;
  const csrfToken = document.querySelector('meta[name="csrf-token"]');
  if (csrfToken) {
    const t = document.createElement('input'); t.type='hidden'; t.name='csrf_token'; t.value=csrfToken.content; form.appendChild(t);
  }
  document.body.appendChild(form); form.submit();
}
function confirmarEliminarTarea(tareaId, nombreTarea) {
  if (confirm(`¬øEliminar la tarea "${nombreTarea}"?`)) eliminarTarea(tareaId);
}
function eliminarTarea(tareaId) {
  fetch(`/obras/tareas/eliminar/${tareaId}`, { method:'POST', headers:{'Content-Type':'application/json'} })
    .then(r=>r.json()).then(d=>{ if(d.success) location.reload(); else alert(d.error||'Error al eliminar la tarea'); })
    .catch(()=> alert('Error al eliminar la tarea'));
}

// Selecci√≥n m√∫ltiple de tareas (UI simple)
{% if can_manage %}
(function(){
  const btnSel = document.getElementById('btn-select-multi');
  const btnCancel = document.getElementById('btn-cancel-selection'); 
  const btnDelete = document.getElementById('btn-delete-selected');
  const btnAssign = document.getElementById('btn-assign-selected');

  function updateCounts() {
      const n = document.querySelectorAll('.task-select:not(.d-none):checked').length;
      document.getElementById('btn-eliminar-count')?.textContent = n;
      document.getElementById('btn-asignar-count')?.textContent = n;
      if (btnDelete) btnDelete.disabled = n === 0;
      if (btnAssign) btnAssign.disabled = n === 0;
  }

  btnSel?.addEventListener('click', () => {
      document.querySelectorAll('.task-select').forEach(cb => cb.classList.remove('d-none'));
      btnSel.style.display = 'none';
      btnCancel.style.display = 'inline-block';
      btnDelete?.classList.remove('d-none');
      btnAssign?.classList.remove('d-none');
      updateCounts();
  });

  btnCancel?.addEventListener('click', () => {
      document.querySelectorAll('.task-select').forEach(cb => { cb.checked = false; cb.classList.add('d-none'); });
      btnSel.style.display = 'inline-block';
      btnCancel.style.display = 'none';
      btnDelete?.classList.add('d-none');
      btnAssign?.classList.add('d-none');
      updateCounts();
  });

  document.addEventListener('change', (e) => { if (e.target.matches('.task-select')) updateCounts(); });

  btnDelete?.addEventListener('click', async () => {
      const ids = Array.from(document.querySelectorAll('.task-select:checked')).map(c=>c.value);
      if (!ids.length) return;
      if (!confirm(`¬øEliminar ${ids.length} tareas seleccionadas?`)) return;
      const r = await fetch('/obras/api/tareas/bulk_delete', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ids }) });
      const j = await r.json();
      if (j.ok) location.reload(); else alert(j.error || 'No se pudo eliminar.');
  });

  btnAssign?.addEventListener('click', () => {
      const ids = Array.from(document.querySelectorAll('.task-select:checked')).map(c=>c.value);
      document.getElementById('tareas-seleccionadas-info').textContent = `${ids.length} tareas seleccionadas`;
      document.querySelectorAll('#asignacionMasivaModal input[name="user_ids[]"]').forEach(cb => { cb.checked = false; });
  });
})();
{% endif %}

// Asignaci√≥n masiva
{% if can_manage %}
document.getElementById('formAsignacionMasiva')?.addEventListener('submit', async function(e) {
  e.preventDefault();
  const selectedTasks = Array.from(document.querySelectorAll('.task-select:checked')).map(c => c.value);
  const selectedUsers = Array.from(document.querySelectorAll('#asignacionMasivaModal input[name="user_ids[]"]:checked')).map(c => c.value);
  if (!selectedTasks.length || !selectedUsers.length) { alert('Seleccion√° al menos una tarea y un usuario'); return; }

  const fd = new FormData();
  selectedTasks.forEach(id => fd.append('tarea_ids[]', id));
  selectedUsers.forEach(id => fd.append('user_ids[]', id));
  const cuota = document.querySelector('#asignacionMasivaModal input[name="cuota_objetivo"]').value;
  if (cuota) fd.append('cuota_objetivo', cuota);

  try {
    const r = await fetch('/obras/asignar-usuarios', { method:'POST', body: fd, credentials:'include' });
    const j = await r.json();
    if (!r.ok || j.ok === false) throw new Error(j.error || `HTTP ${r.status}`);
    alert(`‚úÖ ${j.creados} asignaciones creadas exitosamente`);
    bootstrap.Modal.getInstance(document.getElementById('asignacionMasivaModal')).hide();
    location.reload();
  } catch (err) {
    alert('Error de conexi√≥n al asignar usuarios: ' + err.message);
  }
});
{% endif %}

// Modal ‚ÄúRegistrar Avance‚Äù
(() => {
  const modalDetalle = document.getElementById('modalAvanceDetalle');
  if (!modalDetalle) return;
  modalDetalle.addEventListener('show.bs.modal', (ev) => {
    const btn = ev.relatedTarget;
    const base = btn?.dataset?.unidad || 'un';
    const r    = btn?.dataset?.rendimiento || '';
    const id   = btn?.dataset?.tareaId || '';
    const tareaNombre = btn?.dataset?.tareaNombre || '';

    document.getElementById('unidad_base').value = base;
    document.getElementById('tarea_id').value    = id;
    document.getElementById('rendimiento').value = r;
    document.getElementById('avance_tarea_nombre_detalle').textContent = tareaNombre;

    const sel = document.getElementById('unidad_ingresada');
    if ([...sel.options].some(o => o.value === base)) sel.value = base;
    sel.disabled = true;

    const qty = document.getElementById('cantidad');
    const hrs = document.getElementById('horas');
    const rr = parseFloat(r);
    qty.oninput = hrs.oninput = null;
    if (!isNaN(rr) && rr > 0) {
      hrs.oninput = () => { if (hrs.value && !qty.value) qty.value = (parseFloat(hrs.value)*rr).toFixed(2); };
      qty.oninput = () => { if (qty.value && !hrs.value) hrs.value = (parseFloat(qty.value)/rr).toFixed(2); };
    }
  });
})();

async function completarTarea(tareaId) {
  if (!confirm('¬øMarcar esta tarea como completada?')) return;
  try {
    const r = await fetch(`/obras/tareas/${tareaId}/completar`, { method:'POST', headers:{'Content-Type':'application/json'} });
    const j = await r.json();
    if (j.ok) location.reload(); else alert(j.error || 'Error al completar la tarea');
  } catch { alert('Error de conexi√≥n al completar la tarea'); }
}

document.getElementById('formAvanceDetalle')?.addEventListener('submit', async function(e) {
  e.preventDefault();
  const tareaId = document.getElementById('tarea_id').value;
  const fd = new FormData(this);
  try {
    const r = await fetch(`/obras/tareas/${tareaId}/avances`, { method:'POST', body: fd });
    const j = await r.json();
    if (j.ok) {
      bootstrap.Modal.getInstance(document.getElementById('modalAvanceDetalle')).hide();
      location.reload();
    } else {
      alert(j.error || 'Error al registrar el avance');
    }
  } catch { alert('Error de conexi√≥n al registrar el avance'); }
});

// ===== Avances pendientes (aprobar / rechazar) =====
let currentAvanceToReject = null;

async function mostrarAvancesPendientes(tareaId, tareaNombre) {
  const modal = new bootstrap.Modal(document.getElementById('modalAvancesPendientes'));
  document.getElementById('tarea-nombre-pendiente').textContent = tareaNombre;
  document.getElementById('loading-avances').style.display = 'block';
  document.getElementById('avances-container').style.display = 'none';
  document.getElementById('no-avances').style.display = 'none';
  modal.show();
  try {
    const r = await fetch(`/obras/api/tareas/${tareaId}/avances-pendientes`);
    const d = await r.json();
    document.getElementById('loading-avances').style.display = 'none';
    if (!d.ok || d.avances.length === 0) { document.getElementById('no-avances').style.display = 'block'; return; }
    document.getElementById('avances-container').style.display = 'block';
    renderAvancesPendientes(d.avances);
  } catch {
    document.getElementById('loading-avances').style.display = 'none';
    document.getElementById('no-avances').style.display = 'block';
    document.querySelector('#no-avances h5').textContent = 'Error al cargar avances';
    document.querySelector('#no-avances p').textContent = 'No se pudieron cargar los avances pendientes. Int√©ntalo de nuevo.';
  }
}

function renderAvancesPendientes(avances) {
  const container = document.getElementById('avances-container');
  const template = document.getElementById('avance-pendiente-template');
  container.innerHTML = '';
  avances.forEach(avance => {
    const frag = template.content.cloneNode(true);
    const item = frag.querySelector('.avance-item');
    item.dataset.avanceId = avance.id;
    frag.querySelector('.operario-nombre').textContent = avance.operario.nombre;
    frag.querySelector('.fecha-registro').textContent = avance.fecha;
    frag.querySelector('.cantidad-valor').textContent = avance.cantidad;
    frag.querySelector('.unidad-texto').textContent = avance.unidad || '';
    if (avance.horas > 0) {
      frag.querySelector('.horas-container').style.display = 'block';
      frag.querySelector('.horas-valor').textContent = avance.horas;
    }
    if ((avance.notas || '').trim()) {
      frag.querySelector('.notas-container').style.display = 'block';
      frag.querySelector('.notas-texto').textContent = avance.notas;
    }
    if (avance.fotos.length > 0) {
      const thumbs = frag.querySelector('.fotos-thumbnails');
      frag.querySelector('.fotos-container').style.display = 'block';
      frag.querySelector('.sin-fotos').style.display = 'none';
      frag.querySelector('.fotos-count').textContent = avance.fotos.length;
      avance.fotos.forEach(foto => {
        const col = document.createElement('div'); col.className = 'col-6 col-md-4 col-lg-3';
        col.innerHTML = `
          <div class="photo-thumbnail" style="cursor:pointer" onclick="mostrarFotoAmpliada('${foto.url}')">
            <img src="${foto.thumbnail_url}" alt="Foto evidencia" class="img-fluid rounded border"
                 style="aspect-ratio:1;object-fit:cover;max-height:80px;" loading="lazy">
            <div class="text-center mt-1"><small class="text-muted">${foto.width}x${foto.height}</small></div>
          </div>`;
        thumbs.appendChild(col);
      });
    } else {
      frag.querySelector('.fotos-container').style.display = 'none';
      frag.querySelector('.sin-fotos').style.display = 'block';
    }
    frag.querySelector('button[onclick*="aprobarAvance"]').dataset.avanceId = avance.id;
    frag.querySelector('button[onclick*="rechazarAvance"]').dataset.avanceId = avance.id;
    container.appendChild(frag);
  });
}

function mostrarFotoAmpliada(url) {
  document.getElementById('foto-ampliada').src = url;
  new bootstrap.Modal(document.getElementById('modalFotoAmpliada')).show();
}

async function aprobarAvance(button) {
  const id = button.dataset.avanceId;
  if (!confirm('¬øEst√° seguro de aprobar este avance?')) return;
  const original = button.innerHTML;
  button.disabled = true; button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Aprobando...';
  try {
    const r = await fetch(`/obras/avances/${id}/aprobar`, { method:'POST', headers:{'Content-Type':'application/json'} });
    const j = await r.json();
    if (j.ok) {
      const item = button.closest('.avance-item'); item.style.opacity = '0.5';
      const ok = document.createElement('div'); ok.className='alert alert-success mt-2';
      ok.innerHTML = '<i class="fas fa-check me-2"></i>Avance aprobado correctamente'; item.appendChild(ok);
      setTimeout(() => {
        item.remove();
        if (!document.querySelectorAll('.avance-item').length) {
          bootstrap.Modal.getInstance(document.getElementById('modalAvancesPendientes')).hide();
          location.reload();
        }
      }, 1500);
    } else { throw new Error(j.error || 'Error al aprobar el avance'); }
  } catch (e) {
    alert('Error al aprobar el avance: ' + e.message);
    button.disabled = false; button.innerHTML = original;
  }
}

function rechazarAvance(button) {
  currentAvanceToReject = { avanceId: button.dataset.avanceId, button };
  document.getElementById('motivo-rechazo').value = '';
  new bootstrap.Modal(document.getElementById('modalRechazarAvance')).show();
}

async function confirmarRechazo() {
  if (!currentAvanceToReject) return;
  const motivo = document.getElementById('motivo-rechazo').value.trim();
  if (!motivo) { alert('Por favor ingrese un motivo para el rechazo'); return; }
  const { avanceId, button } = currentAvanceToReject;
  bootstrap.Modal.getInstance(document.getElementById('modalRechazarAvance')).hide();
  const original = button.innerHTML; button.disabled = true; button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Rechazando...';
  try {
    const fd = new FormData(); fd.append('motivo', motivo);
    const r = await fetch(`/obras/avances/${avanceId}/rechazar`, { method:'POST', body: fd });
    const j = await r.json();
    if (j.ok) {
      const item = button.closest('.avance-item'); item.style.opacity = '0.5';
      const msg = document.createElement('div'); msg.className='alert alert-danger mt-2';
      msg.innerHTML = '<i class="fas fa-times me-2"></i>Avance rechazado: ' + motivo; item.appendChild(msg);
      setTimeout(() => {
        item.remove();
        if (!document.querySelectorAll('.avance-item').length) {
          bootstrap.Modal.getInstance(document.getElementById('modalAvancesPendientes')).hide();
          location.reload();
        }
      }, 2000);
    } else { throw new Error(j.error || 'Error al rechazar el avance'); }
  } catch (e) {
    alert('Error al rechazar el avance: ' + e.message);
    button.disabled = false; button.innerHTML = original;
  } finally { currentAvanceToReject = null; }
}

console.log('üîß HOTFIX: Traditional form submission enabled (no AJAX interference)');
</script>
{% endblock %}

