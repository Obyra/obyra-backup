Asunto: Auto‑creación server‑side de tareas por etapa (no sólo dropdown)

Hola equipo, gracias por el avance del dropdown. Sin embargo, el requerimiento es:

Al crear una etapa, se deben insertar automáticamente ~15 tareas predefinidas en la BD (server‑side).
El modal sólo se usa para tareas manuales adicionales.

Ahora el template recibe TAREAS_DETALLADAS_POR_ETAPA y el modal muestra sugerencias, pero faltan estas 3 cosas:

1) Hook server‑side después de crear la etapa
En obras.py, tras db.session.add(nueva_etapa) y db.session.flush() llamen a un seed idempotente:

python
Copiar
Editar
# obras.py
from tareas_predefinidas import TAREAS_POR_ETAPA  # o el nombre real único

def seed_tareas_para_etapa(nueva_etapa):
    tareas = TAREAS_POR_ETAPA.get(nueva_etapa.nombre, [])
    for t in tareas:
        ya = Tarea.query.filter_by(etapa_id=nueva_etapa.id, nombre=t["nombre"]).first()
        if ya:
            continue
        db.session.add(Tarea(
            obra_id=nueva_etapa.obra_id,
            etapa_id=nueva_etapa.id,
            nombre=t["nombre"],
            descripcion=t.get("descripcion", ""),
            horas_estimadas=t.get("horas", 0),
            estado="Pendiente"
        ))

# dentro del handler que crea la etapa:
db.session.add(nueva_etapa)
db.session.flush()           # obtener nueva_etapa.id
seed_tareas_para_etapa(nueva_etapa)
db.session.commit()
Criterio de aceptación: Creo “Mampostería” → al desplegarla veo 15 tareas ya creadas; refresco y no se duplican.

2) Unificar nombres e imports
Hay varias variantes: obtener_tareas_detalladas_para_etapa, TAREAS_DETALLADAS_POR_ETAPA, tareas_detalladas.py, etc.
Por favor usen un único origen (por ejemplo tareas_predefinidas.py con TAREAS_POR_ETAPA) y eliminen tareas_detalladas.py o cualquier alias para evitar que la vista lea la lista corta.

3) Backfill real (no sólo botón)
Ruta admin que recorra todas las etapas existentes y ejecute seed_tareas_para_etapa(etapa) sin duplicar.
Luego verificar que el estado de etapa se pueda cambiar y que eliminar etapas siga sin error float/Decimal.

Gracias. Cuando esto esté, pruebo de nuevo.

Si querés, mientras te lo corrigen, hago una checklist de prueba para cuando te avisen:

Hard refresh → crear etapa Mampostería → ver 15 tareas sin abrir el modal.

Cambiar estado Pendiente → En curso y que persista.

Correr backfill en obra con etapas viejas → completar tareas sin duplicados.

Eliminar etapa de prueba → sin error y totales recalculados.

¿Te lo mando también en Excel con TODAS las tareas por etapa para que lo dejen como fuente única (tareas_predefinidas.py) y no vuelvan a mezclar archivos?