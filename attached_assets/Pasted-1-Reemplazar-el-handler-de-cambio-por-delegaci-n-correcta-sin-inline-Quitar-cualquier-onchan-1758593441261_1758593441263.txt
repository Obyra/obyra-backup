1) Reemplazar el handler de cambio por delegación correcta (sin inline):

// Quitar cualquier onchange="handleEtapaCheckboxChange(...)" del HTML
// y cualquier addEventListener('change', handleEtapaCheckboxChange) sobre el DIV

function bindCatalogEvents(){
  const container = document.getElementById('catalogoEtapas');
  if (!container) return;

  container.addEventListener('change', (e) => {
    const cb = e.target.closest('input[type="checkbox"][data-etapa-id]');
    if (!cb) return;                                // <- evita el undefined
    const id = String(cb.dataset.etapaId);
    if (cb.checked) WZ_STATE.etapasSel.add(id);
    else WZ_STATE.etapasSel.delete(id);
    updateEtapasBadge();
  });
}


2) Asegurar que los checkboxes tengan data-etapa-id:

<input type="checkbox"
       class="etapa-checkbox"
       data-etapa-id="{{ etapa.id }}">


3) Después de renderizar el catálogo, SIEMPRE:

bindCatalogEvents();
rehydrateChecksFromState();
updateEtapasBadge();


4) Handler del botón “Agregar Etapas Seleccionadas” limpio (sin duplicados):

const old = document.getElementById('btnAgregarEtapasSel');
old.replaceWith(old.cloneNode(true));
const btn = document.getElementById('btnAgregarEtapasSel');

btn.addEventListener('click', async (e) => {
  e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
  const ids = [...WZ_STATE.etapasSel];
  console.log('ADD ids ->', ids);
  if (!ids.length) { alert('Debe seleccionar al menos una etapa'); return; }
  try {
    await window.applyCatalogAndAdvance?.(ids);
    await window.gotoPaso?.(2);
  } catch (err) {
    console.error('applyCatalogAndAdvance error', err);
  }
}, { once: true });


5) Quitar cualquier POST/refresh en el change del checkbox.
(Si hay re-render por otro lado, el punto 3 rehidrata y actualiza.)

Resultado esperado

Ya no aparece el TypeError ... leyendo 'etapaId'.

El badge muestra el número correcto.

Siguiente se habilita con N>0.

Click en Agregar → se loguea ADD ids -> [...] y pasa al Paso 2.

Si después de esto no ves el log ADD ids -> [...], decime y te paso el parche para applyCatalogAndAdvance/gotoPaso.