ğŸ“Œ Contexto

En el Wizard de Obras â€“ Paso 1 (CatÃ¡logo de Etapas), al pasar a Paso 2 se hace un POST a /obras/api/wizard-tareas/preview. Ese POST estÃ¡ yendo con etapa_ids: [] y vuelve 400 â€œetapa_ids requeridosâ€.

â— QuÃ© pasa hoy

La UI muestra checkboxes en cada card de etapa.

El contador de â€œN etapas seleccionadasâ€ se actualiza, pero el payload del POST sale vacÃ­o.

En consola aparece que getSelectedEtapaIds no existe y/o el selector del collector no encuentra nada.

Hay desajuste de clases: los checkboxes renderizan como etapa-checkbox, pero el collector busca etapa-check.

ğŸ§© Causa tÃ©cnica

El cÃ³digo que arma etapa_ids:

No encuentra los elementos (porque busca una clase distinta).

No estÃ¡ expuesto globalmente (no existe window.getSelectedEtapaIds).

El handler â€œAgregar/Siguienteâ€ en Paso 1 no usa un collector Ãºnico y por eso arma el POST con un array vacÃ­o.

âœ… Lo que necesitamos que cambies

Unificar el markup de los checkboxes de Paso 1:

Cada checkbox debe tener una clase estable (podÃ©s usar etapa-check o mantener etapa-checkbox, pero que sea una sola y consistente).

Debe traer el ID de la etapa (en value o en data-etapa-id).

Importante: el collector debe buscar exactamente la clase que se renderiza.

Collector canÃ³nico (una sola fuente de verdad):

Crear una funciÃ³n global getSelectedEtapaIds() (en window) que:

Busque los checkboxes marcados dentro del contenedor del Paso 1.

Extraiga los IDs desde data-etapa-id o value.

Devuelva un array de nÃºmeros.

Ese mismo collector debe usarse para:

Actualizar el contador de seleccionadas.

Armar el payload del POST.

Handler de Paso 1 â†’ Paso 2:

El botÃ³n â€œAgregar Etapas Seleccionadas / Siguienteâ€ debe:

Evitar el submit clÃ¡sico (asegurar type="button").

Llamar al collector; si devuelve vacÃ­o, mostrar mensaje y no continuar.

Hacer el POST JSON a /obras/api/wizard-tareas/preview con { obra_id, etapa_ids }.

Solo si responde OK, navegar a Paso 2.

(Opcional, no bloqueante) Al activar un pane, limpiar aria-hidden en el activo para evitar el warning de accesibilidad.

ğŸ—‚ï¸ DÃ³nde tocar

templates/obras/detalle.html: render del Paso 1 (markup de los checkboxes) y botones.

static/js/wizard.js (o el JS del wizard): funciÃ³n global getSelectedEtapaIds() y el handler de â€œSiguienteâ€ de Paso 1.

âœ… Criterios de aceptaciÃ³n

Con al menos una etapa tildada, el Network del navegador muestra el POST a /obras/api/wizard-tareas/preview con un JSON que incluye:

obra_id correcto

etapa_ids como array con 1+ IDs numÃ©ricos (no vacÃ­o).

El modal navega a Paso 2 sin 400.

El contador del Paso 1 coincide con la cantidad de IDs que envÃ­a el POST.

No se rompe el resto:

Paso 2 sigue usando plantillas del catÃ¡logo (no DB real).

Paso 3 mantiene el placeholder â€œâ€” SeleccionÃ¡ â€”â€ en â€œAsignado aâ€.

Finalizar/Confirmar siguen con event delegation y sin volver a Paso 2.